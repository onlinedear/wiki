# 服务器部署步骤

## 前提条件

✅ 已上传 `notedoc-latest.tar` 到服务器 `/root/` 目录  
✅ 已修改 `docker-compose.yml` 配置文件

## 方式 1：使用自动部署脚本（推荐）

### 1. 上传部署脚本

将 `server-deploy.sh` 上传到服务器的项目目录（如 `/www/wwwroot/notedoc/`）

### 2. SSH 登录服务器

```bash
ssh root@你的服务器IP
```

### 3. 运行部署脚本

```bash
cd /www/wwwroot/notedoc  # 你的项目目录
chmod +x server-deploy.sh
./server-deploy.sh
```

脚本会自动完成：
- 停止现有服务
- 加载镜像
- 验证镜像
- 启动服务
- 显示日志

## 方式 2：手动部署

### 1. SSH 登录服务器

```bash
ssh root@你的服务器IP
```

### 2. 加载镜像

```bash
cd /root
docker load -i notedoc-latest.tar
```

### 3. 验证镜像

```bash
docker images | grep notedoc
```

应该看到类似输出：
```
notedoc      latest    2a991f4942a8   10 minutes ago   613MB
```

### 4. 进入项目目录

```bash
cd /www/wwwroot/notedoc  # 替换为你的实际路径
```

### 5. 停止旧服务（如果有）

```bash
docker-compose down
```

### 6. 启动新服务

```bash
docker-compose up -d
```

### 7. 查看日志

```bash
docker-compose logs -f notedoc
```

看到类似输出表示成功：
```
[Nest] XX - LOG [NestApplication] Nest application successfully started
[Nest] XX - LOG [NestApplication] Listening on http://127.0.0.1:3000
```

按 `Ctrl+C` 退出日志查看

### 8. 检查服务状态

```bash
docker-compose ps
```

应该看到所有服务都是 `Up` 状态

## 验证部署

### 1. 在浏览器访问

```
http://你的服务器IP:3000
```

或者如果配置了域名：
```
https://your-domain.com
```

### 2. 创建管理员账号

首次访问会提示创建管理员账号

## 常用命令

```bash
# 查看所有容器状态
docker-compose ps

# 查看实时日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f notedoc

# 重启服务
docker-compose restart notedoc

# 停止所有服务
docker-compose down

# 停止并删除数据（危险！）
docker-compose down -v
```

## 故障排查

### 问题 1：服务无法启动

```bash
# 查看详细日志
docker-compose logs notedoc

# 检查配置文件
cat docker-compose.yml

# 检查环境变量
docker-compose config
```

### 问题 2：端口被占用

修改 `docker-compose.yml` 中的端口映射：
```yaml
ports:
  - "3001:3000"  # 改为其他端口
```

### 问题 3：数据库连接失败

检查 `DATABASE_URL` 配置是否正确：
```bash
docker-compose exec notedoc env | grep DATABASE_URL
```

### 问题 4：镜像加载失败

```bash
# 检查磁盘空间
df -h

# 清理旧镜像
docker system prune -a
```

## 更新部署

如果需要更新镜像：

1. 构建新镜像并上传
2. 停止服务：`docker-compose down`
3. 删除旧镜像：`docker rmi notedoc:latest`
4. 加载新镜像：`docker load -i notedoc-latest.tar`
5. 启动服务：`docker-compose up -d`

## 备份数据

```bash
# 备份数据库
docker-compose exec db pg_dump -U notedoc notedoc > backup.sql

# 备份文件存储
tar -czf storage-backup.tar.gz data/storage/
```

## 需要帮助？

如果遇到问题，收集以下信息：
- `docker-compose ps` 输出
- `docker-compose logs notedoc` 输出
- `docker-compose config` 输出
