# 本地 Docker 测试成功 ✅

## 当前状态

镜像已成功构建并在本地运行！

- **镜像文件**: `notedoc-latest.tar` (613MB)
- **本地访问**: http://localhost:3000
- **状态**: 运行中

## 本地测试命令

```bash
# 启动服务
docker-compose -f docker-compose.local.yml up -d

# 查看日志
docker-compose -f docker-compose.local.yml logs -f

# 停止服务
docker-compose -f docker-compose.local.yml down

# 停止并删除数据
docker-compose -f docker-compose.local.yml down -v
```

## 部署到服务器

### 1. 上传镜像

**方式 A：宝塔面板**
- 文件管理 → 上传 `notedoc-latest.tar` 到 `/root/`

**方式 B：scp 命令**
```bash
scp notedoc-latest.tar root@你的服务器IP:/root/
```

### 2. 在服务器上操作

SSH 登录后：

```bash
# 加载镜像
cd /root
docker load -i notedoc-latest.tar

# 验证镜像
docker images | grep notedoc

# 进入项目目录
cd /www/wwwroot/notedoc  # 你的实际路径

# 确保 docker-compose.yml 配置正确
# 需要配置以下环境变量：
# - APP_URL: 你的域名或 IP
# - APP_SECRET: 至少 32 字符的随机字符串
# - DATABASE_URL: PostgreSQL 连接字符串
# - REDIS_URL: Redis 连接字符串

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f notedoc
```

### 3. 服务器 docker-compose.yml 示例

```yaml
services:
  notedoc:
    image: notedoc:latest  # 使用本地加载的镜像
    depends_on:
      - db
      - redis
    environment:
      APP_URL: 'https://your-domain.com'  # 改为你的域名
      APP_SECRET: 'your-super-secret-key-at-least-32-characters-long'  # 改为随机字符串
      DATABASE_URL: 'postgresql://notedoc:STRONG_PASSWORD@db:5432/notedoc?schema=public'
      REDIS_URL: 'redis://redis:6379'
    ports:
      - "3000:3000"
    restart: unless-stopped
    volumes:
      - notedoc_data:/app/data/storage

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: notedoc
      POSTGRES_USER: notedoc
      POSTGRES_PASSWORD: STRONG_PASSWORD  # 改为强密码
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7.2-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  notedoc_data:
  db_data:
  redis_data:
```

## 重要提示

1. **APP_SECRET**: 必须至少 32 字符，用于加密会话
2. **数据库密码**: 生产环境请使用强密码
3. **APP_URL**: 必须是你的实际域名或 IP
4. **端口映射**: 如果 3000 端口被占用，可以改为其他端口（如 3001:3000）

## 首次访问

访问 http://your-domain.com:3000 后：
1. 创建管理员账号
2. 设置工作空间
3. 开始使用

## 故障排查

```bash
# 查看容器状态
docker-compose ps

# 查看详细日志
docker-compose logs -f

# 重启服务
docker-compose restart notedoc

# 检查数据库连接
docker-compose exec notedoc sh
# 在容器内测试连接
```

## 下一步

镜像已经准备好，可以上传到服务器部署了！
