# é£ä¹¦æ–‡æ¡£è§†é¢‘å¯¼å…¥åŠŸèƒ½è¯´æ˜

## å½“å‰çŠ¶æ€

âš ï¸ **éƒ¨åˆ†å®ç°** - è§†é¢‘å—å¯ä»¥è¯†åˆ«ï¼Œä½†ä¸‹è½½å¯èƒ½å¤±è´¥ã€‚

## åŠŸèƒ½æ¦‚è¿°

æ”¯æŒä»é£ä¹¦æ–‡æ¡£å¯¼å…¥è§†é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ä¸‹è½½å¹¶ä¿å­˜åˆ° NoteDoc å­˜å‚¨ä¸­ã€‚

## å®ç°æ–¹å¼

### 1. è§†é¢‘å—è¯†åˆ«

é£ä¹¦æ–‡æ¡£ä¸­çš„è§†é¢‘å—ç±»å‹ä¸º `block_type: 33`ï¼Œæ˜¯ä¸€ä¸ªå®¹å™¨å—ï¼Œå®é™…è§†é¢‘æ•°æ®åœ¨å­å—ä¸­ã€‚

**å—ç»“æ„ï¼š**
```json
{
  "block_type": 33,
  "block_id": "...",
  "parent_id": "...",
  "children": ["child_block_id"],
  "view": {
    "view_type": "..."
  }
}
```

å­å—åŒ…å«å®é™…çš„è§†é¢‘ tokenï¼ˆ`file.token`ã€`media.token` æˆ– `video.token`ï¼‰ã€‚

### 2. ä¸‹è½½æµç¨‹

```typescript
// 1. è·å–è§†é¢‘ä¸‹è½½ URL
GET /drive/v1/medias/{videoToken}/download
GET /drive/v1/files/{videoToken}/download

// 2. ä¸‹è½½è§†é¢‘æ–‡ä»¶ï¼ˆæœ€å¤§ 200MBï¼Œè¶…æ—¶ 2 åˆ†é’Ÿï¼‰
// 3. ä¸Šä¼ åˆ° NoteDoc å­˜å‚¨
// 4. åˆ›å»ºé™„ä»¶è®°å½•
// 5. ç”Ÿæˆè§†é¢‘èŠ‚ç‚¹
```

### 3. è§†é¢‘èŠ‚ç‚¹æ ¼å¼

```json
{
  "type": "video",
  "attrs": {
    "attachmentId": "uuid",
    "src": "/files/{attachmentId}/{fileName}"
  }
}
```

## é…ç½®è¯´æ˜

### æ–‡ä»¶å¤§å°é™åˆ¶

- æœ€å¤§æ–‡ä»¶å¤§å°ï¼š200MB
- ä¸‹è½½è¶…æ—¶ï¼š2 åˆ†é’Ÿ
- æ”¯æŒæ ¼å¼ï¼šmp4ï¼ˆé»˜è®¤ï¼‰

### æƒé™è¦æ±‚

éœ€è¦é…ç½®é£ä¹¦åº”ç”¨æƒé™ï¼š
- `drive:file:readonly` - è¯»å–äº‘ç©ºé—´æ–‡ä»¶

## æµ‹è¯•æ–¹æ³•

1. åœ¨é£ä¹¦æ–‡æ¡£ä¸­æ’å…¥è§†é¢‘
2. å¯¼å…¥è¯¥æ–‡æ¡£åˆ° NoteDoc
3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è§†é¢‘ä¸‹è½½æˆåŠŸ
4. åœ¨æ–‡æ¡£ä¸­æ’­æ”¾è§†é¢‘

## æ—¥å¿—ç¤ºä¾‹

```
ğŸ“¥ Processing video with token: VMxxxxxxxx
Getting video URL for token: VMxxxxxxxx
âœ“ Got video URL via medias API: https://...
â¬‡ï¸ Downloading video from URL: https://...
âœ“ Downloaded video: 15.67 MB
ğŸ“¤ Video uploaded to storage: workspace-xxx/files/...
âœ… Video imported successfully: uuid-xxx (15.67 MB)
```

## å·²çŸ¥é—®é¢˜

### è§†é¢‘ä¸‹è½½å¤±è´¥

**ç—‡çŠ¶ï¼š** æ˜¾ç¤º `ğŸ¬ [è§†é¢‘å¯¼å…¥å¤±è´¥ - Token: xxx...]`

**å¯èƒ½åŸå› ï¼š**

1. **æƒé™ä¸è¶³** - é£ä¹¦è§†é¢‘å¯èƒ½éœ€è¦é¢å¤–çš„ API æƒé™
   - æ£€æŸ¥æ˜¯å¦é…ç½®äº† `drive:drive:readonly` æƒé™
   - æ£€æŸ¥æ˜¯å¦é…ç½®äº† `media:media:readonly` æƒé™

2. **API ç«¯ç‚¹ä¸æ­£ç¡®** - è§†é¢‘ä¸‹è½½å¯èƒ½ä½¿ç”¨ä¸åŒçš„ API
   - å½“å‰å°è¯•ï¼š`/drive/v1/medias/{token}/download`
   - å½“å‰å°è¯•ï¼š`/drive/v1/files/{token}/download`
   - å¯èƒ½éœ€è¦ï¼š`/drive/v1/medias/{token}/download_url` æˆ–å…¶ä»–ç«¯ç‚¹

3. **Token ç±»å‹ä¸åŒ¹é…** - è§†é¢‘ token å¯èƒ½ä¸å›¾ç‰‡ token æ ¼å¼ä¸åŒ

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
grep -E "Video container|Found video file token|Getting video URL|Method" logs/app.log

# æ£€æŸ¥é£ä¹¦åº”ç”¨æƒé™é…ç½®
# åœ¨é£ä¹¦å¼€æ”¾å¹³å° -> åº”ç”¨è¯¦æƒ… -> æƒé™ç®¡ç†
```

## å¤±è´¥å¤„ç†

å¦‚æœè§†é¢‘ä¸‹è½½å¤±è´¥ï¼Œä¼šæ˜¾ç¤ºå ä½ç¬¦ï¼š

```
ğŸ¬ [è§†é¢‘å¯¼å…¥å¤±è´¥ - Token: xxx...]
```

## ç›¸å…³æ–‡ä»¶

- `apps/server/src/ee/feishu-import/feishu-import.service.ts`
- `apps/server/src/ee/feishu-import/feishu-api.service.ts`
- `apps/client/src/features/editor/components/video/video-view.tsx`
