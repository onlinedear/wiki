# 飞书文档图片导入测试指南

## 快速测试步骤

### 1. 准备测试文档

在飞书中创建一个包含图片的测试文档：

- 插入 2-3 张不同格式的图片（PNG、JPG）
- 混合文本和图片内容
- 包含不同大小的图片

### 2. 配置飞书应用

确保飞书应用已配置以下权限：

- `docx:document:readonly` - 读取文档
- `drive:drive:readonly` - 读取云空间
- `drive:file:readonly` - 读取文件

### 3. 执行导入

1. 进入 NoteDoc 设置 → 集成 → 飞书
2. 配置 App ID 和 App Secret
3. 输入包含图片的文档 URL
4. 点击导入

### 4. 验证结果

检查导入的文档：

- ✅ 图片是否正常显示
- ✅ 图片位置是否正确
- ✅ 图片是否可以点击查看大图
- ✅ 文本内容是否完整

### 5. 检查附件记录

在数据库中验证：

```sql
-- 查看附件记录
SELECT id, fileName, fileSize, type, pageId 
FROM attachments 
WHERE pageId = '<导入的页面ID>'
ORDER BY createdAt DESC;
```

### 6. 检查存储文件

验证文件是否已上传到存储：

- **本地存储**：检查 `data/storage/<workspaceId>/files/` 目录
- **S3 存储**：检查 S3 bucket 中的文件

## 测试场景

### 场景 1：单张图片

- 文档只包含一张图片
- 验证图片正常导入

### 场景 2：多张图片

- 文档包含 5+ 张图片
- 验证所有图片都能导入
- 检查导入速度

### 场景 3：大图片

- 插入 5MB+ 的大图片
- 验证能否正常下载和上传

### 场景 4：图片下载失败

- 使用已删除的图片 token（模拟失败）
- 验证是否显示占位符 "🖼️ [图片导入失败]"
- 确认不会中断整个导入流程

## 常见问题排查

### 图片不显示

1. 检查飞书权限配置
2. 查看服务器日志中的错误信息
3. 验证存储服务是否正常工作

### 图片下载慢

1. 检查网络连接
2. 考虑使用 CDN 加速
3. 实现批量并行下载

### 存储空间不足

1. 检查存储配额
2. 考虑启用图片压缩
3. 清理不需要的附件

## 日志查看

查看导入过程的日志：

```bash
# 查看图片下载日志
grep "Downloading image" logs/app.log

# 查看图片上传日志
grep "Image uploaded" logs/app.log

# 查看错误日志
grep "Failed to download" logs/app.log
```

## 性能指标

正常情况下的性能参考：

- 单张图片下载时间：< 2 秒
- 单张图片上传时间：< 1 秒
- 10 张图片的文档导入时间：< 30 秒

## 成功标准

- ✅ 所有图片都能正常显示
- ✅ 图片附件记录正确创建
- ✅ 存储文件正确保存
- ✅ 失败时有友好的错误提示
- ✅ 不影响其他内容的导入
