# 甘特图时间字段映射功能说明

## 功能概述

在甘特图设置中，将"开始时间"和"结束时间"从日历控件改为下拉框，允许用户选择自定义字段中类型为"日期"的字段作为时间范围的数据源。

## 修改内容

### 1. 数据结构调整

在 `GanttSettings` 接口中新增两个字段：

```typescript
interface GanttSettings {
  startDateField?: string; // 开始时间字段ID
  endDateField?: string; // 结束时间字段ID
  // ... 其他字段
}
```

### 2. 设置界面修改

将甘特图设置模态框中的时间范围选择器从 `DatePickerInput`（日历控件）改为 `Select`（下拉框）：

- **开始时间**：下拉框选择日期类型的自定义字段
- **结束时间**：下拉框选择日期类型的自定义字段
- 下拉框选项：仅显示类型为 `date` 的自定义字段

### 3. 日期获取逻辑

新增 `getTaskDates` 函数，根据配置获取任务的实际日期：

```typescript
const getTaskDates = (task: GanttTask): { startDate: string | null; endDate: string | null } => {
  // 如果设置了字段映射，使用字段值
  if (ganttSettings.startDateField && task[ganttSettings.startDateField]) {
    const startDate = task[ganttSettings.startDateField];
    const endDate = ganttSettings.endDateField && task[ganttSettings.endDateField] 
      ? task[ganttSettings.endDateField] 
      : startDate;
    return { startDate, endDate };
  }
  
  // 否则使用默认的 startDate 和 endDate 字段
  return {
    startDate: task.startDate || null,
    endDate: task.endDate || null
  };
};
```

### 4. 相关功能更新

所有涉及任务日期的功能都已更新为使用 `getTaskDates` 函数：

- **日期范围计算** (`getDateRange`)：根据配置的字段计算甘特图的显示范围
- **任务位置计算** (`calculateTaskPosition`)：根据配置的字段计算进度条位置
- **任务拖拽移动** (`handleTaskBarMouseDown`, `handleMouseMove`)：拖拽时更新配置的字段
- **任务大小调整** (`handleTaskResize`)：调整大小时更新配置的字段
- **进度条渲染**：根据配置的字段显示进度条

## 使用方式

### 1. 创建日期类型的自定义字段

在甘特图中，先添加日期类型的自定义字段，例如：
- "计划开始日期"
- "计划结束日期"
- "实际开始日期"
- "实际结束日期"

### 2. 配置时间范围

1. 点击甘特图工具栏的"设置"按钮
2. 在"时间范围"部分：
   - **开始时间**：从下拉框中选择一个日期字段（如"计划开始日期"）
   - **结束时间**：从下拉框中选择一个日期字段（如"计划结束日期"）
3. 点击"保存"

### 3. 填写任务数据

在任务列表中，为每个任务填写对应的日期字段值，甘特图将自动根据这些字段显示进度条。

## 优势

1. **灵活性**：可以根据不同场景选择不同的日期字段（计划日期 vs 实际日期）
2. **复用性**：同一个甘特图可以通过切换字段映射来显示不同的时间维度
3. **一致性**：与自定义字段系统完全集成，保持数据结构的一致性

## 兼容性

- 如果未配置字段映射，系统会自动使用默认的 `startDate` 和 `endDate` 字段
- 已有的甘特图数据不受影响，可以继续正常使用
- 拖拽和调整大小功能会根据配置自动更新对应的字段

## 技术实现

- **文件位置**：`apps/client/src/features/editor/components/gantt/gantt-view.tsx`
- **核心函数**：`getTaskDates`, `calculateTaskPosition`, `handleTaskResize`
- **UI组件**：`GanttSettingsForm` 中的时间范围选择器
