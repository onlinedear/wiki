# 邮件服务配置 - 部署清单

## ✅ 部署前检查

### 代码验证
```bash
# 运行验证脚本
./scripts/verify-mail-settings.sh
```

### 编译检查
```bash
# 检查后端编译
cd apps/server
pnpm build

# 检查前端编译
cd apps/client
pnpm build
```

## 📋 部署步骤

### 1. 代码部署
- [ ] 拉取最新代码
- [ ] 安装依赖: `pnpm install`
- [ ] 构建项目: `pnpm build`

### 2. 数据库
- [ ] 无需数据库迁移（使用现有 settings 字段）
- [ ] 确认 workspaces 表有 settings 字段

### 3. 启动服务
```bash
# 开发环境
pnpm dev

# 生产环境
pnpm start
```

### 4. 功能验证
- [ ] 以管理员身份登录
- [ ] 访问: 设置 → 系统 → 邮件服务
- [ ] 确认页面正常显示
- [ ] 配置 SMTP 设置
- [ ] 发送测试邮件
- [ ] 确认收到测试邮件

## 🔍 验证清单

### 前端验证
- [ ] 邮件服务菜单显示在"系统"分组下
- [ ] 仅管理员可见
- [ ] 仅自托管版本显示（云版本不显示）
- [ ] 页面加载正常
- [ ] 表单输入正常
- [ ] 保存功能正常
- [ ] 测试邮件功能正常
- [ ] 中文翻译正确

### 后端验证
- [ ] API 端点响应正常
- [ ] 权限控制生效
- [ ] 配置保存成功
- [ ] 测试邮件发送成功
- [ ] 错误处理正确

### 集成验证
- [ ] 用户邀请邮件使用新配置
- [ ] 密码重置邮件使用新配置
- [ ] 通知邮件使用新配置

## 🧪 测试场景

### 场景 1: 配置 Gmail
```
SMTP 主机: smtp.gmail.com
SMTP 端口: 587
SSL/TLS: 关闭
用户名: your-email@gmail.com
密码: [应用专用密码]
```
- [ ] 保存成功
- [ ] 测试邮件发送成功

### 场景 2: 配置 QQ 邮箱
```
SMTP 主机: smtp.qq.com
SMTP 端口: 587
SSL/TLS: 关闭
用户名: your-email@qq.com
密码: [授权码]
```
- [ ] 保存成功
- [ ] 测试邮件发送成功

### 场景 3: 错误处理
- [ ] 错误的 SMTP 主机 → 显示错误信息
- [ ] 错误的端口 → 显示错误信息
- [ ] 错误的用户名/密码 → 显示错误信息
- [ ] 非管理员访问 → 403 禁止访问

## 🔒 安全检查

- [ ] 仅管理员可访问邮件设置
- [ ] API 端点有权限验证
- [ ] 密码不在前端日志中显示
- [ ] HTTPS 传输（生产环境）

## 📊 性能检查

- [ ] 页面加载速度正常
- [ ] API 响应时间正常
- [ ] 测试邮件发送时间合理（< 10 秒）

## 🐛 常见问题排查

### 问题 1: 菜单不显示
**检查**:
- 是否以管理员身份登录
- 是否为自托管版本（云版本不显示）

### 问题 2: 测试邮件发送失败
**检查**:
- SMTP 配置是否正确
- 网络连接是否正常
- 防火墙是否封锁端口
- 用户名密码是否正确

### 问题 3: 保存失败
**检查**:
- 是否有管理员权限
- 网络连接是否正常
- 后端服务是否运行
- 查看浏览器控制台错误

## 📝 回滚计划

如果部署出现问题：

1. **前端回滚**
   ```bash
   git revert <commit-hash>
   pnpm build
   ```

2. **后端回滚**
   ```bash
   git revert <commit-hash>
   pnpm build
   ```

3. **无需数据库回滚**（使用现有字段）

## 📞 支持联系

如遇到问题：
1. 查看文档: `docs/邮件服务配置说明.md`
2. 运行验证: `./scripts/verify-mail-settings.sh`
3. 查看日志: 检查服务器日志
4. 联系技术支持

## ✅ 部署完成确认

- [ ] 所有验证通过
- [ ] 功能测试通过
- [ ] 文档已更新
- [ ] 团队已通知

---

**部署日期**: ___________
**部署人员**: ___________
**验证人员**: ___________
**状态**: [ ] 成功 [ ] 失败 [ ] 部分成功
