# 甘特图筛选功能说明

## 功能概述

甘特图的筛选功能允许用户根据自定义条件过滤任务列表，只显示符合条件的任务。筛选条件存储在本地状态中，不会影响其他协作者的视图。

## 功能特性

### 1. 筛选按钮

- 位置：工具栏左侧第三个按钮
- 图标：漏斗图标（IconFilter）
- 状态指示：
  - 无筛选条件时：灰色 subtle 样式
  - 有筛选条件时：蓝色 filled 样式，显示条件数量

### 2. 筛选条件设置

每个筛选条件包含三个部分：

#### 第一列：字段选择
- 可选择任务名（内置字段）
- 可选择所有自定义字段
- 下拉框显示字段名称

#### 第二列：操作符
支持 6 种操作符：
- **等于**：精确匹配
- **不等于**：不匹配
- **包含**：文本包含（不区分大小写）
- **不包含**：文本不包含（不区分大小写）
- **为空**：字段值为空、null、undefined 或空数组
- **不为空**：字段值不为空

#### 第三列：值输入
根据字段类型显示不同的输入控件：
- **文本字段**：文本输入框
- **单选字段**：下拉选择器（显示预设选项）
- **多选字段**：下拉选择器（显示预设选项）
- **人员字段**：人员选择器（支持搜索）
- **日期字段**：日期选择器
- **数字字段**：数字输入框
- **复选框字段**：已选中/未选中选择器
- **超链接字段**：文本输入框

注意：当操作符为"为空"或"不为空"时，不显示值输入控件。

### 3. 筛选逻辑切换

当有 2 个或以上筛选条件时，标题栏右侧会显示逻辑切换器：

- **位置**：模态框标题栏右侧
- **显示条件**：筛选条件数量 ≥ 2
- **格式**："符合以下 [所有/任一] 条件"
- **选项**：
  - **所有**（AND）：必须同时满足所有条件
  - **任一**（OR）：满足任意一个条件即可
- **默认值**：所有（AND）

### 4. 筛选逻辑

- **多条件关系**：
  - **所有（AND）**：所有条件必须同时满足
  - **任一（OR）**：满足任意一个条件即可
- **数组字段处理**：
  - 多选字段：检查数组中是否包含指定值
  - 等于/不等于：检查数组中是否包含该值
  - 包含/不包含：检查数组中任一元素是否包含文本
- **大小写不敏感**：包含/不包含操作符不区分大小写

### 5. 筛选结果

- 实时更新：修改筛选条件或逻辑后立即生效
- 结果提示：显示"共 X 个任务，筛选后显示 Y 个"
- 空状态：无筛选条件时显示提示文字

### 6. 操作功能

- **添加条件**：点击"添加条件"按钮
- **删除条件**：点击每行右侧的删除按钮
- **切换逻辑**：当有 2 个或以上条件时，在标题栏右侧切换"所有/任一"
- **清空全部**：点击标题栏的"清空全部"按钮
- **关闭面板**：点击关闭按钮或遮罩层

## 技术实现

### 数据结构

```typescript
type FilterOperator = 'equals' | 'notEquals' | 'contains' | 'notContains' | 'isEmpty' | 'isNotEmpty';

type FilterLogic = 'and' | 'or';

interface FilterCondition {
  id: string;           // 条件唯一标识
  fieldId: string;      // 字段 ID
  operator: FilterOperator;  // 操作符
  value: any;           // 筛选值
}
```

### 状态管理

- 使用 React useState 管理筛选条件和逻辑类型
- 筛选条件和逻辑存储在组件本地状态，不持久化到文档
- 不影响其他协作者的视图
- 默认逻辑为 AND（所有条件）

### 筛选算法

```typescript
// 检查单个条件是否匹配
const checkCondition = (task: GanttTask, condition: FilterCondition): boolean => {
  const fieldValue = task[condition.fieldId];
  const { operator, value } = condition;

  switch (operator) {
    case 'isEmpty':
      return fieldValue === null || fieldValue === undefined || fieldValue === '' || 
             (Array.isArray(fieldValue) && fieldValue.length === 0);
    
    case 'isNotEmpty':
      return fieldValue !== null && fieldValue !== undefined && fieldValue !== '' && 
             (!Array.isArray(fieldValue) || fieldValue.length > 0);
    
    case 'equals':
      if (Array.isArray(fieldValue)) {
        return fieldValue.includes(value);
      }
      return String(fieldValue) === String(value);
    
    case 'notEquals':
      if (Array.isArray(fieldValue)) {
        return !fieldValue.includes(value);
      }
      return String(fieldValue) !== String(value);
    
    case 'contains':
      if (Array.isArray(fieldValue)) {
        return fieldValue.some(v => String(v).toLowerCase().includes(String(value).toLowerCase()));
      }
      return String(fieldValue).toLowerCase().includes(String(value).toLowerCase());
    
    case 'notContains':
      if (Array.isArray(fieldValue)) {
        return !fieldValue.some(v => String(v).toLowerCase().includes(String(value).toLowerCase()));
      }
      return !String(fieldValue).toLowerCase().includes(String(value).toLowerCase());
    
    default:
      return true;
  }
};

// 应用筛选条件
const applyFilters = (task: GanttTask): boolean => {
  if (filterConditions.length === 0) return true;

  // 根据逻辑类型应用筛选
  if (filterLogic === 'and') {
    // 所有条件都必须满足
    return filterConditions.every(condition => checkCondition(task, condition));
  } else {
    // 任一条件满足即可
    return filterConditions.some(condition => checkCondition(task, condition));
  }
};
```

### 性能优化

- 使用 useMemo 缓存筛选结果
- 依赖项：tasks、filterConditions 和 filterLogic
- 只在依赖变化时重新计算
- 条件检查逻辑独立封装，便于复用

## 使用场景

### AND 逻辑（所有条件）
1. **精确筛选**：负责人是"张三" AND 状态是"进行中"
2. **时间范围**：开始日期 >= 2024-01-01 AND 结束日期 <= 2024-12-31
3. **多维度筛选**：优先级是"高" AND 负责人是"李四" AND 状态不为空

### OR 逻辑（任一条件）
1. **多人任务**：负责人是"张三" OR 负责人是"李四"
2. **状态查询**：状态是"进行中" OR 状态是"待开始"
3. **灵活筛选**：优先级是"高" OR 优先级是"紧急"

### 混合场景
- 先用 OR 逻辑找出多个可能的任务
- 再用 AND 逻辑精确定位特定任务
- 根据实际需求灵活切换

## 注意事项

1. 筛选条件和逻辑不会保存到文档中，刷新页面后会重置
2. 筛选不影响其他协作者，每个用户可以独立设置
3. 筛选只影响任务列表显示，不影响数据本身
4. 删除字段后，相关的筛选条件仍会保留（但可能无效）
5. 建议先设置字段，再添加筛选条件
6. 逻辑切换器仅在有 2 个或以上条件时显示
7. 单个条件时，逻辑类型不影响结果

## 未来扩展

可能的功能增强：
- 保存常用筛选条件为预设
- 支持条件分组（嵌套的 AND/OR 逻辑）
- 支持更多操作符（大于、小于、介于等）
- 筛选条件持久化到用户偏好设置
- 导出筛选后的任务列表
- 筛选历史记录
- 快速筛选模板
