# 飞书文档图片导入实现总结

## 实现概述

成功实现了飞书文档导入时的图片自动下载和上传功能。图片会从飞书下载并永久保存到 NoteDoc 的存储系统中。

## 修改的文件

### 1. `apps/server/src/ee/feishu-import/feishu-import.service.ts`

**新增方法：**
- `downloadAndUploadImage()` - 下载飞书图片并上传到 NoteDoc 存储

**修改方法：**
- `importOnlinePages()` - 先创建页面，再转换内容（以获取 pageId）
- `convertFeishuBlocksToTiptap()` - 改为 async，传递图片处理所需参数
- `convertFeishuBlock()` - 改为 async，实现 case 27 图片处理逻辑

**新增依赖：**
- `StorageService` - 文件上传
- `AttachmentRepo` - 附件记录管理
- `AxiosInstance` - HTTP 客户端类型

### 2. `apps/server/src/ee/feishu-import/feishu-import.module.ts`

**新增导入：**
- `StorageModule` - 存储服务模块
- `AttachmentModule` - 附件管理模块

## 技术实现细节

### 图片处理流程

```
飞书文档 → 提取 image.token → 获取临时 URL → 下载图片
    ↓
生成 attachmentId → 上传到存储 → 创建附件记录
    ↓
在 Tiptap JSON 中引用 attachmentId
```

### 关键代码逻辑

1. **先创建页面**：为了获取 pageId 用于附件关联
2. **异步转换**：图片下载是异步操作，需要 async/await
3. **错误处理**：下载失败时显示占位符，不中断导入
4. **参数传递**：通过方法参数传递 client、pageId、workspaceId、userId

### 数据结构

**Tiptap 图片节点：**
```json
{
  "type": "image",
  "attrs": {
    "attachmentId": "uuid7-generated-id",
    "src": "/api/files/{attachmentId}/{fileName}",
    "alt": null,
    "title": null
  }
}
```

**注意：** `src` 必须包含 `fileId` 和 `fileName` 两个参数，匹配后端路由 `/files/:fileId/:fileName`

**附件记录：**
```typescript
{
  id: attachmentId,
  fileName: `${attachmentId}.png`,
  fileExt: '.png',
  filePath: `${workspaceId}/files/${attachmentId}/${fileName}`,
  fileSize: imageBuffer.length,
  mimeType: 'image/png',
  type: AttachmentType.File,
  pageId: pageId,
  workspaceId: workspaceId,
  creatorId: userId,
}
```

## 功能特性

### ✅ 已实现

- 自动下载飞书图片
- 上传到 NoteDoc 存储（支持 S3 和本地）
- 创建附件记录
- 在文档中正确引用
- 错误处理和日志记录
- 失败时显示占位符

### 🔄 待优化

- 图片格式自动检测（当前默认 PNG）
- 批量并行下载（提升速度）
- 图片压缩（节省存储）
- 进度显示（前端反馈）
- 重试机制（提高成功率）

## 测试建议

1. **基础测试**：导入包含 1-3 张图片的文档
2. **批量测试**：导入包含 10+ 张图片的文档
3. **大图测试**：导入包含 5MB+ 大图的文档
4. **失败测试**：模拟网络错误，验证占位符显示
5. **存储测试**：验证 S3 和本地存储都能正常工作

详见：[飞书文档图片导入测试指南.md](./飞书文档图片导入测试指南.md)

## 相关文档

- [飞书文档导入图片处理说明.md](./飞书文档导入图片处理说明.md) - 详细技术说明
- [飞书文档图片导入测试指南.md](./飞书文档图片导入测试指南.md) - 测试步骤
- [飞书权限配置详细步骤.md](./飞书权限配置详细步骤.md) - 权限配置

## 依赖关系

```
FeishuImportService
  ├── FeishuApiService (下载图片)
  ├── StorageService (上传文件)
  ├── AttachmentRepo (创建记录)
  └── PageRepo (创建/更新页面)
```

## 性能考虑

- **串行下载**：当前实现是串行下载图片，适合图片数量较少的场景
- **内存使用**：图片先下载到内存，再上传，适合中小型图片
- **网络延迟**：受飞书 API 和存储服务的网络延迟影响

## 安全性

- ✅ 使用 uuid7 生成唯一的附件 ID
- ✅ 文件路径包含 workspaceId 隔离
- ✅ 附件记录关联 pageId 和 userId
- ✅ 遵循 NoteDoc 的附件管理规范

## 兼容性

- ✅ 支持 S3 存储
- ✅ 支持本地存储
- ✅ 兼容现有的附件管理系统
- ✅ 符合 Tiptap 图片节点规范
