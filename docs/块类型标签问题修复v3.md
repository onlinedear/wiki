# 块类型标签问题修复 v3

## 修复的问题

### 1. ✅ 图标显示问题
**问题描述：** drag-handle 左侧没有出现对应的图标

**修复方案：**
- 在 `extensions.ts` 中添加了 try-catch 错误处理
- 使用 `renderToStaticMarkup` 将 React 图标组件转换为 HTML
- 添加了 console.error 用于调试图标渲染问题

**验证方法：**
1. 打开浏览器控制台，检查是否有图标渲染错误
2. 鼠标悬停在不同类型的块上，检查标签中是否显示图标
3. 如果图标不显示，检查控制台错误信息

### 2. ✅ 列表项中出现两个拖拽手柄
**问题描述：** 当标题前面加上编号后，编号前面有一个拖拽手柄，编号后面标题前面又有一个拖拽手柄

**根本原因：**
- 列表项（`<li>`）有一个拖拽手柄
- 列表项内的标题（`<h1>` 等）又有自己的拖拽手柄
- 导致出现两个拖拽手柄

**修复方案：**
在 `drag-handle.css` 中添加 CSS 规则，隐藏列表项内标题的拖拽手柄：

```css
/* 隐藏列表项内标题自己的拖拽手柄，只保留列表项的拖拽手柄 */
.tiptap ol li > h1 .drag-handle-container,
.tiptap ol li > h2 .drag-handle-container,
.tiptap ol li > h3 .drag-handle-container,
.tiptap ol li > h4 .drag-handle-container,
.tiptap ol li > h5 .drag-handle-container,
.tiptap ol li > h6 .drag-handle-container,
.tiptap ol li > p .drag-handle-container {
  display: none !important;
}
```

**效果：**
- 编号+标题组合成一个块
- 只在编号前面显示一个拖拽手柄
- 拖拽手柄可以拖动整个列表项（包括编号和标题）

### 3. ✅ 调整编号的 padding-left
**问题描述：** 需要调整各级标题的左侧间距

**修复方案：**
按照要求调整了 `ordered-list.css` 中的 padding-left：

| 标题级别 | padding-left |
|---------|--------------|
| H1      | 2em          |
| H2      | 3em          |
| H3      | 4em          |
| H4      | 5em          |
| H5      | 6em          |
| H6      | 7em          |

同时调整了编号的宽度（从 `min-width` 改为固定 `width`）：

| 标题级别 | 编号宽度 | 示例编号 |
|---------|---------|---------|
| H1      | 1.5em   | 1.      |
| H2      | 2.5em   | 1.1     |
| H3      | 3.5em   | 1.1.1   |
| H4      | 4.5em   | 1.1.1.1 |
| H5      | 5.5em   | 1.1.1.1.1 |
| H6      | 6.5em   | 1.1.1.1.1.1 |

### 4. ✅ 统一拖拽手柄距离
**问题描述：** "有序列表"的拖拽手柄与其他类型的块距离不同

**修复方案：**
在 `drag-handle.css` 中添加：

```css
/* 调整有序列表的拖拽手柄位置，使其与其他块保持一致的距离 */
.tiptap ol {
  margin-left: 0;
}

.tiptap ol li {
  margin-left: 0;
}
```

**效果：**
- 有序列表的拖拽手柄与其他块（段落、标题等）保持相同的左侧距离
- 视觉上更加统一和协调

## 技术细节

### 图标渲染流程
1. 在 `renderContent` 函数中动态 require `@tabler/icons-react`
2. 根据节点类型获取对应的图标组件
3. 使用 `React.createElement` 创建图标元素
4. 使用 `renderToStaticMarkup` 转换为 HTML 字符串
5. 插入到 DOM 中

### CSS 选择器优先级
使用 `!important` 确保列表项内标题的拖拽手柄被隐藏：
```css
.tiptap ol li > h1 .drag-handle-container {
  display: none !important;
}
```

### 编号宽度计算
使用固定宽度而不是 `min-width`，确保编号区域大小一致：
- 避免编号长度变化导致标题位置跳动
- 为长编号（如 1.1.1.1.1.1）预留足够空间

## 测试清单

### 基础功能测试
- [ ] 图标是否正确显示在块类型标签中
- [ ] 不同类型的块是否显示对应的图标
- [ ] 图标大小和颜色是否合适

### 列表项拖拽手柄测试
- [ ] 创建有序列表，添加标题
- [ ] 检查是否只有一个拖拽手柄（在编号前面）
- [ ] 检查标题前面是否没有拖拽手柄
- [ ] 拖拽手柄是否可以拖动整个列表项

### 编号间距测试
- [ ] H1 标题的 padding-left 是否为 2em
- [ ] H2 标题的 padding-left 是否为 3em
- [ ] H3 标题的 padding-left 是否为 4em
- [ ] H4 标题的 padding-left 是否为 5em
- [ ] H5 标题的 padding-left 是否为 6em
- [ ] H6 标题的 padding-left 是否为 7em
- [ ] 编号与标题文本是否对齐
- [ ] 长编号（如 1.1.1）是否与标题重叠

### 拖拽手柄距离测试
- [ ] 创建段落、标题、有序列表等不同类型的块
- [ ] 鼠标悬停在每个块上
- [ ] 检查拖拽手柄的左侧距离是否一致
- [ ] 有序列表的拖拽手柄是否与其他块对齐

## 已知问题和限制

### 图标不显示的可能原因
1. **模块加载失败** - `@tabler/icons-react` 未正确安装或导入
2. **React 版本不兼容** - `renderToStaticMarkup` 可能在某些 React 版本中有问题
3. **CSP 限制** - 内容安全策略可能阻止动态 HTML 插入

**调试方法：**
- 打开浏览器控制台，查看是否有错误信息
- 检查 Network 面板，确认图标库是否加载
- 尝试在控制台手动执行 `require("@tabler/icons-react")`

### 嵌套列表
- 深度嵌套的列表可能需要进一步调整间距
- 嵌套列表的拖拽手柄位置可能需要优化

## 相关文件

### 修改的文件
- `apps/client/src/features/editor/extensions/extensions.ts` - 添加图标渲染和错误处理
- `apps/client/src/features/editor/styles/drag-handle.css` - 隐藏列表项内标题的拖拽手柄，统一距离
- `apps/client/src/features/editor/styles/ordered-list.css` - 调整 padding-left 和编号宽度

### 新增的文件
- `docs/块类型标签问题修复v3.md` - 本文档

## 下一步

如果图标仍然不显示，可能需要：
1. 检查 Vite 配置，确保正确处理动态 require
2. 考虑使用静态导入而不是动态 require
3. 使用 SVG 字符串而不是 React 组件
4. 添加更详细的错误日志

如果需要进一步调试，请提供：
- 浏览器控制台的错误信息
- Network 面板的请求记录
- 具体的复现步骤
