# 飞书文档导入功能实现说明

## 一、功能概述

已成功实现飞书文档导入功能，允许管理员在系统设置中配置飞书应用凭证，用户可以通过文档导入界面直接从飞书导入文档。

## 二、实现内容

### 2.1 前端实现

#### 路由调整
- **移动第三方集成菜单**：从"账户"分类移至"系统"分类
  - 旧路径：`/settings/account/integrations`
  - 新路径：`/settings/integrations`
  - 仅管理员可见

#### 新增组件

1. **飞书配置页面** (`apps/client/src/pages/settings/integrations/feishu-integration.tsx`)
   - 配置 App ID 和 App Secret
   - 保存/删除配置
   - 配置说明和帮助链接

2. **飞书在线导入模态框** (`apps/client/src/features/feishu/components/feishu-online-import-modal.tsx`)
   - 输入飞书文档 URL
   - 选择是否包含子页面
   - 使用系统保存的配置

3. **飞书图标组件** (`apps/client/src/components/icons/feishu-icon.tsx`)
   - SVG 图标组件

4. **飞书服务** (`apps/client/src/features/feishu/services/feishu-service.ts`)
   - API 调用封装
   - 配置管理
   - 文档导入

#### 导入入口
在文档导入模态框中添加"飞书"按钮，位于 Markdown、HTML、Notion、Confluence 之后。

### 2.2 后端实现

#### 模块结构
```
apps/server/src/ee/feishu-import/
├── dto/
│   └── feishu-online-import.dto.ts    # DTO 定义
├── feishu-api.service.ts              # 飞书 API 封装
├── feishu-import.controller.ts        # 控制器
├── feishu-import.service.ts           # 业务逻辑
└── feishu-import.module.ts            # 模块定义
```

#### 核心功能

1. **FeishuApiService** - 飞书 API 调用
   - `getTenantAccessToken()` - 获取租户访问令牌
   - `getUserAccessToken()` - 获取用户访问令牌
   - `getDocumentContent()` - 获取文档内容
   - `getDocumentMeta()` - 获取文档元数据
   - `listFiles()` - 列出文件
   - `extractDocumentToken()` - 从 URL 提取文档 token

2. **FeishuImportService** - 导入业务逻辑
   - `importOnlinePages()` - 导入在线文档
   - `convertFeishuToTiptap()` - 内容格式转换
   - `saveUserFeishuConfig()` - 保存用户配置
   - `getUserFeishuConfig()` - 获取用户配置
   - `deleteUserFeishuConfig()` - 删除用户配置

3. **FeishuImportController** - API 端点
   - `POST /feishu/import/online` - 导入文档
   - `POST /feishu/config` - 保存配置
   - `GET /feishu/config` - 获取配置
   - `DELETE /feishu/config` - 删除配置

#### 数据存储
配置存储在 `users` 表的 `settings` 字段中：
```json
{
  "feishu": {
    "appId": "cli_xxxxxxxxxx",
    "appSecret": "xxxxxxxxxxxxxxxx"
  }
}
```

### 2.3 国际化

添加了中英文翻译：
- `apps/client/public/locales/zh-CN/translation.json`
- `apps/client/public/locales/en-US/translation.json`

包含的翻译键：
- Feishu Integration
- App ID / App Secret
- 配置说明
- 导入相关提示
- 错误消息

## 三、使用流程

### 3.1 管理员配置

1. 访问飞书开放平台 (https://open.feishu.cn)
2. 创建应用或选择现有应用
3. 获取 App ID 和 App Secret
4. 启用权限：`docs:read`, `drive:read`
5. 在 NoteDoc 系统设置 > 第三方系统集成 > 飞书集成中配置

### 3.2 用户导入

1. 在文档库中点击"导入文档"
2. 选择"飞书"
3. 输入飞书文档 URL（支持格式）：
   - `https://xxx.feishu.cn/docx/xxxxx`
   - `https://xxx.feishu.cn/docs/doccnxxxxx`
   - `https://xxx.feishu.cn/wiki/xxxxx`
4. 选择是否包含子页面
5. 点击"从飞书导入"

## 四、技术要点

### 4.1 内容转换

飞书文档内容转换为 Tiptap JSON 格式：
- 支持标题（H1-H3）
- 支持段落
- 基础 Markdown 格式识别

### 4.2 权限控制

- 第三方集成菜单仅管理员可见
- 使用 `@AuthWorkspace()` 装饰器获取工作空间上下文
- 使用 `JwtAuthGuard` 保护所有端点

### 4.3 错误处理

- URL 格式验证
- 配置检查
- API 调用错误捕获
- 用户友好的错误提示

## 五、文件清单

### 前端文件
- `apps/client/src/App.tsx` - 路由配置
- `apps/client/src/components/settings/settings-sidebar.tsx` - 侧边栏菜单
- `apps/client/src/pages/settings/integrations/third-party-integrations.tsx` - 集成页面
- `apps/client/src/pages/settings/integrations/feishu-integration.tsx` - 飞书配置
- `apps/client/src/features/feishu/components/feishu-online-import-modal.tsx` - 导入模态框
- `apps/client/src/features/feishu/services/feishu-service.ts` - API 服务
- `apps/client/src/components/icons/feishu-icon.tsx` - 图标组件
- `apps/client/src/features/page/components/page-import-modal.tsx` - 导入入口

### 后端文件
- `apps/server/src/ee/ee.module.ts` - EE 模块注册
- `apps/server/src/ee/feishu-import/feishu-import.module.ts` - 飞书模块
- `apps/server/src/ee/feishu-import/feishu-import.controller.ts` - 控制器
- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - 服务
- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - API 封装
- `apps/server/src/ee/feishu-import/dto/feishu-online-import.dto.ts` - DTO

### 翻译文件
- `apps/client/public/locales/zh-CN/translation.json`
- `apps/client/public/locales/en-US/translation.json`

## 六、后续优化建议

1. **增强内容转换**
   - 支持更多飞书富文本格式
   - 支持图片、表格、代码块等
   - 支持附件下载

2. **批量导入**
   - 支持文件夹导入
   - 支持多文档选择
   - 显示导入进度

3. **增量同步**
   - 定期自动同步
   - 检测文档更新
   - 版本对比

4. **权限映射**
   - 飞书权限映射到 NoteDoc
   - 协作者信息同步

## 七、测试建议

1. **配置测试**
   - 保存有效配置
   - 保存无效配置
   - 删除配置
   - 更新配置

2. **导入测试**
   - 导入单个文档
   - 导入包含子页面的文档
   - 导入不同格式的文档
   - 错误 URL 处理

3. **权限测试**
   - 管理员访问配置页面
   - 普通用户无法访问配置
   - 用户可以导入文档

---

**实现日期**：2025-11-25  
**实现者**：Kiro AI Assistant
