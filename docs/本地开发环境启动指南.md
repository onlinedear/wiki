# NoteDoc 本地开发环境启动指南

## 概述

本文档记录了 NoteDoc 项目在 macOS 环境下的本地开发环境启动过程和配置方法，适用于开发调试和功能测试。

## 环境要求

### 必需软件

- **Node.js**: v20.14.0 或更高版本
- **pnpm**: 10.4.0（包管理器）
- **PostgreSQL**: 16+ （数据库）
- **Redis**: 7.2+ （缓存和消息队列）

### 可选软件

- **Docker**: 用于容器化部署（生产环境推荐）

## 当前环境配置

### 已安装服务

通过 Homebrew 安装并运行的服务：

```bash
# 查看服务状态
brew services list | grep -E "postgres|redis"

# 输出示例：
# postgresql@16 started
# redis         started
```

### 环境变量配置

项目根目录的 `.env` 文件配置：

```bash
# 应用访问地址
APP_URL=http://localhost:3001
PORT=3001

# 数据库连接（PostgreSQL）
DATABASE_URL=postgresql://docmost:STRONG_DB_PASSWORD@localhost:5432/docmost?schema=public

# Redis 连接
REDIS_URL=redis://127.0.0.1:6379

# 应用密钥（至少32字符）
APP_SECRET=0123456789abcdef0123456789abcdef

# 邮件服务配置
MAIL_DRIVER=smtp
MAIL_FROM_ADDRESS=ai@mcd.ac.cn
MAIL_FROM_NAME=NoteDoc
SMTP_HOST=smtp.mxhichina.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USERNAME=ai@mcd.ac.cn
SMTP_PASSWORD=你的授权码
```

## 启动步骤

### 1. 安装依赖

由于 macOS 权限限制，使用 `npx` 来运行 pnpm：

```bash
# 安装项目依赖（如果尚未安装）
npx pnpm@10.4.0 install
```

### 2. 数据库迁移

确保数据库表结构是最新的：

```bash
# 进入 server 目录
cd apps/server

# 运行数据库迁移
npx pnpm migration:up

# 返回项目根目录
cd ../..
```

### 3. 启动开发服务器

由于 NX daemon 在某些环境下可能不稳定，建议禁用 daemon 运行：

```bash
# 禁用 NX daemon 并启动开发服务器
NX_DAEMON=false npx pnpm dev
```

这个命令会同时启动：
- **前端开发服务器**（Vite）: http://localhost:5173
- **后端 API 服务器**（NestJS）: http://localhost:3001

### 4. 验证服务状态

#### 检查后端健康状态

```bash
curl http://localhost:3001/api/health
```

预期输出：
```json
{
  "status": "ok",
  "info": {
    "database": {"status": "up"},
    "redis": {"status": "up"}
  },
  "error": {},
  "details": {
    "database": {"status": "up"},
    "redis": {"status": "up"}
  }
}
```

#### 检查前端页面

在浏览器中访问：http://localhost:5173

应该能看到 NoteDoc 的登录/注册页面。

## 常见问题和解决方案

### 问题 1: NX Daemon 连接失败

**症状**：
```
NX   Daemon process terminated and closed the connection
```

**解决方案**：
```bash
# 重置 NX 缓存
npx nx reset

# 使用禁用 daemon 的方式启动
NX_DAEMON=false npx pnpm dev
```

### 问题 2: pnpm 命令未找到

**症状**：
```
bash: pnpm: command not found
```

**解决方案**：
使用 npx 来运行 pnpm：
```bash
npx pnpm@10.4.0 <command>
```

或者尝试启用 corepack（需要 sudo 权限）：
```bash
sudo corepack enable
```

### 问题 3: 数据库连接失败

**症状**：
```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**解决方案**：
```bash
# 检查 PostgreSQL 服务状态
brew services list | grep postgres

# 如果未运行，启动服务
brew services start postgresql@16

# 验证数据库连接
psql -h localhost -p 5432 -U docmost -d docmost
```

### 问题 4: Redis 连接失败

**症状**：
```
Error: connect ECONNREFUSED 127.0.0.1:6379
```

**解决方案**：
```bash
# 检查 Redis 服务状态
brew services list | grep redis

# 如果未运行，启动服务
brew services start redis

# 验证 Redis 连接
redis-cli ping
# 应该返回: PONG
```

## 开发常用命令

### 前端开发

```bash
# 仅启动前端
npx pnpm client:dev

# 构建前端
npx pnpm client:build
```

### 后端开发

```bash
# 仅启动后端
npx pnpm server:dev

# 构建后端
npx pnpm server:build

# 启动协作服务器（Hocuspocus）
npx pnpm collab:dev
```

### 数据库操作

```bash
cd apps/server

# 创建新迁移
npx pnpm migration:create <migration_name>

# 运行迁移
npx pnpm migration:up

# 回滚迁移
npx pnpm migration:down

# 从数据库生成 TypeScript 类型
npx pnpm migration:codegen
```

### 代码质量

```bash
# 代码检查
npx pnpm lint

# 代码格式化
npx pnpm format

# 运行测试
npx pnpm test
```

## 项目结构

```
notedoc/
├── apps/
│   ├── client/          # React 前端应用 (Vite + React 18)
│   │   ├── src/
│   │   │   ├── features/    # 功能模块
│   │   │   ├── components/  # 共享组件
│   │   │   ├── pages/       # 路由页面
│   │   │   └── ee/          # 企业版功能
│   │   └── public/
│   │       └── locales/     # 国际化翻译文件
│   │
│   └── server/          # NestJS 后端应用
│       ├── src/
│       │   ├── core/        # 核心业务逻辑
│       │   ├── database/    # 数据库层
│       │   ├── integrations/# 第三方集成
│       │   ├── collaboration/# 实时协作
│       │   └── ee/          # 企业版功能
│       └── dist/            # 构建输出
│
├── packages/
│   ├── editor-ext/      # Tiptap 编辑器扩展
│   └── ee/              # 企业版许可证
│
├── docs/                # 文档
├── data/storage/        # 本地文件存储
└── .env                 # 环境变量配置
```

## 技术栈说明

### 前端技术栈

- **框架**: React 18 + TypeScript
- **构建工具**: Vite 6
- **UI 库**: Mantine 8
- **编辑器**: Tiptap 2 (基于 ProseMirror)
- **状态管理**: Jotai
- **数据获取**: TanStack Query (React Query)
- **路由**: React Router 7
- **国际化**: i18next + react-i18next
- **实时协作**: Yjs + Hocuspocus Provider

### 后端技术栈

- **框架**: NestJS 11 + TypeScript
- **HTTP 服务器**: Fastify
- **数据库**: PostgreSQL 16+ with Kysely
- **缓存**: Redis (ioredis)
- **队列**: BullMQ
- **认证**: Passport (JWT, OAuth, SAML)
- **WebSocket**: Socket.io
- **协作服务**: Hocuspocus Server (Yjs)
- **存储**: AWS SDK S3 (兼容 S3 协议)
- **邮件**: Nodemailer

## 访问地址

启动成功后，可以通过以下地址访问：

- **前端应用**: http://localhost:5173
- **后端 API**: http://localhost:3001
- **API 文档**: http://localhost:3001/api
- **健康检查**: http://localhost:3001/api/health

## 下一步

### 首次使用

1. 访问 http://localhost:5173
2. 注册管理员账号
3. 创建第一个工作空间
4. 开始创建文档库和页面

### 开发调试

- 前端代码修改会自动热重载
- 后端代码修改会自动重启服务
- 查看控制台日志了解请求和错误信息

### 企业版功能

企业版功能位于 `apps/*/src/ee/` 目录，包括：
- SSO 单点登录
- MFA 多因素认证
- API 密钥管理
- Confluence/飞书导入
- 审计日志

## 相关文档

- [完整部署指南](./NoteDoc完整部署指南.md) - 生产环境部署
- [Vercel 部署指南](./Vercel部署指南.md) - 云平台部署
- [宝塔面板部署指南](./宝塔面板部署指南.md) - 宝塔 Docker 部署
- [技术栈说明](../.kiro/steering/tech.md) - 详细技术栈
- [项目结构](../.kiro/steering/structure.md) - 代码结构说明

## 总结

本地开发环境已成功启动，包括：
- ✅ PostgreSQL 数据库连接正常
- ✅ Redis 缓存服务运行正常
- ✅ 后端 API 服务运行在 3001 端口
- ✅ 前端开发服务器运行在 5173 端口
- ✅ 所有健康检查通过

现在可以开始开发和测试 NoteDoc 的各项功能了！
