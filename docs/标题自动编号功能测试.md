# 标题自动编号功能测试文档

## 当前实现状态

根据代码审查，标题自动编号功能已经实现了以下内容：

### 1. 核心组件

#### 1.1 CustomOrderedList 扩展
- 位置：`packages/editor-ext/src/lib/ordered-list/ordered-list.ts`
- 功能：
  - 支持标题的层级编号（H1-H6）
  - 支持自定义编号起始值
  - 支持重新开始编号
  - 通过 `data-heading-level` 属性标记标题级别

#### 1.2 CustomListItem 扩展
- 位置：`packages/editor-ext/src/lib/list-item/list-item.ts`
- 功能：
  - 允许标题作为列表项内容
  - 内容模式：`paragraph block* | heading block*`
  - 支持键盘快捷键（Enter、Tab、Shift-Tab）

#### 1.3 CSS 样式实现
- 位置：`apps/client/src/features/editor/styles/ordered-list.css`
- 功能：
  - 使用 CSS Counter 实现自动编号
  - H1: `1.`, `2.`, `3.` ...
  - H2: `1.1`, `1.2`, `2.1` ...
  - H3: `1.1.1`, `1.1.2`, `1.2.1` ...
  - H4-H6: 继续嵌套编号
  - 普通段落：独立编号系统

### 2. 编号规则

#### 2.1 计数器重置
```css
.tiptap {
  counter-reset: h1-counter h2-counter h3-counter h4-counter;
}
```

#### 2.2 层级编号逻辑
- H1 标题：递增 `h1-counter`，重置 `h2-counter`
- H2 标题：递增 `h2-counter`，重置 `h3-counter`
- H3 标题：递增 `h3-counter`，重置 `h4-counter`

#### 2.3 编号显示
- 使用 `::before` 伪元素注入编号
- 编号不写入 DOM 文本节点（避免复制时携带）
- 支持自定义编号覆盖（通过 `data-custom-number` 属性）

### 3. 用户交互

#### 3.1 NumberingMenu 组件
- 位置：`apps/client/src/features/editor/components/ordered-list/numbering-menu.tsx`
- 功能：
  - 继续标题编号
  - 重新开始编号（从 1 或当前值）
  - 设置自定义编号值
- **状态：已实现但未集成到编辑器**

### 4. 符合 PRD 要求的功能

✅ **已实现**：
1. H1-H3 三级标题自动编号
2. 编号格式符合标准（1. / 1.1 / 1.1.1）
3. 使用 CSS Counter，性能优秀
4. 编号与文本分离（::before 伪元素）
5. 支持自定义编号和重新开始编号

✅ **扩展实现**（超出 PRD）：
1. 支持 H4-H6 标题（PRD 只要求 H1-H3）
2. 普通段落也有独立编号系统

✅ **已修复**：
1. 缺失父级时从 1 开始（不再显示 "0.1" 或 "0.0.1"）
   - 只有 H2 时：显示 "1.", "2.", "3." ...
   - 只有 H3 时：显示 "1.", "2.", "3." ...
   - 有 H2 但没有 H1 时的 H3：显示 "1.1", "1.2" ...

⚠️ **待完善**：
1. NumberingMenu 未集成到编辑器（点击编号时显示菜单）
2. 拖拽排序后的编号刷新机制需要验证
3. 协作场景下的编号同步需要测试

### 5. 测试场景

#### 5.1 基础编号测试
1. 创建有序列表
2. 在列表项中插入 H1 标题 → 应显示 "1."
3. 插入 H2 标题 → 应显示 "1.1"
4. 插入 H3 标题 → 应显示 "1.1.1"

#### 5.2 跨级跳跃测试
1. 创建 H1 标题
2. 直接插入 H3（跳过 H2）→ 应显示 "1.1.1"

#### 5.3 删除标题测试
1. 创建 H1、H2、H3 序列
2. 删除中间的 H2 → H3 应升级为 H2，编号变为 "1.1"

#### 5.4 缺失父级测试（PRD 核心要求）
1. 只创建 H2 标题（没有 H1）→ 应显示 "1.", "2.", "3." ...
2. 只创建 H3 标题（没有 H1 和 H2）→ 应显示 "1.", "2.", "3." ...
3. 创建 H2 和 H3（没有 H1）→ H2 显示 "1.", H3 显示 "1.1"
4. 创建 H1 和 H3（没有 H2）→ H1 显示 "1.", H3 显示 "1.1"

#### 5.5 拖拽排序测试
1. 创建多个标题
2. 拖拽调整顺序 → 编号应实时更新

### 6. 下一步工作

#### 6.1 集成 NumberingMenu（可选）
如果需要用户手动控制编号：
1. 监听编号点击事件
2. 显示 NumberingMenu 弹窗
3. 应用用户选择的编号设置

#### 6.2 文档和帮助
1. 在帮助中心添加使用说明
2. 添加工具提示（hover 编号时显示说明）

#### 6.3 性能测试
1. 测试 500+ 标题的文档
2. 验证编号刷新耗时 < 100ms

## 结论

标题自动编号的核心功能已经完整实现，符合 PRD 的主要需求。CSS Counter 方案确保了高性能和浏览器原生支持。当前实现已经可以在编辑器中使用，用户只需：

1. 创建有序列表（点击工具栏的编号列表按钮）
2. 在列表项中插入标题（使用 / 命令或快捷键）
3. 编号会自动显示

如果需要更高级的编号控制（自定义起始值、重新开始编号），可以进一步集成 NumberingMenu 组件。
