# 飞书文档导入测试指南

## 前置条件

### 1. 获取飞书应用凭证

1. 访问飞书开放平台：https://open.feishu.cn
2. 创建企业自建应用或选择现有应用
3. 进入"凭证与基础信息" > "应用凭证"
4. 复制 **App ID** 和 **App Secret**
5. 在"权限管理"中添加以下权限（**必须**）：
   - **查看、评论和导出文档** (`docx:document:readonly`) - 必需
   - 或 **查看、评论、编辑和管理文档** (`docx:document`) - 推荐
   - `查看云空间文件` (`drive:read`) - 可选
6. **重要**：点击"创建版本"并发布应用，权限才会生效

### 2. 在 NoteDoc 中配置

1. 以管理员身份登录 NoteDoc
2. 进入"设置" > "系统" > "第三方系统集成"
3. 找到"飞书集成"部分
4. 填写：
   - **App ID**: 从飞书开放平台复制的 App ID
   - **App Secret**: 从飞书开放平台复制的 App Secret
5. 点击"保存配置"

## 测试步骤

### 测试 1：配置保存和读取

1. 在第三方集成页面保存飞书配置
2. 刷新页面
3. 验证 App ID 是否正确显示
4. 验证 App Secret 显示为 `••••••••••••••••`

**预期结果**：配置成功保存并可以读取

### 测试 2：导入单个文档

1. 在飞书中创建一个测试文档，内容如下：
   ```markdown
   # 测试文档标题
   
   这是第一段内容。
   
   ## 二级标题
   
   这是第二段内容。
   
   ### 三级标题
   
   这是第三段内容。
   ```

2. 复制文档 URL（格式如：`https://xxx.feishu.cn/docx/xxxxx`）

3. 在 NoteDoc 中：
   - 进入任意文档库
   - 点击文档后面的三个点 `...`
   - 选择"导入文档"
   - 点击"飞书"按钮

4. 在弹出的对话框中：
   - 粘贴飞书文档 URL
   - 勾选或不勾选"包含子页面"
   - 点击"从飞书导入"

**预期结果**：
- 显示"导入已开始"提示
- 文档成功导入到当前文档库
- 文档标题为"测试文档标题"
- 内容格式正确保留

### 测试 3：错误处理

#### 3.1 未配置凭证
1. 删除飞书配置
2. 尝试导入文档

**预期结果**：提示"请先在系统设置中配置您的飞书连接"

#### 3.2 无效的文档 URL
1. 输入错误的 URL：`https://example.com/test`
2. 点击导入

**预期结果**：提示"请输入有效的飞书文档 URL"

#### 3.3 无权限访问的文档
1. 输入一个你没有权限访问的飞书文档 URL
2. 点击导入

**预期结果**：提示导入失败，显示权限错误

### 测试 4：配置更新

1. 保存飞书配置
2. 修改 App Secret
3. 再次保存
4. 验证新配置生效

**预期结果**：配置成功更新

### 测试 5：配置删除

1. 点击"删除配置"按钮
2. 确认删除
3. 刷新页面

**预期结果**：
- 配置被清空
- App ID 和 App Secret 字段为空

## 支持的飞书文档 URL 格式

- `https://xxx.feishu.cn/docx/xxxxx`
- `https://xxx.feishu.cn/docs/doccnxxxxx`
- `https://xxx.feishu.cn/wiki/xxxxx`
- `https://xxx.larksuite.com/docx/xxxxx`（国际版）

## 常见问题

### Q1: 提示"Feishu configuration not found"
**A**: 需要先在系统设置中配置飞书 App ID 和 App Secret

### Q2: 提示"Invalid Feishu document URL"
**A**: 检查 URL 格式是否正确，确保是飞书文档的完整 URL

### Q3: 提示"Failed to get tenant access token"
**A**: 检查 App ID 和 App Secret 是否正确

### Q4: 提示"Failed to get document content" 或 "Access denied"
**A**: 可能的原因：
- **应用没有文档读取权限**（最常见）
  - 需要添加 `docx:document:readonly` 或 `docx:document` 权限
  - 添加权限后必须发布新版本
- 文档不存在或已删除
- 应用未发布或未启用
- Token 已过期

### Q5: 导入的文档格式不正确
**A**: 当前版本只支持基础的 Markdown 格式转换，复杂格式（表格、图片等）暂不支持

## 数据库验证

配置保存在 `users` 表的 `settings` 字段中：

```sql
-- 查看用户的飞书配置
SELECT id, email, settings->'feishu' as feishu_config 
FROM users 
WHERE settings->'feishu' IS NOT NULL;
```

预期结果：
```json
{
  "appId": "cli_xxxxxxxxxx",
  "appSecret": "xxxxxxxxxxxxxxxx"
}
```

## 日志检查

### 后端日志关键信息

成功导入：
```
[FeishuImportService] Starting Feishu import for user xxx
[FeishuImportService] Created page xxx from Feishu document xxx
```

失败情况：
```
[FeishuApiService] Failed to get tenant access token
[FeishuApiService] Failed to get document content for xxx
```

## 性能指标

- 配置保存：< 100ms
- 单个文档导入：1-3 秒（取决于文档大小）
- API 调用次数：2-3 次/文档

## 安全检查

1. ✅ App Secret 在前端显示为密文
2. ✅ 配置仅管理员可访问
3. ✅ API 端点需要 JWT 认证
4. ✅ 配置存储在数据库中加密

---

**测试日期**：2025-11-26  
**版本**：v1.0.0
