# é£ä¹¦æ–‡æ¡£å›¾ç‰‡å¯¼å…¥é—®é¢˜æ’æŸ¥

## ğŸ”§ æœ€æ–°ä¿®å¤ (2024-11-26)

### ä¿®å¤ 1: å¢å¼ºå›¾ç‰‡ä¸‹è½½ API

**é—®é¢˜ï¼š** é£ä¹¦å›¾ç‰‡ API è°ƒç”¨æ–¹å¼ä¸å®Œæ•´ï¼Œåªå°è¯•äº†ä¸¤ç§æ–¹æ³•ã€‚

**ä¿®å¤ï¼š** æ·»åŠ äº†ä¸‰ç§ API è°ƒç”¨æ–¹å¼ï¼Œæé«˜æˆåŠŸç‡ï¼š

```typescript
// Method 1: æ–‡æ¡£å—ä¸­çš„ image_key
GET /drive/v1/medias/{imageToken}/download

// Method 2: file_token æ–¹å¼
GET /drive/v1/files/{imageToken}/download

// Method 3: æ‰¹é‡è·å–ï¼ˆæ–°å¢ï¼‰
GET /drive/v1/medias/batch_get_tmp_download_url?file_tokens={imageToken}
```

### ä¿®å¤ 2: é™„ä»¶è®°å½•ç¼ºå°‘ spaceId

**é—®é¢˜ï¼š** åˆ›å»ºé™„ä»¶è®°å½•æ—¶ç¼ºå°‘ `spaceId` å­—æ®µï¼Œå¯¼è‡´é™„ä»¶æŸ¥è¯¢å¤±è´¥ï¼ˆ404ï¼‰ã€‚

**ä¿®å¤ï¼š**
1. åœ¨ `convertFeishuBlocksToTiptap` ä¸­ä¼ é€’ `spaceId` å‚æ•°
2. åœ¨ `downloadAndUploadImage` ä¸­æ·»åŠ  `spaceId` å‚æ•°
3. åˆ›å»ºé™„ä»¶è®°å½•æ—¶åŒ…å« `spaceId` å­—æ®µ

```typescript
// âœ… ä¿®å¤å
await this.attachmentRepo.insertAttachment({
  id: attachmentId,
  fileName,
  fileExt,
  filePath,
  fileSize: imageBuffer.length,
  mimeType: 'image/png',
  type: AttachmentType.File,
  pageId,
  spaceId,      // â† æ–°å¢
  workspaceId,
  creatorId: userId,
});
```

### ä¿®å¤ 3: å›¾ç‰‡ URL è·¯å¾„é”™è¯¯

**é—®é¢˜ï¼š** ç”Ÿæˆçš„å›¾ç‰‡ src æ˜¯ `/api/files/...`ï¼Œå¯¼è‡´å‰ç«¯ URL å¤„ç†é”™è¯¯ã€‚

**ä¿®å¤ï¼š** ä½¿ç”¨ `/files/...` è·¯å¾„ï¼ˆä¸å¸¦ `/api` å‰ç¼€ï¼‰ï¼Œè®©å‰ç«¯çš„ `getFileUrl` å‡½æ•°æ­£ç¡®å¤„ç†ï¼š

```typescript
// âœ… ä¿®å¤å
const imageSrc = `/files/${result.attachmentId}/${result.fileName}`;
```

### ä¿®å¤ 4: æ”¹è¿›æ—¥å¿—è¾“å‡º

- âœ“ æˆåŠŸæ—¶æ˜¾ç¤ºç»¿è‰²æ ‡è®°å’Œæ–‡ä»¶å¤§å°
- âŒ å¤±è´¥æ—¶æ˜¾ç¤ºçº¢è‰²æ ‡è®°
- ğŸ“¥ ğŸ“¤ â¬‡ï¸ ä½¿ç”¨ emoji æ ‡è®°ä¸åŒé˜¶æ®µ
- æ˜¾ç¤ºå®Œæ•´çš„è®¿é—® URL è·¯å¾„

### æµ‹è¯•æ–¹æ³•

é‡æ–°å¯¼å…¥åŒ…å«å›¾ç‰‡çš„é£ä¹¦æ–‡æ¡£ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹å›¾ç‰‡å¯¼å…¥å®Œæ•´æµç¨‹
tail -f logs/app.log | grep -E "Processing image|Getting image|Method [123]|Downloaded|uploaded|imported"
```

é¢„æœŸçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
ğŸ“¥ Processing image with token: IMxxxxxxxx
Getting image URL for token: IMxxxxxxxx
Method 1 (medias) response code: 0, msg: success
âœ“ Got image URL via medias API: https://open.feishu.cn/...
â¬‡ï¸ Downloading image from URL: https://...
âœ“ Downloaded image: 245.67 KB
ğŸ“¤ Image uploaded to storage: workspace-xxx/files/...
âœ… Image imported successfully: uuid-xxx (245.67 KB)
   File path: workspace-xxx/files/uuid-xxx/uuid-xxx.png
   Access URL: /files/uuid-xxx/uuid-xxx.png
```

---

## å¸¸è§é—®é¢˜

### 1. å›¾ç‰‡ä¸æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºä¸ºé”™è¯¯çš„ srcï¼‰

**ç—‡çŠ¶ï¼š**
- å›¾ç‰‡ `src` æ˜¾ç¤ºä¸ºç±»ä¼¼ `Qpkybs0jAoNe7Vx1ocAcaQBjneg` çš„å­—ç¬¦ä¸²
- å›¾ç‰‡æ— æ³•åŠ è½½

**åŸå› ï¼š**
- `src` è·¯å¾„æ ¼å¼ä¸æ­£ç¡®
- ç¼ºå°‘ `fileName` å‚æ•°

**è§£å†³æ–¹æ¡ˆï¼š**
ç¡®ä¿ç”Ÿæˆçš„å›¾ç‰‡èŠ‚ç‚¹ `src` æ ¼å¼ä¸ºï¼š`/api/files/{attachmentId}/{fileName}`

```typescript
// âœ… æ­£ç¡®
src: `/api/files/${result.attachmentId}/${result.fileName}`

// âŒ é”™è¯¯
src: `/api/files/${attachmentId}`
```

**åç«¯è·¯ç”±è¦æ±‚ï¼š**
```typescript
@Get('/files/:fileId/:fileName')
```

### 2. å›¾ç‰‡ä¸‹è½½å¤±è´¥

**ç—‡çŠ¶ï¼š**
- æ—¥å¿—æ˜¾ç¤º "Failed to download image"
- æ–‡æ¡£ä¸­æ˜¾ç¤º "ğŸ–¼ï¸ [å›¾ç‰‡å¯¼å…¥å¤±è´¥]"

**å¯èƒ½åŸå› ï¼š**

1. **é£ä¹¦æƒé™ä¸è¶³**
   - æ£€æŸ¥æ˜¯å¦é…ç½®äº† `drive:file:readonly` æƒé™
   - éªŒè¯ App ID å’Œ App Secret æ˜¯å¦æ­£ç¡®

2. **ç½‘ç»œé—®é¢˜**
   - æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦èƒ½è®¿é—®é£ä¹¦ API
   - æŸ¥çœ‹æ˜¯å¦æœ‰é˜²ç«å¢™é™åˆ¶

3. **å›¾ç‰‡ token æ— æ•ˆ**
   - å›¾ç‰‡å¯èƒ½å·²è¢«åˆ é™¤
   - token å¯èƒ½å·²è¿‡æœŸ

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
grep "Failed to download" logs/app.log

# 2. æµ‹è¯•é£ä¹¦ API è¿æ¥
curl -H "Authorization: Bearer {token}" \
  https://open.feishu.cn/open-apis/drive/v1/medias/{imageToken}/download

# 3. æ£€æŸ¥æƒé™é…ç½®
# åœ¨é£ä¹¦å¼€æ”¾å¹³å°æŸ¥çœ‹åº”ç”¨æƒé™
```

### 3. å›¾ç‰‡ä¸Šä¼ åˆ°å­˜å‚¨å¤±è´¥

**ç—‡çŠ¶ï¼š**
- å›¾ç‰‡ä¸‹è½½æˆåŠŸä½†ä¸Šä¼ å¤±è´¥
- æ—¥å¿—æ˜¾ç¤ºå­˜å‚¨ç›¸å…³é”™è¯¯

**å¯èƒ½åŸå› ï¼š**

1. **å­˜å‚¨æœåŠ¡é…ç½®é”™è¯¯**
   - S3 é…ç½®ä¸æ­£ç¡®
   - æœ¬åœ°å­˜å‚¨è·¯å¾„æƒé™é—®é¢˜

2. **å­˜å‚¨ç©ºé—´ä¸è¶³**
   - ç£ç›˜ç©ºé—´å·²æ»¡
   - S3 é…é¢å·²ç”¨å®Œ

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥å­˜å‚¨é…ç½®
cat .env | grep STORAGE

# 2. æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
df -h

# 3. æµ‹è¯•å­˜å‚¨æœåŠ¡
# å°è¯•æ‰‹åŠ¨ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
```

### 4. é™„ä»¶è®°å½•åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶ï¼š**
- å›¾ç‰‡æ–‡ä»¶å·²ä¸Šä¼ ä½†æ•°æ®åº“æ— è®°å½•
- å›¾ç‰‡æ— æ³•åœ¨å‰ç«¯æ˜¾ç¤º

**å¯èƒ½åŸå› ï¼š**
- æ•°æ®åº“è¿æ¥é—®é¢˜
- å­—æ®µéªŒè¯å¤±è´¥
- äº‹åŠ¡å›æ»š

**æ’æŸ¥æ­¥éª¤ï¼š**

```sql
-- æ£€æŸ¥é™„ä»¶è¡¨
SELECT * FROM attachments 
WHERE pageId = '{pageId}' 
ORDER BY createdAt DESC;

-- æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„æ–‡ä»¶
SELECT filePath FROM attachments 
WHERE pageId IS NULL;
```

### 5. å‰ç«¯å›¾ç‰‡è·¯å¾„è§£æé”™è¯¯

**ç—‡çŠ¶ï¼š**
- åç«¯ç”Ÿæˆçš„è·¯å¾„æ­£ç¡®
- å‰ç«¯æ˜¾ç¤ºçš„ URL ä¸æ­£ç¡®

**æ£€æŸ¥ç‚¹ï¼š**

1. **getFileUrl å‡½æ•°**
```typescript
// apps/client/src/lib/config.ts
export function getFileUrl(src: string) {
  if (!src) return src;
  if (src.startsWith("http")) return src;
  if (src.startsWith("/api/")) {
    // Remove the '/api' prefix
    return getBackendUrl() + src.substring(4);
  }
  if (src.startsWith("/files/")) {
    return getBackendUrl() + src;
  }
  return src;
}
```

2. **å›¾ç‰‡ç»„ä»¶**
```typescript
// apps/client/src/features/editor/components/image/image-view.tsx
<Image src={getFileUrl(src)} />
```

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `feishu-import.service.ts` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```typescript
this.logger.debug(`Image token: ${block.image.token}`);
this.logger.debug(`Download result: ${JSON.stringify(result)}`);
this.logger.debug(`Generated src: ${src}`);
```

### 2. æ£€æŸ¥ç”Ÿæˆçš„ Tiptap JSON

åœ¨å¯¼å…¥å®Œæˆåï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„æ–‡æ¡£å†…å®¹ï¼š

```typescript
this.logger.debug(`Tiptap content: ${JSON.stringify(tiptapContent, null, 2)}`);
```

### 3. éªŒè¯é™„ä»¶è®°å½•

```sql
-- æŸ¥çœ‹æœ€è¿‘åˆ›å»ºçš„é™„ä»¶
SELECT 
  id, 
  fileName, 
  filePath, 
  fileSize, 
  pageId,
  createdAt 
FROM attachments 
ORDER BY createdAt DESC 
LIMIT 10;
```

### 4. æ£€æŸ¥å­˜å‚¨æ–‡ä»¶

```bash
# æœ¬åœ°å­˜å‚¨
ls -lh data/storage/{workspaceId}/files/

# S3 å­˜å‚¨
aws s3 ls s3://{bucket}/{workspaceId}/files/ --recursive
```

## æ€§èƒ½ä¼˜åŒ–

### å›¾ç‰‡ä¸‹è½½æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

1. **å¹¶è¡Œä¸‹è½½**
```typescript
// æ”¶é›†æ‰€æœ‰å›¾ç‰‡ token
const imageTokens = blocks.items
  .filter(b => b.block_type === 27 && b.image)
  .map(b => b.image.token);

// å¹¶è¡Œä¸‹è½½
const results = await Promise.all(
  imageTokens.map(token => 
    this.downloadAndUploadImage(client, token, pageId, workspaceId, userId)
  )
);
```

2. **å¢åŠ è¶…æ—¶æ—¶é—´**
```typescript
const response = await axios.get(url, {
  responseType: 'arraybuffer',
  timeout: 30000, // 30 ç§’
});
```

3. **æ·»åŠ é‡è¯•æœºåˆ¶**
```typescript
async downloadWithRetry(url: string, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await axios.get(url);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

## æµ‹è¯•æ¸…å•

- [ ] å•å¼ å›¾ç‰‡å¯¼å…¥æ­£å¸¸
- [ ] å¤šå¼ å›¾ç‰‡å¯¼å…¥æ­£å¸¸
- [ ] å¤§å›¾ç‰‡ï¼ˆ5MB+ï¼‰å¯¼å…¥æ­£å¸¸
- [ ] å›¾ç‰‡ src æ ¼å¼æ­£ç¡®ï¼š`/api/files/{id}/{name}`
- [ ] é™„ä»¶è®°å½•æ­£ç¡®åˆ›å»º
- [ ] å­˜å‚¨æ–‡ä»¶æ­£ç¡®ä¿å­˜
- [ ] å‰ç«¯å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- [ ] å›¾ç‰‡å¯ä»¥ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
- [ ] å¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

## è§†é¢‘å¯¼å…¥

è§†é¢‘å¯¼å…¥ä½¿ç”¨ç›¸åŒçš„æœºåˆ¶ï¼Œä½†æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š

- **å—ç±»å‹**: `block_type: 33`
- **æ–‡ä»¶å¤§å°é™åˆ¶**: 200MBï¼ˆå›¾ç‰‡ä¸º 50MBï¼‰
- **ä¸‹è½½è¶…æ—¶**: 2 åˆ†é’Ÿï¼ˆå›¾ç‰‡ä¸º 30 ç§’ï¼‰
- **é»˜è®¤æ ¼å¼**: mp4
- **èŠ‚ç‚¹ç±»å‹**: `video`

è¯¦è§ï¼š[é£ä¹¦æ–‡æ¡£è§†é¢‘å¯¼å…¥åŠŸèƒ½è¯´æ˜.md](./é£ä¹¦æ–‡æ¡£è§†é¢‘å¯¼å…¥åŠŸèƒ½è¯´æ˜.md)

## ç›¸å…³æ–‡ä»¶

- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - å¯¼å…¥æœåŠ¡
- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - API æœåŠ¡
- `apps/server/src/core/attachment/attachment.controller.ts` - æ–‡ä»¶è·¯ç”±
- `apps/client/src/lib/config.ts` - URL å¤„ç†
- `apps/client/src/features/editor/components/image/image-view.tsx` - å›¾ç‰‡ç»„ä»¶
- `apps/client/src/features/editor/components/video/video-view.tsx` - è§†é¢‘ç»„ä»¶
