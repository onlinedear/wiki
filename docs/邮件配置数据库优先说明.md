# 邮件配置数据库优先功能说明

## 概述

邮件服务现在支持从数据库动态读取配置，优先级为：**数据库配置 > 环境变量配置**

## 功能特点

### 1. 配置优先级

- **优先使用数据库配置**：如果在"设置 → 系统 → 邮件服务"中配置了 SMTP 设置，系统会优先使用这些配置
- **回退到环境变量**：如果数据库中没有配置或配置不完整，系统会自动使用 `.env` 文件中的环境变量配置

### 2. 支持的邮件场景

所有邮件发送场景都支持数据库配置优先：

- ✅ 用户邀请邮件
- ✅ 邀请接受通知邮件
- ✅ 密码重置邮件
- ✅ 密码修改通知邮件
- ✅ 测试邮件

### 3. 配置方式

#### 方式 1：通过 Web 界面配置（推荐）

1. 登录系统
2. 进入"设置 → 系统 → 邮件服务"
3. 填写 SMTP 配置：
   - SMTP 主机
   - SMTP 端口
   - 使用 SSL/TLS
   - SMTP 用户名
   - SMTP 密码（授权码）
   - 发件人邮箱
   - 发件人名称
4. 点击"保存设置"
5. 点击"发送测试邮件"验证配置

#### 方式 2：通过环境变量配置（备用）

在 `.env` 文件中配置：

```env
MAIL_DRIVER=smtp
MAIL_FROM_ADDRESS=noreply@example.com
MAIL_FROM_NAME=NoteDoc
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USERNAME=your-username
SMTP_PASSWORD=your-password
```

## 技术实现

### 核心改动

1. **MailService 增强**
   - 添加 `getMailConfig()` 方法，优先从数据库读取配置
   - 修改 `sendEmail()` 方法，支持动态配置
   - 修改 `sendToQueue()` 方法，传递 workspaceId

2. **队列处理器更新**
   - EmailProcessor 支持接收 workspaceId
   - 发送邮件时使用对应 workspace 的配置

3. **服务层更新**
   - WorkspaceInvitationService：邀请邮件传递 workspaceId
   - AuthService：密码相关邮件传递 workspaceId

### 配置读取逻辑

```typescript
// 伪代码
async getMailConfig(workspaceId) {
  if (workspaceId) {
    // 尝试从数据库读取
    const dbConfig = await getFromDatabase(workspaceId);
    if (dbConfig.isComplete) {
      return dbConfig; // 使用数据库配置
    }
  }
  
  // 回退到环境变量
  return getFromEnvironment();
}
```

## 使用建议

### 单租户部署

- 推荐使用 Web 界面配置，方便管理和修改
- 环境变量作为备用配置

### 多租户部署

- 每个 workspace 可以配置独立的邮件服务
- 支持不同租户使用不同的邮件服务商

## 调试

### 查看配置来源

在后端日志中查找：

```
[MailService] Using mail config from database for workspace xxx
```

或

```
[MailService] Using mail config from environment variables
```

### 测试邮件发送

1. 在 Web 界面点击"发送测试邮件"
2. 或使用脚本测试：

```bash
./scripts/test-mail-with-db-config.sh
```

## 常见问题

### Q: 修改数据库配置后需要重启服务吗？

A: 不需要。配置是动态读取的，修改后立即生效。

### Q: 如果数据库和环境变量都配置了，使用哪个？

A: 优先使用数据库配置。只有当数据库配置不存在或不完整时，才会使用环境变量。

### Q: 如何判断配置是否完整？

A: 数据库配置必须包含 `smtpHost` 和 `smtpPort` 才被认为是有效配置。

### Q: 邮件发送失败怎么办？

A: 
1. 检查后端日志，确认使用的配置来源
2. 验证 SMTP 配置是否正确
3. 确认是否使用授权码而非邮箱密码
4. 检查网络连接和防火墙设置

## 相关文件

- `apps/server/src/integrations/mail/mail.service.ts` - 邮件服务核心逻辑
- `apps/server/src/integrations/mail/processors/email.processor.ts` - 邮件队列处理器
- `apps/server/src/core/workspace/services/workspace-invitation.service.ts` - 邀请邮件
- `apps/server/src/core/auth/services/auth.service.ts` - 认证相关邮件
- `apps/server/src/database/repos/workspace/workspace.repo.ts` - 配置存储

## 更新日志

- 2024-11-23: 实现数据库配置优先功能
- 支持所有邮件场景使用数据库配置
- 保持向后兼容，环境变量配置仍然有效
