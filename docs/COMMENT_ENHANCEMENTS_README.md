# è¯„è®ºåŠŸèƒ½å¢å¼ºæ–‡æ¡£

## ğŸ“‹ æ–°å¢åŠŸèƒ½æ¦‚è§ˆ

æœ¬æ¬¡æ›´æ–°ä¸º Docmost çš„è¯„è®ºç³»ç»Ÿæ·»åŠ äº†ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼š

### 1. è¯„è®ºæœç´¢å’Œè¿‡æ»¤ âœ…
- æŒ‰å…³é”®è¯æœç´¢è¯„è®ºå†…å®¹
- æŒ‰è¯„è®ºçŠ¶æ€è¿‡æ»¤ï¼ˆå·²è§£å†³/æœªè§£å†³ï¼‰
- æŒ‰åˆ›å»ºè€…è¿‡æ»¤
- å®æ—¶æœç´¢ç»“æœ

### 2. è¯„è®ºååº”ç³»ç»Ÿ âœ…
- 6 ç§ååº”ç±»å‹ï¼šğŸ‘ èµã€â¤ï¸ å–œæ¬¢ã€ğŸ˜„ å¤§ç¬‘ã€ğŸ˜® æƒŠè®¶ã€ğŸ˜¢ éš¾è¿‡ã€ğŸ˜  ç”Ÿæ°”
- æ¯ä¸ªç”¨æˆ·æ¯æ¡è¯„è®ºåªèƒ½æ·»åŠ ä¸€ä¸ªååº”
- å®æ—¶æ˜¾ç¤ºååº”æ•°é‡
- ç‚¹å‡»åˆ‡æ¢ååº”çŠ¶æ€

### 3. @æåŠåŠŸèƒ½ âœ…
- åœ¨è¯„è®ºä¸­ @æåŠå…¶ä»–ç”¨æˆ·
- æ ¼å¼ï¼š`@[userId](userName)`
- è¢«æåŠç”¨æˆ·ä¼šæ”¶åˆ°é€šçŸ¥
- è‡ªåŠ¨æå–å’Œå¤„ç†æåŠ

### 4. è¯„è®ºé€šçŸ¥ç³»ç»Ÿ âœ…
- ä¸‰ç§é€šçŸ¥ç±»å‹ï¼š
  - å›å¤é€šçŸ¥ï¼šæœ‰äººå›å¤ä½ çš„è¯„è®º
  - æåŠé€šçŸ¥ï¼šæœ‰äººåœ¨è¯„è®ºä¸­æåˆ°ä½ 
  - ååº”é€šçŸ¥ï¼šæœ‰äººå¯¹ä½ çš„è¯„è®ºåšå‡ºååº”
- æœªè¯»é€šçŸ¥è®¡æ•°å¾½ç« 
- é€šçŸ¥ä¸­å¿ƒå¼¹çª—
- æ ‡è®°ä¸ºå·²è¯»åŠŸèƒ½
- ä¸€é”®å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»
- ç‚¹å‡»é€šçŸ¥è·³è½¬åˆ°ç›¸å…³è¯„è®º

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### æ–°å¢è¡¨

#### comment_reactions
```sql
- id (UUID, ä¸»é”®)
- comment_id (UUID, å¤–é”® -> comments.id)
- user_id (UUID, å¤–é”® -> users.id)
- reaction_type (VARCHAR, ååº”ç±»å‹)
- created_at (TIMESTAMP)
- UNIQUE(comment_id, user_id, reaction_type)
```

#### comment_mentions
```sql
- id (UUID, ä¸»é”®)
- comment_id (UUID, å¤–é”® -> comments.id)
- mentioned_user_id (UUID, å¤–é”® -> users.id)
- created_at (TIMESTAMP)
```

#### comment_notifications
```sql
- id (UUID, ä¸»é”®)
- user_id (UUID, å¤–é”® -> users.id)
- comment_id (UUID, å¤–é”® -> comments.id)
- type (VARCHAR, é€šçŸ¥ç±»å‹: reply/mention/reaction)
- is_read (BOOLEAN, é»˜è®¤ false)
- created_at (TIMESTAMP)
- read_at (TIMESTAMP, å¯é€‰)
```

### ç´¢å¼•
- `idx_comment_reactions_comment_id`
- `idx_comment_mentions_comment_id`
- `idx_comment_mentions_user_id`
- `idx_comment_notifications_user_id`
- `idx_comment_notifications_is_read`

## ğŸ”§ åç«¯ API

### æœç´¢è¯„è®º
```
POST /api/comments/search
Body: {
  pageId?: string,
  searchText?: string,
  creatorId?: string,
  resolved?: boolean,
  page?: number,
  limit?: number
}
```

### ååº”ç®¡ç†
```
POST /api/comments/reactions/add
Body: { commentId: string, reactionType: string }

POST /api/comments/reactions/remove
Body: { commentId: string, reactionType: string }

POST /api/comments/reactions
Body: { commentId: string }
```

### é€šçŸ¥ç®¡ç†
```
GET /api/comments/notifications
Query: { unreadOnly?: boolean }

GET /api/comments/notifications/unread-count

POST /api/comments/notifications/mark-read
Body: { notificationId: string }

POST /api/comments/notifications/mark-all-read
```

## ğŸ¨ å‰ç«¯ç»„ä»¶

### æ–°å¢ç»„ä»¶

1. **CommentSearch** - è¯„è®ºæœç´¢ç»„ä»¶
   - ä½ç½®ï¼š`apps/client/src/features/comment/components/comment-search.tsx`
   - åŠŸèƒ½ï¼šæœç´¢æ¡†ã€çŠ¶æ€è¿‡æ»¤ã€æ¸…é™¤æŒ‰é’®

2. **CommentReactions** - è¯„è®ºååº”ç»„ä»¶
   - ä½ç½®ï¼š`apps/client/src/features/comment/components/comment-reactions.tsx`
   - åŠŸèƒ½ï¼šæ˜¾ç¤ºå’Œç®¡ç†è¯„è®ºååº”

3. **CommentNotifications** - é€šçŸ¥ä¸­å¿ƒç»„ä»¶
   - ä½ç½®ï¼š`apps/client/src/features/comment/components/comment-notifications.tsx`
   - åŠŸèƒ½ï¼šé€šçŸ¥åˆ—è¡¨ã€æœªè¯»è®¡æ•°ã€æ ‡è®°å·²è¯»

### æ›´æ–°çš„ç»„ä»¶

1. **CommentListItem** - æ·»åŠ äº†ååº”æ˜¾ç¤º
2. **comment-service.ts** - æ·»åŠ äº†æ–°çš„ API è°ƒç”¨
3. **comment-query.ts** - æ·»åŠ äº†æ–°çš„ React Query hooks

## ğŸ“¦ å®‰è£…æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
./scripts/run-comment-enhancements-migration.sh
```

æˆ–æ‰‹åŠ¨è¿è¡Œï¼š

```bash
cd apps/server
npm run migration:run
```

### 2. é‡å¯æœåŠ¡å™¨

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm run build
npm start
```

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

åˆ·æ–°æµè§ˆå™¨ä»¥åŠ è½½æ–°çš„å‰ç«¯ä»£ç ã€‚

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•è¯„è®ºæœç´¢
1. æ‰“å¼€ä»»æ„é¡µé¢çš„è¯„è®ºé¢æ¿
2. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯
3. é€‰æ‹©çŠ¶æ€è¿‡æ»¤å™¨ï¼ˆå·²è§£å†³/æœªè§£å†³ï¼‰
4. ç‚¹å‡»"æœç´¢"æŒ‰é’®
5. éªŒè¯æœç´¢ç»“æœæ˜¯å¦æ­£ç¡®

### æµ‹è¯•è¯„è®ºååº”
1. æ‰¾åˆ°ä»»æ„è¯„è®º
2. ç‚¹å‡»ååº”å›¾æ ‡ï¼ˆğŸ‘ â¤ï¸ ğŸ˜„ ç­‰ï¼‰
3. éªŒè¯ååº”è®¡æ•°å¢åŠ 
4. å†æ¬¡ç‚¹å‡»åŒä¸€ååº”
5. éªŒè¯ååº”è¢«ç§»é™¤

### æµ‹è¯• @æåŠ
1. åˆ›å»ºæ–°è¯„è®º
2. è¾“å…¥ `@` ç¬¦å·ï¼ˆå¦‚æœæœ‰è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ï¼‰
3. é€‰æ‹©è¦æåŠçš„ç”¨æˆ·
4. å‘é€è¯„è®º
5. éªŒè¯è¢«æåŠç”¨æˆ·æ”¶åˆ°é€šçŸ¥

### æµ‹è¯•é€šçŸ¥ç³»ç»Ÿ
1. ç‚¹å‡»é¡¶éƒ¨å¯¼èˆªæ çš„é€šçŸ¥å›¾æ ‡ï¼ˆé“ƒé“›ï¼‰
2. æŸ¥çœ‹æœªè¯»é€šçŸ¥è®¡æ•°
3. ç‚¹å‡»é€šçŸ¥é¡¹
4. éªŒè¯è·³è½¬åˆ°ç›¸å…³è¯„è®º
5. éªŒè¯é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»
6. æµ‹è¯•"å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»"åŠŸèƒ½

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. å›¢é˜Ÿåä½œ
- ä½¿ç”¨ @æåŠåŠŸèƒ½é€šçŸ¥ç‰¹å®šå›¢é˜Ÿæˆå‘˜
- ä½¿ç”¨ååº”å¿«é€Ÿè¡¨è¾¾å¯¹è¯„è®ºçš„æ€åº¦
- é€šè¿‡é€šçŸ¥åŠæ—¶äº†è§£è¯„è®ºåŠ¨æ€

### 2. æ–‡æ¡£å®¡é˜…
- æœç´¢ç‰¹å®šä¸»é¢˜çš„è¯„è®º
- è¿‡æ»¤å·²è§£å†³/æœªè§£å†³çš„è¯„è®º
- è¿½è¸ªè¯„è®ºå¤„ç†è¿›åº¦

### 3. çŸ¥è¯†ç®¡ç†
- æœç´¢å†å²è®¨è®º
- æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„è¯„è®º
- æ•´ç†å’Œå½’æ¡£è¯„è®º

## ğŸ”’ æƒé™æ§åˆ¶

- **æ·»åŠ ååº”**ï¼šéœ€è¦é¡µé¢è¯»å–æƒé™
- **åˆ›å»ºè¯„è®º**ï¼šéœ€è¦é¡µé¢ç®¡ç†æƒé™
- **æ¥æ”¶é€šçŸ¥**ï¼šè‡ªåŠ¨ï¼Œæ— éœ€ç‰¹æ®Šæƒé™
- **æœç´¢è¯„è®º**ï¼šéœ€è¦å·¥ä½œç©ºé—´æˆå‘˜èº«ä»½

## ğŸŒ å›½é™…åŒ–

æ‰€æœ‰æ–°åŠŸèƒ½éƒ½å·²æ·»åŠ ä¸­æ–‡ç¿»è¯‘ï¼š
- æœç´¢ç›¸å…³ï¼šæœç´¢è¯„è®ºã€çŠ¶æ€ã€æœç´¢ã€æ¸…é™¤
- ååº”ç±»å‹ï¼šèµã€å–œæ¬¢ã€å¤§ç¬‘ã€æƒŠè®¶ã€éš¾è¿‡ã€ç”Ÿæ°”
- é€šçŸ¥ç›¸å…³ï¼šé€šçŸ¥ã€æœªè¯»ã€å…¨éƒ¨ã€æ ‡è®°ä¸ºå·²è¯»ç­‰

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- React Query ç¼“å­˜å‡å°‘ API è°ƒç”¨
- é€šçŸ¥æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°
- åˆ†é¡µåŠ è½½è¯„è®ºå’Œé€šçŸ¥

## ğŸ› å·²çŸ¥é—®é¢˜

ç›®å‰æ²¡æœ‰å·²çŸ¥é—®é¢˜ã€‚å¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·æŠ¥å‘Šã€‚

## ğŸš€ æœªæ¥æ”¹è¿›

- [ ] @æåŠçš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
- [ ] æ›´å¤šååº”ç±»å‹
- [ ] è¯„è®ºå¯¼å‡ºåŠŸèƒ½
- [ ] è¯„è®ºç»Ÿè®¡å’Œåˆ†æ
- [ ] é‚®ä»¶é€šçŸ¥é›†æˆ
- [ ] è¯„è®ºæ¨¡æ¿

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-11-18)
- âœ… æ·»åŠ è¯„è®ºæœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
- âœ… æ·»åŠ è¯„è®ºååº”ç³»ç»Ÿ
- âœ… æ·»åŠ  @æåŠåŠŸèƒ½
- âœ… æ·»åŠ è¯„è®ºé€šçŸ¥ç³»ç»Ÿ
- âœ… å®Œæ•´çš„ä¸­æ–‡ç¿»è¯‘
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… å®Œæ•´çš„æµ‹è¯•æ–‡æ¡£

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

## ğŸ“„ è®¸å¯è¯

ä¸ Docmost ä¸»é¡¹ç›®ç›¸åŒçš„è®¸å¯è¯ã€‚
