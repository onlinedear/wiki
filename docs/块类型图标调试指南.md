# 块类型图标调试指南

## 问题描述

编辑器中的拖拽手柄无法准确显示每个块的图标，特别是自定义节点视图（如甘特图、Excalidraw、Callout 等）。

## 调试步骤

### 1. 启用调试日志

已在 `apps/client/src/features/editor/extensions/custom-drag-handle.ts` 中添加详细的调试日志。

当你将鼠标悬停在编辑器的不同块上时，浏览器控制台会输出以下信息：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 DOM 元素信息:
  - 标签名: DIV
  - data-type: gantt
  - data-node-type: null
  - class: gantt-container
  - 文本内容: ...
📍 位置信息:
  - pos: 123
  - depth: 2
  - parent type: doc
  - depth 2: paragraph (isBlock: true)
  - depth 1: doc (isBlock: false)
  ✓ 选择块级节点: paragraph
🎯 最终节点类型: paragraph
🎨 渲染图标...
✅ 渲染成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2. 分析日志输出

请在编辑器中测试以下块类型，并将控制台日志贴给我：

1. **标准块**：
   - 段落 (paragraph)
   - 标题 (heading)
   - 列表项 (listItem)
   - 代码块 (codeBlock)
   - 引用 (blockquote)

2. **自定义节点**：
   - 甘特图 (gantt)
   - Excalidraw (excalidraw)
   - Callout (callout)
   - 数学公式块 (mathBlock)
   - 附件 (attachment)
   - 嵌入 (embed)

### 3. 关键信息

从日志中我们需要关注：

- **DOM 元素信息**：
  - `data-type` 属性是否正确设置
  - 标签名和 class 是否符合预期
  
- **位置信息**：
  - ProseMirror 节点类型是否正确
  - 是否正确识别为块级节点
  
- **最终节点类型**：
  - 传递给图标渲染函数的节点类型是否正确

## 问题根源分析

### 当前实现的问题

1. **自定义节点视图的 DOM 结构**：
   - 自定义节点（如 gantt）使用 React 组件渲染
   - React 组件的根元素可能不是 ProseMirror 节点的直接 DOM 表示
   - `data-type` 属性在 `renderHTML` 中设置，但可能被 React 组件覆盖

2. **节点类型识别逻辑**：
   - 当前代码优先使用 ProseMirror 节点类型
   - 只有当节点类型是 `paragraph` 时才会使用 DOM 的 `data-type` 覆盖
   - 这导致很多自定义节点被识别为 `paragraph`

### 为什么会出现这个问题

```typescript
// 当前逻辑
if (targetNode && nodeType && targetNode.type.name === 'paragraph') {
    // 只有 paragraph 才会被覆盖
    targetNode = { ...targetNode, type: { ...targetNode.type, name: nodeType } };
}
```

这个逻辑假设：
- 自定义节点的 ProseMirror 类型名称与 DOM `data-type` 一致
- 但实际上，很多自定义节点在 ProseMirror 中被包装在其他节点中

## 解决方案

### 方案 1：优先使用 DOM 属性（推荐）

修改节点类型识别逻辑，优先使用 DOM 的 `data-type` 属性：

```typescript
// 优先使用 DOM data-type
if (nodeType) {
    console.log('  🔄 使用 DOM data-type:', nodeType);
    targetNode = { ...targetNode, type: { ...targetNode.type, name: nodeType } };
} else if (targetNode) {
    console.log('  ℹ️ 使用 ProseMirror 节点类型:', targetNode.type.name);
}
```

### 方案 2：为 React 节点视图添加 data-node-type

在所有 React 节点视图组件的根元素上添加 `data-node-type` 属性：

```tsx
// 例如：gantt-view.tsx
<div 
  className={styles.ganttContainer}
  data-node-type="gantt"  // 添加这个
  contentEditable={false}
>
  {/* ... */}
</div>
```

然后在拖拽手柄中同时检查两个属性：

```typescript
let nodeType = nodeDOM.getAttribute?.('data-type') || 
               nodeDOM.getAttribute?.('data-node-type');
```

### 方案 3：改进节点查找逻辑

在查找 ProseMirror 节点时，向上遍历 DOM 树查找带有 `data-type` 的父元素：

```typescript
let domElement = nodeDOM;
while (domElement && !nodeType) {
    nodeType = domElement.getAttribute?.('data-type');
    if (!nodeType && domElement.parentElement?.matches?.('.ProseMirror')) {
        break;
    }
    domElement = domElement.parentElement;
}
```

## 测试清单

完成修改后，请测试以下场景：

- [ ] 段落显示正确的图标
- [ ] 各级标题显示正确的图标
- [ ] 有序列表项显示正确的图标
- [ ] 无序列表项显示正确的图标
- [ ] 任务列表项显示正确的图标
- [ ] 代码块显示正确的图标
- [ ] 引用块显示正确的图标
- [ ] 表格显示正确的图标
- [ ] 甘特图显示正确的图标
- [ ] Excalidraw 显示正确的图标
- [ ] Callout 显示正确的图标
- [ ] 数学公式块显示正确的图标
- [ ] 附件显示正确的图标
- [ ] 嵌入内容显示正确的图标

## 下一步

1. 启动开发服务器
2. 打开浏览器控制台
3. 在编辑器中移动鼠标到不同的块上
4. 复制控制台的完整日志
5. 将日志贴给我分析

这样我就能看到：
- 哪些块的图标显示正确
- 哪些块的图标显示错误
- DOM 属性和 ProseMirror 节点类型的对应关系
- 从而确定最佳的修复方案
