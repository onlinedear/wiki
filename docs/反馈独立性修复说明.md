# è¯„è®ºåé¦ˆç‹¬ç«‹æ€§ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç‚¹å‡» ğŸ‘ ä¼šç‚¹äº®ï¼Œä½†ç‚¹å‡» â¤ï¸ æ—¶ï¼ŒğŸ‘ ä¼šå–æ¶ˆï¼ˆå˜æš—ï¼‰ã€‚ä¸åŒçš„åé¦ˆå›¾æ ‡åº”è¯¥æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œç”¨æˆ·åº”è¯¥å¯ä»¥åŒæ—¶ç‚¹å¤šä¸ªåé¦ˆã€‚

## é—®é¢˜åŸå› 

ä¹‹å‰çš„ä»£ç ä¸­ï¼Œåœ¨ `handleReaction` å‡½æ•°é‡Œæ·»åŠ äº†ä¸€ä¸ªå…¨å±€çš„é˜²æŠ–æ£€æŸ¥ï¼š

```typescript
if (addReactionMutation.isPending || removeReactionMutation.isPending) {
  return;
}
```

è¿™ä¸ªæ£€æŸ¥ä¼šåœ¨**ä»»ä½•ä¸€ä¸ª** mutation æ‰§è¡Œæ—¶é˜»æ­¢**æ‰€æœ‰**åé¦ˆçš„ç‚¹å‡»ï¼Œå¯¼è‡´ä¸åŒåé¦ˆç±»å‹äº’ç›¸å¹²æ‰°ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ç§»é™¤å…¨å±€é˜²æŠ–æ£€æŸ¥

**æ–‡ä»¶**: `apps/client/src/features/comment/components/comment-reactions.tsx`

ç§»é™¤äº†æœ‰é—®é¢˜çš„å…¨å±€ pending æ£€æŸ¥ï¼Œè®©æ¯ä¸ªåé¦ˆç±»å‹å¯ä»¥ç‹¬ç«‹æ“ä½œã€‚

### 2. ä¼˜åŒ– Mutation é…ç½®

**æ–‡ä»¶**: `apps/client/src/features/comment/queries/comment-query.ts`

ä¸º `useAddReactionMutation` å’Œ `useRemoveReactionMutation` æ·»åŠ äº†ï¼š

- **onMutate**: åœ¨ mutation æ‰§è¡Œå‰å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢ï¼Œé¿å…ç«æ€æ¡ä»¶
- **onError**: å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€
- **onSettled**: æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½é‡æ–°è·å–æœ€æ–°æ•°æ®ç¡®ä¿ä¸€è‡´æ€§

è¿™æ ·å¯ä»¥ï¼š
- é˜²æ­¢åŒä¸€ä¸ªåé¦ˆçš„å¿«é€Ÿé‡å¤ç‚¹å‡»å¯¼è‡´çš„é—®é¢˜
- ä¸åŒåé¦ˆç±»å‹ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
- æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€å›æ»š

## ä¿®å¤åçš„è¡Œä¸º

### é¢„æœŸè¡Œä¸º

âœ… **ç‹¬ç«‹æ“ä½œ**ï¼š
- ç‚¹å‡» ğŸ‘ â†’ ğŸ‘ ç‚¹äº®
- ç‚¹å‡» â¤ï¸ â†’ â¤ï¸ ç‚¹äº®ï¼ŒğŸ‘ ä¿æŒç‚¹äº®çŠ¶æ€
- ç‚¹å‡» ğŸ˜„ â†’ ğŸ˜„ ç‚¹äº®ï¼ŒğŸ‘ å’Œ â¤ï¸ éƒ½ä¿æŒç‚¹äº®çŠ¶æ€
- ç”¨æˆ·å¯ä»¥åŒæ—¶ç‚¹äº®å¤šä¸ªåé¦ˆ

âœ… **ç‹¬ç«‹å–æ¶ˆ**ï¼š
- å†æ¬¡ç‚¹å‡» ğŸ‘ â†’ åªæœ‰ ğŸ‘ å˜æš—ï¼Œå…¶ä»–åé¦ˆä¸å—å½±å“
- å†æ¬¡ç‚¹å‡» â¤ï¸ â†’ åªæœ‰ â¤ï¸ å˜æš—ï¼Œå…¶ä»–åé¦ˆä¸å—å½±å“

âœ… **è®¡æ•°ç‹¬ç«‹**ï¼š
- æ¯ä¸ªåé¦ˆç±»å‹æœ‰è‡ªå·±çš„è®¡æ•°
- ä¸åŒç”¨æˆ·çš„åé¦ˆä¼šç´¯åŠ åˆ°å¯¹åº”çš„è®¡æ•°ä¸­

## æµ‹è¯•æ­¥éª¤

1. **æ‰“å¼€æµ‹è¯•é¡µé¢**ï¼š
   http://localhost:5173/s/store/p/1117-bMgW0emznk

2. **æµ‹è¯•å¤šä¸ªåé¦ˆåŒæ—¶ç‚¹äº®**ï¼š
   - ç‚¹å‡» ğŸ‘ â†’ éªŒè¯ç‚¹äº®
   - ç‚¹å‡» â¤ï¸ â†’ éªŒè¯ç‚¹äº®ï¼ŒåŒæ—¶ ğŸ‘ ä»ç„¶æ˜¯ç‚¹äº®çŠ¶æ€
   - ç‚¹å‡» ğŸ˜„ â†’ éªŒè¯ç‚¹äº®ï¼ŒåŒæ—¶ ğŸ‘ å’Œ â¤ï¸ ä»ç„¶æ˜¯ç‚¹äº®çŠ¶æ€

3. **æµ‹è¯•ç‹¬ç«‹å–æ¶ˆ**ï¼š
   - å†æ¬¡ç‚¹å‡» â¤ï¸ â†’ éªŒè¯åªæœ‰ â¤ï¸ å˜æš—ï¼ŒğŸ‘ å’Œ ğŸ˜„ ä¿æŒç‚¹äº®
   - å†æ¬¡ç‚¹å‡» ğŸ‘ â†’ éªŒè¯åªæœ‰ ğŸ‘ å˜æš—ï¼ŒğŸ˜„ ä¿æŒç‚¹äº®
   - å†æ¬¡ç‚¹å‡» ğŸ˜„ â†’ éªŒè¯ ğŸ˜„ å˜æš—

4. **æµ‹è¯•å¿«é€Ÿç‚¹å‡»**ï¼š
   - å¿«é€Ÿå¤šæ¬¡ç‚¹å‡»åŒä¸€ä¸ªåé¦ˆå›¾æ ‡
   - éªŒè¯çŠ¶æ€åˆ‡æ¢æ­£å¸¸ï¼Œä¸ä¼šå‡ºç°é”™è¯¯æˆ–å¡ä½

5. **æµ‹è¯•å¤šç”¨æˆ·åœºæ™¯**ï¼š
   - ç”¨å¦ä¸€ä¸ªè´¦å·ç™»å½•
   - å¯¹åŒä¸€æ¡è¯„è®ºæ·»åŠ åé¦ˆ
   - éªŒè¯ä¸¤ä¸ªç”¨æˆ·çš„åé¦ˆç‹¬ç«‹æ˜¾ç¤ºï¼Œè®¡æ•°æ­£ç¡®ç´¯åŠ 

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è®¾è®¡

è¡¨ï¼š`comment_reactions`

å”¯ä¸€çº¦æŸï¼š`(comment_id, user_id, reaction_type)`

è¿™ä¸ªçº¦æŸç¡®ä¿ï¼š
- åŒä¸€ä¸ªç”¨æˆ·å¯¹åŒä¸€æ¡è¯„è®ºçš„åŒä¸€ç§åé¦ˆç±»å‹åªèƒ½æœ‰ä¸€æ¡è®°å½•
- ä½†åŒä¸€ä¸ªç”¨æˆ·å¯ä»¥å¯¹åŒä¸€æ¡è¯„è®ºæ·»åŠ å¤šç§ä¸åŒç±»å‹çš„åé¦ˆ

### å‰ç«¯çŠ¶æ€ç®¡ç†

```typescript
// ç”¨æˆ·çš„æ‰€æœ‰åé¦ˆç±»å‹
const userReactions = reactions
  .filter((r) => r.userId === currentUser?.user?.id)
  .map((r) => r.reactionType);
// ç»“æœå¯èƒ½æ˜¯ï¼š['like', 'love', 'laugh']

// æ£€æŸ¥æŸä¸ªåé¦ˆæ˜¯å¦å·²æ¿€æ´»
const isActive = userReactions.includes(type);
```

### Mutation ä¼˜åŒ–

ä½¿ç”¨ React Query çš„ä¹è§‚æ›´æ–°æ¨¡å¼ï¼š

1. **onMutate**: ç«‹å³å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢ï¼Œä¿å­˜å½“å‰çŠ¶æ€å¿«ç…§
2. **mutationFn**: æ‰§è¡Œå®é™…çš„ API è¯·æ±‚
3. **onError**: å¦‚æœå¤±è´¥ï¼Œæ¢å¤åˆ°å¿«ç…§çŠ¶æ€
4. **onSettled**: æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡æ–°è·å–æœ€æ–°æ•°æ®

è¿™æ ·å¯ä»¥æä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

## ç›¸å…³æ–‡ä»¶

- `apps/client/src/features/comment/components/comment-reactions.tsx` - åé¦ˆç»„ä»¶
- `apps/client/src/features/comment/queries/comment-query.ts` - Mutation é…ç½®
- `apps/server/src/database/repos/comment/comment-reaction.repo.ts` - æ•°æ®åº“æ“ä½œ
- `apps/server/src/database/migrations/20251118T100000-enhance-comments.ts` - æ•°æ®åº“è¡¨ç»“æ„

## éªŒè¯

ä»£ç å·²ç»é€šè¿‡ Vite çƒ­æ›´æ–°è‡ªåŠ¨åº”ç”¨ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ã€‚

ç°åœ¨å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ï¼Œæ‰€æœ‰åé¦ˆå›¾æ ‡åº”è¯¥æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œäº’ä¸å¹²æ‰°ã€‚
