# 飞书批量导入方案

## 问题回顾

由于飞书 Wiki API 不可用，无法自动获取文档树结构。但参考 PandaWiki 的实现，我们可以采用**用户手动选择 + 批量导入**的方式。

## 解决方案

### 方案 A：多 URL 批量导入（推荐实现）

#### 用户操作流程

1. 在飞书中复制要导入的文档 URL：
   ```
   https://xxx.feishu.cn/docx/Sq3wwQjgxiPsmDkMTp9ccQZ1nxh  (Chat 聊天 - 父文档)
   https://xxx.feishu.cn/docx/Abc123xxxxx                  (模型选择 - 子文档)
   https://xxx.feishu.cn/docx/Def456xxxxx                  (Autopilot - 子文档)
   ```

2. 在 NoteDoc 导入界面粘贴这些 URL（每行一个）

3. 选择导入选项：
   - ☑ 第一个文档为父文档
   - ☑ 其他文档作为子文档

4. 点击"批量导入"

#### 后端处理逻辑

```typescript
async importBatchDocuments(params: {
  workspaceId: string;
  spaceId: string;
  userId: string;
  documentUrls: string[];  // 多个文档 URL
  firstAsParent: boolean;  // 第一个是否为父文档
  appId: string;
  appSecret: string;
}) {
  const urls = params.documentUrls;
  let parentPageId: string | null = null;
  
  // 导入第一个文档（可能是父文档）
  const firstPage = await this.importSingleDocument(
    client,
    extractToken(urls[0]),
    null,  // 没有父页面
    spaceId,
    workspaceId,
    userId,
  );
  
  if (params.firstAsParent) {
    parentPageId = firstPage.id;
  }
  
  // 导入其他文档
  for (let i = 1; i < urls.length; i++) {
    await this.importSingleDocument(
      client,
      extractToken(urls[i]),
      parentPageId,  // 设置父页面
      spaceId,
      workspaceId,
      userId,
    );
  }
}
```

#### 前端 UI 改进

在 `feishu-online-import-modal.tsx` 中添加：

```typescript
const [documentUrls, setDocumentUrls] = useState('');
const [firstAsParent, setFirstAsParent] = useState(true);

// 文本框
<Textarea
  label="文档 URL（每行一个）"
  placeholder="https://xxx.feishu.cn/docx/xxxxx"
  value={documentUrls}
  onChange={(e) => setDocumentUrls(e.target.value)}
  rows={5}
/>

// 选项
<Checkbox
  label="第一个文档为父文档，其他作为子文档"
  checked={firstAsParent}
  onChange={(e) => setFirstAsParent(e.currentTarget.checked)}
/>
```

### 方案 B：前端文档选择器（未来实现）

#### 用户操作流程

1. 输入飞书知识库 URL 或空间 ID
2. 系统获取该空间下的所有文档（平铺列表）
3. 显示树形选择器，用户勾选要导入的文档
4. 系统按层级关系批量导入

#### 技术实现

需要前端直接调用飞书 API：

```typescript
// 前端获取文档列表
async function getFeishuDocuments(spaceId: string, accessToken: string) {
  // 调用飞书 API 获取文档列表
  const response = await fetch(
    `https://open.feishu.cn/open-apis/drive/v1/files?folder_token=${spaceId}`,
    {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    }
  );
  
  return response.json();
}
```

然后使用类似 PandaWiki 的树形选择器。

## 实现优先级

### 第一阶段：方案 A（立即可用）

**优点**：
- 实现简单，只需修改前端 UI 和后端接口
- 不依赖飞书 API 的树形结构
- 用户可以精确控制导入哪些文档

**实现步骤**：
1. 修改前端导入对话框，支持多行 URL 输入
2. 添加"第一个为父文档"选项
3. 修改后端接口，支持批量导入
4. 测试验证

**预计时间**：1-2 小时

### 第二阶段：方案 B（未来优化）

**优点**：
- 用户体验更好
- 可视化选择文档
- 自动保持层级关系

**实现步骤**：
1. 前端实现飞书 API 调用
2. 实现树形文档选择器
3. 实现文档层级关系解析
4. 批量导入逻辑

**预计时间**：4-8 小时

## 对比 PandaWiki

### 相似点

- 都采用用户手动选择的方式
- 都支持批量导入
- 都维护文档的父子关系

### 差异点

| 特性 | PandaWiki | NoteDoc 方案 A | NoteDoc 方案 B |
|------|-----------|----------------|----------------|
| 文档选择 | 树形选择器 | 多行 URL 输入 | 树形选择器 |
| 获取文档列表 | 前端调用 API | 用户手动输入 | 前端调用 API |
| 层级关系 | 自动识别 | 用户指定 | 自动识别 |
| 实现复杂度 | 高 | 低 | 高 |
| 用户体验 | 好 | 中 | 好 |

## 推荐方案

**立即实现方案 A**，原因：

1. **快速可用** - 1-2 小时即可完成
2. **解决核心问题** - 用户可以导入多个文档并建立父子关系
3. **不依赖 API** - 绕过飞书 API 限制
4. **用户可接受** - 对于少量文档（< 10 个），手动输入 URL 是可接受的

未来如果需要，可以再实现方案 B 作为增强。

## 示例

### 用户操作示例

```
文档 URL（每行一个）：
https://xxx.feishu.cn/docx/Sq3wwQjgxiPsmDkMTp9ccQZ1nxh
https://xxx.feishu.cn/docx/Abc123xxxxx
https://xxx.feishu.cn/docx/Def456xxxxx

☑ 第一个文档为父文档，其他作为子文档

[批量导入]
```

### 导入结果

```
📄 Chat 聊天 (已导入)
  📄 模型选择 (已导入)
  📄 Autopilot (已导入)
```

---

**创建时间**：2025-11-26  
**推荐方案**：方案 A - 多 URL 批量导入  
**预计实现时间**：1-2 小时
