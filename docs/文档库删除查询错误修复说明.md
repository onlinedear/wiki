# 文档库删除后查询错误修复说明

## 问题描述

删除文档库后，浏览器控制台出现以下错误：

1. **401 Unauthorized** - `POST /api/users/me` 请求失败
2. **404 Not Found** - `POST /api/pages/recent` 请求失败（两次）

虽然删除操作成功，但这些错误会影响用户体验。

## 根本原因

### 1. 查询缓存管理不当

删除文档库后，使用 `invalidateQueries` 会触发所有匹配查询的重新获取，包括：
- 文档库列表查询
- 最近更改查询
- 其他相关查询

在导航到首页的过程中，这些查询的重新获取可能会与页面卸载/挂载冲突，导致 401 错误。

### 2. 查询键不一致

代码中混用了 `recent-changes` 和 `recent-pages` 查询键，导致缓存清理不完整。

## 修复方案

### 1. 统一查询键命名

**文件**: `apps/client/src/features/space/queries/space-query.ts`

确保所有地方都使用 `recent-changes` 作为查询键：

```typescript
// prefetchSpace 函数
queryClient.prefetchQuery({
  queryKey: ["recent-changes", spaceId],
  queryFn: () => getRecentChanges(spaceId),
});

// useDeleteSpaceMutation
queryClient.removeQueries({
  queryKey: ["recent-changes", variables.id],
  exact: true,
});
```

### 2. 使用 removeQueries 替代 invalidateQueries

**文件**: `apps/client/src/features/space/queries/space-query.ts`

```typescript
// 修改前：会触发重新获取
queryClient.invalidateQueries({
  predicate: (item) => ["spaces"].includes(item.queryKey[0] as string),
});

// 修改后：只移除缓存，不触发重新获取
queryClient.removeQueries({
  predicate: (query) => {
    const key = query.queryKey[0];
    return key === "spaces";
  },
});
```

### 3. 优化删除流程

**文件**: `apps/client/src/features/space/components/delete-space-modal.tsx`

在导航前先关闭模态框，避免 UI 更新冲突：

```typescript
const handleDelete = async () => {
  // ... 验证逻辑 ...
  
  try {
    // 先关闭模态框
    close();
    
    // 执行删除
    await deleteSpaceMutation.mutateAsync({ id: space.id, slug: space.slug });
    
    // 导航到首页
    navigate(APP_ROUTE.HOME);
  } catch (error) {
    console.error("Failed to delete space", error);
  }
};
```

## 修改文件清单

- ✅ `apps/client/src/features/space/queries/space-query.ts`
  - 统一使用 `recent-changes` 查询键
  - 使用 `removeQueries` 替代 `invalidateQueries`
  
- ✅ `apps/client/src/features/space/components/delete-space-modal.tsx`
  - 在删除前关闭模态框

## 测试验证

### 测试步骤

1. 登录系统
2. 创建一个测试文档库
3. 打开浏览器开发者工具的控制台
4. 删除该文档库
5. 观察控制台是否有 401 或 404 错误

### 预期结果

- ✅ 删除成功提示显示
- ✅ 自动导航到首页
- ✅ 控制台无 401 错误
- ✅ 控制台无 404 错误
- ✅ 文档库列表正确更新

## 技术说明

### invalidateQueries vs removeQueries

- **invalidateQueries**: 标记查询为过期并触发重新获取（如果查询正在被使用）
- **removeQueries**: 直接从缓存中移除查询，不触发重新获取

在删除操作后导航的场景中，使用 `removeQueries` 更合适，因为：
1. 避免在导航过程中触发不必要的网络请求
2. 防止组件卸载/挂载期间的竞态条件
3. 新页面会自动获取所需数据

### 查询键命名规范

建议在项目中统一查询键的命名：
- 使用描述性名称（如 `recent-changes` 而不是 `recent-pages`）
- 保持一致性，避免混用不同名称指向同一数据
- 在类型定义中明确查询键结构

## 相关文档

- [TanStack Query - Query Invalidation](https://tanstack.com/query/latest/docs/react/guides/query-invalidation)
- [TanStack Query - Query Removal](https://tanstack.com/query/latest/docs/react/guides/query-cancellation)
