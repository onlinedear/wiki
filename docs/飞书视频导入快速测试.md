# é£ä¹¦è§†é¢‘å¯¼å…¥å¿«é€Ÿæµ‹è¯•æŒ‡å—

## æµ‹è¯•å‡†å¤‡

### 1. å‡†å¤‡æµ‹è¯•æ–‡æ¡£

åœ¨é£ä¹¦ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡æ¡£ï¼š
1. åˆ›å»ºæ–°æ–‡æ¡£
2. æ’å…¥ä¸€ä¸ªå°è§†é¢‘ï¼ˆå»ºè®® < 10MBï¼‰
3. å¤åˆ¶æ–‡æ¡£ URL

### 2. è·å–é£ä¹¦é…ç½®

- App ID: `cli_xxxxx`
- App Secret: `xxxxx`

## å¿«é€Ÿæµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šé‡å¯æœåŠ¡å™¨ï¼ˆåº”ç”¨æ–°çš„æ—¥å¿—ä»£ç ï¼‰

```bash
# åœæ­¢æœåŠ¡å™¨
pnpm server:dev  # Ctrl+C

# é‡æ–°å¯åŠ¨
pnpm server:dev
```

### æ­¥éª¤ 2ï¼šå¯¼å…¥æµ‹è¯•æ–‡æ¡£

1. è®¿é—® NoteDoc è®¾ç½®é¡µé¢
2. è¿›å…¥"ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ" â†’ "é£ä¹¦"
3. é…ç½® App ID å’Œ App Secret
4. ç‚¹å‡»"åœ¨çº¿å¯¼å…¥"
5. ç²˜è´´æµ‹è¯•æ–‡æ¡£ URL
6. ç‚¹å‡»å¯¼å…¥

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹æ—¥å¿—

åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰è§†é¢‘ç›¸å…³æ—¥å¿—
tail -f logs/app.log | grep -E "ğŸ¬|Video|video|VMxxxxxxxx"

# æˆ–è€…æŸ¥çœ‹å®Œæ•´æ—¥å¿—
tail -f logs/app.log
```

## æœŸæœ›çš„æ—¥å¿—è¾“å‡º

### æˆåŠŸåœºæ™¯

```
[FeishuImportService] Video container block found with 1 children
[FeishuImportService] Video child block type: XX, keys: block_id, block_type, parent_id, file, ...
[FeishuImportService] Found video file token in child: VMxxxxxxxx
[FeishuImportService] ğŸ“¥ Processing video with token: VMxxxxxxxx
[FeishuApiService] ğŸ¬ Getting video URL for token: VMxxxxxxxx
[FeishuApiService] Trying Method 1: /drive/v1/medias/VMxxxxxxxx/download
[FeishuApiService] Method 1 (medias) response code: 0, msg: success
[FeishuApiService] âœ“ Got video URL via medias API: https://...
[FeishuApiService] â¬‡ï¸ Downloading video from URL: https://...
[FeishuApiService] âœ“ Downloaded video: 15.67 MB
[FeishuImportService] ğŸ“¤ Video uploaded to storage: workspace-xxx/files/...
[FeishuImportService] âœ… Video imported successfully: uuid-xxx (15.67 MB)
```

### å¤±è´¥åœºæ™¯ï¼ˆæƒé™é—®é¢˜ï¼‰

```
[FeishuApiService] ğŸ¬ Getting video URL for token: VMxxxxxxxx
[FeishuApiService] Trying Method 1: /drive/v1/medias/VMxxxxxxxx/download
[FeishuApiService] Method 1 (medias) response code: 99991672, msg: Access denied
[FeishuApiService] Method 1 failed: code=99991672, msg=Access denied
[FeishuApiService] Trying Method 2: /drive/v1/files/VMxxxxxxxx/download
[FeishuApiService] Method 2 (files) response code: 99991672, msg: Access denied
[FeishuApiService] âŒ All methods failed to get video URL for token: VMxxxxxxxx
[FeishuApiService] Please check:
[FeishuApiService]   1. Feishu app permissions (drive:drive:readonly or drive:drive)
[FeishuApiService]   2. Video token format: VMxxxxxxxx
```

### å¤±è´¥åœºæ™¯ï¼ˆToken é—®é¢˜ï¼‰

```
[FeishuApiService] ğŸ¬ Getting video URL for token: VMxxxxxxxx
[FeishuApiService] Trying Method 1: /drive/v1/medias/VMxxxxxxxx/download
[FeishuApiService] Method 1 exception: Request failed with status code 404
[FeishuApiService] Method 1 error response: status=404, data={"code":404,"msg":"Not Found"}
```

## ä½¿ç”¨æµ‹è¯•è„šæœ¬

å¦‚æœå¯¼å…¥å¤±è´¥ï¼Œä½¿ç”¨æµ‹è¯•è„šæœ¬å•ç‹¬æµ‹è¯• APIï¼š

```bash
# 1. ä»æ—¥å¿—ä¸­è·å– video token
grep "Found video file token" logs/app.log

# è¾“å‡ºç¤ºä¾‹ï¼š
# Found video file token in child: VMxxxxxxxx

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
./scripts/test-feishu-video-api.sh cli_xxxxx your_app_secret VMxxxxxxxx
```

æµ‹è¯•è„šæœ¬ä¼šï¼š
1. è·å– tenant_access_token
2. æµ‹è¯• 4 ç§ä¸åŒçš„ API ç«¯ç‚¹
3. å°è¯•ä¸‹è½½è§†é¢‘
4. æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šæ²¡æœ‰æ‰¾åˆ°è§†é¢‘å—

**æ—¥å¿—**ï¼š
```
âŒ Video block (type 33) has no processable children
```

**åŸå› **ï¼šblocks API æ²¡æœ‰è¿”å›è§†é¢‘çš„å­å—æ•°æ®

**è§£å†³**ï¼š
1. æ£€æŸ¥æ–‡æ¡£æ˜¯å¦æ˜¯æ–°ç‰ˆæ–‡æ¡£ï¼ˆURL åŒ…å« `/docx/`ï¼‰
2. ç¡®è®¤è§†é¢‘å·²æ­£ç¡®æ’å…¥åˆ°æ–‡æ¡£ä¸­
3. æŸ¥çœ‹å®Œæ•´çš„ blocks API å“åº”

### é—®é¢˜ 2ï¼šæƒé™ä¸è¶³

**æ—¥å¿—**ï¼š
```
Method 1 failed: code=99991672, msg=Access denied
```

**è§£å†³**ï¼š
1. è®¿é—®é£ä¹¦å¼€æ”¾å¹³å°ï¼š`https://open.feishu.cn/app/ä½ çš„AppID/auth`
2. ç¡®è®¤å·²å¼€é€šæƒé™ï¼š
   - âœ… `docx:document:readonly` - æŸ¥çœ‹æ–‡æ¡£
   - âœ… `drive:drive:readonly` - æŸ¥çœ‹äº‘ç©ºé—´æ–‡ä»¶
   - âš ï¸ å¯èƒ½è¿˜éœ€è¦ `drive:drive` - äº‘ç©ºé—´å®Œæ•´æƒé™
3. æƒé™ä¿®æ”¹åç­‰å¾… 5-10 åˆ†é’Ÿ
4. é‡æ–°æµ‹è¯•

### é—®é¢˜ 3ï¼šToken æ ¼å¼é”™è¯¯

**æ—¥å¿—**ï¼š
```
Method 1 error response: status=404, data={"code":404,"msg":"Not Found"}
```

**è§£å†³**ï¼š
1. æ£€æŸ¥ token æ ¼å¼ï¼ˆåº”è¯¥ç±»ä¼¼ `VMxxxxxxxx`ï¼‰
2. ç¡®è®¤ token æ¥æºå­—æ®µï¼š
   ```bash
   # æŸ¥çœ‹å­å—çš„å®Œæ•´ç»“æ„
   grep -A 10 "Video child block" logs/app.log
   ```
3. å¯èƒ½éœ€è¦ä»ä¸åŒå­—æ®µè·å– tokenï¼š
   - `childBlock.file.token`
   - `childBlock.media.token`
   - `childBlock.video.token`

### é—®é¢˜ 4ï¼šè§†é¢‘å¤ªå¤§

**æ—¥å¿—**ï¼š
```
âŒ Failed to download video for token VMxxxxxxxx
Download response status: undefined (timeout)
```

**è§£å†³**ï¼š
1. æµ‹è¯•æ›´å°çš„è§†é¢‘ï¼ˆ< 10MBï¼‰
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆå½“å‰ 2 åˆ†é’Ÿï¼‰

## ä¸‹ä¸€æ­¥è°ƒè¯•

æ ¹æ®æ—¥å¿—è¾“å‡ºï¼š

### å¦‚æœçœ‹åˆ° "Access denied"
â†’ é…ç½®é£ä¹¦åº”ç”¨æƒé™ï¼Œå‚è€ƒ `docs/é£ä¹¦æƒé™é…ç½®è¯¦ç»†æ­¥éª¤.md`

### å¦‚æœçœ‹åˆ° "404 Not Found"
â†’ Token æ ¼å¼é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ blocks API è¿”å›çš„æ•°æ®ç»“æ„

### å¦‚æœçœ‹åˆ° "no processable children"
â†’ è§†é¢‘å—ç»“æ„é—®é¢˜ï¼Œéœ€è¦æŸ¥çœ‹å®Œæ•´çš„ blocks æ•°æ®

### å¦‚æœæ‰€æœ‰ API éƒ½å¤±è´¥
â†’ ä½¿ç”¨æµ‹è¯•è„šæœ¬å•ç‹¬æµ‹è¯•ï¼Œæˆ–æŸ¥é˜…é£ä¹¦ API æ–‡æ¡£

## è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼š

1. **æ”¶é›†ä¿¡æ¯**ï¼š
   ```bash
   # å¯¼å‡ºç›¸å…³æ—¥å¿—
   grep -E "Video|video|ğŸ¬" logs/app.log > video_debug.log
   ```

2. **æ£€æŸ¥é£ä¹¦æ–‡æ¡£**ï¼š
   - API æ–‡æ¡£ï¼šhttps://open.feishu.cn/document/server-docs/docs/drive-v1/media/introduction
   - æƒé™è¯´æ˜ï¼šhttps://open.feishu.cn/document/home/introduction-to-scope-and-authorization/list-of-permissions-by-application-capability

3. **æä¾›è°ƒè¯•ä¿¡æ¯**ï¼š
   - å®Œæ•´çš„æ—¥å¿—è¾“å‡º
   - æµ‹è¯•è„šæœ¬çš„è¾“å‡º
   - é£ä¹¦åº”ç”¨çš„æƒé™é…ç½®æˆªå›¾
   - Video token çš„å€¼

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šNoteDoc v1.0.0
