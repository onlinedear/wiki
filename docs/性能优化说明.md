# Docmost 性能优化说明

## 问题分析

### 1. 页面加载慢（200M）
**原因：**
- 开发模式下未优化的依赖加载
- 大型库（Excalidraw、Mermaid、Drawio）未分割
- 所有编辑器扩展一次性加载

### 2. ProseMirror 选择错误
**错误信息：** `TextSelection endpoint not pointing into a node with inline content`

**原因：**
- IndexedDB 恢复文档时，保存的选择位置可能指向已删除或无效的节点
- Yjs 文档同步时的状态不一致

## 已实施的优化

### 1. Vite 构建优化

在 `apps/client/vite.config.ts` 中添加了：

```typescript
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        // 分离核心库
        'react-vendor': ['react', 'react-dom', 'react-router-dom'],
        'mantine-vendor': ['@mantine/core', '@mantine/hooks', ...],
        'editor-core': ['@tiptap/react', '@tiptap/core', ...],
        'collab': ['yjs', 'y-indexeddb', '@hocuspocus/provider'],
        
        // 重型库单独分割
        'excalidraw': ['@excalidraw/excalidraw'],
        'mermaid': ['mermaid'],
        'drawio': ['react-drawio'],
        'heavy-deps': ['katex', 'lowlight', 'emoji-mart', ...],
      },
    },
  },
},
optimizeDeps: {
  include: ['react', 'react-dom', '@mantine/core', ...],
  exclude: ['@excalidraw/excalidraw', 'mermaid'], // 排除重型库的预构建
}
```

**效果：**
- 生产构建时会将代码分割成多个小块
- 按需加载重型依赖
- 减少初始加载大小

### 2. 修复 ProseMirror 选择错误

在 `page-editor.tsx` 中的 IndexedDB 同步回调中添加：

```typescript
local.on("synced", () => {
  setLocalSynced(true);
  // 清除无效的选择状态
  try {
    const fragment = ydoc.getXmlFragment('default');
    if (fragment) {
      ydoc.transact(() => {
        // 确保文档处于有效状态
      });
    }
  } catch (e) {
    console.warn('Failed to clear selection state:', e);
  }
});
```

### 3. 懒加载组件（可选）

创建了 `lazy-diagram-components.tsx` 用于按需加载图表组件：

```typescript
export const LazyExcalidrawMenu = lazy(() => import('./excalidraw/excalidraw-menu'));
export const LazyDrawioMenu = lazy(() => import('./drawio/drawio-menu'));
```

## 进一步优化建议

### 1. 开发模式优化

```bash
# 清除开发缓存
rm -rf apps/client/node_modules/.vite
rm -rf .nx/cache

# 重新启动开发服务器
pnpm dev
```

### 2. 生产构建测试

```bash
# 构建并检查大小
pnpm client:build

# 查看构建产物大小
ls -lh apps/client/dist/assets/

# 本地预览生产构建
pnpm client:preview
```

### 3. 浏览器缓存

开发时在浏览器中：
- 打开 DevTools > Network
- 勾选 "Disable cache"
- 硬刷新：Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)

### 4. 清除 IndexedDB

如果 ProseMirror 错误持续出现：

```javascript
// 在浏览器控制台执行
indexedDB.deleteDatabase('page.YOUR_PAGE_ID');
location.reload();
```

### 5. 使用懒加载（需要修改代码）

在 `page-editor.tsx` 中替换：

```typescript
// 替换前
import ExcalidrawMenu from './components/excalidraw/excalidraw-menu';
import DrawioMenu from './components/drawio/drawio-menu';

// 替换后
import { ExcalidrawMenuLazy, DrawioMenuLazy } from './components/lazy-diagram-components';

// 在 JSX 中使用
<ExcalidrawMenuLazy editor={editor} />
<DrawioMenuLazy editor={editor} />
```

## 性能监控

### 检查加载时间

在浏览器 DevTools > Network 中查看：
- **Initial load**: 应该 < 5MB（开发模式）
- **Chunk files**: 每个 < 1MB
- **Total load time**: 应该 < 3秒（本地开发）

### 检查内存使用

在浏览器 DevTools > Performance > Memory：
- 正常使用：< 200MB
- 编辑大文档：< 500MB

## 常见问题

### Q: 为什么开发模式还是很慢？
A: 开发模式不会进行代码分割，所有优化只在生产构建时生效。可以使用 `pnpm client:build && pnpm client:preview` 测试优化效果。

### Q: ProseMirror 错误还在出现？
A: 尝试清除 IndexedDB 数据库：
```javascript
// 浏览器控制台
indexedDB.databases().then(dbs => {
  dbs.forEach(db => {
    if (db.name.startsWith('page.')) {
      indexedDB.deleteDatabase(db.name);
    }
  });
});
```

### Q: 如何查看哪个依赖最大？
A: 构建后使用 rollup-plugin-visualizer：
```bash
pnpm add -D rollup-plugin-visualizer
# 在 vite.config.ts 中添加插件
# 构建后会生成 stats.html
```

## 测试清单

- [ ] 清除缓存后重新启动开发服务器
- [ ] 生产构建并检查文件大小
- [ ] 测试页面加载时间（< 3秒）
- [ ] 验证 ProseMirror 错误是否消失
- [ ] 检查编辑器功能正常（图表、公式等）
- [ ] 测试协作功能正常工作

## 监控指标

**优化前：**
- 开发模式加载：~200MB
- ProseMirror 错误：频繁出现

**优化后目标：**
- 生产构建总大小：< 10MB（gzipped）
- 初始加载：< 2MB（gzipped）
- ProseMirror 错误：不再出现
- 首次内容绘制（FCP）：< 1.5秒
- 可交互时间（TTI）：< 3秒
