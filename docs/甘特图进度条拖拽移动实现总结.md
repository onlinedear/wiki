# 甘特图进度条拖拽移动功能 - 实现总结

## 实现概述

为甘特图添加了进度条拖拽移动功能，允许用户通过拖拽整个进度条来调整任务的起始日期，同时保持任务的持续时间不变。这是一个非常直观的交互方式，显著提升了用户体验。

## 完成的工作

### 1. 状态管理

**文件：`apps/client/src/features/editor/components/gantt/gantt-view.tsx`**

新增拖拽状态：
```typescript
const [draggingTask, setDraggingTask] = useState<{
  taskId: string;
  startX: number;
  originalStartDate: Date;
  originalEndDate: Date;
} | null>(null);
```

**状态说明**：
- `taskId`：正在拖拽的任务 ID
- `startX`：拖拽开始时的鼠标 X 坐标
- `originalStartDate`：任务的原始开始日期
- `originalEndDate`：任务的原始结束日期

### 2. 拖拽开始处理

新增 `handleTaskBarMouseDown` 函数：
```typescript
const handleTaskBarMouseDown = (e: React.MouseEvent, taskId: string) => {
  if (isReadOnly) return;
  e.stopPropagation();
  
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  setDraggingTask({
    taskId,
    startX: e.clientX,
    originalStartDate: new Date(task.startDate + 'T00:00:00'),
    originalEndDate: new Date(task.endDate + 'T00:00:00'),
  });
};
```

**功能**：
- 记录拖拽开始时的鼠标位置
- 保存任务的原始日期
- 阻止事件冒泡

### 3. 拖拽移动处理

修改 `handleMouseMove` 函数，添加拖拽移动逻辑：
```typescript
const handleMouseMove = (e: React.MouseEvent) => {
  // 处理拖拽移动
  if (draggingTask && !isReadOnly) {
    const timeline = e.currentTarget as HTMLElement;
    const rect = timeline.getBoundingClientRect();
    const deltaX = e.clientX - draggingTask.startX;
    const dayWidth = rect.width / dateColumns.length;
    const daysDelta = Math.round(deltaX / dayWidth);
    
    if (daysDelta !== 0) {
      const newStartDate = new Date(draggingTask.originalStartDate);
      newStartDate.setDate(newStartDate.getDate() + daysDelta);
      
      const newEndDate = new Date(draggingTask.originalEndDate);
      newEndDate.setDate(newEndDate.getDate() + daysDelta);
      
      const newTasks = tasks.map(t => 
        t.id === draggingTask.taskId 
          ? { 
              ...t, 
              startDate: newStartDate.toISOString().split('T')[0],
              endDate: newEndDate.toISOString().split('T')[0]
            } 
          : t
      );
      updateAttributes({ tasks: newTasks });
    }
    return;
  }
  
  // 原有的调整大小逻辑...
};
```

**功能**：
- 计算鼠标移动距离
- 转换为移动的天数
- 同时调整开始日期和结束日期
- 实时更新任务数据

### 4. 拖拽结束处理

修改 `handleMouseUp` 函数：
```typescript
const handleMouseUp = () => {
  setResizingTask(null);
  setDraggingTask(null);  // 新增
};
```

**功能**：
- 清除拖拽状态
- 结束拖拽操作

### 5. UI 更新

修改进度条的事件处理：
```typescript
<Box
  className={classes.taskBar}
  style={{
    ...position,
    background: ganttSettings.barColor || '#228be6',
    cursor: isReadOnly ? 'pointer' : 'move',  // 新增
  }}
  onClick={() => handleTaskClick(task)}
  onMouseDown={(e) => {  // 新增
    const target = e.target as HTMLElement;
    if (target.classList.contains(classes.resizeHandle)) {
      return;
    }
    handleTaskBarMouseDown(e, task.id);
  }}
>
```

**功能**：
- 设置光标样式为 `move`
- 添加 `onMouseDown` 事件处理
- 区分点击手柄和点击进度条

### 6. 样式更新

**文件：`apps/client/src/features/editor/components/gantt/gantt-view.module.css`**

修改进度条样式：
```css
.taskBar {
  position: absolute;
  height: 32px;
  color: white;
  border-radius: 4px;
  display: flex;
  align-items: center;
  font-size: 0.75rem;
  cursor: move;  /* 修改 */
  padding: 0 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  transition: filter 0.2s;
  z-index: 5;
  min-width: fit-content;
  user-select: none;  /* 新增 */
}

.taskBar:hover {
  filter: brightness(0.9);
}

.taskBar:active {  /* 新增 */
  cursor: grabbing;
}
```

**功能**：
- 默认光标为 `move`（十字箭头）
- 拖拽时光标为 `grabbing`（抓手）
- 禁用文本选择

### 7. 文档完善

创建了以下文档：
1. **甘特图进度条拖拽移动功能说明.md**：详细的功能说明
2. **甘特图进度条拖拽移动快速测试.md**：快速测试指南
3. **甘特图进度条拖拽移动实现总结.md**：技术实现总结（本文档）

更新了主功能说明文档和功能索引文档。

## 技术要点

### 1. 拖拽精度

- **对齐到天**：使用 `Math.round(deltaX / dayWidth)` 计算移动的天数
- **避免抖动**：只有当 `daysDelta !== 0` 时才更新数据
- **保持持续时间**：同时调整开始日期和结束日期

### 2. 事件处理

- **阻止冒泡**：使用 `e.stopPropagation()` 避免触发其他事件
- **区分操作**：检查点击目标是否为手柄，区分拖拽移动和调整大小
- **只读模式**：在只读模式下禁用拖拽

### 3. 状态管理

- **独立状态**：拖拽移动和调整大小使用不同的状态
- **原始数据保存**：保存原始日期，避免累积误差
- **实时更新**：拖拽过程中实时更新数据

### 4. 用户体验

- **光标反馈**：不同状态显示不同的光标样式
- **禁用选择**：使用 `user-select: none` 避免拖拽时选中文本
- **平滑过渡**：使用 CSS 过渡效果

## 代码变更统计

### 修改的文件

1. `apps/client/src/features/editor/components/gantt/gantt-view.tsx`
   - 新增 1 个状态变量（draggingTask）
   - 新增 1 个事件处理函数（handleTaskBarMouseDown）
   - 修改 1 个事件处理函数（handleMouseMove）
   - 修改 1 个事件处理函数（handleMouseUp）
   - 修改进度条的事件绑定和样式

2. `apps/client/src/features/editor/components/gantt/gantt-view.module.css`
   - 修改 `.taskBar` 样式
   - 新增 `.taskBar:active` 样式

### 新增的文件

1. `docs/甘特图进度条拖拽移动功能说明.md`
2. `docs/甘特图进度条拖拽移动快速测试.md`
3. `docs/甘特图进度条拖拽移动实现总结.md`

### 更新的文件

1. `docs/甘特图功能说明.md`
2. `docs/甘特图功能索引.md`

## 与现有功能的协同

### 1. 与调整大小功能的协同

- **互不干扰**：通过检查点击目标区分两种操作
- **优先级**：点击手柄时不触发拖拽移动
- **独立状态**：使用不同的状态变量管理

### 2. 与点击编辑功能的协同

- **当前实现**：拖拽和点击都会触发
- **未来优化**：可以通过移动距离阈值区分点击和拖拽

### 3. 与只读模式的协同

- **只读模式**：不可拖拽，光标显示为 `pointer`
- **编辑模式**：可拖拽，光标显示为 `move`

### 4. 与视图模式的协同

- **所有视图**：周、月、季、年视图都支持拖拽
- **统一精度**：所有视图模式下拖拽精度都是天

## 测试建议

### 功能测试

1. **基本拖拽**
   - [ ] 向右拖拽进度条
   - [ ] 向左拖拽进度条
   - [ ] 验证日期更新正确
   - [ ] 验证持续时间不变

2. **光标样式**
   - [ ] 悬停时显示 move 光标
   - [ ] 拖拽时显示 grabbing 光标
   - [ ] 只读模式显示 pointer 光标

3. **与其他功能的交互**
   - [ ] 点击手柄不触发拖拽
   - [ ] 拖拽后可以点击编辑
   - [ ] 拖拽后可以调整大小

4. **边界情况**
   - [ ] 拖拽到视图外
   - [ ] 拖拽到过去
   - [ ] 拖拽到很远的未来
   - [ ] 快速拖拽

### 性能测试

1. **拖拽性能**
   - [ ] 拖拽大量任务
   - [ ] 在不同视图模式下拖拽
   - [ ] 拖拽时滚动时间轴

### 兼容性测试

1. **浏览器兼容性**
   - [ ] Chrome
   - [ ] Firefox
   - [ ] Safari
   - [ ] Edge

## 已知限制

1. **拖拽阈值**：当前没有区分点击和拖拽，可能导致误触
2. **自动滚动**：拖拽到视图边缘时不会自动滚动
3. **批量拖拽**：不支持同时拖拽多个任务
4. **依赖关系**：拖拽时不会自动调整依赖任务
5. **拖拽提示**：拖拽时没有显示当前日期和移动天数
6. **性能优化**：拖拽过程中频繁更新可能影响性能

## 未来优化方向

1. **拖拽阈值**：区分点击和拖拽，避免误触
2. **拖拽提示**：显示当前日期和移动天数
3. **自动滚动**：拖拽到边缘时自动滚动时间轴
4. **批量拖拽**：支持同时拖拽多个任务
5. **依赖关系**：拖拽时自动调整依赖任务
6. **日期限制**：设置可拖拽的日期范围
7. **拖拽动画**：添加平滑的拖拽动画
8. **拖拽预览**：显示半透明的预览位置
9. **撤销优化**：合并拖拽过程中的多次更新
10. **性能优化**：使用节流减少更新频率

## 总结

进度条拖拽移动功能的实现主要包括：
1. 新增拖拽状态管理
2. 实现拖拽事件处理逻辑
3. 更新 UI 和样式
4. 完善文档

该功能显著提升了用户体验，使得任务时间调整更加直观和便捷。与现有的调整大小功能互补，为用户提供了灵活的任务时间管理方式。

## 相关文档

- [甘特图进度条拖拽移动功能说明](./甘特图进度条拖拽移动功能说明.md)
- [甘特图进度条拖拽移动快速测试](./甘特图进度条拖拽移动快速测试.md)
- [甘特图功能说明](./甘特图功能说明.md)
- [甘特图功能索引](./甘特图功能索引.md)
