# 甘特图配置保存功能 - 实现总结

## 实现概述

为甘特图添加了配置保存功能，允许用户将筛选、排序、分组等个性化设置保存到数据库，确保刷新页面后能够恢复这些设置。

## 完成的工作

### 1. 数据结构扩展

**文件：`packages/editor-ext/src/lib/gantt/gantt.ts`**

新增类型定义：
```typescript
// 筛选条件
export interface FilterCondition {
  id: string;
  fieldId: string;
  operator: 'equals' | 'notEquals' | 'contains' | 'notContains' | 'isEmpty' | 'isNotEmpty';
  value: any;
}

// 排序条件
export interface SortCondition {
  id: string;
  fieldId: string;
  direction: 'asc' | 'desc';
}

// 分组条件
export interface GroupCondition {
  fieldId: string;
}

// 视图配置
export interface GanttViewConfig {
  filterConditions?: FilterCondition[];
  filterLogic?: 'and' | 'or';
  sortConditions?: SortCondition[];
  autoSort?: boolean;
  groupCondition?: GroupCondition | null;
}
```

扩展 `GanttAttributes`：
```typescript
export interface GanttAttributes {
  tasks?: GanttTask[];
  viewMode?: 'week' | 'month' | 'quarter' | 'year';
  hiddenColumns?: string[];
  customFields?: CustomField[];
  ganttSettings?: GanttSettings;
  viewConfig?: GanttViewConfig;  // 新增
}
```

添加 `viewConfig` 属性的序列化和反序列化：
```typescript
viewConfig: {
  default: {},
  parseHTML: (element) => {
    const data = element.getAttribute('data-view-config');
    return data ? JSON.parse(data) : {};
  },
  renderHTML: (attributes: GanttAttributes) => ({
    'data-view-config': JSON.stringify(attributes.viewConfig || {}),
  }),
}
```

### 2. 前端组件更新

**文件：`apps/client/src/features/editor/components/gantt/gantt-view.tsx`**

#### 2.1 状态初始化

从保存的配置初始化状态：
```typescript
const savedViewConfig = node.attrs.viewConfig || {};
const [filterConditions, setFilterConditions] = useState(savedViewConfig.filterConditions || []);
const [filterLogic, setFilterLogic] = useState(savedViewConfig.filterLogic || 'and');
const [sortConditions, setSortConditions] = useState(savedViewConfig.sortConditions || []);
const [autoSort, setAutoSort] = useState(savedViewConfig.autoSort !== undefined ? savedViewConfig.autoSort : true);
const [groupCondition, setGroupCondition] = useState(savedViewConfig.groupCondition || null);
const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
```

#### 2.2 未保存更改检测

在所有修改配置的操作中添加 `setHasUnsavedChanges(true)`：
- 筛选条件的增删改
- 筛选逻辑切换
- 排序条件的增删改
- 自动排序开关切换
- 分组条件的设置和清除

#### 2.3 保存配置功能

```typescript
const handleSaveViewConfig = () => {
  const viewConfig = {
    filterConditions,
    filterLogic,
    sortConditions,
    autoSort,
    groupCondition,
  };
  updateAttributes({ viewConfig });
  setHasUnsavedChanges(false);
};
```

#### 2.4 UI 更新

添加"保存配置"按钮：
```tsx
<Button
  size="xs"
  variant={hasUnsavedChanges ? 'filled' : 'subtle'}
  color={hasUnsavedChanges ? 'green' : 'gray'}
  onClick={handleSaveViewConfig}
  disabled={isReadOnly || !hasUnsavedChanges}
  title="保存配置"
>
  <IconDeviceFloppy size={18} />
</Button>
```

### 3. 图标导入

添加软盘图标：
```typescript
import { IconDeviceFloppy } from '@tabler/icons-react';
```

### 4. 文档完善

创建了以下文档：
1. **甘特图配置保存功能说明.md**：详细的功能说明
2. **甘特图配置保存快速开始.md**：快速上手指南
3. **甘特图配置保存实现总结.md**：技术实现总结（本文档）

更新了主功能说明文档，添加配置保存功能的介绍。

## 技术要点

### 1. 数据持久化

- 配置保存在 Tiptap 节点的 `viewConfig` 属性中
- 通过 `updateAttributes` 方法更新节点属性
- Tiptap 自动处理序列化和反序列化
- 配置随文档一起保存到数据库

### 2. 状态管理

- 使用 React useState 管理本地状态
- 从 `node.attrs.viewConfig` 初始化状态
- 通过 `hasUnsavedChanges` 标志跟踪未保存的更改

### 3. 用户体验

- 按钮颜色指示未保存状态（灰色/绿色）
- 按钮禁用状态防止无效操作
- 保存后立即更新按钮状态

### 4. 数据流

```
用户操作
  ↓
修改本地状态 (useState)
  ↓
设置 hasUnsavedChanges = true
  ↓
按钮变为绿色可点击
  ↓
用户点击"保存配置"
  ↓
调用 updateAttributes({ viewConfig })
  ↓
Tiptap 更新节点属性
  ↓
文档标记为已修改
  ↓
自动保存或手动保存
  ↓
数据持久化到数据库
  ↓
刷新页面时从 node.attrs.viewConfig 恢复
```

## 代码变更统计

### 修改的文件

1. `packages/editor-ext/src/lib/gantt/gantt.ts`
   - 新增 4 个接口定义
   - 扩展 1 个接口
   - 新增 1 个属性配置

2. `apps/client/src/features/editor/components/gantt/gantt-view.tsx`
   - 新增 1 个状态变量
   - 修改 6 个状态初始化
   - 新增 1 个保存函数
   - 修改 11 个事件处理函数（添加未保存标记）
   - 新增 1 个按钮组件
   - 新增 1 个图标导入

### 新增的文件

1. `docs/甘特图配置保存功能说明.md`
2. `docs/甘特图配置保存快速开始.md`
3. `docs/甘特图配置保存实现总结.md`

### 更新的文件

1. `docs/甘特图功能说明.md`

## 测试建议

### 功能测试

1. **保存和恢复**
   - [ ] 设置筛选条件后保存，刷新页面验证恢复
   - [ ] 设置排序条件后保存，刷新页面验证恢复
   - [ ] 设置分组条件后保存，刷新页面验证恢复
   - [ ] 同时设置筛选、排序、分组后保存，刷新页面验证恢复

2. **按钮状态**
   - [ ] 初始状态按钮为灰色且禁用
   - [ ] 修改配置后按钮变为绿色且可点击
   - [ ] 保存后按钮变回灰色且禁用
   - [ ] 只读模式下按钮始终禁用

3. **未保存更改检测**
   - [ ] 添加筛选条件触发未保存状态
   - [ ] 修改筛选条件触发未保存状态
   - [ ] 删除筛选条件触发未保存状态
   - [ ] 切换筛选逻辑触发未保存状态
   - [ ] 添加排序条件触发未保存状态
   - [ ] 修改排序条件触发未保存状态
   - [ ] 删除排序条件触发未保存状态
   - [ ] 切换自动排序触发未保存状态
   - [ ] 设置分组触发未保存状态
   - [ ] 清除分组触发未保存状态

4. **边界情况**
   - [ ] 空配置保存和恢复
   - [ ] 删除字段后相关配置的处理
   - [ ] 多次保存不会出错
   - [ ] 保存后立即修改再保存

5. **协作测试**
   - [ ] 用户 A 保存配置，用户 B 刷新后看到配置
   - [ ] 用户 A 修改配置但不保存，用户 B 看不到更改
   - [ ] 用户 A 保存配置，用户 B 在线时自动同步

### 性能测试

1. **保存性能**
   - [ ] 大量筛选条件的保存速度
   - [ ] 大量排序条件的保存速度
   - [ ] 频繁保存不会导致性能问题

2. **加载性能**
   - [ ] 复杂配置的加载速度
   - [ ] 配置恢复不会阻塞页面渲染

### 兼容性测试

1. **浏览器兼容性**
   - [ ] Chrome
   - [ ] Firefox
   - [ ] Safari
   - [ ] Edge

2. **数据兼容性**
   - [ ] 旧版本文档（没有 viewConfig）正常工作
   - [ ] 新版本文档在旧版本编辑器中不会出错

## 问题修复

### 修复：排序条件拖拽排序未标记未保存状态

**问题描述**：
- 拖拽调整排序条件的优先级后，"保存配置"按钮没有变为绿色
- 导致用户可能忘记保存，刷新后丢失排序优先级的调整

**修复方案**：
在 `handleSortDragEnd` 函数中添加 `setHasUnsavedChanges(true)`

**修复代码**：
```typescript
const handleSortDragEnd = (result: any) => {
  if (!result.destination) return;

  const items = Array.from(sortConditions);
  const [reorderedItem] = items.splice(result.source.index, 1);
  items.splice(result.destination.index, 0, reorderedItem);

  setSortConditions(items);
  setHasUnsavedChanges(true);  // 新增
};
```

**测试验证**：
- [ ] 拖拽排序条件后按钮变为绿色
- [ ] 保存后刷新页面，排序优先级正确恢复

## 已知限制

1. **配置共享**：配置对所有协作者可见，无法设置个人专属配置
2. **折叠状态**：分组的折叠/展开状态不会被保存
3. **配置冲突**：删除字段后相关配置会失效，需要手动清理
4. **单一配置**：每个甘特图只能保存一个配置方案

## 未来优化方向

1. **个人配置**：支持个人专属的视图配置
2. **配置模板**：预设常用的配置模板
3. **配置历史**：查看和恢复历史配置
4. **配置导入导出**：在不同甘特图之间复制配置
5. **自动保存**：配置更改后自动保存
6. **配置命名**：为不同的配置方案命名
7. **折叠状态保存**：保存分组的折叠/展开状态
8. **配置验证**：删除字段时自动清理相关配置

## 总结

配置保存功能的实现主要包括：
1. 扩展数据结构以支持视图配置的存储
2. 修改前端组件以支持配置的保存和恢复
3. 添加 UI 元素以提供保存功能和状态指示
4. 完善文档以帮助用户理解和使用功能

该功能显著提升了用户体验，使得个性化的视图设置能够持久化，避免了每次打开文档都需要重新设置的麻烦。同时，配置的共享特性也有助于团队协作，确保所有成员看到一致的视图。
