---
creator: "${author}"
created: "${createTime}"
last_modified_by: "${author}"
last_modified: "${updateTime}"
version: "v1.0"
visibility: "internal"
---
# 附件搜索 500 错误修复说明

## 问题描述

附件搜索功能返回 500 Internal Server Error，前端显示错误：
```
POST http://localhost:5173/api/search/search-attachments 500 (Internal Server Error)
```

## 根本原因

1. **tsv 字段为 NULL**: 现有的附件记录可能没有 `tsv` 字段值
2. **触发器未生效**: 数据库触发器可能未正确创建或未对现有数据生效
3. **SQL 查询错误**: 对 NULL 值执行全文搜索操作导致错误

## 解决方案

### 方案 1: 自动修复脚本（推荐）

运行修复脚本：

```bash
./scripts/fix-attachment-search.sh
```

此脚本会：
1. 检查数据库连接
2. 更新所有附件的 tsv 字段
3. 验证触发器是否存在

### 方案 2: 手动修复

#### 步骤 1: 更新现有附件的 tsv 字段

使用 psql 或数据库管理工具执行：

```sql
UPDATE attachments 
SET tsv = 
    setweight(to_tsvector('english', f_unaccent(coalesce(file_name, ''))), 'A') ||
    setweight(to_tsvector('english', f_unaccent(coalesce(text_content, ''))), 'B')
WHERE tsv IS NULL;
```

#### 步骤 2: 验证触发器

检查触发器是否存在：

```sql
SELECT tgname, tgenabled 
FROM pg_trigger 
WHERE tgname = 'attachments_tsvector_update';
```

如果触发器不存在，运行迁移：

```bash
cd apps/server
npm run migration:up
```

#### 步骤 3: 验证修复

检查附件的 tsv 字段：

```sql
SELECT 
    COUNT(*) as total_attachments,
    COUNT(tsv) as attachments_with_tsv,
    COUNT(*) - COUNT(tsv) as attachments_without_tsv
FROM attachments;
```

应该显示所有附件都有 tsv 字段。

### 方案 3: 代码层面的防护

已在代码中添加了 NULL 检查：

```typescript
.where('attachments.tsv', 'is not', null)
.where(
  'attachments.tsv',
  '@@',
  sql<string>`to_tsquery('english', f_unaccent(${searchQuery}))`,
)
```

这确保只搜索有 tsv 字段的附件。

## 验证修复

### 1. 重启后端服务

```bash
# 停止当前服务 (Ctrl+C)
# 重新启动
npm run server:dev
```

### 2. 测试附件搜索

在浏览器中：
1. 按 `Cmd+K` (Mac) 或 `Ctrl+K` (Windows/Linux)
2. 选择"附件"类型
3. 输入搜索关键词
4. 应该能看到搜索结果，不再有 500 错误

### 3. 检查后端日志

如果仍有问题，查看后端日志中的错误信息：
- 查看运行 `npm run server:dev` 的终端
- 查找错误堆栈跟踪
- 检查是否有 SQL 错误

## 预防措施

### 1. 触发器自动维护

数据库触发器会自动为新上传的附件创建 tsv 字段：

```sql
CREATE OR REPLACE TRIGGER attachments_tsvector_update 
BEFORE INSERT OR UPDATE
ON attachments 
FOR EACH ROW 
EXECUTE FUNCTION attachments_tsvector_trigger();
```

### 2. 迁移脚本

迁移脚本 `20251121T100000-attachments-tsvector-trigger.ts` 包含：
- 创建触发器函数
- 创建触发器
- 更新现有数据的 tsv 字段

### 3. 代码防护

搜索服务中添加了 NULL 检查，防止查询 NULL 值。

## 常见问题

### Q1: 为什么现有附件没有 tsv 字段？

A: 触发器只对新插入或更新的记录生效。迁移脚本中包含了更新现有数据的 SQL，但如果迁移时数据库中没有附件，后来添加的附件就不会有 tsv 字段。

### Q2: 如何确认触发器正在工作？

A: 上传一个新附件，然后检查其 tsv 字段：

```sql
SELECT id, file_name, tsv 
FROM attachments 
ORDER BY created_at DESC 
LIMIT 1;
```

tsv 字段应该有值。

### Q3: 搜索结果为空是正常的吗？

A: 是的，如果：
- 没有匹配的附件
- 用户没有权限访问包含附件的空间
- 附件的 tsv 字段为 NULL（已修复）

### Q4: 如何测试特定附件的搜索？

A: 在数据库中查找附件的文件名，然后搜索该名称：

```sql
SELECT file_name, tsv 
FROM attachments 
WHERE deleted_at IS NULL 
LIMIT 5;
```

## 相关文件

- **迁移文件**: `apps/server/src/database/migrations/20251121T100000-attachments-tsvector-trigger.ts`
- **搜索服务**: `apps/server/src/core/search/search.service.ts`
- **搜索控制器**: `apps/server/src/core/search/search.controller.ts`
- **修复脚本**: `scripts/fix-attachment-search.sh`
- **SQL 脚本**: `scripts/update-attachment-tsv.sql`

## 技术细节

### tsv 字段结构

```
tsv = 
  setweight(to_tsvector('english', f_unaccent(file_name)), 'A') ||
  setweight(to_tsvector('english', f_unaccent(text_content)), 'B')
```

- **权重 A**: 文件名（最高优先级）
- **权重 B**: 文件内容（次优先级）
- **f_unaccent**: 移除重音符号，支持更广泛的搜索

### 全文搜索查询

```sql
WHERE attachments.tsv @@ to_tsquery('english', f_unaccent('search_term*'))
ORDER BY ts_rank(attachments.tsv, to_tsquery('english', f_unaccent('search_term*'))) DESC
```

## 总结

500 错误主要是由于现有附件缺少 tsv 字段导致的。通过运行修复脚本或手动更新数据库，可以解决此问题。代码层面也添加了防护措施，确保不会查询 NULL 值。
