# 飞书视频导入测试步骤

## 当前状态

✅ **服务器已重启** - 新的日志代码已生效  
⏳ **等待测试** - 需要执行实际导入测试

## 测试准备清单

### 1. 飞书测试文档

在飞书中准备一个测试文档：

- [ ] 创建新的飞书文档（确保是新版文档，URL 包含 `/docx/`）
- [ ] 插入一个小视频（建议 < 10MB，便于快速测试）
- [ ] 复制文档 URL

**示例 URL 格式**：
```
https://xxx.feishu.cn/docx/xxxxxxxxx
```

### 2. 飞书应用配置

确认你有以下信息：

- [ ] App ID: `cli_xxxxx`
- [ ] App Secret: `xxxxx`

### 3. 打开日志监控

在一个新的终端窗口中运行：

```bash
# 进入项目目录
cd /Users/cn-stevenlv/docmost/docmost

# 实时查看视频相关日志
tail -f apps/server/logs/app.log | grep -E "🎬|Video|video|VMxxxxxxxx"
```

或者查看所有日志：

```bash
tail -f apps/server/logs/app.log
```

## 测试步骤

### 步骤 1：访问 NoteDoc

1. 打开浏览器访问 NoteDoc（通常是 `http://localhost:3000`）
2. 登录你的账号

### 步骤 2：配置飞书集成

1. 点击右上角头像 → "设置"
2. 在左侧菜单找到 "第三方系统集成"
3. 点击 "飞书"
4. 输入你的 App ID 和 App Secret
5. 点击 "保存配置"

### 步骤 3：执行在线导入

1. 在飞书集成页面，点击 "在线导入" 按钮
2. 在弹出的对话框中：
   - 选择目标文档库（Space）
   - 粘贴飞书文档 URL
3. 点击 "导入" 按钮

### 步骤 4：观察日志输出

在日志监控终端中，你应该看到类似的输出：

#### 成功场景：

```
[FeishuImportService] Starting Feishu import for user xxx
[FeishuImportService] Document title: 测试文档
[FeishuImportService] Blocks items count: 10
[FeishuImportService] Converting Feishu blocks to Tiptap
[FeishuImportService] Video container block found with 1 children
[FeishuImportService] Video child block type: XX, keys: block_id, block_type, parent_id, file, ...
[FeishuImportService] Found video file token in child: VMxxxxxxxx
[FeishuImportService] 📥 Processing video with token: VMxxxxxxxx
[FeishuApiService] 🎬 Getting video URL for token: VMxxxxxxxx
[FeishuApiService] Trying Method 1: /drive/v1/medias/VMxxxxxxxx/download
[FeishuApiService] Method 1 (medias) response code: 0, msg: success
[FeishuApiService] Method 1 full response: {"code":0,"msg":"success","data":{"tmp_download_url":"https://..."}}
[FeishuApiService] ✓ Got video URL via medias API: https://...
[FeishuApiService] ⬇️ Downloading video from URL: https://...
[FeishuApiService] ✓ Downloaded video: 15.67 MB
[FeishuImportService] 📤 Video uploaded to storage: workspace-xxx/files/...
[FeishuImportService] ✅ Video imported successfully: uuid-xxx (15.67 MB)
[FeishuImportService] Created page xxx from Feishu document
```

#### 失败场景（权限问题）：

```
[FeishuApiService] 🎬 Getting video URL for token: VMxxxxxxxx
[FeishuApiService] Trying Method 1: /drive/v1/medias/VMxxxxxxxx/download
[FeishuApiService] Method 1 (medias) response code: 99991672, msg: Access denied
[FeishuApiService] Method 1 full response: {"code":99991672,"msg":"Access denied","data":{}}
[FeishuApiService] Method 1 failed: code=99991672, msg=Access denied
[FeishuApiService] Trying Method 2: /drive/v1/files/VMxxxxxxxx/download
[FeishuApiService] Method 2 (files) response code: 99991672, msg: Access denied
[FeishuApiService] ❌ All methods failed to get video URL for token: VMxxxxxxxx
[FeishuApiService] Please check:
[FeishuApiService]   1. Feishu app permissions (drive:drive:readonly or drive:drive)
[FeishuApiService]   2. Video token format: VMxxxxxxxx
```

### 步骤 5：检查导入结果

1. 导入完成后，在 NoteDoc 中打开新创建的文档
2. 检查视频是否正确显示
3. 尝试播放视频

## 问题排查

### 如果看到 "Access denied" (code: 99991672)

**问题**：权限不足

**解决方案**：

1. 访问飞书开放平台：
   ```
   https://open.feishu.cn/app/你的AppID/auth
   ```

2. 确认已开通以下权限：
   - ✅ `docx:document:readonly` - 查看、评论和导出文档
   - ✅ `drive:drive:readonly` - 查看云空间中所有文件
   - ⚠️ 可能还需要 `drive:drive` - 云空间完整权限

3. 保存权限配置后，等待 5-10 分钟让权限生效

4. 重新测试导入

### 如果看到 "404 Not Found"

**问题**：Video token 格式不正确

**解决方案**：

1. 从日志中复制完整的 video token：
   ```bash
   grep "Found video file token" apps/server/logs/app.log
   ```

2. 使用测试脚本单独测试：
   ```bash
   ./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN>
   ```

3. 查看测试脚本的输出，确定具体问题

### 如果看到 "no processable children"

**问题**：视频块结构问题

**解决方案**：

1. 确认文档是新版文档（URL 包含 `/docx/`）
2. 查看完整的块结构日志
3. 可能需要调整代码以适配实际的块结构

### 如果视频下载超时

**问题**：视频文件太大或网络问题

**解决方案**：

1. 尝试更小的视频（< 10MB）
2. 检查网络连接
3. 如果需要，可以增加超时时间

## 使用测试脚本

如果导入失败，可以使用测试脚本单独测试 API：

### 1. 从日志获取 video token

```bash
grep "Found video file token" apps/server/logs/app.log
```

**输出示例**：
```
[FeishuImportService] Found video file token in child: VMxxxxxxxx
```

### 2. 运行测试脚本

```bash
cd /Users/cn-stevenlv/docmost/docmost
./scripts/test-feishu-video-api.sh cli_xxxxx your_app_secret VMxxxxxxxx
```

### 3. 查看测试结果

测试脚本会：
- 测试 4 种不同的 API 端点
- 显示每个 API 的详细响应
- 尝试实际下载视频
- 提供明确的成功/失败标识

## 收集调试信息

如果问题仍未解决，收集以下信息：

### 1. 导出日志

```bash
# 导出视频相关日志
grep -E "Video|video|🎬" apps/server/logs/app.log > video_debug.log

# 或导出完整的导入日志
grep -A 100 "Starting Feishu import" apps/server/logs/app.log > import_debug.log
```

### 2. 运行测试脚本

```bash
./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN> > api_test_result.txt 2>&1
```

### 3. 截图

- 飞书应用权限配置页面
- NoteDoc 导入界面
- 导入后的文档显示

## 预期结果

### 成功标志

- ✅ 日志显示 "✓ Got video URL via medias API"
- ✅ 日志显示 "✓ Downloaded video: XX MB"
- ✅ 日志显示 "✅ Video imported successfully"
- ✅ 文档中可以看到并播放视频

### 失败标志

- ❌ 日志显示 "❌ All methods failed to get video URL"
- ❌ 文档中显示 "🎬 [视频导入失败]"
- ❌ 测试脚本所有 API 都失败

## 下一步

根据测试结果：

### 如果成功
→ 视频导入功能正常工作，可以正式使用

### 如果失败
→ 根据具体错误信息：
- 权限问题 → 配置飞书应用权限
- Token 问题 → 检查 blocks API 数据结构
- API 问题 → 查阅飞书文档或联系技术支持

## 快速命令参考

```bash
# 查看实时日志
tail -f apps/server/logs/app.log | grep -E "🎬|Video"

# 查看最近的视频日志
grep -E "🎬|Video" apps/server/logs/app.log | tail -50

# 运行测试脚本
./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN>

# 导出调试日志
grep -E "Video|video|🎬" apps/server/logs/app.log > video_debug.log
```

---

**创建时间**：2025-11-26  
**适用版本**：NoteDoc v1.0.0

## 现在开始测试！

1. ✅ 服务器已重启
2. ⏳ 准备飞书测试文档
3. ⏳ 打开日志监控
4. ⏳ 执行导入测试
5. ⏳ 分析结果
