# NoteDoc 启动运行总结

## 执行时间

2024年11月27日

## 执行目标

在 macOS 本地环境成功启动 NoteDoc 开发服务器，并为生产环境部署准备完整的文档和脚本。

## 环境信息

### 操作系统
- **系统**: macOS (darwin)
- **Shell**: zsh
- **架构**: ARM64 (Apple Silicon)

### 软件版本
- **Node.js**: v20.14.0
- **pnpm**: 10.4.0 (通过 npx 运行)
- **PostgreSQL**: 16 (通过 Homebrew 安装)
- **Redis**: 7.2 (通过 Homebrew 安装)

### 项目信息
- **项目名称**: NoteDoc
- **版本**: 0.23.2
- **仓库**: https://github.com/onlinedear/wiki

## 启动过程

### 1. 环境检查

#### 已安装的服务
```bash
# PostgreSQL 和 Redis 通过 Homebrew 管理
brew services list | grep -E "postgres|redis"

结果：
- postgresql@16: started ✓
- redis: started ✓
```

#### 环境变量配置
项目已有 `.env` 配置文件：
- APP_URL: http://localhost:3001
- PORT: 3001
- DATABASE_URL: postgresql://docmost:***@localhost:5432/docmost
- REDIS_URL: redis://127.0.0.1:6379
- 邮件服务已配置（SMTP）

### 2. 依赖安装

项目依赖已预先安装在 `node_modules` 目录：
- 使用 pnpm workspaces 管理 monorepo
- 包含前端、后端和共享包的所有依赖

### 3. 数据库迁移

```bash
cd apps/server
npx pnpm migration:up

结果：No pending migrations to execute ✓
```

数据库表结构已是最新状态。

### 4. 解决 NX Daemon 问题

**遇到的问题**：
NX daemon 进程在启动时出现连接问题，导致开发服务器无法正常启动。

**解决方案**：
1. 重置 NX 缓存：`npx nx reset`
2. 禁用 NX daemon 运行：`NX_DAEMON=false npx pnpm dev`

### 5. 启动开发服务器

```bash
NX_DAEMON=false npx pnpm dev
```

成功启动两个服务：
- **前端** (Vite): http://localhost:5173
- **后端** (NestJS): http://localhost:3001

### 6. 服务验证

#### 后端健康检查
```bash
curl http://localhost:3001/api/health

响应：
{
  "status": "ok",
  "info": {
    "database": {"status": "up"},
    "redis": {"status": "up"}
  }
}
```

#### 前端页面
```bash
curl http://localhost:5173

响应：HTML 页面，标题为 "NoteDoc"
```

## 启动成功状态

### 运行中的服务

| 服务 | 地址 | 状态 | 说明 |
|------|------|------|------|
| 前端开发服务器 | http://localhost:5173 | ✓ 运行中 | Vite + React |
| 后端 API 服务器 | http://localhost:3001 | ✓ 运行中 | NestJS + Fastify |
| PostgreSQL | localhost:5432 | ✓ 运行中 | 数据库 |
| Redis | localhost:6379 | ✓ 运行中 | 缓存和队列 |

### 可用的 API 端点

后端成功注册了以下主要功能模块：
- 用户认证 (`/api/auth`)
- 工作空间管理 (`/api/workspace`)
- 文档库管理 (`/api/spaces`)
- 页面管理 (`/api/pages`)
- 评论系统 (`/api/comments`)
- 搜索功能 (`/api/search`)
- 文件上传 (`/api/files`, `/api/attachments`)
- 用户组管理 (`/api/groups`)
- 分享功能 (`/api/shares`)
- 健康检查 (`/api/health`)

### 企业版功能

已加载的企业版功能：
- API 密钥管理 (`/api/workspaces/:workspaceId/api-keys`)
- MFA 多因素认证 (`/api/mfa`)
- SSO 单点登录 (`/api/sso`)
- Confluence 导入 (`/api/confluence`)
- 飞书导入 (`/api/feishu`)

## 创建的文档和脚本

### 文档

1. **本地开发环境启动指南** (`docs/本地开发环境启动指南.md`)
   - 详细的本地开发环境配置步骤
   - 常见问题和解决方案
   - 开发常用命令
   - 项目结构说明
   - 技术栈介绍

2. **生产环境部署指南** (`docs/生产环境部署指南.md`)
   - Docker Compose 部署方案（推荐）
   - 手动部署方案
   - S3 对象存储配置
   - Nginx 反向代理配置
   - SSL 证书配置
   - 数据备份和恢复
   - 监控和维护
   - 安全加固
   - 性能优化
   - 故障排查

3. **启动运行总结** (`docs/启动运行总结.md`)
   - 本文档，记录完整的启动过程

### 脚本

1. **开发环境启动脚本** (`start-dev.sh`)
   - 自动检查依赖环境
   - 自动启动 PostgreSQL 和 Redis
   - 运行数据库迁移
   - 启动开发服务器
   - 使用方法：`./start-dev.sh`

2. **生产环境部署脚本** (`deploy-production.sh`)
   - 自动安装 Docker 和 Docker Compose
   - 生成安全密钥
   - 创建 docker-compose.yml
   - 启动所有服务
   - 使用方法：`sudo ./deploy-production.sh`

## 技术架构总结

### Monorepo 结构

```
notedoc/
├── apps/
│   ├── client/          # React 前端 (Vite)
│   └── server/          # NestJS 后端 (Fastify)
├── packages/
│   ├── editor-ext/      # Tiptap 编辑器扩展
│   └── ee/              # 企业版许可证
└── docs/                # 文档
```

### 前端技术栈

- **框架**: React 18 + TypeScript
- **构建**: Vite 6
- **UI**: Mantine 8
- **编辑器**: Tiptap 2 (ProseMirror)
- **状态**: Jotai
- **数据**: TanStack Query
- **路由**: React Router 7
- **国际化**: i18next
- **协作**: Yjs + Hocuspocus Provider

### 后端技术栈

- **框架**: NestJS 11 + TypeScript
- **HTTP**: Fastify
- **数据库**: PostgreSQL 16 + Kysely
- **缓存**: Redis (ioredis)
- **队列**: BullMQ
- **认证**: Passport (JWT, OAuth, SAML)
- **WebSocket**: Socket.io
- **协作**: Hocuspocus Server
- **存储**: S3 兼容
- **邮件**: Nodemailer

## 部署建议

### 开发环境

**推荐方式**：本地直接运行
- 使用 `./start-dev.sh` 快速启动
- 前端热重载，后端自动重启
- 便于调试和开发

**要求**：
- Node.js 20+
- PostgreSQL 16+
- Redis 7.2+
- 4GB+ 内存

### 生产环境

**推荐方式**：Docker Compose
- 使用 `./deploy-production.sh` 一键部署
- 所有服务容器化
- 易于维护和扩展

**最低配置**：
- CPU: 2核
- 内存: 4GB
- 磁盘: 20GB SSD
- 带宽: 5Mbps

**推荐配置**：
- CPU: 4核
- 内存: 8GB
- 磁盘: 50GB SSD
- 带宽: 10Mbps

### 云平台部署

支持的平台：
- **Vercel**: 适合小团队，需要外部数据库
- **Railway**: 完全免费，自动配置数据库
- **Render**: 免费套餐，托管数据库
- **DigitalOcean**: App Platform 一键部署
- **AWS/GCP/Azure**: 完全控制，适合大规模

详见：`docs/一键部署方案.md`

## 安全建议

### 必须配置

1. **强密码**
   - APP_SECRET: 至少 32 字符随机字符串
   - 数据库密码: 至少 16 字符复杂密码
   - Redis 密码: 生产环境必须配置

2. **HTTPS**
   - 生产环境必须启用 HTTPS
   - 使用 Let's Encrypt 免费证书
   - 配置 HSTS 头

3. **防火墙**
   - 只开放必要端口（80, 443）
   - 数据库和 Redis 不对外暴露
   - 配置 fail2ban 防止暴力破解

### 推荐配置

1. **备份策略**
   - 每天自动备份数据库
   - 备份文件存储
   - 保留至少 30 天备份

2. **监控**
   - 配置健康检查
   - 监控资源使用
   - 设置告警通知

3. **更新**
   - 定期更新应用版本
   - 及时安装安全补丁
   - 测试后再部署到生产

## 常见问题

### 1. NX Daemon 连接失败

**解决方案**：禁用 daemon
```bash
NX_DAEMON=false npx pnpm dev
```

### 2. pnpm 命令未找到

**解决方案**：使用 npx
```bash
npx pnpm@10.4.0 <command>
```

### 3. 数据库连接失败

**解决方案**：检查服务状态
```bash
brew services list | grep postgres
brew services start postgresql@16
```

### 4. 端口被占用

**解决方案**：修改 .env 中的 PORT
```bash
PORT=3002  # 改为其他端口
```

## 下一步操作

### 开发

1. 访问 http://localhost:5173
2. 注册管理员账号
3. 创建工作空间
4. 开始开发和测试

### 部署到生产

1. 准备服务器（Ubuntu/CentOS/Debian）
2. 运行部署脚本：`sudo ./deploy-production.sh`
3. 配置域名和 SSL
4. 配置邮件服务
5. 设置定期备份

### 功能扩展

1. 配置 S3 对象存储
2. 启用 SSO 单点登录
3. 配置 MFA 多因素认证
4. 集成 Confluence/飞书导入
5. 自定义品牌和主题

## 相关资源

### 文档

- [本地开发环境启动指南](./本地开发环境启动指南.md)
- [生产环境部署指南](./生产环境部署指南.md)
- [Vercel 部署指南](./Vercel部署指南.md)
- [宝塔面板部署指南](./宝塔面板部署指南.md)
- [一键部署方案](./一键部署方案.md)
- [完整部署指南](./NoteDoc完整部署指南.md)

### 技术文档

- [技术栈说明](../.kiro/steering/tech.md)
- [项目结构](../.kiro/steering/structure.md)
- [产品概述](../.kiro/steering/product.md)

### 功能文档

- [API 密钥使用指南](./API密钥使用完整指南.md)
- [SSO 快速开始](./SSO_快速开始.md)
- [评论管理功能](./评论管理功能说明.md)
- [Confluence 导入](./Confluence在线导入功能说明.md)

### 在线资源

- **GitHub**: https://github.com/onlinedear/wiki
- **官网**: https://notedoc.cn
- **文档**: https://notedoc.cn/docs
- **讨论区**: https://github.com/onlinedear/wiki/discussions

## 总结

NoteDoc 已成功在本地开发环境启动运行，所有核心服务（前端、后端、数据库、缓存）均正常工作。同时创建了完整的部署文档和自动化脚本，可以快速部署到生产环境。

**启动状态**：✅ 成功
- 前端: http://localhost:5173 ✓
- 后端: http://localhost:3001 ✓
- 数据库: PostgreSQL 16 ✓
- 缓存: Redis 7.2 ✓

**文档完整性**：✅ 完成
- 本地开发指南 ✓
- 生产部署指南 ✓
- 自动化脚本 ✓
- 问题排查 ✓

**生产就绪**：✅ 准备完毕
- Docker 部署方案 ✓
- 安全配置建议 ✓
- 备份恢复方案 ✓
- 监控维护指南 ✓

现在可以开始使用 NoteDoc 进行开发，或者将其部署到生产服务器了！
