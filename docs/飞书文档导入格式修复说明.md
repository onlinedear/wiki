# 飞书文档导入格式修复说明

## 问题描述

在实现飞书文档导入功能后，发现导入的文档所有内容都显示为 H1 标题格式，而不是正确的段落、标题等格式。

## 问题原因

在 `feishu-import.service.ts` 的 `convertFeishuBlock` 方法中，block_type 的映射关系错误：

**错误的映射：**
- `case 1`: Text/Paragraph (文本段落)
- `case 2`: Heading 1
- `case 3`: Heading 2
- ...

**正确的映射（根据飞书 Blocks API 文档）：**
- `case 1`: Page (页面根节点) - 应该跳过
- `case 2`: Text/Paragraph (文本段落)
- `case 3`: Heading 1
- `case 4`: Heading 2
- `case 5`: Heading 3
- `case 6`: Heading 4
- `case 7`: Heading 5
- `case 8`: Heading 6
- `case 9`: Heading 7
- `case 10`: Heading 8
- `case 11`: Heading 9
- `case 12`: Bullet list (无序列表)
- `case 13`: Ordered list (有序列表)
- `case 15`: Code block (代码块)
- `case 17`: Quote (引用)
- `case 22`: Divider (分割线)

## 修复内容

### 1. 修正 block_type 映射关系

```typescript
private convertFeishuBlock(block: any): any {
  const blockType = block.block_type;

  switch (blockType) {
    case 1: // Page (root node) - should be skipped
      return null;
    
    case 2: // Text/Paragraph
      return this.convertTextBlock(block);
    
    case 3: // Heading 1
      return {
        type: 'heading',
        attrs: { level: 1 },
        content: this.extractTextElements(block.text?.elements),
      };
    
    case 4: // Heading 2
      return {
        type: 'heading',
        attrs: { level: 2 },
        content: this.extractTextElements(block.text?.elements),
      };
    
    // ... 其他类型
  }
}
```

### 2. 改进日志输出

添加了详细的调试日志，帮助追踪转换过程：

```typescript
// 记录每个 block 的转换结果
this.logger.debug(`Converted block type ${block.block_type} to ${converted.type}`);

// 记录转换统计
this.logger.log(`Conversion complete: ${convertedCount} blocks converted, ${skippedCount} skipped`);

// 记录前几个 blocks 的结构
this.logger.debug(`First 3 blocks: ${JSON.stringify(blocks.items.slice(0, 3).map((b: any) => ({ 
  block_type: b.block_type, 
  has_text: !!b.text,
  has_code: !!b.code 
})))}`);
```

### 3. 修复 TypeScript 类型警告

- 为 `docMeta` 和 `blocks` 变量添加显式类型注解
- 移除未使用的 `includeChildren` 参数引用

## 支持的飞书内容类型

修复后，导入功能现在正确支持以下飞书内容类型：

- ✅ 文本段落
- ✅ 标题 1-6（飞书支持 1-9，但 Tiptap 只支持到 6）
- ✅ 无序列表
- ✅ 有序列表
- ✅ 代码块（保留语言信息）
- ✅ 引用块
- ✅ 高亮块/提示块（Callout）
- ✅ 分割线
- ✅ 文本样式（粗体、斜体、删除线、下划线、行内代码）
- ✅ 链接
- ✅ 文档提及（转换为文本）
- ✅ 用户提及（转换为文本）
- ❌ 图片（暂不支持，详见 [飞书文档导入图片处理说明](./飞书文档导入图片处理说明.md)）

## 当前限制

1. **图片不支持**：飞书文档中的图片会被跳过，不会显示在导入的文档中。这是因为需要额外的下载和存储处理。详见 [飞书文档导入图片处理说明](./飞书文档导入图片处理说明.md)

2. **多维表格/甘特图不支持**：飞书的多维表格（Bitable）和基于它的甘特图视图无法导入。导入时会显示警告提示框，提醒用户在飞书中查看原始内容。这是因为飞书的多维表格是一个独立的数据库应用，与 NoteDoc 的数据结构完全不同。

3. **表格不支持**：普通表格暂不支持导入，会显示警告提示框。

4. **子页面不支持**：目前只支持单个文档导入，不支持递归导入子页面

5. **附件不支持**：文档中的附件（如 PDF、Word 等）不会被导入

## 测试步骤

1. 确保后端服务正在运行
2. 在飞书中创建一个包含多种格式的测试文档：
   - 标题 1、2、3
   - 普通段落
   - 无序列表
   - 有序列表
   - 代码块
   - 引用
3. 在 NoteDoc 中导入该文档
4. 验证所有格式都正确显示

## 相关文件

- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - 主要修复文件
- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - API 服务
- `docs/飞书文档导入功能实现说明.md` - 功能实现文档
- `docs/飞书文档导入测试指南.md` - 测试指南

## 注意事项

1. 飞书支持 9 级标题，但 Tiptap 只支持 6 级，因此 7-9 级标题会被转换为 6 级
2. 页面根节点（block_type: 1）会被自动跳过
3. 不支持的 block 类型会尝试提取文本内容作为段落
4. 空文本节点会被自动过滤

## 下一步

- [ ] 测试各种复杂文档的导入
- [ ] 支持更多飞书特有的内容类型（表格、图片等）
- [ ] 实现子页面递归导入功能
- [ ] 优化大文档的导入性能
