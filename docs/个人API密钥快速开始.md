# 个人 API 密钥快速开始指南

## 功能简介

个人 API 密钥功能允许用户在 `http://localhost:5173/settings/account/api-keys` 页面创建和管理自己的 API 密钥，用于编程访问 NoteDoc API。

## 快速验证

运行验证脚本：

```bash
bash scripts/verify-personal-api-keys.sh
```

## 启动应用

```bash
# 安装依赖（如果还没有安装）
pnpm install

# 启动开发服务器
pnpm dev
```

## 访问功能

1. 打开浏览器访问：`http://localhost:5173`
2. 登录到你的账户
3. 导航到：`设置 > 账户 > API 密钥`
4. 或直接访问：`http://localhost:5173/settings/account/api-keys`

## 功能测试

### 1. 创建 API 密钥

1. 点击"创建 API 密钥"按钮
2. **步骤 1：基本信息**
   - 输入名称（必填）：例如 "测试密钥"
   - 输入描述（可选）：例如 "用于测试 API 访问"
   - 点击"下一步"

3. **步骤 2：权限**
   - 选择需要的权限范围：
     - 文档：读取、写入、删除
     - 文档库：读取、写入、删除
     - 用户：读取
     - 评论：读取、写入、删除
   - 点击"下一步"

4. **步骤 3：安全**
   - 选择过期时间：
     - 30 天
     - 60 天
     - 90 天
     - 365 天
     - 自定义
     - 永不过期
   - （可选）启用高级安全设置：
     - IP 白名单
     - 速率限制
   - 点击"创建 API 密钥"

5. **保存密钥**
   - ⚠️ **重要**：密钥仅显示一次，请立即复制保存
   - 点击复制按钮复制密钥
   - 点击"我已保存我的 API 密钥"关闭弹窗

### 2. 查看密钥列表

- 在主页面可以看到所有你创建的 API 密钥
- 显示信息包括：
  - 名称
  - 描述
  - 状态（活跃、即将过期、已过期）
  - 创建时间
  - 最后使用时间
  - 过期时间
  - 操作按钮

### 3. 搜索和筛选

- **搜索**：在搜索框中输入密钥名称或描述
- **筛选**：使用状态筛选器
  - 全部
  - 活跃
  - 即将过期
  - 已过期

### 4. 查看密钥详情

1. 点击密钥行的"查看详情"按钮
2. 在右侧抽屉中查看：
   - 基本信息（ID、名称、描述）
   - 权限范围
   - 使用统计
   - 安全设置
   - 日期信息

### 5. 更新密钥

1. 点击密钥行的"编辑"按钮
2. 修改名称、描述或权限
3. 点击"更新"保存更改

### 6. 撤销密钥

1. 点击密钥行的"撤销"按钮
2. 确认撤销操作
3. ⚠️ **注意**：此操作不可撤销，使用该密钥的应用将停止工作

## 与工作区 API 管理的区别

| 特性 | 个人 API 密钥 | 工作区 API 管理 |
|------|--------------|----------------|
| 访问路径 | `/settings/account/api-keys` | `/settings/api-keys` |
| 权限要求 | 所有用户 | 仅管理员 |
| 显示范围 | 仅显示自己创建的密钥 | 显示所有用户的密钥 |
| 创建者列 | 不显示 | 显示创建者信息 |

## API 使用示例

创建密钥后，可以在 HTTP 请求中使用：

```bash
# 使用 curl
curl -H "Authorization: Bearer dk_your_api_key_here" \
     http://localhost:5173/api/pages

# 使用 JavaScript
fetch('http://localhost:5173/api/pages', {
  headers: {
    'Authorization': 'Bearer dk_your_api_key_here'
  }
})
```

## 安全提示

1. ✅ **立即保存**：密钥仅在创建时显示一次
2. ✅ **安全存储**：不要将密钥提交到版本控制系统
3. ✅ **定期轮换**：定期创建新密钥并撤销旧密钥
4. ✅ **最小权限**：仅授予必需的权限
5. ✅ **设置过期**：避免使用永不过期的密钥
6. ✅ **监控使用**：定期检查密钥的使用情况

## 故障排查

### 问题：无法看到 API 密钥菜单

**解决方案**：
- 确保你已登录
- 检查侧边栏的"账户"部分是否有"API 密钥"选项
- 如果没有，可能是权限或配置问题

### 问题：创建密钥失败

**解决方案**：
- 检查网络连接
- 确保后端服务正在运行
- 查看浏览器控制台的错误信息
- 检查后端日志

### 问题：密钥无法使用

**解决方案**：
- 检查密钥是否已过期
- 确认密钥格式正确（以 `dk_` 开头）
- 验证请求头格式：`Authorization: Bearer dk_...`
- 检查密钥是否有足够的权限

## 技术实现

### 前端
- React + TypeScript
- Mantine UI 组件库
- TanStack Query 状态管理
- React Router 路由

### 后端
- NestJS 框架
- PostgreSQL 数据库
- Kysely ORM
- JWT 认证

### 数据流
```
用户操作 → React 组件 → TanStack Query → API 服务 → 
NestJS 控制器 → 服务层 → 数据仓库 → PostgreSQL
```

## 相关文档

- [个人API密钥功能说明.md](./个人API密钥功能说明.md) - 详细的功能说明和实现细节
- [API_MANAGEMENT_FEATURES.md](./API_MANAGEMENT_FEATURES.md) - 工作区 API 管理功能
- [API_KEY_README.md](./API_KEY_README.md) - API 密钥系统总体说明

## 下一步

1. ✅ 功能已实现并验证通过
2. 🔄 启动开发服务器测试功能
3. 📝 根据测试结果调整和优化
4. 🚀 准备部署到生产环境

## 支持

如有问题或建议，请：
1. 查看相关文档
2. 检查验证脚本输出
3. 查看浏览器控制台和后端日志
4. 联系开发团队
