# é£ä¹¦å­æ–‡æ¡£å¯¼å…¥æµ‹è¯•æŒ‡å—

## å½“å‰çŠ¶æ€

âœ… **ä»£ç å·²å®ç°** - é€’å½’å¯¼å…¥é€»è¾‘å·²å®Œæˆ  
âš ï¸ **éœ€è¦æµ‹è¯•** - éœ€è¦éªŒè¯å­æ–‡æ¡£è¯†åˆ«é€»è¾‘  
âš ï¸ **å¯èƒ½éœ€è¦è°ƒæ•´** - å­æ–‡æ¡£å—ç±»å‹å¯èƒ½éœ€è¦æ ¹æ®å®é™… API å“åº”è°ƒæ•´

## é‡è¦è¯´æ˜

### å­æ–‡æ¡£è¯†åˆ«é€»è¾‘

å½“å‰å®ç°åŸºäºä»¥ä¸‹å‡è®¾ï¼š

```typescript
// åœ¨ feishu-api.service.ts ä¸­
for (const block of blocks.items) {
  // å‡è®¾æ–‡æ¡£å¼•ç”¨å—çš„ç±»å‹æ˜¯ 22
  if (block.block_type === 22 && block.file?.token) {
    childDocs.push({
      token: block.file.token,
      title: block.file.name || 'Untitled',
    });
  }
}
```

**è¿™ä¸ªå‡è®¾å¯èƒ½ä¸æ­£ç¡®ï¼** éœ€è¦é€šè¿‡å®é™…æµ‹è¯•æ¥ç¡®å®šï¼š
1. é£ä¹¦æ–‡æ¡£ä¸­çš„å­æ–‡æ¡£å¼•ç”¨ä½¿ç”¨ä»€ä¹ˆ block_type
2. å­æ–‡æ¡£ä¿¡æ¯å­˜å‚¨åœ¨å“ªä¸ªå­—æ®µä¸­
3. æ˜¯å¦æœ‰å…¶ä»–æ–¹å¼è·å–å­æ–‡æ¡£åˆ—è¡¨

## æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šå‡†å¤‡æµ‹è¯•æ–‡æ¡£

åœ¨é£ä¹¦ä¸­åˆ›å»ºæµ‹è¯•æ–‡æ¡£ç»“æ„ï¼š

```
ğŸ“„ ä¸»æµ‹è¯•æ–‡æ¡£
  - æ·»åŠ ä¸€äº›å†…å®¹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ç­‰ï¼‰
  - æ’å…¥å­æ–‡æ¡£é“¾æ¥æˆ–å¼•ç”¨
  
ğŸ“„ å­æ–‡æ¡£ A
  - æ·»åŠ ä¸€äº›å†…å®¹
  
ğŸ“„ å­æ–‡æ¡£ B
  - æ·»åŠ ä¸€äº›å†…å®¹
```

**å¦‚ä½•åœ¨é£ä¹¦ä¸­æ·»åŠ å­æ–‡æ¡£**ï¼š
1. åœ¨ä¸»æ–‡æ¡£ä¸­ï¼Œä½¿ç”¨ `/` å‘½ä»¤
2. æœç´¢"æ–‡æ¡£"æˆ–"å­æ–‡æ¡£"
3. é€‰æ‹©æ’å…¥æ–‡æ¡£å¼•ç”¨
4. é€‰æ‹©å­æ–‡æ¡£ A å’Œå­æ–‡æ¡£ B

### æ­¥éª¤ 2ï¼šæŸ¥çœ‹ Blocks API å“åº”

åœ¨å¯¼å…¥å‰ï¼Œå…ˆæŸ¥çœ‹ blocks API è¿”å›çš„æ•°æ®ç»“æ„ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„ blocks ç»“æ„
tail -f apps/server/logs/app.log | grep -A 50 "Blocks items count"
```

æˆ–è€…æ·»åŠ ä¸´æ—¶è°ƒè¯•ä»£ç ï¼š

```typescript
// åœ¨ feishu-api.service.ts çš„ getChildDocuments æ–¹æ³•ä¸­
this.logger.debug(`=== All Blocks ===`);
this.logger.debug(JSON.stringify(blocks.items, null, 2));
```

### æ­¥éª¤ 3ï¼šæ‰§è¡Œå¯¼å…¥

1. è®¿é—® NoteDoc
2. è¿›å…¥é£ä¹¦é›†æˆè®¾ç½®
3. ç‚¹å‡»"åœ¨çº¿å¯¼å…¥"
4. ç²˜è´´ä¸»æµ‹è¯•æ–‡æ¡£çš„ URL
5. ç¡®ä¿ includeChildren ä¸º trueï¼ˆé»˜è®¤ï¼‰
6. ç‚¹å‡»å¯¼å…¥

### æ­¥éª¤ 4ï¼šæŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å­æ–‡æ¡£ç›¸å…³æ—¥å¿—
tail -f apps/server/logs/app.log | grep -E "child|Child|Importing document|Found.*child"
```

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—**ï¼š

```
[FeishuImportService] Starting Feishu import for user xxx, includeChildren: true
[FeishuImportService] Importing document: doccnxxxxx, parent: none
[FeishuApiService] Fetching child documents for token: doccnxxxxx
[FeishuApiService] Found 2 child documents
[FeishuImportService] Found 2 child documents for doccnxxxxx
[FeishuImportService] Importing document: doccnyyyyy, parent: page-1
[FeishuImportService] Created page page-2 from Feishu document doccnyyyyy
```

**å¦‚æœæ²¡æœ‰æ‰¾åˆ°å­æ–‡æ¡£**ï¼š

```
[FeishuApiService] Fetching child documents for token: doccnxxxxx
[FeishuApiService] Found 0 child documents
[FeishuImportService] No child documents found for doccnxxxxx
```

è¿™è¯´æ˜å­æ–‡æ¡£è¯†åˆ«é€»è¾‘éœ€è¦è°ƒæ•´ã€‚

### æ­¥éª¤ 5ï¼šåˆ†æ Blocks æ•°æ®

å¦‚æœæ²¡æœ‰æ‰¾åˆ°å­æ–‡æ¡£ï¼Œéœ€è¦åˆ†æ blocks æ•°æ®ï¼š

1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å®Œæ•´ blocks æ•°æ®
2. æ‰¾åˆ°å­æ–‡æ¡£å¼•ç”¨å¯¹åº”çš„ block
3. ç¡®å®šæ­£ç¡®çš„ block_type å’Œå­—æ®µå

**å¯èƒ½çš„ block ç»“æ„**ï¼š

```json
{
  "block_type": XX,  // éœ€è¦ç¡®å®šçš„ç±»å‹
  "block_id": "xxx",
  "parent_id": "xxx",
  // å¯èƒ½çš„å­—æ®µï¼š
  "file": {
    "token": "doccnxxxxx",
    "name": "å­æ–‡æ¡£ A"
  },
  // æˆ–è€…
  "link": {
    "url": "https://xxx.feishu.cn/docx/xxxxx",
    "text": "å­æ–‡æ¡£ A"
  },
  // æˆ–è€…å…¶ä»–ç»“æ„
}
```

### æ­¥éª¤ 6ï¼šè°ƒæ•´ä»£ç 

æ ¹æ®å®é™…çš„ blocks æ•°æ®ç»“æ„ï¼Œè°ƒæ•´ `getChildDocuments` æ–¹æ³•ï¼š

```typescript
async getChildDocuments(client: AxiosInstance, documentToken: string): Promise<any[]> {
  try {
    this.logger.debug(`Fetching child documents for token: ${documentToken}`);
    
    const blocks = await this.getDocumentBlocks(client, documentToken);
    
    if (!blocks || !blocks.items) {
      return [];
    }
    
    const childDocs: any[] = [];
    
    // éå†æ‰€æœ‰ blocksï¼Œè¾“å‡ºè¯¦ç»†ä¿¡æ¯
    for (const block of blocks.items) {
      this.logger.debug(`Block type: ${block.block_type}, keys: ${Object.keys(block).join(', ')}`);
      
      // å°è¯•ä¸åŒçš„è¯†åˆ«æ–¹å¼
      
      // æ–¹å¼ 1: æ–‡ä»¶å¼•ç”¨
      if (block.file?.token) {
        this.logger.debug(`Found file reference: ${block.file.token}`);
        childDocs.push({
          token: block.file.token,
          title: block.file.name || 'Untitled',
        });
      }
      
      // æ–¹å¼ 2: é“¾æ¥å¼•ç”¨
      if (block.link?.url) {
        const token = this.extractDocumentToken(block.link.url);
        if (token) {
          this.logger.debug(`Found link reference: ${token}`);
          childDocs.push({
            token: token,
            title: block.link.text || 'Untitled',
          });
        }
      }
      
      // æ–¹å¼ 3: å…¶ä»–å¯èƒ½çš„æ–¹å¼
      // æ ¹æ®å®é™…æ•°æ®ç»“æ„æ·»åŠ 
    }
    
    this.logger.debug(`Found ${childDocs.length} child documents`);
    return childDocs;
  } catch (error) {
    this.logger.error(`Failed to get child documents for ${documentToken}`, error);
    return [];
  }
}
```

## å¯èƒ½çš„åœºæ™¯

### åœºæ™¯ 1ï¼šé£ä¹¦æ²¡æœ‰å­æ–‡æ¡£æ¦‚å¿µ

å¦‚æœé£ä¹¦æ–‡æ¡£æœ¬èº«æ²¡æœ‰"å­æ–‡æ¡£"çš„æ¦‚å¿µï¼Œåªæœ‰æ–‡æ¡£ä¹‹é—´çš„é“¾æ¥ï¼Œé‚£ä¹ˆï¼š

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¯†åˆ«æ–‡æ¡£é“¾æ¥å—
- æå–é“¾æ¥ä¸­çš„æ–‡æ¡£ token
- ä½œä¸º"å­æ–‡æ¡£"å¯¼å…¥

### åœºæ™¯ 2ï¼šéœ€è¦ä½¿ç”¨ä¸åŒçš„ API

å¦‚æœ blocks API ä¸åŒ…å«å­æ–‡æ¡£ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»– APIï¼š

**å¯èƒ½çš„ API**ï¼š
```typescript
// è·å–æ–‡æ¡£çš„å­èŠ‚ç‚¹
GET /docx/v1/documents/{document_id}/children

// æˆ–è€…è·å–æ–‡æ¡£æ ‘
GET /drive/v1/files/{file_token}/children
```

### åœºæ™¯ 3ï¼šå­æ–‡æ¡£åœ¨æ–‡æ¡£å…ƒæ•°æ®ä¸­

å­æ–‡æ¡£ä¿¡æ¯å¯èƒ½åœ¨æ–‡æ¡£å…ƒæ•°æ®ä¸­ï¼š

```typescript
async getDocumentMeta(client: AxiosInstance, documentToken: string): Promise<any> {
  const response = await client.get(`/docx/v1/documents/${documentToken}`);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ children å­—æ®µ
  if (response.data.data.document.children) {
    this.logger.debug(`Found children in metadata: ${JSON.stringify(response.data.data.document.children)}`);
  }
  
  return response.data.data.document;
}
```

## è°ƒè¯•æŠ€å·§

### 1. æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨ `getChildDocuments` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```typescript
// è¾“å‡ºæ‰€æœ‰ blocks çš„ç±»å‹
const blockTypes = blocks.items.map((b: any) => b.block_type);
this.logger.debug(`All block types: ${JSON.stringify(blockTypes)}`);

// è¾“å‡ºåŒ…å« file å­—æ®µçš„ blocks
const fileBlocks = blocks.items.filter((b: any) => b.file);
this.logger.debug(`Blocks with file: ${JSON.stringify(fileBlocks, null, 2)}`);

// è¾“å‡ºåŒ…å« link å­—æ®µçš„ blocks
const linkBlocks = blocks.items.filter((b: any) => b.link);
this.logger.debug(`Blocks with link: ${JSON.stringify(linkBlocks, null, 2)}`);
```

### 2. ä½¿ç”¨æµ‹è¯•è„šæœ¬

åˆ›å»ºä¸€ä¸ªæµ‹è¯•è„šæœ¬æ¥æŸ¥çœ‹ blocks æ•°æ®ï¼š

```bash
# scripts/test-feishu-blocks.sh
#!/bin/bash

APP_ID=$1
APP_SECRET=$2
DOC_TOKEN=$3

# è·å– token
TOKEN=$(curl -s -X POST 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal' \
  -H 'Content-Type: application/json' \
  -d "{\"app_id\":\"$APP_ID\",\"app_secret\":\"$APP_SECRET\"}" | \
  grep -o '"tenant_access_token":"[^"]*' | cut -d'"' -f4)

# è·å– blocks
curl -s -X GET "https://open.feishu.cn/open-apis/docx/v1/documents/$DOC_TOKEN/blocks?page_size=500" \
  -H "Authorization: Bearer $TOKEN" | jq '.'
```

### 3. æŸ¥é˜…é£ä¹¦ API æ–‡æ¡£

è®¿é—®é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£ï¼š
- https://open.feishu.cn/document/server-docs/docs/docx-v1/document/list
- https://open.feishu.cn/document/server-docs/docs/drive-v1/file/list

æŸ¥æ‰¾å…³äºå­æ–‡æ¡£æˆ–æ–‡æ¡£å…³ç³»çš„ APIã€‚

## æµ‹è¯•æ¸…å•

- [ ] å‡†å¤‡åŒ…å«å­æ–‡æ¡£çš„æµ‹è¯•æ–‡æ¡£
- [ ] æ‰§è¡Œå¯¼å…¥å¹¶æŸ¥çœ‹æ—¥å¿—
- [ ] ç¡®è®¤æ˜¯å¦æ‰¾åˆ°å­æ–‡æ¡£
- [ ] å¦‚æœæœªæ‰¾åˆ°ï¼Œåˆ†æ blocks æ•°æ®ç»“æ„
- [ ] è°ƒæ•´ `getChildDocuments` æ–¹æ³•
- [ ] é‡æ–°æµ‹è¯•
- [ ] éªŒè¯æ–‡æ¡£å±‚çº§ç»“æ„æ­£ç¡®
- [ ] æµ‹è¯•å¤šçº§å­æ–‡æ¡£ï¼ˆ3 å±‚ä»¥ä¸Šï¼‰
- [ ] æµ‹è¯•ç¦ç”¨å­æ–‡æ¡£å¯¼å…¥

## é¢„æœŸç»“æœ

### æˆåŠŸåœºæ™¯

1. ä¸»æ–‡æ¡£å’Œæ‰€æœ‰å­æ–‡æ¡£éƒ½æˆåŠŸå¯¼å…¥
2. æ–‡æ¡£å±‚çº§ç»“æ„æ­£ç¡®
3. çˆ¶å­å…³ç³»æ­£ç¡®å»ºç«‹
4. æ‰€æœ‰æ–‡æ¡£å†…å®¹å®Œæ•´

### éœ€è¦è°ƒæ•´çš„åœºæ™¯

1. æ²¡æœ‰æ‰¾åˆ°å­æ–‡æ¡£ â†’ è°ƒæ•´è¯†åˆ«é€»è¾‘
2. æ‰¾åˆ°äº†é”™è¯¯çš„æ–‡æ¡£ â†’ è°ƒæ•´è¿‡æ»¤æ¡ä»¶
3. å¯¼å…¥å¤±è´¥ â†’ æ£€æŸ¥æƒé™å’Œé”™è¯¯æ—¥å¿—

## ä¸‹ä¸€æ­¥

æ ¹æ®æµ‹è¯•ç»“æœï¼š

1. **å¦‚æœæˆåŠŸ** â†’ æ·»åŠ å‰ç«¯é€‰é¡¹ï¼Œå®Œå–„æ–‡æ¡£
2. **å¦‚æœå¤±è´¥** â†’ æ ¹æ®å®é™… API å“åº”è°ƒæ•´ä»£ç 
3. **å¦‚æœä¸æ”¯æŒ** â†’ è€ƒè™‘å…¶ä»–å®ç°æ–¹å¼æˆ–ç§»é™¤æ­¤åŠŸèƒ½

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é‡è¦æç¤º**ï¼šå½“å‰å®ç°åŸºäºå‡è®¾ï¼Œéœ€è¦é€šè¿‡å®é™…æµ‹è¯•éªŒè¯å’Œè°ƒæ•´ï¼
