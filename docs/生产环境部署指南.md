# NoteDoc 生产环境部署指南

## 概述

本文档提供 NoteDoc 在生产环境中的完整部署方案，包括 Docker 部署、手动部署和云平台部署等多种方式。

## 部署方案对比

| 方案 | 难度 | 适用场景 | 优点 | 缺点 |
|------|------|----------|------|------|
| Docker Compose | ⭐ | 小型团队、快速部署 | 一键部署、易维护 | 需要 Docker 环境 |
| 手动部署 | ⭐⭐⭐ | 自定义需求、大型部署 | 完全控制、性能优化 | 配置复杂 |
| Vercel | ⭐ | 个人/小团队、测试 | 免费、自动部署 | 需要外部数据库 |
| 宝塔面板 | ⭐⭐ | 国内服务器、可视化管理 | 图形界面、易操作 | 需要宝塔环境 |
| Kubernetes | ⭐⭐⭐⭐ | 大规模、高可用 | 自动扩展、容错 | 运维复杂 |

## 方案一：Docker Compose 部署（推荐）

### 优势

- 一键启动所有服务
- 自动管理依赖关系
- 易于备份和迁移
- 适合生产环境

### 部署步骤

#### 1. 准备服务器

```bash
# 最低配置要求
# - CPU: 2核
# - 内存: 4GB
# - 磁盘: 20GB
# - 操作系统: Ubuntu 20.04+ / CentOS 8+ / Debian 11+

# 安装 Docker
curl -fsSL https://get.docker.com | bash

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 2. 下载配置文件

```bash
# 创建项目目录
mkdir -p /opt/notedoc
cd /opt/notedoc

# 下载 docker-compose.yml
curl -O https://raw.githubusercontent.com/onlinedear/wiki/main/docker-compose.yml

# 或者手动创建（见下方配置）
```

#### 3. 配置 docker-compose.yml

```yaml
services:
  notedoc:
    image: notedoc/notedoc:latest
    depends_on:
      - db
      - redis
    environment:
      # 应用访问地址（修改为你的域名）
      APP_URL: 'https://your-domain.com'
      
      # 应用密钥（必须修改，至少32字符）
      APP_SECRET: 'REPLACE_WITH_LONG_SECRET_GENERATED_BY_OPENSSL'
      
      # 数据库连接
      DATABASE_URL: 'postgresql://notedoc:STRONG_DB_PASSWORD@db:5432/notedoc?schema=public'
      
      # Redis 连接
      REDIS_URL: 'redis://redis:6379'
      
      # JWT 令牌过期时间
      JWT_TOKEN_EXPIRES_IN: '30d'
      
      # 存储驱动（local 或 s3）
      STORAGE_DRIVER: 'local'
      
      # 邮件配置（可选）
      MAIL_DRIVER: 'smtp'
      MAIL_FROM_ADDRESS: 'noreply@your-domain.com'
      MAIL_FROM_NAME: 'NoteDoc'
      SMTP_HOST: 'smtp.gmail.com'
      SMTP_PORT: '587'
      SMTP_USERNAME: 'your-email@gmail.com'
      SMTP_PASSWORD: 'your-app-password'
      SMTP_SECURE: 'false'
      
      # 文件上传大小限制（默认 50MB）
      FILE_UPLOAD_SIZE_LIMIT: '50mb'
      
      # 禁用遥测（可选）
      DISABLE_TELEMETRY: 'true'
      
    ports:
      - "3000:3000"
    restart: unless-stopped
    volumes:
      - notedoc_data:/app/data/storage
    networks:
      - notedoc_network

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: notedoc
      POSTGRES_USER: notedoc
      # 修改为强密码
      POSTGRES_PASSWORD: STRONG_DB_PASSWORD
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - notedoc_network
    # 可选：暴露端口用于备份
    # ports:
    #   - "5432:5432"

  redis:
    image: redis:7.2-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - notedoc_network
    # Redis 持久化配置
    command: redis-server --appendonly yes

volumes:
  notedoc_data:
  postgres_data:
  redis_data:

networks:
  notedoc_network:
    driver: bridge
```

#### 4. 生成安全密钥

```bash
# 生成 APP_SECRET（32字节十六进制）
openssl rand -hex 32

# 生成数据库密码（24字节 base64）
openssl rand -base64 24

# 将生成的密钥替换到 docker-compose.yml 中
```

#### 5. 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f notedoc

# 等待服务启动（约30秒）
```

#### 6. 配置反向代理（Nginx）

```bash
# 安装 Nginx
sudo apt install nginx -y

# 创建配置文件
sudo nano /etc/nginx/sites-available/notedoc
```

Nginx 配置内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL 证书配置（使用 Let's Encrypt）
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 客户端最大上传大小
    client_max_body_size 50M;
    
    # 代理配置
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # WebSocket 支持
        proxy_read_timeout 86400;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/notedoc /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 7. 配置 SSL 证书（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

#### 8. 配置防火墙

```bash
# UFW 防火墙配置
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# 或者 firewalld（CentOS）
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 验证部署

```bash
# 检查服务状态
docker-compose ps

# 检查健康状态
curl http://localhost:3000/api/health

# 访问应用
# 浏览器打开: https://your-domain.com
```

## 方案二：使用 S3 对象存储

如果需要使用 S3 存储文件（推荐用于生产环境），修改 docker-compose.yml：

```yaml
services:
  notedoc:
    environment:
      # 存储驱动改为 s3
      STORAGE_DRIVER: 's3'
      
      # S3 配置
      AWS_S3_ACCESS_KEY_ID: 'your-access-key'
      AWS_S3_SECRET_ACCESS_KEY: 'your-secret-key'
      AWS_S3_REGION: 'us-east-1'
      AWS_S3_BUCKET: 'your-bucket-name'
      
      # 如果使用兼容 S3 的服务（如 MinIO、阿里云 OSS）
      AWS_S3_ENDPOINT: 'https://s3.your-provider.com'
      AWS_S3_FORCE_PATH_STYLE: 'true'
```

### 支持的 S3 兼容服务

- AWS S3
- MinIO
- 阿里云 OSS
- 腾讯云 COS
- 七牛云 Kodo
- DigitalOcean Spaces
- Backblaze B2

## 方案三：手动部署

### 适用场景

- 需要完全控制部署过程
- 自定义优化和配置
- 已有数据库和 Redis 服务

### 部署步骤

#### 1. 安装依赖

```bash
# 安装 Node.js 20+
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 pnpm
npm install -g pnpm@10.4.0

# 安装 PostgreSQL 16
sudo apt install postgresql-16 postgresql-contrib-16

# 安装 Redis
sudo apt install redis-server

# 启动服务
sudo systemctl start postgresql
sudo systemctl start redis
sudo systemctl enable postgresql
sudo systemctl enable redis
```

#### 2. 配置数据库

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 创建数据库和用户
CREATE DATABASE notedoc;
CREATE USER notedoc WITH ENCRYPTED PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE notedoc TO notedoc;
\q
```

#### 3. 克隆和构建项目

```bash
# 克隆仓库
git clone https://github.com/onlinedear/wiki.git /opt/notedoc
cd /opt/notedoc

# 安装依赖
pnpm install

# 配置环境变量
cp .env.example .env
nano .env
```

编辑 `.env` 文件：

```bash
APP_URL=https://your-domain.com
PORT=3000
APP_SECRET=your_generated_secret_key
JWT_TOKEN_EXPIRES_IN=30d

DATABASE_URL=postgresql://notedoc:your_strong_password@localhost:5432/notedoc?schema=public
REDIS_URL=redis://127.0.0.1:6379

STORAGE_DRIVER=local
MAIL_DRIVER=smtp
# ... 其他配置
```

```bash
# 运行数据库迁移
cd apps/server
pnpm migration:up
cd ../..

# 构建项目
pnpm build

# 测试启动
pnpm start
```

#### 4. 配置 PM2 进程管理

```bash
# 安装 PM2
npm install -g pm2

# 创建 PM2 配置文件
nano ecosystem.config.js
```

PM2 配置内容：

```javascript
module.exports = {
  apps: [
    {
      name: 'notedoc',
      script: 'pnpm',
      args: 'start',
      cwd: '/opt/notedoc',
      instances: 2,
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
      },
      error_file: '/var/log/notedoc/error.log',
      out_file: '/var/log/notedoc/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    },
  ],
};
```

```bash
# 创建日志目录
sudo mkdir -p /var/log/notedoc
sudo chown -R $USER:$USER /var/log/notedoc

# 启动应用
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status
pm2 logs notedoc
```

## 方案四：宝塔面板部署

详细步骤请参考：[宝塔面板部署指南](./宝塔面板部署指南.md)

简要步骤：

1. 安装宝塔面板
2. 安装 Docker 管理器
3. 上传 docker-compose.yml
4. 配置环境变量
5. 启动容器
6. 配置反向代理和 SSL

## 数据备份和恢复

### 备份

```bash
# 备份 PostgreSQL 数据库
docker-compose exec db pg_dump -U notedoc notedoc > backup_$(date +%Y%m%d).sql

# 备份文件存储
docker-compose exec notedoc tar -czf /tmp/storage_backup.tar.gz /app/data/storage
docker cp notedoc:/tmp/storage_backup.tar.gz ./storage_backup_$(date +%Y%m%d).tar.gz

# 或者备份整个 Docker 卷
docker run --rm -v notedoc_notedoc_data:/data -v $(pwd):/backup alpine tar -czf /backup/notedoc_data_$(date +%Y%m%d).tar.gz /data
```

### 恢复

```bash
# 恢复数据库
docker-compose exec -T db psql -U notedoc notedoc < backup_20241127.sql

# 恢复文件存储
docker cp storage_backup_20241127.tar.gz notedoc:/tmp/
docker-compose exec notedoc tar -xzf /tmp/storage_backup.tar.gz -C /
```

### 自动备份脚本

```bash
#!/bin/bash
# /opt/notedoc/backup.sh

BACKUP_DIR="/opt/notedoc/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose -f /opt/notedoc/docker-compose.yml exec -T db pg_dump -U notedoc notedoc | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 备份文件
docker run --rm -v notedoc_notedoc_data:/data -v $BACKUP_DIR:/backup alpine tar -czf /backup/files_$DATE.tar.gz /data

# 删除30天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

```bash
# 添加到 crontab（每天凌晨2点备份）
crontab -e
# 添加：
0 2 * * * /opt/notedoc/backup.sh >> /var/log/notedoc/backup.log 2>&1
```

## 监控和维护

### 查看日志

```bash
# Docker 部署
docker-compose logs -f notedoc
docker-compose logs -f db
docker-compose logs -f redis

# PM2 部署
pm2 logs notedoc
```

### 性能监控

```bash
# 查看资源使用
docker stats

# 查看数据库连接
docker-compose exec db psql -U notedoc -c "SELECT count(*) FROM pg_stat_activity;"

# 查看 Redis 信息
docker-compose exec redis redis-cli info
```

### 更新应用

```bash
# Docker 部署
cd /opt/notedoc
docker-compose pull
docker-compose up -d

# 手动部署
cd /opt/notedoc
git pull
pnpm install
pnpm build
pm2 restart notedoc
```

## 安全加固

### 1. 数据库安全

```bash
# 修改 PostgreSQL 配置
sudo nano /etc/postgresql/16/main/pg_hba.conf

# 只允许本地连接
# local   all             all                                     peer
# host    all             all             127.0.0.1/32            scram-sha-256
```

### 2. Redis 安全

```bash
# 配置 Redis 密码
sudo nano /etc/redis/redis.conf

# 添加：
requirepass your_redis_password
bind 127.0.0.1

# 重启 Redis
sudo systemctl restart redis
```

### 3. 应用安全

- 使用强密码（APP_SECRET 至少 32 字符）
- 启用 HTTPS（必须）
- 配置 CORS 白名单
- 定期更新依赖
- 启用防火墙
- 配置失败登录限制

### 4. 系统安全

```bash
# 禁用 root SSH 登录
sudo nano /etc/ssh/sshd_config
# PermitRootLogin no

# 配置自动安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

## 性能优化

### 1. PostgreSQL 优化

```sql
-- 调整连接池大小
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET effective_io_concurrency = 200;

-- 重启生效
SELECT pg_reload_conf();
```

### 2. Redis 优化

```bash
# 配置最大内存
maxmemory 512mb
maxmemory-policy allkeys-lru

# 启用持久化
appendonly yes
appendfsync everysec
```

### 3. Nginx 优化

```nginx
# 启用 gzip 压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;

# 启用缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## 故障排查

### 应用无法启动

```bash
# 检查端口占用
sudo netstat -tlnp | grep 3000

# 检查环境变量
docker-compose config

# 查看详细日志
docker-compose logs --tail=100 notedoc
```

### 数据库连接失败

```bash
# 测试数据库连接
docker-compose exec db psql -U notedoc -d notedoc -c "SELECT 1;"

# 检查数据库日志
docker-compose logs db
```

### 文件上传失败

```bash
# 检查存储目录权限
docker-compose exec notedoc ls -la /app/data/storage

# 检查磁盘空间
df -h
```

## 相关文档

- [本地开发环境启动指南](./本地开发环境启动指南.md)
- [Vercel 部署指南](./Vercel部署指南.md)
- [宝塔面板部署指南](./宝塔面板部署指南.md)
- [一键部署方案](./一键部署方案.md)

## 技术支持

- GitHub Issues: https://github.com/onlinedear/wiki/issues
- 讨论区: https://github.com/onlinedear/wiki/discussions
- 官方文档: https://notedoc.cn/docs

## 总结

本指南涵盖了 NoteDoc 的多种生产环境部署方案，推荐使用 Docker Compose 方式进行部署，它提供了最佳的易用性和可维护性平衡。根据你的具体需求选择合适的部署方案，并遵循安全和性能优化建议。
