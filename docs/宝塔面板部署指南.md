# 宝塔面板部署 Docmost 完整指南

本指南将帮助你在安装了宝塔面板的服务器上部署 Docmost 协作文档平台。

## 前置要求

- 已安装宝塔面板（Linux 版本 7.x 或更高）
- 服务器配置建议：2核CPU、4GB内存、20GB硬盘
- 已绑定域名（可选，建议用于生产环境）

## 一、安装 Docker 环境

### 1.1 安装 Docker 管理器

1. 登录宝塔面板
2. 点击左侧菜单 **软件商店**
3. 搜索 **Docker 管理器**
4. 点击 **安装**，等待安装完成

### 1.2 验证 Docker 安装

安装完成后，在宝塔面板左侧菜单会出现 **Docker** 选项。

或者通过 SSH 终端验证：
```bash
docker --version
docker-compose --version
```

## 二、准备部署文件

### 2.1 创建项目目录

通过宝塔面板的 **文件** 管理器或 SSH 终端创建目录：

```bash
# 创建项目目录
mkdir -p /www/wwwroot/docmost
cd /www/wwwroot/docmost
```

### 2.2 创建 docker-compose.yml

在 `/www/wwwroot/docmost` 目录下创建 `docker-compose.yml` 文件：

```yaml
services:
  docmost:
    image: docmost/docmost:latest
    container_name: docmost
    depends_on:
      - db
      - redis
    environment:
      APP_URL: 'https://your-domain.com'  # 改为你的域名
      APP_SECRET: 'your-secret-key-here'  # 改为随机密钥
      DATABASE_URL: 'postgresql://docmost:your-db-password@db:5432/docmost?schema=public'
      REDIS_URL: 'redis://redis:6379'
    ports:
      - "3000:3000"
    restart: unless-stopped
    volumes:
      - docmost_data:/app/data/storage

  db:
    image: postgres:16-alpine
    container_name: docmost_db
    environment:
      POSTGRES_DB: docmost
      POSTGRES_USER: docmost
      POSTGRES_PASSWORD: your-db-password  # 改为强密码
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7.2-alpine
    container_name: docmost_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  docmost_data:
  db_data:
  redis_data:
```

### 2.3 生成安全密钥

通过 SSH 终端生成随机密钥：

```bash
# 生成 APP_SECRET（至少32字符）
openssl rand -hex 32

# 生成数据库密码
openssl rand -base64 24
```

将生成的密钥替换到 `docker-compose.yml` 中的对应位置：
- `APP_SECRET`: 替换 `your-secret-key-here`
- `POSTGRES_PASSWORD` 和 `DATABASE_URL` 中的密码: 替换 `your-db-password`
- `APP_URL`: 替换为你的域名（如 `https://doc.example.com`）

## 三、启动服务

### 3.1 使用宝塔 Docker 管理器启动

1. 打开宝塔面板的 **Docker** 菜单
2. 点击 **容器** 标签
3. 点击右上角 **添加容器**
4. 选择 **Compose** 方式
5. 项目名称填写：`docmost`
6. 项目路径选择：`/www/wwwroot/docmost`
7. 点击 **确定** 启动

### 3.2 或使用命令行启动

通过 SSH 终端：

```bash
cd /www/wwwroot/docmost
docker-compose up -d
```

### 3.3 查看启动状态

```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f docmost
```

等待所有容器状态变为 `Up`，通常需要 1-2 分钟。

## 四、配置反向代理（推荐）

### 4.1 添加网站

1. 在宝塔面板点击 **网站**
2. 点击 **添加站点**
3. 填写域名（如 `doc.example.com`）
4. 选择 **纯静态**
5. 点击 **提交**

### 4.2 配置反向代理

1. 找到刚创建的网站，点击 **设置**
2. 点击左侧 **反向代理**
3. 点击 **添加反向代理**
4. 填写配置：
   - 代理名称：`docmost`
   - 目标URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
5. 点击 **提交**

### 4.3 配置 SSL 证书（推荐）

1. 在网站设置中点击 **SSL**
2. 选择 **Let's Encrypt** 免费证书
3. 勾选你的域名
4. 点击 **申请**
5. 申请成功后，开启 **强制HTTPS**

### 4.4 修改 APP_URL

SSL 配置完成后，需要更新 `docker-compose.yml` 中的 `APP_URL`：

```yaml
APP_URL: 'https://doc.example.com'  # 使用 https
```

然后重启容器：
```bash
cd /www/wwwroot/docmost
docker-compose down
docker-compose up -d
```

## 五、配置防火墙

### 5.1 宝塔面板防火墙

1. 点击 **安全**
2. 如果使用反向代理，**不需要**开放 3000 端口
3. 确保开放了 80 和 443 端口（HTTP/HTTPS）

### 5.2 服务器防火墙

如果使用云服务器（阿里云、腾讯云等），需要在安全组中开放：
- 80 端口（HTTP）
- 443 端口（HTTPS）

## 六、首次访问和初始化

### 6.1 访问网站

打开浏览器访问你配置的域名：`https://doc.example.com`

### 6.2 创建管理员账户

首次访问会进入初始化页面：
1. 填写工作空间名称
2. 设置管理员邮箱
3. 设置管理员密码
4. 点击 **创建工作空间**

### 6.3 开始使用

初始化完成后，使用管理员账户登录即可开始使用。

## 七、日常维护

### 7.1 查看日志

通过宝塔 Docker 管理器：
1. 打开 **Docker** > **容器**
2. 找到 `docmost` 容器
3. 点击 **日志** 查看

或通过命令行：
```bash
cd /www/wwwroot/docmost
docker-compose logs -f docmost
```

### 7.2 重启服务

```bash
cd /www/wwwroot/docmost
docker-compose restart
```

### 7.3 停止服务

```bash
cd /www/wwwroot/docmost
docker-compose down
```

### 7.4 更新版本

```bash
cd /www/wwwroot/docmost

# 拉取最新镜像
docker-compose pull

# 重启服务
docker-compose down
docker-compose up -d
```

### 7.5 备份数据

备份重要的 Docker 卷：

```bash
# 备份数据库
docker exec docmost_db pg_dump -U docmost docmost > /www/backup/docmost_db_$(date +%Y%m%d).sql

# 备份文件存储
docker run --rm -v docmost_docmost_data:/data -v /www/backup:/backup alpine tar czf /backup/docmost_files_$(date +%Y%m%d).tar.gz -C /data .
```

建议使用宝塔面板的 **计划任务** 功能设置自动备份。

## 八、故障排查

### 8.1 容器无法启动

检查日志：
```bash
docker-compose logs
```

常见问题：
- 端口被占用：修改 `docker-compose.yml` 中的端口映射
- 配置错误：检查环境变量是否正确设置

### 8.2 无法访问网站

1. 检查容器是否运行：`docker-compose ps`
2. 检查防火墙设置
3. 检查反向代理配置
4. 检查域名解析是否正确

### 8.3 数据库连接失败

1. 确保 `DATABASE_URL` 中的密码与 `POSTGRES_PASSWORD` 一致
2. 检查数据库容器是否正常运行
3. 查看数据库日志：`docker-compose logs db`

### 8.4 性能优化

如果访问较慢，可以：
1. 增加服务器配置
2. 在宝塔面板安装 **Nginx** 并启用缓存
3. 配置 CDN 加速静态资源

## 九、安全建议

1. **定期更新**：及时更新 Docmost 到最新版本
2. **强密码**：使用复杂的数据库密码和 APP_SECRET
3. **SSL 证书**：始终使用 HTTPS 访问
4. **定期备份**：设置自动备份任务
5. **限制访问**：如果是内部使用，可以在宝塔面板配置 IP 白名单
6. **监控日志**：定期检查访问日志和错误日志

## 十、进阶配置

### 10.1 配置邮件服务

编辑 `docker-compose.yml`，在 `docmost` 服务的 `environment` 中添加：

```yaml
MAIL_DRIVER: smtp
MAIL_HOST: smtp.example.com
MAIL_PORT: 587
MAIL_USERNAME: your-email@example.com
MAIL_PASSWORD: your-email-password
MAIL_FROM_ADDRESS: noreply@example.com
MAIL_FROM_NAME: Docmost
```

### 10.2 配置对象存储（S3）

如果需要使用对象存储替代本地存储：

```yaml
STORAGE_DRIVER: s3
AWS_S3_BUCKET: your-bucket-name
AWS_S3_REGION: your-region
AWS_ACCESS_KEY_ID: your-access-key
AWS_SECRET_ACCESS_KEY: your-secret-key
```

### 10.3 配置搜索服务（可选）

Docmost 支持 Typesense 全文搜索，可以提升搜索性能。

## 支持与帮助

- 官方文档：https://docmost.com/docs
- GitHub 仓库：https://github.com/docmost/docmost
- 问题反馈：https://github.com/docmost/docmost/issues

---

**部署完成！** 现在你可以开始使用 Docmost 进行团队协作了。
