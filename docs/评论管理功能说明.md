# 评论管理功能

## 功能概述

在工作区设置页面（`/settings/workspace`）的左侧菜单中添加了"评论管理"功能，允许管理员查看和管理工作区内的所有评论。

## 功能特性

### 1. 评论列表
- 显示工作区内所有评论
- 包含以下信息：
  - 作者（头像和名称）
  - 评论内容（最多显示2行）
  - 所属页面
  - 所属空间
  - 创建时间（相对时间，如"2小时前"）

### 2. 搜索和筛选
- **搜索**：按评论内容搜索
- **类型筛选**：
  - 行内评论（inline）
  - 页面评论（page）

### 3. 批量操作
- **全选/取消全选**：点击表头的复选框
- **单选**：点击每行的复选框
- **批量删除**：选中多条评论后点击"删除"按钮

### 4. 单个操作
- 每行末尾有删除按钮，可以快速删除单条评论

### 5. 分页
- 每页显示 20 条评论
- 底部有分页控件

### 6. 统计信息
- 显示评论总数
- 显示已选中的评论数量

## 权限控制

- 只有工作区管理员（admin 或 owner 角色）可以访问此功能
- 非管理员访问会返回 403 错误

## 技术实现

### 前端

#### 页面组件
- **文件**: `apps/client/src/pages/settings/comment/comment-management.tsx`
- **路由**: `/settings/comments`
- **功能**:
  - 评论列表展示
  - 搜索和筛选
  - 批量选择和删除
  - 分页

#### 查询和服务
- **查询**: `apps/client/src/features/comment/queries/comment-management-query.ts`
  - `useWorkspaceCommentsQuery`: 获取工作区评论列表
  - `useDeleteCommentsMutation`: 批量删除评论

- **服务**: `apps/client/src/features/comment/services/comment-management-service.ts`
  - `getWorkspaceComments`: API 调用获取评论
  - `deleteComments`: API 调用批量删除

#### 侧边栏菜单
- **文件**: `apps/client/src/components/settings/settings-sidebar.tsx`
- 在 "Workspace" 分组下添加了"评论管理"菜单项
- 图标：`IconMessageCircle`
- 仅管理员可见

### 后端

#### API 端点

1. **获取工作区评论列表**
   - 端点：`POST /api/comments/workspace/list`
   - 权限：仅管理员
   - 参数：
     ```typescript
     {
       page?: number;
       limit?: number;
       searchText?: string;
       type?: string;
       creatorId?: string;
     }
     ```
   - 响应：分页的评论列表，包含作者、页面、空间信息

2. **批量删除评论**
   - 端点：`POST /api/comments/workspace/delete-batch`
   - 权限：仅管理员
   - 参数：
     ```typescript
     {
       commentIds: string[];
     }
     ```
   - 响应：`{ deleted: number }`

#### 服务层
- **文件**: `apps/server/src/core/comment/comment.service.ts`
- **方法**:
  - `getWorkspaceComments`: 获取工作区评论
  - `deleteBatchComments`: 批量删除评论（包含权限验证）

#### 数据库层
- **文件**: `apps/server/src/database/repos/comment/comment.repo.ts`
- **方法**:
  - `getWorkspaceComments`: 查询评论，支持筛选和分页
  - `withPage`: 关联页面信息
  - `withSpace`: 关联空间信息

## 使用方法

### 访问评论管理

1. 以管理员身份登录
2. 访问：http://localhost:5173/settings/comments
3. 或者：点击设置 → 左侧菜单 → 评论管理

### 搜索评论

1. 在搜索框中输入关键词
2. 系统会自动搜索评论内容

### 筛选评论

1. 点击"按类型筛选"下拉框
2. 选择"行内"或"页面"
3. 点击清除按钮可以清除筛选

### 删除单条评论

1. 找到要删除的评论
2. 点击该行末尾的删除图标
3. 在确认对话框中点击"删除"

### 批量删除评论

1. 勾选要删除的评论（可以点击表头全选）
2. 点击顶部的"删除 (N)"按钮
3. 在确认对话框中点击"删除"

## 界面预览

### 主界面
- 顶部：搜索框、筛选器、删除按钮
- 中间：统计徽章（总数、已选数）
- 主体：评论列表表格
- 底部：分页控件

### 表格列
| 列名 | 说明 |
|------|------|
| 复选框 | 用于选择评论 |
| 作者 | 显示头像和名称 |
| 内容 | 评论内容（最多2行） |
| 页面 | 所属页面标题 |
| 空间 | 所属空间名称 |
| 创建时间 | 相对时间显示 |
| 操作 | 删除按钮 |

## 国际化

已添加中文翻译：
- 评论管理
- 搜索评论...
- 按类型筛选
- 删除
- 总计
- 已选
- 未找到评论
- 作者
- 内容
- 页面
- 空间
- 创建时间
- 操作
- 删除评论
- 评论删除成功
- 删除评论失败
- 等等...

## 注意事项

1. **权限**：只有管理员可以访问此功能
2. **删除操作**：删除后无法恢复，请谨慎操作
3. **级联删除**：删除评论时会同时删除相关的反馈、提及和通知
4. **性能**：大量评论时建议使用搜索和筛选功能
5. **分页**：默认每页显示 20 条评论

## 后续优化建议

1. **导出功能**：支持导出评论为 CSV 或 Excel
2. **高级筛选**：
   - 按作者筛选
   - 按日期范围筛选
   - 按空间筛选
   - 按页面筛选
3. **批量操作**：
   - 批量移动到其他页面
   - 批量标记为已解决
4. **评论详情**：点击评论可以查看完整内容和上下文
5. **审核功能**：支持评论审核和批准流程
6. **统计报表**：评论数量趋势、活跃用户等

## 相关文件

### 前端
- `apps/client/src/pages/settings/comment/comment-management.tsx`
- `apps/client/src/features/comment/queries/comment-management-query.ts`
- `apps/client/src/features/comment/services/comment-management-service.ts`
- `apps/client/src/components/settings/settings-sidebar.tsx`
- `apps/client/src/App.tsx`
- `apps/client/public/locales/zh-CN/translation.json`

### 后端
- `apps/server/src/core/comment/comment.controller.ts`
- `apps/server/src/core/comment/comment.service.ts`
- `apps/server/src/database/repos/comment/comment.repo.ts`

## 测试

功能已经部署，可以直接访问测试：

1. 确保以管理员身份登录
2. 访问：http://localhost:5173/settings/comments
3. 测试各项功能：
   - 查看评论列表
   - 搜索评论
   - 筛选评论
   - 删除单条评论
   - 批量删除评论
   - 分页功能
