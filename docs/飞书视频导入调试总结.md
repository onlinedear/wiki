# 飞书视频导入调试总结

## 当前状态

✅ **代码已更新** - 增强了日志输出，便于调试  
✅ **权限已开通** - 云文档所有权限  
⚠️ **待测试** - 需要实际导入测试以确认问题

## 已完成的工作

### 1. 增强日志输出

**文件**：`apps/server/src/ee/feishu-import/feishu-api.service.ts`

**改进**：
- 添加了 🎬 emoji 标记，便于过滤日志
- 输出每个 API 方法的详细请求和响应
- 显示完整的错误信息和响应数据
- 新增 Method 4：获取视频元数据
- 在失败时提供明确的排查建议

### 2. 创建测试脚本

**文件**：`scripts/test-feishu-video-api.sh`

**功能**：
- 自动测试 4 种不同的 API 端点
- 显示每个 API 的详细响应
- 尝试实际下载视频文件
- 提供彩色输出和清晰的成功/失败标识

**使用方法**：
```bash
./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN>
```

### 3. 创建调试文档

- ✅ `docs/飞书视频导入调试指南.md` - 详细的调试步骤
- ✅ `docs/飞书视频导入快速测试.md` - 快速测试流程
- ✅ `docs/飞书视频导入调试总结.md` - 本文档

## 测试流程

### 第一步：重启服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动以应用新的日志代码
pnpm server:dev
```

### 第二步：准备测试文档

1. 在飞书中创建测试文档
2. 插入一个小视频（< 10MB）
3. 复制文档 URL

### 第三步：导入并查看日志

在一个终端窗口：
```bash
# 实时查看视频相关日志
tail -f logs/app.log | grep -E "🎬|Video|video"
```

在另一个窗口进行导入操作。

### 第四步：分析日志

根据日志输出判断问题：

#### 场景 A：权限问题
```
Method 1 failed: code=99991672, msg=Access denied
```
→ 需要配置飞书应用权限

#### 场景 B：Token 问题
```
Method 1 error response: status=404
```
→ Video token 格式不正确

#### 场景 C：API 端点问题
```
All methods failed to get video URL
```
→ 可能需要使用不同的 API 端点

### 第五步：使用测试脚本

如果导入失败，从日志中获取 video token：
```bash
grep "Found video file token" logs/app.log
```

然后运行测试脚本：
```bash
./scripts/test-feishu-video-api.sh cli_xxxxx your_secret VMxxxxxxxx
```

## 可能的问题和解决方案

### 问题 1：权限不足

**症状**：API 返回 code 99991672 (Access denied)

**解决方案**：
1. 访问飞书开放平台：`https://open.feishu.cn/app/你的AppID/auth`
2. 确认已开通以下权限：
   - ✅ `docx:document:readonly` - 查看文档
   - ✅ `drive:drive:readonly` - 查看云空间文件
   - ⚠️ 可能需要 `drive:drive` - 云空间完整权限（包含下载）
3. 保存权限配置
4. 等待 5-10 分钟让权限生效
5. 重新测试

**验证方法**：
```bash
# 使用测试脚本验证权限
./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN>
```

### 问题 2：Video Token 格式错误

**症状**：API 返回 404 Not Found

**可能原因**：
- Token 字段获取错误
- Token 类型不匹配

**解决方案**：
1. 查看完整的视频块结构：
   ```bash
   grep -A 20 "Video child block" logs/app.log
   ```

2. 检查 token 来源字段：
   - `childBlock.file.token`
   - `childBlock.media.token`
   - `childBlock.video.token`

3. 如果需要，修改代码以使用正确的字段

### 问题 3：API 端点不正确

**症状**：所有 API 方法都失败

**可能原因**：
- 飞书视频使用特殊的 API 端点
- 需要额外的参数或认证

**解决方案**：
1. 查阅飞书 API 文档：
   - https://open.feishu.cn/document/server-docs/docs/drive-v1/media/introduction
   - https://open.feishu.cn/document/server-docs/docs/drive-v1/file/introduction

2. 尝试其他可能的 API 端点：
   - `/drive/v1/medias/{token}/download_url`
   - `/drive/v1/videos/{token}/download`
   - 其他文档中提到的端点

3. 联系飞书技术支持获取帮助

### 问题 4：视频块结构问题

**症状**：日志显示 "no processable children"

**可能原因**：
- blocks API 没有返回视频的子块
- 视频块结构与预期不同

**解决方案**：
1. 确认文档是新版文档（URL 包含 `/docx/`）
2. 查看完整的 blocks API 响应
3. 检查视频块的实际结构
4. 可能需要调整代码以适配实际结构

## 调试工具

### 1. 日志过滤

```bash
# 查看所有视频相关日志
tail -f logs/app.log | grep -E "🎬|Video|video"

# 查看 API 响应
tail -f logs/app.log | grep -E "Method [1-4]|response"

# 查看错误信息
tail -f logs/app.log | grep -E "❌|failed|Failed"
```

### 2. 测试脚本

```bash
# 完整测试
./scripts/test-feishu-video-api.sh <APP_ID> <APP_SECRET> <VIDEO_TOKEN>

# 查看脚本帮助
./scripts/test-feishu-video-api.sh
```

### 3. 手动 API 测试

```bash
# 1. 获取 token
curl -X POST 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal' \
  -H 'Content-Type: application/json' \
  -d '{"app_id":"xxx","app_secret":"xxx"}'

# 2. 测试视频下载 API
curl -X GET 'https://open.feishu.cn/open-apis/drive/v1/medias/VMxxxxxxxx/download' \
  -H 'Authorization: Bearer token'
```

## 下一步行动

### 立即执行

1. **重启服务器**以应用新的日志代码
2. **准备测试文档**（包含小视频）
3. **执行导入**并查看日志输出
4. **分析结果**并确定具体问题

### 根据结果

#### 如果是权限问题
→ 配置飞书应用权限，等待生效后重试

#### 如果是 Token 问题
→ 检查 blocks API 数据结构，调整 token 获取逻辑

#### 如果是 API 端点问题
→ 查阅飞书文档，尝试其他 API 端点

#### 如果是其他问题
→ 使用测试脚本单独测试，收集详细信息

## 相关文件

### 代码文件
- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - API 服务（已更新）
- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - 导入服务

### 文档文件
- `docs/飞书视频导入调试指南.md` - 详细调试步骤
- `docs/飞书视频导入快速测试.md` - 快速测试流程
- `docs/飞书视频导入功能说明.md` - 功能说明
- `docs/飞书Blocks_API权限配置.md` - 权限配置指南
- `docs/飞书权限配置详细步骤.md` - 权限配置步骤

### 工具文件
- `scripts/test-feishu-video-api.sh` - API 测试脚本（可执行）

## 预期结果

### 成功标志

当视频导入成功时，你会看到：

```
[FeishuApiService] 🎬 Getting video URL for token: VMxxxxxxxx
[FeishuApiService] ✓ Got video URL via medias API: https://...
[FeishuApiService] ⬇️ Downloading video from URL: https://...
[FeishuApiService] ✓ Downloaded video: 15.67 MB
[FeishuImportService] ✅ Video imported successfully: uuid-xxx (15.67 MB)
```

文档中会显示可播放的视频。

### 失败处理

如果视频导入失败，文档中会显示：
```
🎬 [视频导入失败 - Token: VMxxxxxxxx...]
```

这样用户知道有视频但导入失败，可以在飞书中查看原始内容。

## 总结

已经完成的准备工作：
- ✅ 增强了日志输出，便于定位问题
- ✅ 创建了测试脚本，可以单独测试 API
- ✅ 编写了详细的调试文档
- ✅ 提供了多种调试工具和方法

现在需要：
1. 重启服务器应用新代码
2. 执行实际的导入测试
3. 根据日志输出确定具体问题
4. 应用相应的解决方案

---

**创建时间**：2025-11-26  
**更新时间**：2025-11-26  
**适用版本**：NoteDoc v1.0.0
