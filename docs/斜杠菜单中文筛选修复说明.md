# 斜杠菜单中文筛选修复说明

## 问题描述

在编辑器中使用斜杠命令（/）时，输入中文关键词无法筛选出对应的菜单项。例如：
- 输入"无序"无法筛选出"无序列表"
- 输入"标题"无法筛选出"1级标题"、"2级标题"等
- 只能使用英文关键词进行筛选

## 根本原因

斜杠菜单的筛选逻辑（`getSuggestionItems` 函数）只匹配英文的 `title`、`description` 和 `searchTerms`，没有考虑翻译后的中文文本。

## 解决方案

### 1. 修改筛选函数支持翻译文本匹配

**文件**: `apps/client/src/features/editor/components/slash-menu/menu-items.ts`

- 为 `getSuggestionItems` 函数添加可选的翻译函数参数 `t`
- 在筛选逻辑中同时匹配英文原文和翻译后的文本
- 使用模糊匹配算法对翻译后的标题和描述进行匹配

```typescript
export const getSuggestionItems = ({
  query,
  t,
}: {
  query: string;
  t?: (key: string) => string;
}): SlashMenuGroupedItemsType => {
  // ...
  const matchesEnglish = /* 原有的英文匹配逻辑 */;
  const matchesTranslated = t
    ? fuzzyMatch(search, t(item.title)) ||
      t(item.description).toLowerCase().includes(search)
    : false;
  
  return matchesEnglish || matchesTranslated;
};
```

### 2. 传递翻译函数到筛选逻辑

**文件**: `apps/client/src/features/editor/extensions/slash-command.ts`

- 导入 i18n 实例
- 在配置 Suggestion 插件时，将 `i18n.t` 函数传递给 `getSuggestionItems`

```typescript
import i18n from '@/i18n';

const SlashCommand = Command.configure({
  suggestion: {
    items: ({ query }) => getSuggestionItems({ query, t: i18n.t }),
    render: renderItems,
  },
});
```

## 修改的文件

1. `apps/client/src/features/editor/components/slash-menu/menu-items.ts`
   - 添加翻译函数参数
   - 实现翻译文本匹配逻辑

2. `apps/client/src/features/editor/extensions/slash-command.ts`
   - 导入 i18n
   - 传递翻译函数

## 验证方法

运行验证脚本：
```bash
./scripts/verify-slash-menu-chinese-filter.sh
```

### 手动测试步骤

1. 启动应用：`pnpm dev`
2. 登录并切换到中文界面
3. 创建或编辑一个文档
4. 在编辑器中输入 `/`
5. 尝试输入中文关键词：
   - 输入"无序" → 应显示"无序列表"
   - 输入"有序" → 应显示"有序列表"
   - 输入"标题" → 应显示"1级标题"、"2级标题"、"3级标题"
   - 输入"待办" → 应显示"待办列表"
   - 输入"引用" → 应显示"引用块"
   - 输入"代码" → 应显示"代码"
   - 输入"表格" → 应显示"表格"
   - 输入"图片" → 应显示"图片"

## 技术细节

### 模糊匹配算法

使用的 `fuzzyMatch` 函数实现了简单的模糊匹配：
- 按顺序查找查询字符串中的每个字符
- 不要求字符连续出现
- 例如："无序" 可以匹配 "无序列表"

### 向后兼容

- 翻译函数参数是可选的（`t?`）
- 如果不提供翻译函数，仍然使用原有的英文匹配逻辑
- 不影响其他语言的使用

## 影响范围

- 仅影响斜杠菜单的筛选功能
- 不影响菜单项的显示和执行
- 支持所有已翻译的语言（不仅限于中文）

## 相关文件

- 翻译文件：`apps/client/public/locales/zh-CN/translation.json`
- 验证脚本：`scripts/verify-slash-menu-chinese-filter.sh`
