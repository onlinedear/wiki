# 甘特图字段配置和设置功能

## 更新日期
2025-11-25

## 功能概述

为甘特图添加了两个重要的配置功能：
1. **字段配置面板** - 管理字段的显示、排序和编辑
2. **甘特图设置面板** - 配置时间范围、标题字段和进度条颜色

## 1. 字段配置面板

### 访问方式
点击工具栏左侧第一个按钮（列图标）打开字段配置面板。

### 功能特性

#### 字段列表
- 显示所有字段（内置字段 + 自定义字段）
- 每个字段显示：
  - 拖拽手柄（左侧）
  - 字段类型图标
  - 字段名称
  - 显示/隐藏按钮（眼睛图标）
  - 操作菜单（三点图标，仅自定义字段）

#### 内置字段
- 任务名（始终显示，不可隐藏）
- 带锁定图标，不可删除和拖拽
- 开始日期和结束日期不在字段配置中显示，始终在任务编辑对话框中可用

#### 拖拽排序
- 使用 `@hello-pangea/dnd` 实现
- 拖动字段左侧的手柄图标可调整顺序
- 内置字段不可拖拽
- 拖拽时有视觉反馈（背景变灰）

#### 显示/隐藏
- 点击眼睛图标切换字段可见性
- 隐藏的字段显示为闭眼图标
- 显示的字段会在任务名后面的列中显示
- 新增的自定义字段默认为隐藏状态
- 任务名字段始终显示，不可隐藏

#### 编辑和删除
- 点击自定义字段的三点菜单
- 选择"编辑"打开字段编辑对话框
- 选择"删除"删除该字段

#### 新增字段
- 点击底部"新增字段"按钮
- 打开字段配置对话框

### 技术实现

```typescript
// 字段拖拽排序
const handleFieldDragEnd = (result: any) => {
  if (!result.destination) return;
  
  const items = Array.from(allFields);
  const [reorderedItem] = items.splice(result.source.index, 1);
  items.splice(result.destination.index, 0, reorderedItem);
  
  // 更新自定义字段的顺序
  const updatedCustomFields = customFields.map(field => {
    const newIndex = items.findIndex(f => f.id === field.id);
    return { ...field, order: newIndex };
  });
  
  updateAttributes({ customFields: updatedCustomFields });
};

// 切换字段可见性
const toggleFieldVisibility = (fieldId: string) => {
  const newHiddenColumns = hiddenColumns.includes(fieldId)
    ? hiddenColumns.filter(c => c !== fieldId)
    : [...hiddenColumns, fieldId];
  updateAttributes({ hiddenColumns: newHiddenColumns });
};
```

## 2. 甘特图设置面板

### 访问方式
点击工具栏左侧第二个按钮（齿轮图标）打开甘特图设置面板。

### 配置项

#### 时间范围
- **开始时间**：设置甘特图显示的起始日期
- **结束时间**：设置甘特图显示的结束日期
- 留空则自动根据任务时间计算范围
- 使用日期选择器，支持清除

#### 标题显示字段
- 选择在进度条上显示的字段
- 默认为"任务名"
- 可选择任意字段（包括自定义字段）
- 下拉列表显示所有可用字段
- 进度条显示格式：**天数 + 选中字段的值**
  - 例如：选择"任务名"显示为"5 天 - 任务1"
  - 例如：选择"完成状态"显示为"5 天 - 已完成"
- 不同字段类型的显示：
  - 日期字段：按配置的格式显示
  - 复选框：显示 ✓ 或 ✗
  - 多选字段：用逗号分隔显示
  - 人员字段：显示人员名称
  - 其他字段：直接显示值

#### 进度条颜色
- 8 种预设颜色方案：
  1. 蓝色（#228be6，默认）
  2. 绿色（#40c057）
  3. 红色（#fa5252）
  4. 橙色（#fd7e14）
  5. 紫色（#be4bdb）
  6. 青色（#15aabf）
  7. 黄色（#fab005）
  8. 粉色（#e64980）
- 点击色块选择颜色
- 选中的颜色有蓝色边框高亮

#### 仅计算工作日
- **功能说明**：勾选后，进度条上的天数将仅计算工作日，去除周末时间
- **默认模式**：法定工作日（周一至周五）
- **自定义模式**：可以自定义每周工作日
  - 勾选"自定义每周工作日"
  - 选择周一到周日中的任意天作为工作日
  - 至少需要选择一个工作日
- **显示效果**：
  - 未勾选：显示"X 天"（自然日）
  - 勾选后：显示"X 工作日"
- **计算逻辑**：
  - 自然日：包含所有日期（周末、节假日）
  - 工作日：只计算选中的工作日
  - 例如：周一到周五共5天，如果跨越周末，自然日为7天，工作日为5天

### 技术实现

```typescript
interface GanttSettings {
  startDate?: string;   // 甘特图开始日期
  endDate?: string;     // 甘特图结束日期
  titleField?: string;  // 标题显示字段（默认为 'name'）
  barColor?: string;    // 进度条颜色（默认为 '#228be6'）
}

// 保存设置
const handleSaveGanttSettings = (settings: GanttSettings) => {
  updateAttributes({ ganttSettings: settings });
  setIsGanttSettingsModalOpen(false);
};

// 应用颜色到进度条
<Box
  className={classes.taskBar}
  style={{
    ...position,
    background: ganttSettings.barColor || '#228be6',
  }}
  onClick={() => handleTaskClick(task)}
>
```

## 3. 工具栏布局

### 左侧按钮（快捷设置）
1. 字段配置（列图标）
2. 甘特图设置（齿轮图标）
3. 筛选（漏斗图标）- 待实现
4. 排序（排序图标）- 待实现
5. 分组（列表图标）- 待实现
6. 分隔线
7. 评论（消息图标）- 待实现
8. 全屏（最大化图标）- 待实现

### 右侧按钮（视图切换）
1. 周视图
2. 月视图
3. 季视图
4. 年视图
5. 今天（快速定位）

## 4. 数据结构更新

```typescript
interface CustomField {
  id: string;
  name: string;
  type: FieldType;
  options?: string[];
  defaultValue?: any;
  order?: number;        // 新增：字段排序
}

interface GanttSettings {
  startDate?: string;       // 甘特图开始日期
  endDate?: string;         // 甘特图结束日期
  titleField?: string;      // 标题显示字段ID（默认为 'name'）
  barColor?: string;        // 进度条颜色（默认为 '#228be6'）
  workdaysOnly?: boolean;   // 是否仅计算工作日
  customWorkdays?: number[]; // 自定义工作日 (0=周日, 1=周一, ..., 6=周六)
}

interface GanttAttributes {
  tasks?: GanttTask[];
  viewMode?: ViewMode;
  hiddenColumns?: string[];
  customFields?: CustomField[];
  ganttSettings?: GanttSettings;  // 新增：甘特图设置
}
```

### 数据持久化

所有设置都通过 Tiptap 的 `updateAttributes` 方法保存到节点属性中：
- 字段配置（显示/隐藏、排序）保存在 `hiddenColumns` 和 `customFields.order`
- 甘特图设置保存在 `ganttSettings` 对象中
- 数据随文档内容一起保存到数据库
- 重新打开文档时自动恢复所有设置

## 5. 样式更新

### 进度条颜色
- 移除固定的蓝色背景
- 使用动态颜色（从设置中读取）
- Hover 效果使用 `filter: brightness(0.9)` 实现
- 兼容所有颜色方案

```css
.taskBar {
  /* 移除固定背景色 */
  /* background: var(--mantine-color-blue-6); */
  transition: filter 0.2s;
}

.taskBar:hover {
  /* 使用 filter 实现通用的 hover 效果 */
  filter: brightness(0.9);
}
```

## 6. 依赖更新

新增依赖：
- `@hello-pangea/dnd@^18.0.1` - 拖拽排序库

## 7. 使用示例

### 显示和排序字段
1. 点击"字段配置"按钮
2. 点击隐藏字段的闭眼图标，字段变为显示状态
3. 拖动显示的字段到目标位置调整顺序
4. 关闭面板，设置自动保存

### 隐藏字段
1. 点击"字段配置"按钮
2. 点击显示字段右侧的睁眼图标
3. 字段变为隐藏状态，不在任务列表中显示

### 更改进度条颜色
1. 点击"甘特图设置"按钮
2. 在"进度条颜色"区域点击喜欢的颜色
3. 点击"保存"按钮
4. 所有任务条颜色更新

### 启用工作日计算
1. 点击"甘特图设置"按钮
2. 勾选"仅计算工作日"
3. 选择计算模式：
   - 法定工作日：使用默认的周一至周五
   - 自定义每周工作日：勾选后可以选择任意工作日组合
4. 点击"保存"按钮
5. 所有任务的天数显示更新为工作日

### 自定义标题显示
1. 点击"甘特图设置"按钮
2. 在"标题显示字段"下拉框中选择字段（如"完成状态"）
3. 点击"保存"按钮
4. 进度条上的显示从"天数 - 任务名"变为"天数 - 完成状态"
5. 设置会保存到数据库，下次打开时保持

## 8. 注意事项

1. 新增的自定义字段默认为隐藏状态，需要点击眼睛图标显示
2. 字段排序只影响显示顺序，不影响数据存储
3. 隐藏的字段仍然保存数据，只是不在表格中显示
4. 任务名字段始终显示，不可删除和隐藏
5. 开始日期和结束日期不在字段配置中，但在任务编辑对话框中始终可用
6. 只有显示状态的字段才会在任务名后面的列中显示
7. 时间范围留空时，系统会根据任务自动计算合适的范围
8. 颜色更改会立即应用到所有任务条
9. 只读模式下，所有配置按钮都被禁用

## 9. 技术实现细节

### 工作日计算算法

```typescript
// 计算工作日天数
const calculateWorkdays = (startDate: Date, endDate: Date, customWorkdays?: number[]) => {
  // 默认工作日：周一到周五 (1, 2, 3, 4, 5)
  const workdays = customWorkdays || [1, 2, 3, 4, 5];
  
  let count = 0;
  const current = new Date(startDate);
  
  while (current <= endDate) {
    const dayOfWeek = current.getDay();
    if (workdays.includes(dayOfWeek)) {
      count++;
    }
    current.setDate(current.getDate() + 1);
  }
  
  return count;
};

// 计算任务持续天数
const calculateDuration = (startDateStr: string, endDateStr: string) => {
  const startDate = new Date(startDateStr + 'T00:00:00');
  const endDate = new Date(endDateStr + 'T00:00:00');
  
  if (ganttSettings.workdaysOnly) {
    return calculateWorkdays(startDate, endDate, ganttSettings.customWorkdays);
  } else {
    // 自然日计算（包含周末）
    return Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
  }
};
```

## 10. 后续优化建议

1. 添加更多颜色选项或自定义颜色选择器
2. 实现筛选、排序、分组功能
3. 添加评论功能
4. 实现全屏模式
5. 支持按字段值设置不同的进度条颜色
6. 添加字段宽度调整功能
7. 支持导出甘特图为图片
8. 支持导入节假日数据，自动排除法定节假日
9. 添加工作日计算的详细说明提示
