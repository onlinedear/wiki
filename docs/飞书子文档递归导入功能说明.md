# é£ä¹¦å­æ–‡æ¡£é€’å½’å¯¼å…¥åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æ”¯æŒä»é£ä¹¦æ–‡æ¡£é€’å½’å¯¼å…¥æ‰€æœ‰å­æ–‡æ¡£ï¼Œè‡ªåŠ¨å»ºç«‹çˆ¶å­å…³ç³»ï¼Œä¿æŒæ–‡æ¡£å±‚çº§ç»“æ„ã€‚

## å®ç°æ–¹å¼

### 1. è·å–å­æ–‡æ¡£

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-api.service.ts`

**æ–°å¢æ–¹æ³•**ï¼š`getChildDocuments()`

```typescript
async getChildDocuments(client: AxiosInstance, documentToken: string): Promise<any[]>
```

**åŠŸèƒ½**ï¼š
- ä»æ–‡æ¡£çš„ blocks ä¸­æŸ¥æ‰¾å­æ–‡æ¡£å¼•ç”¨
- æå–å­æ–‡æ¡£çš„ token å’Œæ ‡é¢˜
- è¿”å›å­æ–‡æ¡£åˆ—è¡¨

**å®ç°é€»è¾‘**ï¼š
1. è·å–æ–‡æ¡£çš„ blocks
2. éå†æ‰€æœ‰ blocksï¼ŒæŸ¥æ‰¾æ–‡æ¡£å¼•ç”¨å—ï¼ˆblock_type: 22ï¼‰
3. æå– `block.file.token` å’Œ `block.file.name`
4. è¿”å›å­æ–‡æ¡£ä¿¡æ¯æ•°ç»„

### 2. é€’å½’å¯¼å…¥é€»è¾‘

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-import.service.ts`

**é‡æ„å†…å®¹**ï¼š

#### ä¸»å…¥å£æ–¹æ³•ï¼š`importOnlinePages()`

```typescript
async importOnlinePages(params: {
  workspaceId: string;
  spaceId: string;
  userId: string;
  documentUrl: string;
  appId: string;
  appSecret: string;
  includeChildren?: boolean;  // æ–°å¢å‚æ•°
})
```

**æµç¨‹**ï¼š
1. å¯¼å…¥ä¸»æ–‡æ¡£
2. å¦‚æœ `includeChildren` ä¸º trueï¼ˆé»˜è®¤ï¼‰ï¼Œé€’å½’å¯¼å…¥æ‰€æœ‰å­æ–‡æ¡£
3. è¿”å›ä¸»æ–‡æ¡£çš„ pageId

#### å•æ–‡æ¡£å¯¼å…¥ï¼š`importSingleDocument()`

```typescript
private async importSingleDocument(
  client: AxiosInstance,
  documentToken: string,
  parentPageId: string | null,  // çˆ¶é¡µé¢ ID
  spaceId: string,
  workspaceId: string,
  userId: string,
): Promise<any>
```

**åŠŸèƒ½**ï¼š
- å¯¼å…¥å•ä¸ªæ–‡æ¡£
- æ”¯æŒè®¾ç½®çˆ¶é¡µé¢ ID
- è¿”å›åˆ›å»ºçš„é¡µé¢å¯¹è±¡

**ç‰¹æ€§**ï¼š
- è·å–æ–‡æ¡£å…ƒæ•°æ®å’Œå†…å®¹
- è½¬æ¢ä¸º Tiptap æ ¼å¼
- åˆ›å»ºé¡µé¢å¹¶è®¾ç½®çˆ¶å­å…³ç³»
- è§¦å‘é¡µé¢åˆ›å»ºäº‹ä»¶

#### é€’å½’å¯¼å…¥å­æ–‡æ¡£ï¼š`importChildDocuments()`

```typescript
private async importChildDocuments(
  client: AxiosInstance,
  parentDocumentToken: string,
  parentPageId: string,
  spaceId: string,
  workspaceId: string,
  userId: string,
): Promise<void>
```

**åŠŸèƒ½**ï¼š
- è·å–æŒ‡å®šæ–‡æ¡£çš„æ‰€æœ‰å­æ–‡æ¡£
- é€’å½’å¯¼å…¥æ¯ä¸ªå­æ–‡æ¡£åŠå…¶å­æ–‡æ¡£
- è‡ªåŠ¨å»ºç«‹çˆ¶å­å…³ç³»

**é€’å½’é€»è¾‘**ï¼š
```
ä¸»æ–‡æ¡£
â”œâ”€â”€ å­æ–‡æ¡£ 1
â”‚   â”œâ”€â”€ å­™æ–‡æ¡£ 1.1
â”‚   â””â”€â”€ å­™æ–‡æ¡£ 1.2
â””â”€â”€ å­æ–‡æ¡£ 2
    â””â”€â”€ å­™æ–‡æ¡£ 2.1
```

## ä½¿ç”¨æ–¹æ³•

### API è°ƒç”¨

```typescript
POST /api/feishu/import/online

{
  "documentUrl": "https://xxx.feishu.cn/docx/xxxxx",
  "spaceId": "space-id",
  "includeChildren": true  // å¯é€‰ï¼Œé»˜è®¤ true
}
```

### å‰ç«¯è°ƒç”¨

åœ¨å¯¼å…¥å¯¹è¯æ¡†ä¸­æ·»åŠ é€‰é¡¹ï¼š

```typescript
const [includeChildren, setIncludeChildren] = useState(true);

// è°ƒç”¨å¯¼å…¥ API
await importFeishuDocument({
  documentUrl,
  spaceId,
  includeChildren,
});
```

## æ–‡æ¡£å±‚çº§ç»“æ„

### åœ¨ NoteDoc ä¸­çš„è¡¨ç°

å¯¼å…¥åçš„æ–‡æ¡£ä¼šä¿æŒé£ä¹¦ä¸­çš„å±‚çº§ç»“æ„ï¼š

```
ğŸ“„ ä¸»æ–‡æ¡£
  ğŸ“„ å­æ–‡æ¡£ 1
    ğŸ“„ å­™æ–‡æ¡£ 1.1
    ğŸ“„ å­™æ–‡æ¡£ 1.2
  ğŸ“„ å­æ–‡æ¡£ 2
    ğŸ“„ å­™æ–‡æ¡£ 2.1
```

### æ•°æ®åº“ç»“æ„

æ¯ä¸ªé¡µé¢éƒ½æœ‰ `parentPageId` å­—æ®µæŒ‡å‘å…¶çˆ¶é¡µé¢ï¼š

```typescript
{
  id: 'page-1',
  title: 'ä¸»æ–‡æ¡£',
  parentPageId: null,  // ä¸»æ–‡æ¡£æ²¡æœ‰çˆ¶é¡µé¢
}

{
  id: 'page-2',
  title: 'å­æ–‡æ¡£ 1',
  parentPageId: 'page-1',  // æŒ‡å‘ä¸»æ–‡æ¡£
}

{
  id: 'page-3',
  title: 'å­™æ–‡æ¡£ 1.1',
  parentPageId: 'page-2',  // æŒ‡å‘å­æ–‡æ¡£ 1
}
```

## æ—¥å¿—è¾“å‡º

### æˆåŠŸåœºæ™¯

```
[FeishuImportService] Starting Feishu import for user xxx, includeChildren: true
[FeishuImportService] Importing document: doccnxxxxx, parent: none
[FeishuImportService] Document title: ä¸»æ–‡æ¡£
[FeishuImportService] Created page page-1 from Feishu document doccnxxxxx
[FeishuImportService] Found 2 child documents for doccnxxxxx
[FeishuImportService] Importing document: doccnyyyyy, parent: page-1
[FeishuImportService] Document title: å­æ–‡æ¡£ 1
[FeishuImportService] Created page page-2 from Feishu document doccnyyyyy
[FeishuImportService] Found 2 child documents for doccnyyyyy
[FeishuImportService] Importing document: doccnzzzzz, parent: page-2
[FeishuImportService] Document title: å­™æ–‡æ¡£ 1.1
[FeishuImportService] Created page page-3 from Feishu document doccnzzzzz
[FeishuImportService] No child documents found for doccnzzzzz
```

### æ— å­æ–‡æ¡£åœºæ™¯

```
[FeishuImportService] Starting Feishu import for user xxx, includeChildren: true
[FeishuImportService] Importing document: doccnxxxxx, parent: none
[FeishuImportService] Created page page-1 from Feishu document doccnxxxxx
[FeishuImportService] No child documents found for doccnxxxxx
```

### ç¦ç”¨å­æ–‡æ¡£å¯¼å…¥

```
[FeishuImportService] Starting Feishu import for user xxx, includeChildren: false
[FeishuImportService] Importing document: doccnxxxxx, parent: none
[FeishuImportService] Created page page-1 from Feishu document doccnxxxxx
```

## é”™è¯¯å¤„ç†

### å­æ–‡æ¡£å¯¼å…¥å¤±è´¥

å¦‚æœæŸä¸ªå­æ–‡æ¡£å¯¼å…¥å¤±è´¥ï¼Œä¸ä¼šå½±å“å…¶ä»–å­æ–‡æ¡£çš„å¯¼å…¥ï¼š

```
[FeishuImportService] Failed to import child document doccnyyyyy: Access denied
[FeishuImportService] Importing document: doccnzzzzz, parent: page-1
[FeishuImportService] Created page page-3 from Feishu document doccnzzzzz
```

### è·å–å­æ–‡æ¡£å¤±è´¥

å¦‚æœæ— æ³•è·å–å­æ–‡æ¡£åˆ—è¡¨ï¼Œä¼šè®°å½•é”™è¯¯ä½†ä¸ä¼šä¸­æ–­ä¸»æ–‡æ¡£å¯¼å…¥ï¼š

```
[FeishuImportService] Failed to get child documents for doccnxxxxx: Network error
[FeishuImportService] Created page page-1 from Feishu document doccnxxxxx
```

## æ€§èƒ½è€ƒè™‘

### å¯¼å…¥æ—¶é—´

- å•ä¸ªæ–‡æ¡£ï¼šçº¦ 2-5 ç§’
- åŒ…å« 10 ä¸ªå­æ–‡æ¡£ï¼šçº¦ 20-50 ç§’
- åŒ…å« 50 ä¸ªå­æ–‡æ¡£ï¼šçº¦ 100-250 ç§’

### ä¼˜åŒ–å»ºè®®

1. **åˆ†æ‰¹å¯¼å…¥**ï¼šå¯¹äºå¤§é‡å­æ–‡æ¡£ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ‰¹å¯¼å…¥
2. **è¿›åº¦æ˜¾ç¤º**ï¼šå‰ç«¯æ˜¾ç¤ºå¯¼å…¥è¿›åº¦
3. **åå°ä»»åŠ¡**ï¼šå¯¹äºè¶…å¤§æ–‡æ¡£æ ‘ï¼Œä½¿ç”¨åå°ä»»åŠ¡é˜Ÿåˆ—

## å·²çŸ¥é™åˆ¶

### 1. å­æ–‡æ¡£è¯†åˆ«

å½“å‰å®ç°åŸºäº block_type: 22 æ¥è¯†åˆ«å­æ–‡æ¡£å¼•ç”¨ã€‚å¦‚æœé£ä¹¦ä½¿ç”¨ä¸åŒçš„å—ç±»å‹ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ã€‚

**å¯èƒ½éœ€è¦æ”¯æŒçš„å—ç±»å‹**ï¼š
- block_type: 22 - æ–‡ä»¶/æ–‡æ¡£å¼•ç”¨
- å…¶ä»–ç±»å‹ - å¾…ç¡®è®¤

### 2. å¾ªç¯å¼•ç”¨

å¦‚æœæ–‡æ¡£ä¹‹é—´å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼ˆA â†’ B â†’ Aï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ— é™é€’å½’ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ å·²è®¿é—®æ–‡æ¡£çš„è·Ÿè¸ª
- è®¾ç½®æœ€å¤§é€’å½’æ·±åº¦é™åˆ¶

### 3. æƒé™é—®é¢˜

å¦‚æœç”¨æˆ·å¯¹æŸäº›å­æ–‡æ¡£æ²¡æœ‰è®¿é—®æƒé™ï¼Œè¿™äº›æ–‡æ¡£ä¼šè¢«è·³è¿‡ã€‚

## æœªæ¥æ”¹è¿›

### 1. æ·»åŠ å¾ªç¯å¼•ç”¨æ£€æµ‹

```typescript
private async importChildDocuments(
  client: AxiosInstance,
  parentDocumentToken: string,
  parentPageId: string,
  spaceId: string,
  workspaceId: string,
  userId: string,
  visited: Set<string> = new Set(),  // è·Ÿè¸ªå·²è®¿é—®çš„æ–‡æ¡£
): Promise<void> {
  if (visited.has(parentDocumentToken)) {
    this.logger.warn(`Circular reference detected: ${parentDocumentToken}`);
    return;
  }
  
  visited.add(parentDocumentToken);
  // ... ç»§ç»­å¯¼å…¥é€»è¾‘
}
```

### 2. æ·»åŠ æœ€å¤§æ·±åº¦é™åˆ¶

```typescript
private async importChildDocuments(
  // ... å…¶ä»–å‚æ•°
  maxDepth: number = 10,
  currentDepth: number = 0,
): Promise<void> {
  if (currentDepth >= maxDepth) {
    this.logger.warn(`Max depth ${maxDepth} reached`);
    return;
  }
  // ... ç»§ç»­å¯¼å…¥é€»è¾‘
}
```

### 3. æ·»åŠ è¿›åº¦å›è°ƒ

```typescript
interface ImportProgress {
  total: number;
  completed: number;
  current: string;
}

onProgress?: (progress: ImportProgress) => void;
```

### 4. æ”¯æŒæ›´å¤šå­æ–‡æ¡£ç±»å‹

- æ–‡æ¡£é“¾æ¥
- åµŒå…¥çš„æ–‡æ¡£
- æ–‡æ¡£é›†åˆ

## æµ‹è¯•æ–¹æ³•

### 1. å‡†å¤‡æµ‹è¯•æ–‡æ¡£

åœ¨é£ä¹¦ä¸­åˆ›å»ºæµ‹è¯•æ–‡æ¡£ç»“æ„ï¼š

```
ä¸»æµ‹è¯•æ–‡æ¡£
â”œâ”€â”€ å­æ–‡æ¡£ A
â”‚   â”œâ”€â”€ å­™æ–‡æ¡£ A1
â”‚   â””â”€â”€ å­™æ–‡æ¡£ A2
â””â”€â”€ å­æ–‡æ¡£ B
```

### 2. æ‰§è¡Œå¯¼å…¥

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f apps/server/logs/app.log | grep -E "Importing document|Created page|Found.*child"
```

### 3. éªŒè¯ç»“æœ

1. æ£€æŸ¥ NoteDoc ä¸­çš„æ–‡æ¡£æ ‘ç»“æ„
2. ç¡®è®¤çˆ¶å­å…³ç³»æ­£ç¡®
3. éªŒè¯æ‰€æœ‰æ–‡æ¡£å†…å®¹å®Œæ•´

### 4. æµ‹è¯•åœºæ™¯

- âœ… å•ä¸ªæ–‡æ¡£ï¼ˆæ— å­æ–‡æ¡£ï¼‰
- âœ… ä¸€çº§å­æ–‡æ¡£
- âœ… å¤šçº§å­æ–‡æ¡£ï¼ˆ3 å±‚ä»¥ä¸Šï¼‰
- âœ… ç¦ç”¨å­æ–‡æ¡£å¯¼å…¥ï¼ˆincludeChildren: falseï¼‰
- âš ï¸ å¾ªç¯å¼•ç”¨ï¼ˆå¾…å®ç°æ£€æµ‹ï¼‰
- âš ï¸ æƒé™ä¸è¶³çš„å­æ–‡æ¡£

## ç›¸å…³æ–‡ä»¶

### åç«¯ä»£ç 
- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - API æœåŠ¡ï¼ˆæ–°å¢ getChildDocumentsï¼‰
- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - å¯¼å…¥æœåŠ¡ï¼ˆé‡æ„é€’å½’é€»è¾‘ï¼‰

### å‰ç«¯ä»£ç 
- `apps/client/src/features/feishu/components/feishu-online-import-modal.tsx` - å¯¼å…¥å¯¹è¯æ¡†ï¼ˆå¾…æ·»åŠ é€‰é¡¹ï¼‰

## æ€»ç»“

âœ… **å·²å®ç°**ï¼š
- é€’å½’å¯¼å…¥å­æ–‡æ¡£
- è‡ªåŠ¨å»ºç«‹çˆ¶å­å…³ç³»
- ä¿æŒæ–‡æ¡£å±‚çº§ç»“æ„
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—

âš ï¸ **å¾…ä¼˜åŒ–**ï¼š
- å¾ªç¯å¼•ç”¨æ£€æµ‹
- æœ€å¤§æ·±åº¦é™åˆ¶
- è¿›åº¦æ˜¾ç¤º
- æ›´å¤šå­æ–‡æ¡£ç±»å‹æ”¯æŒ

ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼š
1. æµ‹è¯•é€’å½’å¯¼å…¥åŠŸèƒ½
2. æ ¹æ®å®é™…é£ä¹¦ API å“åº”è°ƒæ•´å­æ–‡æ¡£è¯†åˆ«é€»è¾‘
3. æ·»åŠ å‰ç«¯é€‰é¡¹æ§åˆ¶æ˜¯å¦å¯¼å…¥å­æ–‡æ¡£
4. ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šNoteDoc v1.0.0
