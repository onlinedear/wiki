# 甘特图分组功能说明

## 功能概述

甘特图分组功能允许用户根据自定义字段对任务进行分组显示，使得任务管理更加清晰有序。

## 功能特性

### 1. 分组设置

- **入口位置**：工具栏左侧的"分组"按钮（图标：IconLayoutList）
- **设置方式**：点击按钮打开"设置分组条件"模态框
- **字段选择**：可以选择任何非锁定的自定义字段作为分组依据
- **状态指示**：
  - 未设置分组时，按钮为灰色（subtle）
  - 设置分组后，按钮变为蓝色（filled），并显示当前分组字段名称

### 2. 分组显示

#### 分组标题行
- 显示分组名称和该分组下的任务数量，格式：`{分组名称} ({任务数量})`
- 左侧显示折叠/展开图标
- 背景色为浅灰色，与普通任务行区分
- 点击标题行可以折叠/展开该分组

#### 分组规则
根据不同字段类型，分组规则如下：

1. **文本字段**：按文本值分组
2. **单选字段**：按选项值分组，按选项顺序排序
3. **多选字段**：
   - 每个选项值创建一个分组
   - 一个任务可能出现在多个分组中
   - 按选项顺序排序
4. **人员字段**：按人员分组，显示人员名称
5. **日期字段**：按日期值分组，显示格式化的日期
6. **复选框字段**：分为"已选中"和"未选中"两组
7. **数字字段**：按数值分组
8. **空值处理**：所有空值任务归入"(暂无)"分组，排在最后

#### 分组排序
- 单选/多选字段：按照字段选项的定义顺序排序
- 其他字段：按照分组名称的字母顺序排序（中文按拼音）
- "(暂无)"分组始终排在最后

### 3. 折叠/展开

- **折叠状态**：分组标题行显示右箭头图标（IconChevronRight）
- **展开状态**：分组标题行显示下箭头图标（IconChevronDown）
- **默认状态**：所有分组默认展开
- **状态保持**：折叠状态在本地保持，不影响其他协作者

### 4. 任务编号

- 分组后，任务编号仍然保持全局连续
- 编号计算考虑了所有分组中的任务顺序

### 5. 清除分组

- 在"设置分组条件"模态框的标题栏右侧有"清除分组"按钮
- 点击后恢复到无分组的平铺显示模式

## 使用场景

### 场景 1：按任务状态分组
选择"任务状态"字段进行分组，可以清晰看到：
- 未开始的任务
- 进行中的任务
- 已完成的任务
- 未设置状态的任务（暂无）

### 场景 2：按负责人分组
选择"负责人"字段进行分组，可以：
- 查看每个成员负责的任务
- 快速了解团队成员的工作量分布

### 场景 3：按优先级分组
选择"优先级"字段进行分组，可以：
- 优先关注高优先级任务
- 合理安排不同优先级任务的时间

## 技术实现

### 数据结构

```typescript
interface GroupCondition {
  fieldId: string;
}

interface GroupedTask {
  groupKey: string | null;
  groupLabel: string | null;
  tasks: GanttTask[];
}
```

### 状态管理

- `groupCondition`: 当前的分组条件
- `collapsedGroups`: Set<string>，存储已折叠的分组 key
- `isGroupModalOpen`: 分组设置模态框的打开状态

### 核心逻辑

1. **分组计算**：在 `groupedTasks` useMemo 中实现
   - 先应用筛选条件
   - 再应用排序条件
   - 最后根据分组条件进行分组

2. **渲染逻辑**：
   - 遍历 `groupedTasks` 数组
   - 对每个分组，先渲染分组标题行
   - 然后渲染该分组下的所有任务（如果未折叠）

3. **样式处理**：
   - `.groupHeader`: 分组标题行样式
   - `.groupHeaderTimeline`: 分组标题行对应的时间轴区域样式

## 注意事项

1. **本地生效**：分组设置仅在本地生效，不会同步给其他协作者
2. **与筛选排序的关系**：
   - 分组在筛选和排序之后应用
   - 先筛选 → 再排序 → 最后分组
3. **多选字段特殊处理**：多选字段的任务可能出现在多个分组中
4. **只读模式**：在只读模式下，分组按钮被禁用

## 后续优化方向

1. **多级分组**：支持按多个字段进行层级分组
2. **分组统计**：在分组标题行显示更多统计信息（如总工时、完成率等）
3. **分组颜色**：为不同分组设置不同的颜色标识
4. **分组排序**：支持手动调整分组的显示顺序
5. **保存分组设置**：将分组设置保存到文档属性中，实现协作者间的同步
