# 飞书批量导入功能快速测试指南

## 前置条件

1. ✅ 已配置飞书应用的App ID和App Secret
2. ✅ 飞书应用已开通必要权限：
   - `docx:document:readonly` 或 `docx:document`
   - `drive:drive:readonly` 或 `drive:drive`
3. ✅ 飞书应用已发布版本

## 测试步骤

### 步骤1：准备测试数据

在飞书中创建测试文件夹结构：

```
测试文件夹 (fldcnxxxxxx)
├── 文档A.docx
├── 文档B.docx
├── 子文件夹1
│   ├── 文档C.docx
│   └── 文档D.docx
└── 子文件夹2
    └── 文档E.docx
```

### 步骤2：获取文件夹Token

1. 在飞书中打开测试文件夹
2. 从URL中复制文件夹token
   - URL格式：`https://xxx.feishu.cn/drive/folder/fldcnxxxxxx`
   - Token就是：`fldcnxxxxxx`

### 步骤3：打开导入界面

1. 登录NoteDoc
2. 进入目标文档库（Space）
3. 点击"导入"按钮
4. 选择"从飞书导入"

### 步骤4：测试批量导入

1. **切换到"批量导入"标签页**
   - 应该看到两个标签：单文档 | 批量导入

2. **输入文件夹Token**
   ```
   输入框：fldcnxxxxxx
   ```

3. **点击"加载文档"按钮**
   - 应该显示加载动画
   - 等待几秒后显示文档树

4. **验证文档树显示**
   - ✅ 显示所有文档和文件夹
   - ✅ 文件夹显示文件夹图标（蓝色）
   - ✅ 文档显示文件图标（灰色）
   - ✅ 文件夹旁显示子项数量 (N)

5. **测试展开/折叠**
   - 点击文件夹前的箭头图标
   - ✅ 箭头旋转90度
   - ✅ 子项显示/隐藏

6. **测试文档选择**
   - 勾选单个文档
   - ✅ 复选框被选中
   - ✅ 按钮文本更新："导入选中的文档 (1)"

7. **测试父子联动**
   - 勾选文件夹
   - ✅ 所有子文档自动被选中
   - ✅ 计数正确更新

8. **点击"导入选中的文档"**
   - ✅ 显示加载状态
   - ✅ 显示成功通知
   - ✅ 模态框关闭
   - ✅ 文档列表刷新

9. **验证导入结果**
   - 在文档库中查看导入的文档
   - ✅ 所有选中的文档都已导入
   - ✅ 父子关系正确（子文档在父文档下）
   - ✅ 文档内容完整

### 步骤5：测试边界情况

#### 测试1：空文件夹
```
输入一个空文件夹的token
预期：显示"未找到文档"提示
```

#### 测试2：无效Token
```
输入：invalid_token
预期：显示错误提示
```

#### 测试3：未选择文档
```
加载文档后，不选择任何文档，直接点击导入
预期：显示"请至少选择一个文档"提示
```

#### 测试4：大量文档
```
测试包含50+文档的文件夹
预期：
- 加载时间可能较长
- 树形结构正常显示
- 滚动条出现（高度超过400px）
```

## 测试检查清单

### UI测试
- [ ] 标签页切换正常
- [ ] 文件夹token输入框正常
- [ ] 加载按钮和状态正常
- [ ] 文档树渲染正确
- [ ] 图标显示正确（文件夹/文档）
- [ ] 展开/折叠动画流畅
- [ ] 复选框状态正确
- [ ] 计数显示准确
- [ ] 导入按钮状态正确

### 功能测试
- [ ] 文档列表加载成功
- [ ] 树形结构构建正确
- [ ] 父子关系正确
- [ ] 选择功能正常
- [ ] 父子联动正常
- [ ] 批量导入成功
- [ ] 文档内容完整
- [ ] 图片正常显示
- [ ] 视频正常显示

### 错误处理测试
- [ ] 无效token错误提示
- [ ] 权限不足错误提示
- [ ] 网络错误处理
- [ ] 未选择文档提示
- [ ] 部分导入失败处理

## 常见问题排查

### 问题1：加载文档失败
**可能原因**：
- Token格式错误
- 权限不足
- 网络问题

**解决方法**：
1. 检查token是否正确（从URL复制）
2. 检查飞书应用权限配置
3. 查看浏览器控制台错误信息
4. 查看后端日志

### 问题2：文档树为空
**可能原因**：
- 文件夹确实为空
- 只包含非文档类型文件
- API返回数据格式问题

**解决方法**：
1. 确认文件夹中有docx文档
2. 检查后端日志中的API响应
3. 验证文档类型过滤逻辑

### 问题3：导入失败
**可能原因**：
- 文档权限问题
- 文档内容格式问题
- 网络超时

**解决方法**：
1. 检查后端日志中的详细错误
2. 尝试单独导入失败的文档
3. 检查文档内容是否有特殊格式

## 调试技巧

### 1. 查看后端日志
```bash
# 查看导入过程日志
tail -f logs/app.log | grep -i feishu
```

### 2. 浏览器控制台
```javascript
// 查看API请求
Network -> Filter: feishu

// 查看组件状态
React DevTools -> Components -> FeishuOnlineImportModal
```

### 3. 测试API直接调用
```bash
# 测试文档列表API
curl -X POST http://localhost:3001/api/feishu/list-documents \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"folderToken": "fldcnxxxxxx"}'

# 测试批量导入API
curl -X POST http://localhost:3001/api/feishu/import/batch \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "spaceId": "YOUR_SPACE_ID",
    "documents": [
      {"token": "doc1", "parentToken": null},
      {"token": "doc2", "parentToken": "doc1"}
    ]
  }'
```

## 性能基准

### 预期性能指标
- 加载10个文档：< 2秒
- 加载50个文档：< 5秒
- 加载100个文档：< 10秒
- 导入10个文档：< 30秒
- 导入50个文档：< 2分钟

### 性能优化建议
如果性能不达标，可以：
1. 检查网络延迟
2. 优化API并发数
3. 添加缓存机制
4. 实现分页加载

## 测试报告模板

```markdown
## 飞书批量导入测试报告

**测试日期**：2024-XX-XX
**测试人员**：XXX
**测试环境**：开发/测试/生产

### 测试结果
- [ ] UI显示正常
- [ ] 文档加载成功
- [ ] 选择功能正常
- [ ] 批量导入成功
- [ ] 错误处理正确

### 发现的问题
1. 问题描述
   - 重现步骤
   - 预期结果
   - 实际结果
   - 截图/日志

### 性能数据
- 加载50个文档：X秒
- 导入10个文档：X秒

### 建议
- 优化建议1
- 优化建议2
```

## 下一步

测试通过后，可以：
1. 编写用户文档
2. 录制演示视频
3. 通知用户新功能
4. 收集用户反馈
5. 规划后续优化
