# 飞书权限配置详细步骤

## 问题现象

导入飞书文档时提示：
```
Access denied. One of the following scopes is required: [docx:document, docx:document:readonly]
应用尚未开通所需的应用身份权限
```

## 解决方案

### 步骤 1：访问飞书开放平台

访问：https://open.feishu.cn/app/cli_a9af6850aa389bdc/auth

（将 `cli_a9af6850aa389bdc` 替换为你的 App ID）

### 步骤 2：添加权限

1. 在左侧菜单点击"权限管理"
2. 点击"添加权限"或搜索框
3. 搜索"文档"
4. 找到以下权限之一并勾选：
   - ✅ **查看、评论和导出文档** (`docx:document:readonly`) - 推荐
   - ✅ **查看、评论、编辑和管理文档** (`docx:document`)
5. 点击"批量开通"或"确定"

### 步骤 3：发布版本（重要！）

⚠️ **权限添加后必须发布版本才能生效**

1. 在左侧菜单点击"版本管理与发布"
2. 点击"创建版本"按钮
3. 填写版本说明（例如：添加文档读取权限）
4. 选择"全部员工"或特定范围
5. 点击"保存并发布"

### 步骤 4：等待生效

- 权限发布后通常需要 **1-5 分钟**生效
- 建议等待 5 分钟后再测试

### 步骤 5：验证权限

1. 访问：https://open.feishu.cn/app/cli_a9af6850aa389bdc/auth
2. 检查"已开通权限"列表中是否包含：
   - `docx:document:readonly` 或
   - `docx:document`
3. 确认权限状态为"已开通"

## 常见问题

### Q1: 我已经添加权限了，为什么还是报错？

**A**: 可能的原因：
1. **没有发布版本** - 添加权限后必须创建并发布新版本
2. **权限还没生效** - 等待 5-10 分钟
3. **选错了权限** - 确保是 `docx:document:readonly` 或 `docx:document`
4. **应用类型不对** - 确保是"企业自建应用"

### Q2: 找不到"文档"相关权限

**A**: 
1. 确保应用类型是"企业自建应用"
2. 在权限管理页面搜索"docx"或"document"
3. 如果还是找不到，尝试搜索"云文档"

### Q3: 发布版本后还是不行

**A**: 
1. 等待 10 分钟
2. 清除浏览器缓存
3. 在 NoteDoc 中重新保存飞书配置
4. 检查飞书开放平台的"应用发布"状态

### Q4: 提示"应用未启用"

**A**: 
1. 进入"应用发布"页面
2. 确保应用状态为"已启用"
3. 如果是"停用"状态，点击"启用"

## 权限说明

### docx:document:readonly（推荐）
- 可以读取文档内容
- 可以导出文档
- **不能**编辑文档
- 适合导入场景

### docx:document
- 可以读取文档内容
- 可以编辑文档
- 可以管理文档
- 权限更高，但不是必需的

## 验证配置

### 方法 1：通过 API 测试

使用 Postman 或 curl 测试：

```bash
# 1. 获取 tenant_access_token
curl -X POST 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal' \
  -H 'Content-Type: application/json' \
  -d '{
    "app_id": "你的App ID",
    "app_secret": "你的App Secret"
  }'

# 2. 测试文档访问
curl -X GET 'https://open.feishu.cn/open-apis/docx/v1/documents/文档ID/raw_content' \
  -H 'Authorization: Bearer 上一步获取的token'
```

如果返回文档内容，说明权限配置正确。

### 方法 2：查看后端日志

在 NoteDoc 后端日志中查找：
```
Access denied. One of the following scopes is required
```

如果看到这个错误，说明权限还没生效。

## 完整配置检查清单

- [ ] 创建了飞书企业自建应用
- [ ] 复制了 App ID 和 App Secret
- [ ] 在 NoteDoc 系统设置中保存了配置
- [ ] 在飞书开放平台添加了 `docx:document:readonly` 权限
- [ ] 创建并发布了新版本
- [ ] 等待了 5-10 分钟
- [ ] 应用状态为"已启用"
- [ ] 在"已开通权限"中看到了文档权限

## 截图参考

### 1. 权限管理页面
应该看到：
- 权限名称：查看、评论和导出文档
- 权限标识：docx:document:readonly
- 状态：已开通

### 2. 版本管理页面
应该看到：
- 最新版本包含文档权限
- 发布状态：已发布
- 发布范围：全部员工

## 联系支持

如果按照以上步骤操作后仍然无法解决，请提供：
1. 飞书 App ID
2. 后端完整错误日志
3. 飞书开放平台的权限截图
4. 版本发布截图

---

**更新时间**：2025-11-26  
**适用版本**：NoteDoc v1.0.0
