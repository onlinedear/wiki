# 用户注册 404 错误修复指南

## 问题描述

访问注册页面并提交表单时，出现以下错误：
```
POST http://localhost:5173/api/auth/register 404 (Not Found)
```

## 原因

后端服务器没有重启，新添加的 `/api/auth/register` 端点还没有被加载。

## 解决方案

### 方案 1：重启开发服务器（推荐）

1. **停止当前服务器**
   - 在运行 `pnpm dev` 的终端按 `Ctrl+C`

2. **重新启动**
   ```bash
   pnpm dev
   ```

3. **等待服务器完全启动**
   - 后端服务器通常运行在 `http://localhost:3000`
   - 前端开发服务器运行在 `http://localhost:5173`
   - 等待看到类似 "Nest application successfully started" 的消息

4. **刷新浏览器**
   - 硬刷新：`Cmd+Shift+R` (Mac) 或 `Ctrl+Shift+R` (Windows/Linux)

### 方案 2：仅重启后端服务器

如果只想重启后端：

1. **找到后端进程并停止**
   ```bash
   # 查找 NestJS 进程
   ps aux | grep nest
   
   # 或查找 Node 进程
   ps aux | grep node
   
   # 停止进程（替换 <PID> 为实际进程 ID）
   kill <PID>
   ```

2. **重启后端**
   ```bash
   pnpm server:dev
   ```

### 方案 3：使用 PM2 或其他进程管理器

如果使用 PM2：
```bash
pm2 restart notedoc-server
```

## 验证修复

### 1. 检查后端端点

在终端运行：
```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com",
    "password": "testpass123",
    "confirmPassword": "testpass123"
  }'
```

**预期结果**：
- 如果端点正常，应该返回用户数据或错误信息（如邮箱已存在）
- 如果仍然 404，说明后端还没有完全重启

### 2. 检查后端日志

查看后端控制台输出，应该能看到：
```
[Nest] INFO [RouterExplorer] Mapped {/auth/register, POST} route
```

### 3. 测试注册页面

1. 访问 `http://localhost:5173/register`
2. 填写表单
3. 提交
4. 应该能够成功注册或看到具体的错误信息（不再是 404）

## 仍然无法解决？

### 检查清单

- [ ] 后端服务器已完全重启
- [ ] 后端控制台没有错误信息
- [ ] 后端运行在正确的端口（默认 3000）
- [ ] 前端代理配置正确（Vite 配置）
- [ ] 浏览器已清除缓存或使用无痕模式
- [ ] `apps/server/src/core/auth/auth.controller.ts` 包含注册端点代码

### 检查后端控制器

确认 `apps/server/src/core/auth/auth.controller.ts` 包含以下代码：

```typescript
@HttpCode(HttpStatus.OK)
@Post('register')
async register(
  @AuthWorkspace() workspace: Workspace,
  @Res({ passthrough: true }) res: FastifyReply,
  @Body() registerDto: RegisterDto,
) {
  validateSsoEnforcement(workspace);

  if (registerDto.password !== registerDto.confirmPassword) {
    throw new BadRequestException('Passwords do not match');
  }

  const authToken = await this.authService.register(
    {
      name: registerDto.name,
      email: registerDto.email,
      password: registerDto.password,
    },
    workspace.id,
  );

  this.setAuthCookie(res, authToken);
}
```

### 检查 DTO 文件

确认 `apps/server/src/core/auth/dto/register.dto.ts` 存在并包含正确的代码。

### 检查导入

确认 `apps/server/src/core/auth/auth.controller.ts` 顶部包含：

```typescript
import { RegisterDto } from './dto/register.dto';
```

### 重新构建

如果以上都正确，尝试清理并重新构建：

```bash
# 清理构建缓存
rm -rf apps/server/dist
rm -rf node_modules/.cache

# 重新安装依赖（可选）
pnpm install

# 重新启动
pnpm dev
```

## 其他常见错误

### 401 Unauthorized

如果看到 401 错误而不是 404，说明端点已经工作，但可能是：
- 用户未登录（这是正常的，注册页面不需要登录）
- 检查是否是 `/api/users/me` 的 401（这个可以忽略）

### 400 Bad Request

如果看到 400 错误，说明端点工作但数据验证失败：
- 检查表单字段是否完整
- 确认密码和确认密码是否匹配
- 确认邮箱格式正确

### 500 Internal Server Error

如果看到 500 错误，检查：
- 后端控制台的详细错误信息
- 数据库连接是否正常
- 环境变量是否配置正确

## 快速测试命令

```bash
# 1. 停止所有服务
pkill -f "nest\|vite"

# 2. 重新启动
pnpm dev

# 3. 等待 10 秒让服务器完全启动
sleep 10

# 4. 测试注册端点
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","email":"test@example.com","password":"12345678","confirmPassword":"12345678"}'
```

## 联系支持

如果问题仍然存在，请提供：
1. 后端控制台完整日志
2. 浏览器控制台错误信息
3. 网络请求详情（从浏览器开发者工具）
4. 运行 `./scripts/verify-register-implementation.sh` 的输出
