# 块类型标签显示功能说明

## 功能概述

在鼠标悬停在编辑器块上时，会显示一个标签来指示块的类型（如 "H1"、"Callout" 等）以及拖拽手柄，方便用户识别和操作不同类型的内容块。

## 最新更新 (v2)

### 新增功能
1. **图标显示** - 每个块类型标签现在都包含对应的图标，与 "/" 命令菜单中的图标一致
2. **编号列表优化** - 修复了编号+标题组合时的布局问题
3. **对齐改进** - 修复了编号与标题文本的垂直对齐问题

### 修复的问题
1. ✅ 拖拽手柄与编号重叠 - 调整了拖拽手柄的 z-index，确保在编号左侧正确显示
2. ✅ 编号与标题重叠 - 增加了列表项的 padding-left，为不同长度的编号（如 1.1.1）留出足够空间
3. ✅ 垂直对齐问题 - 使用 `display: inline-flex` 和 `align-items: baseline` 确保编号与标题在同一基线上

## 实现方式

### 1. GlobalDragHandle 配置增强

在 `apps/client/src/features/editor/extensions/extensions.ts` 中配置了 `GlobalDragHandle` 扩展：

```typescript
GlobalDragHandle.configure({
  dragHandleWidth: 20,
  scrollTreshold: 100,
  renderContent: (node) => {
    // 获取块类型信息（标签和图标）
    const { label, icon: IconComponent } = getBlockInfo(node);
    
    // 创建容器
    const container = document.createElement('div');
    container.className = 'drag-handle-container';
    
    // 创建标签（包含图标）
    const labelEl = document.createElement('div');
    labelEl.className = 'block-type-label';
    
    // 使用 renderToStaticMarkup 将 React 图标组件转换为 HTML
    if (IconComponent) {
      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'block-type-icon';
      iconWrapper.innerHTML = renderToStaticMarkup(
        React.createElement(IconComponent, { size: 14, stroke: 1.5 })
      );
      labelEl.appendChild(iconWrapper);
    }
    
    // 添加文本
    const textSpan = document.createElement('span');
    textSpan.textContent = label;
    labelEl.appendChild(textSpan);
    
    // 创建拖拽手柄
    const handleEl = document.createElement('div');
    handleEl.className = 'drag-handle-icon';
    
    container.appendChild(labelEl);
    container.appendChild(handleEl);
    
    return container;
  },
})
```

**关键技术点：**
- 使用 `react-dom/server` 的 `renderToStaticMarkup` 将 React 图标组件转换为静态 HTML
- 动态导入 `@tabler/icons-react` 图标组件
- 支持国际化，通过 `i18n.t()` 获取翻译后的标签文本

### 2. 块类型映射

支持的块类型及其显示标签：

| 块类型 | 显示标签 |
|--------|----------|
| heading (level 1-6) | H1, H2, H3, H4, H5, H6 |
| paragraph | P / 段落 |
| bulletList | • List / 无序列表 |
| orderedList | 1. List / 有序列表 |
| taskList | ☑ Task / 任务列表 |
| blockquote | Quote / 引用 |
| codeBlock | Code / 代码块 |
| callout | Callout / 高亮块 |
| table | Table / 表格 |
| image | Image / 图片 |
| video | Video / 视频 |
| attachment | File / 文件 |
| excalidraw | Excalidraw |
| drawio | Draw.io |
| gantt | Gantt / 甘特图 |
| embed | Embed / 嵌入 |
| details | Toggle / 折叠块 |
| mathBlock | Math / 数学公式 |

### 3. 样式实现

在 `apps/client/src/features/editor/styles/drag-handle.css` 中定义了主要样式类：

#### `.drag-handle-container`
- 容器元素，包含标签和手柄
- 默认透明度为 0，鼠标悬停时显示
- 使用 flexbox 布局，间距 4px
- `z-index: 50` 确保在内容上方显示

#### `.block-type-label`
- 块类型标签容器
- 使用 `display: flex` 布局，图标和文本水平排列
- 小字体（11px）、圆角（4px）、半透明背景
- 支持亮色/暗色主题
- 不可选中、不响应鼠标事件

#### `.block-type-icon`
- 图标容器
- 使用 `inline-flex` 确保图标正确对齐
- 图标大小 14px，stroke 1.5

#### `.drag-handle-icon`
- 拖拽手柄图标
- 六点拖拽图标（SVG）
- 支持 grab/grabbing 光标
- 响应鼠标事件，可拖拽
- `pointer-events: auto` 允许交互

### 4. 编号列表样式优化

在 `apps/client/src/features/editor/styles/ordered-list.css` 中优化了编号样式：

#### 间距调整
- 基础列表项：`padding-left: 3.5em`
- H1 标题：`padding-left: 4em`
- H2 标题：`padding-left: 4em`
- H3 标题：`padding-left: 5em`（编号更长）
- H4 标题：`padding-left: 5.5em`
- H5 标题：`padding-left: 6em`
- H6 标题：`padding-left: 6.5em`

#### 对齐优化
```css
.tiptap ol li:has(> h1)::before {
  display: inline-flex;
  align-items: baseline;  /* 与标题文本基线对齐 */
  min-width: 3em;         /* 确保编号有足够宽度 */
  top: 0;                 /* 从顶部开始对齐 */
}
```

#### 拖拽手柄位置
```css
/* 在有序列表中确保拖拽手柄不被编号遮挡 */
.tiptap ol li .drag-handle-container {
  z-index: 51;  /* 高于编号的 z-index */
}
```

### 4. 交互行为

1. **默认状态**：标签和手柄隐藏（透明度 0）
2. **鼠标悬停**：当鼠标悬停在任何块上时，显示对应的标签和手柄
3. **拖拽操作**：点击手柄可以拖拽移动整个块
4. **响应式**：在小屏幕（<600px）上自动隐藏

## 技术细节

### DOM 结构

```html
<div class="drag-handle-container">
  <div class="block-type-label">H1</div>
  <div class="drag-handle-icon"></div>
</div>
```

### 主题支持

- 使用 PostCSS `@mixin light` 和 `@mixin dark` 定义不同主题样式
- 暗色主题通过 `.dark` 类名切换

### 国际化

标签文本通过 `i18n.t()` 函数支持多语言：

```typescript
const blockLabels: Record<string, string> = {
  'paragraph': i18n.t('Paragraph') || 'P',
  'bulletList': i18n.t('Bullet List') || '• List',
  // ...
};
```

## 使用场景

1. **内容识别**：快速识别不同类型的内容块
2. **拖拽重排**：通过手柄拖拽调整块的顺序
3. **编辑辅助**：为用户提供视觉反馈，提升编辑体验

## 兼容性

- 兼容现有的 `drag-handle` 类名（向后兼容）
- 支持水平方向拖拽（通过 `data-direction` 属性）
- 移动端自动隐藏（避免干扰触摸操作）

## 测试建议

### 基础功能测试
1. 在编辑器中创建不同类型的块（标题、段落、列表等）
2. 鼠标悬停在每个块上，检查：
   - 标签是否正确显示
   - 图标是否与块类型匹配
   - 拖拽手柄是否可见
3. 测试拖拽功能是否正常工作
4. 切换亮色/暗色主题，检查样式是否正确
5. 在不同屏幕尺寸下测试响应式行为

### 编号列表专项测试
1. 创建有序列表，添加不同级别的标题（H1-H6）
2. 检查编号是否正确显示（1., 1.1, 1.1.1 等）
3. 验证编号与标题文本是否在同一基线上对齐
4. 检查长编号（如 1.1.1）是否与标题文本重叠
5. 鼠标悬停时，检查拖拽手柄是否在编号左侧正确显示，不与编号重叠
6. 测试拖拽功能在编号列表中是否正常工作

### 图标显示测试
验证以下块类型的图标是否正确显示：
- ✓ 标题（H1-H6）- 对应的标题图标
- ✓ 段落 - 文本图标
- ✓ 无序列表 - 列表图标
- ✓ 有序列表 - 编号列表图标
- ✓ 任务列表 - 复选框图标
- ✓ 引用 - 引用图标
- ✓ 代码块 - 代码图标
- ✓ 高亮块 - 信息图标
- ✓ 表格 - 表格图标
- ✓ 图片 - 图片图标
- ✓ 视频 - 视频图标
- ✓ 附件 - 回形针图标
- ✓ 甘特图 - 日历图标
- ✓ 折叠块 - 箭头图标
- ✓ 数学公式 - 数学图标
- ✓ 嵌入 - 窗口图标
- ✓ 子页面 - 站点地图图标

## 已知限制

1. **移动端隐藏** - 在屏幕宽度小于 600px 时，拖拽手柄和标签会自动隐藏，避免干扰触摸操作
2. **嵌套列表** - 在深度嵌套的列表中，拖拽手柄的位置可能需要进一步调整
3. **自定义块** - 如果添加了新的自定义块类型，需要在 `getBlockInfo` 函数中添加对应的图标映射

## 相关文件

### 核心实现
- `apps/client/src/features/editor/extensions/extensions.ts` - GlobalDragHandle 配置和块类型映射
- `apps/client/src/features/editor/styles/drag-handle.css` - 拖拽手柄和标签样式
- `apps/client/src/features/editor/styles/ordered-list.css` - 编号列表样式优化
- `apps/client/src/features/editor/styles/index.css` - 样式入口

### 依赖
- `tiptap-extension-global-drag-handle` - 拖拽手柄扩展
- `@tabler/icons-react` - 图标库
- `react-dom/server` - 用于将 React 组件转换为静态 HTML

### 参考
- `apps/client/src/features/editor/components/slash-menu/menu-items.ts` - Slash 命令菜单项定义（图标来源）
