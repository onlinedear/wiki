# 甘特图评论引用功能说明

## 功能概述

在甘特图中为任务添加评论时，评论会自动引用对应的任务名称，方便用户识别评论所关联的任务。

## 实现方式

### 1. 状态管理

在 `apps/client/src/features/comment/atoms/comment-atom.ts` 中添加了任务引用的状态管理：

```typescript
export interface TaskReference {
  taskId: string;
  taskName: string;
}

export const taskReferenceAtom = atom<TaskReference | null>(null);
```

### 2. 甘特图集成

在 `apps/client/src/features/editor/components/gantt/gantt-view.tsx` 中：

- 当用户点击任务的"添加评论"按钮时，会设置任务引用信息
- 同时打开评论侧边栏

```typescript
const handleAddComment = (taskId: string) => {
  const task = tasks.find(t => t.id === taskId);
  if (task) {
    setTaskReference({
      taskId: task.id,
      taskName: task.name,
    });
    
    setAsideState({
      tab: 'comments',
      isAsideOpen: true,
    });
  }
  handleCloseContextMenu();
};
```

### 3. 评论编辑器显示

在 `apps/client/src/features/comment/components/comment-editor.tsx` 中：

- 添加了 `showTaskReference` 属性来控制是否显示任务引用徽章
- 只有顶部的新评论输入框会显示任务引用徽章（`showTaskReference={true}`）
- 回复评论的输入框不显示任务引用徽章（默认 `showTaskReference={false}`）
- 当存在任务引用且 `showTaskReference` 为 true 时，在评论输入框上方显示一个徽章
- 徽章显示"引用任务: [任务名称]"
- 用户可以点击关闭按钮移除引用

### 4. 评论内容保存

在 `apps/client/src/features/comment/components/comment-list-with-tabs.tsx` 中：

- 创建评论时，如果存在任务引用，会在评论内容开头添加任务引用信息
- 引用信息以加粗文本形式显示：`[任务: 任务名称]`

## 使用流程

1. 在甘特图中右键点击任务
2. 选择"添加评论"选项
3. 评论侧边栏打开，顶部新评论输入框上方显示任务引用徽章
4. 输入评论内容
5. 提交评论后，评论内容会包含任务引用信息
6. 回复已有评论时，不会显示任务引用徽章（只有新评论才显示）

## 技术细节

- 使用 Jotai 进行状态管理
- 任务引用信息在评论提交后会被清除
- 引用信息作为 Tiptap 文档节点的一部分保存
- 支持用户手动移除引用（点击徽章上的关闭按钮）
- 通过 `showTaskReference` 属性控制徽章显示，只在新评论输入框显示，回复评论不显示

## 相关文件

- `apps/client/src/features/comment/atoms/comment-atom.ts` - 状态定义
- `apps/client/src/features/editor/components/gantt/gantt-view.tsx` - 甘特图集成
- `apps/client/src/features/comment/components/comment-editor.tsx` - 编辑器显示
- `apps/client/src/features/comment/components/comment-list-with-tabs.tsx` - 评论保存逻辑
