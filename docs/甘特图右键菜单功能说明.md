# 甘特图右键菜单功能说明

## 功能概述

甘特图右键菜单功能允许用户通过右键点击进度条来快速访问常用操作，包括清除时间条、查看详情、添加评论和删除记录。这是一个便捷的交互方式，提升了用户的操作效率。

## 功能特性

### 1. 右键菜单触发

- **操作方式**：在进度条上点击鼠标右键
- **菜单位置**：在鼠标点击位置附近显示
- **关闭方式**：
  - 点击菜单外的任意位置
  - 选择菜单项后自动关闭
  - 按 ESC 键关闭

### 2. 菜单选项

#### 2.1 清除时间条

- **图标**：日历 X 图标（IconCalendarX）
- **功能**：清除任务的开始日期和结束日期
- **效果**：
  - 进度条从甘特图中消失
  - 任务本身保留在任务列表中
  - 任务的其他字段（名称、自定义字段等）不受影响
- **使用场景**：
  - 任务尚未确定具体时间
  - 需要临时移除时间信息
  - 重新规划任务时间
- **只读模式**：禁用

#### 2.2 查看详情

- **图标**：信息圆圈图标（IconInfoCircle）
- **功能**：打开任务详情编辑对话框
- **效果**：与点击进度条相同，显示任务的所有信息
- **使用场景**：
  - 查看任务的完整信息
  - 编辑任务的各个字段
  - 修改任务的开始和结束日期
- **只读模式**：可用（但对话框中的编辑功能禁用）

#### 2.3 添加评论

- **图标**：消息加号图标（IconMessagePlus）
- **功能**：打开评论面板，针对当前任务添加评论
- **效果**：
  - 打开右侧评论区（如果支持）
  - 评论下方引用任务名称
  - 可以针对特定任务进行讨论
- **使用场景**：
  - 讨论任务的具体细节
  - 记录任务的进展情况
  - 与团队成员沟通任务相关问题
- **当前状态**：功能接口已预留，具体实现待完成

#### 2.4 删除记录

- **图标**：垃圾桶图标（IconTrash）
- **颜色**：红色（警告色）
- **功能**：删除整个任务记录
- **效果**：
  - 任务从任务列表中移除
  - 进度条从甘特图中消失
  - 任务的所有数据被删除
  - 操作不可恢复（除非使用撤销功能）
- **使用场景**：
  - 删除不需要的任务
  - 清理过期的任务
  - 移除错误创建的任务
- **只读模式**：禁用
- **分隔线**：此选项前有分隔线，与其他选项区分

## 使用方法

### 基本操作

1. **打开右键菜单**
   - 找到要操作的任务进度条
   - 在进度条上点击鼠标右键
   - 菜单在鼠标位置附近显示

2. **选择操作**
   - 浏览菜单选项
   - 点击需要的操作
   - 菜单自动关闭并执行操作

3. **取消操作**
   - 点击菜单外的任意位置
   - 或按 ESC 键
   - 菜单关闭，不执行任何操作

### 使用场景

#### 场景 1：清除未确定时间的任务

**需求**：任务 A 已创建，但具体时间尚未确定，需要先移除时间信息。

**操作**：
1. 在任务 A 的进度条上右键点击
2. 选择"清除时间条"
3. 进度条消失，任务保留在列表中

**效果**：
- 任务 A 仍在任务列表中
- 开始日期和结束日期为空
- 可以稍后重新设置时间

#### 场景 2：快速查看任务详情

**需求**：需要查看任务 B 的详细信息。

**操作**：
1. 在任务 B 的进度条上右键点击
2. 选择"查看详情"
3. 任务详情对话框打开

**效果**：
- 显示任务的所有字段
- 可以编辑任务信息
- 与左键点击进度条效果相同

#### 场景 3：针对任务添加评论

**需求**：需要讨论任务 C 的实施方案。

**操作**：
1. 在任务 C 的进度条上右键点击
2. 选择"添加评论"
3. 评论面板打开（待实现）

**效果**：
- 打开评论区
- 评论引用任务 C 的名称
- 可以与团队讨论

#### 场景 4：删除错误的任务

**需求**：任务 D 是错误创建的，需要删除。

**操作**：
1. 在任务 D 的进度条上右键点击
2. 选择"删除记录"
3. 任务被删除

**效果**：
- 任务 D 从列表中移除
- 进度条消失
- 如需恢复，使用撤销功能（Ctrl+Z / Cmd+Z）

## 技术实现

### 状态管理

```typescript
const [contextMenu, setContextMenu] = useState<{
  taskId: string;
  x: number;
  y: number;
} | null>(null);
```

### 右键菜单触发

```typescript
const handleContextMenu = (e: React.MouseEvent, taskId: string) => {
  e.preventDefault();
  e.stopPropagation();
  setContextMenu({
    taskId,
    x: e.clientX,
    y: e.clientY,
  });
};
```

### 菜单选项处理

```typescript
// 清除时间条
const handleClearTimeBar = (taskId: string) => {
  const newTasks = tasks.map(t => 
    t.id === taskId 
      ? { ...t, startDate: '', endDate: '' } 
      : t
  );
  updateAttributes({ tasks: newTasks });
  handleCloseContextMenu();
};

// 查看详情
const handleViewDetails = (taskId: string) => {
  const task = tasks.find(t => t.id === taskId);
  if (task) {
    setEditingTask(task);
    setIsModalOpen(true);
  }
  handleCloseContextMenu();
};

// 添加评论
const handleAddComment = (taskId: string) => {
  const task = tasks.find(t => t.id === taskId);
  if (task) {
    // TODO: 实现评论功能
    console.log('添加评论到任务:', task.name);
  }
  handleCloseContextMenu();
};

// 删除记录
const handleDeleteRecord = (taskId: string) => {
  const newTasks = tasks.filter(t => t.id !== taskId);
  updateAttributes({ tasks: newTasks });
  handleCloseContextMenu();
};
```

### 菜单渲染

```tsx
{contextMenu && (
  <Menu
    opened={true}
    onClose={handleCloseContextMenu}
    position="bottom-start"
    withinPortal
  >
    <Menu.Target>
      <Box
        style={{
          position: 'fixed',
          left: contextMenu.x,
          top: contextMenu.y,
          width: 0,
          height: 0,
        }}
      />
    </Menu.Target>
    <Menu.Dropdown>
      <Menu.Item
        leftSection={<IconCalendarX size={16} />}
        onClick={() => handleClearTimeBar(contextMenu.taskId)}
        disabled={isReadOnly}
      >
        清除时间条
      </Menu.Item>
      {/* 其他菜单项... */}
    </Menu.Dropdown>
  </Menu>
)}
```

## 与其他功能的交互

### 1. 与点击编辑功能的协同

- **左键点击**：打开任务详情对话框
- **右键点击**：显示右键菜单
- **右键菜单中的"查看详情"**：与左键点击效果相同

### 2. 与拖拽功能的协同

- **拖拽移动**：左键按住拖拽
- **右键菜单**：右键点击显示菜单
- **互不干扰**：两种操作独立工作

### 3. 与只读模式的协同

- **只读模式下**：
  - "清除时间条"禁用
  - "删除记录"禁用
  - "查看详情"可用（但不可编辑）
  - "添加评论"可用

### 4. 与撤销/重做的协同

- **清除时间条**：可撤销
- **删除记录**：可撤销
- **查看详情**：不涉及数据修改，无需撤销
- **添加评论**：评论系统自己处理撤销

## 注意事项

### 1. 清除时间条 vs 删除记录

| 操作 | 任务保留 | 进度条 | 其他字段 | 可恢复 |
|------|----------|--------|----------|--------|
| 清除时间条 | ✅ 保留 | ❌ 消失 | ✅ 保留 | ✅ 可重新设置 |
| 删除记录 | ❌ 删除 | ❌ 消失 | ❌ 删除 | ✅ 可撤销 |

### 2. 菜单位置

- 菜单在鼠标点击位置附近显示
- 如果靠近屏幕边缘，菜单会自动调整位置
- 使用 `withinPortal` 确保菜单不被容器裁剪

### 3. 评论功能

- 当前"添加评论"功能接口已预留
- 具体实现需要评论系统的支持
- 评论应该引用任务名称，方便识别

### 4. 删除确认

- 当前删除操作没有二次确认
- 建议在实际使用中添加确认对话框
- 或者依赖撤销功能来恢复误删

## 常见问题

### Q1：右键菜单没有显示？

A：可能的原因：
1. 浏览器禁用了右键菜单
2. 点击位置不在进度条上
3. 页面有其他元素覆盖

解决方法：
- 确保点击在进度条上
- 检查浏览器设置
- 刷新页面重试

### Q2：清除时间条后如何恢复？

A：两种方法：
1. 使用撤销功能（Ctrl+Z / Cmd+Z）
2. 点击任务，重新设置开始和结束日期

### Q3：删除记录后可以恢复吗？

A：可以，使用撤销功能（Ctrl+Z / Cmd+Z）。但如果已经保存文档并关闭，则无法恢复。

### Q4：为什么"添加评论"没有反应？

A：当前"添加评论"功能接口已预留，但具体实现待完成。点击后会在控制台输出日志。

### Q5：只读模式下可以使用右键菜单吗？

A：可以打开右键菜单，但"清除时间条"和"删除记录"会被禁用。"查看详情"可用但不可编辑。

### Q6：右键菜单如何关闭？

A：三种方式：
1. 点击菜单外的任意位置
2. 选择菜单项后自动关闭
3. 按 ESC 键

## 未来优化方向

1. **删除确认**：添加删除确认对话框，避免误删
2. **评论功能**：完整实现评论功能，包括评论面板和引用
3. **批量操作**：支持选中多个任务后批量操作
4. **更多选项**：
   - 复制任务
   - 移动到其他分组
   - 设置任务优先级
   - 标记为完成
5. **快捷键**：为常用操作添加快捷键
6. **自定义菜单**：允许用户自定义右键菜单选项
7. **菜单图标**：使用更直观的图标
8. **菜单分组**：将相关操作分组显示

## 相关文档

- [甘特图功能说明](./甘特图功能说明.md) - 完整功能概述
- [甘特图功能索引](./甘特图功能索引.md) - 所有文档导航

## 测试建议

### 基本功能测试
- [ ] 右键点击进度条显示菜单
- [ ] 点击"清除时间条"清除日期
- [ ] 点击"查看详情"打开对话框
- [ ] 点击"添加评论"（验证接口）
- [ ] 点击"删除记录"删除任务

### 菜单交互测试
- [ ] 点击菜单外关闭菜单
- [ ] 按 ESC 键关闭菜单
- [ ] 选择菜单项后自动关闭

### 只读模式测试
- [ ] 只读模式下"清除时间条"禁用
- [ ] 只读模式下"删除记录"禁用
- [ ] 只读模式下"查看详情"可用

### 撤销测试
- [ ] 清除时间条后可撤销
- [ ] 删除记录后可撤销

### 边界情况测试
- [ ] 在屏幕边缘右键点击
- [ ] 快速连续右键点击
- [ ] 右键点击后拖拽进度条
