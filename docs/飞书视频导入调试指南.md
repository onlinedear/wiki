# é£ä¹¦è§†é¢‘å¯¼å…¥è°ƒè¯•æŒ‡å—

## å½“å‰çŠ¶æ€

âœ… æƒé™å·²å¼€é€šï¼šäº‘æ–‡æ¡£æ‰€æœ‰æƒé™  
âš ï¸ è§†é¢‘ä¸‹è½½å¤±è´¥ï¼šéœ€è¦è°ƒè¯• API è°ƒç”¨

## è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šç¡®è®¤è§†é¢‘å—ç»“æ„

åœ¨å¯¼å…¥æ—¶ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„è§†é¢‘å—ç»“æ„ï¼š

```bash
# æŸ¥çœ‹è§†é¢‘ç›¸å…³æ—¥å¿—
grep -E "Video container|Found video file token|block_type.*33" logs/app.log

# æŸ¥çœ‹å®Œæ•´çš„å—ç»“æ„
grep -A 20 "Video container block found" logs/app.log
```

**æœŸæœ›è¾“å‡º**ï¼š
```
Video container block found with X children
Video child block type: XX, keys: block_id, block_type, parent_id, ...
Found video file token in child: VMxxxxxxxx
```

### æ­¥éª¤ 2ï¼šæµ‹è¯•è§†é¢‘ä¸‹è½½ API

ä½¿ç”¨ curl æµ‹è¯•ä¸åŒçš„ API ç«¯ç‚¹ï¼š

#### æ–¹æ³• 1ï¼šmedias APIï¼ˆæ¨èï¼‰

```bash
# 1. è·å– tenant_access_token
curl -X POST 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal' \
  -H 'Content-Type: application/json' \
  -d '{
    "app_id": "ä½ çš„App ID",
    "app_secret": "ä½ çš„App Secret"
  }'

# 2. è·å–è§†é¢‘ä¸‹è½½é“¾æ¥ï¼ˆä½¿ç”¨ä»æ—¥å¿—ä¸­è·å–çš„ video tokenï¼‰
curl -X GET 'https://open.feishu.cn/open-apis/drive/v1/medias/VMxxxxxxxx/download' \
  -H 'Authorization: Bearer ä¸Šä¸€æ­¥è·å–çš„token'
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "tmp_download_url": "https://..."
  }
}
```

**å¤±è´¥å“åº”**ï¼š
```json
{
  "code": 99991672,
  "msg": "Access denied",
  "data": {}
}
```

#### æ–¹æ³• 2ï¼šfiles API

```bash
curl -X GET 'https://open.feishu.cn/open-apis/drive/v1/files/VMxxxxxxxx/download' \
  -H 'Authorization: Bearer token'
```

#### æ–¹æ³• 3ï¼šè·å–è§†é¢‘å…ƒæ•°æ®

```bash
# å…ˆè·å–è§†é¢‘ä¿¡æ¯
curl -X GET 'https://open.feishu.cn/open-apis/drive/v1/medias/VMxxxxxxxx' \
  -H 'Authorization: Bearer token'
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥æƒé™é…ç½®

è®¿é—®é£ä¹¦å¼€æ”¾å¹³å°æƒé™é¡µé¢ï¼š
```
https://open.feishu.cn/app/ä½ çš„AppID/auth
```

ç¡®è®¤å·²å¼€é€šä»¥ä¸‹æƒé™ï¼š

#### å¿…éœ€æƒé™
- âœ… `docx:document:readonly` - æŸ¥çœ‹æ–‡æ¡£ï¼ˆåŒ…å« blocks APIï¼‰
- âœ… `drive:drive:readonly` - æŸ¥çœ‹äº‘ç©ºé—´æ–‡ä»¶

#### å¯èƒ½éœ€è¦çš„é¢å¤–æƒé™
- âš ï¸ `drive:file:readonly` - è¯»å–äº‘ç©ºé—´æ–‡ä»¶å†…å®¹
- âš ï¸ `media:media:readonly` - è¯»å–åª’ä½“æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨æ­¤æƒé™ï¼‰
- âš ï¸ `drive:drive` - äº‘ç©ºé—´å®Œæ•´æƒé™ï¼ˆåŒ…å«ä¸‹è½½ï¼‰

### æ­¥éª¤ 4ï¼šæŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

ä¿®æ”¹ä»£ç ä»¥è¾“å‡ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š

åœ¨ `feishu-api.service.ts` çš„ `getVideoUrl` æ–¹æ³•ä¸­ï¼Œå·²ç»æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºã€‚å¯¼å…¥æ—¶æŸ¥çœ‹ï¼š

```bash
# æŸ¥çœ‹è§†é¢‘ä¸‹è½½ç›¸å…³çš„æ‰€æœ‰æ—¥å¿—
tail -f logs/app.log | grep -E "video|Video|VMxxxxxxxx"

# æŸ¥çœ‹ API å“åº”
tail -f logs/app.log | grep -E "Method [123]|response code"
```

**å…³é”®æ—¥å¿—**ï¼š
```
Getting video URL for token: VMxxxxxxxx
Method 1 (medias) response code: 0, msg: success
âœ“ Got video URL via medias API: https://...
â¬‡ï¸ Downloading video from URL: https://...
âœ“ Downloaded video: 15.67 MB
```

æˆ–è€…å¤±è´¥æ—¶ï¼š
```
Getting video URL for token: VMxxxxxxxx
Method 1 (medias) response code: 99991672, msg: Access denied
Method 2 (files) response code: 99991672, msg: Access denied
âŒ All methods failed to get video URL for token: VMxxxxxxxx
```

### æ­¥éª¤ 5ï¼šæµ‹è¯•å®é™…ä¸‹è½½

å¦‚æœè·å–åˆ°äº† `tmp_download_url`ï¼Œæµ‹è¯•ä¸‹è½½ï¼š

```bash
# ä½¿ç”¨è·å–åˆ°çš„ä¸´æ—¶ä¸‹è½½é“¾æ¥
curl -o test_video.mp4 'https://internal-api-drive-stream.feishu.cn/...'

# æ£€æŸ¥æ–‡ä»¶å¤§å°
ls -lh test_video.mp4
```

**æ³¨æ„**ï¼šä¸´æ—¶ä¸‹è½½é“¾æ¥é€šå¸¸ä¸éœ€è¦ Authorization headerã€‚

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šæƒé™ä¸è¶³ (code: 99991672)

**ç—‡çŠ¶**ï¼š
```
Method 1 (medias) response code: 99991672, msg: Access denied
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥é£ä¹¦åº”ç”¨æƒé™é…ç½®
2. ç¡®è®¤å·²å¼€é€š `drive:drive:readonly` æˆ– `drive:drive`
3. æƒé™ä¿®æ”¹åç­‰å¾… 5-10 åˆ†é’Ÿç”Ÿæ•ˆ
4. é‡æ–°è·å– tenant_access_token

### é—®é¢˜ 2ï¼šToken ç±»å‹é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
Method 1 exception: Request failed with status code 404
Method 2 exception: Request failed with status code 404
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ token æ ¼å¼ï¼ˆåº”è¯¥æ˜¯ `VMxxxxxxxx` æˆ–ç±»ä¼¼æ ¼å¼ï¼‰
2. ç¡®è®¤ token æ¥æºï¼ˆä» blocks API çš„å“ªä¸ªå­—æ®µè·å–ï¼‰
3. å°è¯•ä¸åŒçš„ token å­—æ®µï¼š
   - `block.video.token`
   - `block.file.token`
   - `block.media.token`

### é—®é¢˜ 3ï¼šè§†é¢‘å—ç»“æ„ä¸æ­£ç¡®

**ç—‡çŠ¶**ï¼š
```
Video container block found with 0 children
âŒ Video block (type 33) has no processable children
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ blocks API è¿”å›çš„å®Œæ•´æ•°æ®
2. ç¡®è®¤è§†é¢‘å—æ˜¯å¦æœ‰ children
3. æ£€æŸ¥å­å—çš„ block_type å’Œå¯ç”¨å­—æ®µ

### é—®é¢˜ 4ï¼šä¸‹è½½è¶…æ—¶

**ç—‡çŠ¶**ï¼š
```
â¬‡ï¸ Downloading video from URL: https://...
âŒ Failed to download video for token VMxxxxxxxx
Download response status: undefined (timeout)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆå½“å‰æ˜¯ 2 åˆ†é’Ÿï¼‰
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. å°è¯•åˆ†æ®µä¸‹è½½å¤§æ–‡ä»¶

## è°ƒè¯•ä»£ç å¢å¼º

å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹ä»£ç ï¼š

### 1. è¾“å‡ºå®Œæ•´çš„è§†é¢‘å—ç»“æ„

åœ¨ `feishu-import.service.ts` çš„ `convertFeishuBlock` æ–¹æ³•ä¸­ï¼Œcase 33 éƒ¨åˆ†ï¼š

```typescript
case 33: // Video
  // è¾“å‡ºå®Œæ•´çš„å—ç»“æ„
  this.logger.debug(`=== Full Video Block Structure ===`);
  this.logger.debug(JSON.stringify(block, null, 2));
  
  if (block.children && blockMap) {
    for (const childId of block.children) {
      const childBlock = blockMap.get(childId);
      this.logger.debug(`=== Child Block ${childId} ===`);
      this.logger.debug(JSON.stringify(childBlock, null, 2));
    }
  }
  // ... ç»§ç»­åŸæœ‰é€»è¾‘
```

### 2. æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„ API ç«¯ç‚¹

åœ¨ `feishu-api.service.ts` çš„ `getVideoUrl` æ–¹æ³•ä¸­æ·»åŠ æ›´å¤šå°è¯•ï¼š

```typescript
// Method 3: Try video-specific API (if exists)
try {
  const response = await client.get(`/drive/v1/videos/${videoToken}/download`);
  // ...
} catch (err) {
  this.logger.debug(`Method 3 exception: ${err instanceof Error ? err.message : 'Unknown'}`);
}

// Method 4: Try getting file metadata first
try {
  const metaResponse = await client.get(`/drive/v1/medias/${videoToken}`);
  this.logger.debug(`Video metadata: ${JSON.stringify(metaResponse.data)}`);
} catch (err) {
  this.logger.debug(`Metadata fetch exception: ${err instanceof Error ? err.message : 'Unknown'}`);
}
```

## æµ‹è¯•æ–‡æ¡£å‡†å¤‡

åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡æ¡£ï¼š

1. åœ¨é£ä¹¦ä¸­åˆ›å»ºæ–°æ–‡æ¡£
2. æ’å…¥ä¸€ä¸ªå°è§†é¢‘ï¼ˆ< 10MBï¼‰
3. è®°å½•æ–‡æ¡£ URL
4. å°è¯•å¯¼å…¥åˆ° NoteDoc
5. æŸ¥çœ‹æ—¥å¿—è¾“å‡º

## æˆåŠŸæ ‡å¿—

å½“è§†é¢‘å¯¼å…¥æˆåŠŸæ—¶ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ“¥ Processing video with token: VMxxxxxxxx
Getting video URL for token: VMxxxxxxxx
âœ“ Got video URL via medias API: https://...
â¬‡ï¸ Downloading video from URL: https://...
âœ“ Downloaded video: 15.67 MB
ğŸ“¤ Video uploaded to storage: workspace-xxx/files/...
Creating video attachment record: {"id":"...","fileName":"..."}
âœ… Video imported successfully: uuid-xxx (15.67 MB)
   File path: workspace-xxx/files/uuid-xxx/uuid-xxx.mp4
   Access URL: /files/uuid-xxx/uuid-xxx.mp4
```

## ä¸‹ä¸€æ­¥

æ ¹æ®è°ƒè¯•ç»“æœï¼š

1. **å¦‚æœæƒé™é—®é¢˜** â†’ é…ç½®æ­£ç¡®çš„é£ä¹¦åº”ç”¨æƒé™
2. **å¦‚æœ API ç«¯ç‚¹é—®é¢˜** â†’ æŸ¥é˜…é£ä¹¦ API æ–‡æ¡£ï¼Œæ‰¾åˆ°æ­£ç¡®çš„è§†é¢‘ä¸‹è½½ç«¯ç‚¹
3. **å¦‚æœ token é—®é¢˜** â†’ æ£€æŸ¥ blocks API è¿”å›çš„æ•°æ®ç»“æ„
4. **å¦‚æœä¸‹è½½é—®é¢˜** â†’ æ£€æŸ¥ç½‘ç»œã€è¶…æ—¶è®¾ç½®ã€æ–‡ä»¶å¤§å°é™åˆ¶

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šNoteDoc v1.0.0
