# 附件搜索功能实现说明

## 功能概述

实现了按附件名称和内容进行全文搜索的功能，用户可以在搜索界面中选择"附件"类型来搜索所有上传的文件。

## 实现内容

### 1. 数据库层

#### 迁移文件：`20251121T100000-attachments-tsvector-trigger.ts`

- 创建了 PostgreSQL 全文搜索触发器函数 `attachments_tsvector_trigger()`
- 自动维护 `attachments` 表的 `tsv` 字段（tsvector类型）
- 搜索权重：
  - 文件名（file_name）：权重 A（最高）
  - 文件内容（text_content）：权重 B
- 使用 `f_unaccent()` 函数支持无重音符号搜索
- 自动更新现有附件的 tsv 字段

### 2. 后端实现

#### 搜索控制器（`search.controller.ts`）

新增路由：`POST /search-attachments`

```typescript
@HttpCode(HttpStatus.OK)
@Post('search-attachments')
async attachmentSearch(
  @Body() searchDto: SearchDTO,
  @AuthUser() user: User,
  @AuthWorkspace() workspace: Workspace,
)
```

- 需要 JWT 认证
- 支持按空间过滤
- 检查用户对空间的读取权限

#### 搜索服务（`search.service.ts`）

新增方法：`searchAttachments()`

**功能特性：**
- 使用 PostgreSQL 全文搜索（ts_rank 排序）
- 支持模糊匹配（查询词后自动添加 `*`）
- 生成搜索结果高亮（ts_headline）
- 关联查询页面和空间信息
- 只搜索用户有权限访问的空间
- 排除已删除的附件和页面

**返回数据结构：**
```typescript
{
  id: string;              // 附件ID
  fileName: string;        // 文件名
  pageId: string;          // 所属页面ID
  creatorId: string;       // 创建者ID
  createdAt: Date;         // 创建时间
  updatedAt: Date;         // 更新时间
  rank: number;            // 搜索相关度评分
  highlight: string;       // 高亮的搜索结果片段
  space: {                 // 所属空间信息
    id: string;
    name: string;
    slug: string;
    logo: string;
  };
  page: {                  // 所属页面信息
    id: string;
    title: string;
    slugId: string;
  };
}
```

### 3. 前端实现

前端已有完整的附件搜索UI支持：

#### 搜索服务（`search-service.ts`）
- `searchAttachments()` 方法调用后端 API

#### 统一搜索钩子（`use-unified-search.ts`）
- 根据 `contentType` 参数自动路由到附件或页面搜索
- 附件搜索对所有用户开放

#### 搜索过滤器（`search-spotlight-filters.tsx`）
- 提供"类型"下拉菜单
- 选项：页面 / 附件
- 附件选项对所有用户开放

#### 搜索结果展示（`search-result-item.tsx`）
- 附件结果显示：
  - 文件图标
  - 文件名
  - 所属空间和页面
  - 搜索高亮片段
  - 下载按钮
- 点击结果跳转到附件所在页面
- 点击下载图标直接下载附件

## 使用方法

### 用户操作流程

1. **打开搜索**
   - Mac: `Cmd + K`
   - Windows/Linux: `Ctrl + K`

2. **选择搜索类型**
   - 点击"类型"下拉菜单
   - 选择"附件"

3. **输入搜索关键词**
   - 支持文件名搜索
   - 支持文件内容搜索（PDF和DOCX）

4. **查看搜索结果**
   - 显示匹配的附件列表
   - 显示附件所在的页面和空间
   - 高亮显示匹配的内容片段

5. **操作附件**
   - 点击结果：跳转到附件所在页面
   - 点击下载图标：直接下载附件

### 可选过滤

- **按空间过滤**：点击"空间"下拉菜单选择特定空间
- **全局搜索**：选择"所有空间"搜索全部附件

## 技术特性

### 搜索能力

1. **文件名搜索**
   - 支持部分匹配
   - 不区分大小写
   - 支持无重音符号搜索

2. **文件内容搜索**
   - PDF 文件内容（通过后台索引）
   - DOCX 文件内容（通过后台索引）
   - 其他文件类型仅搜索文件名

3. **搜索优化**
   - 使用 PostgreSQL GIN 索引加速
   - 按相关度排序（ts_rank）
   - 自动生成搜索结果摘要

### 权限控制

- 只搜索用户有权限访问的空间中的附件
- 自动过滤已删除的附件和页面
- 支持按创建者过滤（可选）

### 性能优化

- 使用数据库触发器自动维护搜索索引
- GIN 索引加速全文搜索
- 支持分页（limit/offset）
- 查询防抖（300ms）

## 许可证要求

附件搜索功能对所有用户开放，无需企业版许可证或云版本。

## 文件结构

```
apps/server/src/
├── core/search/
│   ├── search.controller.ts          # 新增附件搜索路由
│   └── search.service.ts             # 新增附件搜索方法
└── database/migrations/
    └── 20251121T100000-attachments-tsvector-trigger.ts  # 新增触发器

apps/client/src/features/search/
├── services/search-service.ts        # 已有附件搜索API调用
├── hooks/use-unified-search.ts       # 已有统一搜索逻辑
├── components/
│   ├── search-spotlight-filters.tsx  # 已有附件类型过滤
│   └── search-result-item.tsx        # 已有附件结果展示
└── types/search.types.ts             # 已有附件搜索类型定义

scripts/
└── test-attachment-search.sh         # 功能测试脚本
```

## 测试验证

运行测试脚本：
```bash
./scripts/test-attachment-search.sh
```

测试内容：
- ✓ 数据库迁移状态
- ✓ 后端搜索路由
- ✓ 搜索服务方法
- ✓ 前端搜索服务
- ✓ 前端搜索UI
- ✓ 数据库触发器

## 注意事项

1. **内容索引**
   - PDF 和 DOCX 文件上传后会自动索引内容
   - 索引过程在后台队列中异步执行
   - 其他文件类型仅索引文件名

2. **搜索语法**
   - 自动添加通配符支持前缀匹配
   - 使用英文分词器（english）
   - 支持多词搜索

3. **性能考虑**
   - 大量附件时建议使用空间过滤
   - 搜索结果默认限制20条
   - 可通过 limit/offset 参数分页

## 后续优化建议

1. 支持更多文件类型的内容索引（TXT、MD等）
2. 支持高级搜索语法（AND、OR、NOT）
3. 添加文件类型过滤（按扩展名）
4. 添加文件大小过滤
5. 支持按上传时间范围过滤
6. 添加搜索历史记录
7. 优化搜索结果排序算法
