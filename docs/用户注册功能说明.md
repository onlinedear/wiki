# 用户注册功能实现说明

## 功能概述

实现了用户自助注册功能，允许新用户通过邮箱、密码和姓名进行注册。注册后的用户将自动分配到"注册用户"默认用户组，角色为"用户"。

## 实现内容

### 后端实现

#### 1. 注册 DTO (`apps/server/src/core/auth/dto/register.dto.ts`)
- 定义注册请求数据结构
- 字段验证：
  - `name`: 必填，1-50 字符
  - `email`: 必填，有效邮箱格式
  - `password`: 必填，8-70 字符
  - `confirmPassword`: 必填，8-70 字符

#### 2. 控制器端点 (`apps/server/src/core/auth/auth.controller.ts`)
- 新增 `POST /api/auth/register` 端点
- 验证 SSO 强制登录状态（如果启用 SSO 强制登录，则禁用注册）
- 验证密码和确认密码是否匹配
- 调用认证服务完成注册
- 自动设置认证 Cookie

#### 3. 认证服务 (`apps/server/src/core/auth/services/auth.service.ts`)
- 更新 `register` 方法，确保新用户角色为 `UserRole.USER`
- 通过 `signupService.signup` 创建用户
- 自动添加用户到默认用户组（通过 `addUserToDefaultGroup`）
- 生成并返回访问令牌

### 前端实现

#### 1. 注册页面 (`apps/client/src/pages/auth/register.tsx`)
- 创建注册页面组件
- 设置页面标题和元数据

#### 2. 注册表单 (`apps/client/src/features/auth/components/register-form.tsx`)
- 实现注册表单 UI，风格与登录页面保持一致
- 表单字段：
  - 姓名（Name）
  - 邮箱（Email）
  - 密码（Password）
  - 确认密码（Confirm Password）
- 表单验证：
  - 所有字段必填
  - 邮箱格式验证
  - 密码最少 8 字符
  - 密码和确认密码必须匹配
- SSO 强制登录检测：如果启用，显示提示信息
- 注册成功后自动跳转到首页
- 错误处理和通知

#### 3. 认证服务 (`apps/client/src/features/auth/services/auth-service.ts`)
- 新增 `register` 方法
- 导出 `AuthService` 对象，包含所有认证相关方法

#### 4. 类型定义 (`apps/client/src/features/auth/types/auth.types.ts`)
- 更新 `IRegister` 接口，包含所有必需字段

#### 5. 路由配置
- `apps/client/src/lib/app-route.ts`: 添加 `REGISTER: "/register"` 路由
- `apps/client/src/App.tsx`: 添加注册页面路由

#### 6. 登录表单更新 (`apps/client/src/features/auth/components/login-form.tsx`)
- 添加"还没有账户？注册"链接

### 国际化

#### 英文翻译 (`apps/client/public/locales/en-US/translation.json`)
```json
"Register": "Register",
"Don't have an account?": "Don't have an account?",
"Already have an account?": "Already have an account?",
"Confirm your password": "Confirm your password",
"Registration Disabled": "Registration Disabled",
"Registration is disabled when SSO is enforced.": "Registration is disabled when SSO is enforced."
```

#### 中文翻译 (`apps/client/public/locales/zh-CN/translation.json`)
```json
"Register": "注册",
"Don't have an account?": "还没有账户？",
"Already have an account?": "已有账户？",
"Confirm your password": "确认密码",
"Confirm Password": "确认密码",
"Registration Disabled": "注册已禁用",
"Registration is disabled when SSO is enforced.": "启用 SSO 强制登录时，注册功能将被禁用。"
```

## 用户流程

1. 用户访问 `/register` 页面
2. 填写注册表单：
   - 姓名
   - 邮箱地址
   - 密码
   - 确认密码
3. 提交表单
4. 后端验证：
   - 检查 SSO 强制登录状态
   - 验证密码匹配
   - 检查邮箱是否已存在
   - 创建用户账户
5. 自动设置用户属性：
   - 角色：`USER`（用户）
   - 用户组：默认用户组（"注册用户"）
6. 生成认证令牌并设置 Cookie
7. 自动跳转到首页

## 安全特性

1. **密码验证**：前后端双重验证密码匹配
2. **SSO 强制登录保护**：启用 SSO 强制登录时禁用注册
3. **邮箱唯一性**：防止重复注册
4. **密码强度**：最少 8 字符
5. **自动认证**：注册成功后自动登录

## 测试

使用测试脚本验证功能：

```bash
./scripts/test-register.sh
```

测试场景：
1. 正常注册流程
2. 注册后登录验证
3. 密码不匹配错误
4. 重复邮箱注册错误

## 访问路径

- 注册页面：`http://localhost:5173/register`
- 登录页面：`http://localhost:5173/login`

## 注意事项

1. 注册功能在 SSO 强制登录启用时会被禁用
2. 新注册用户默认角色为"用户"，权限受限
3. 新用户会自动加入默认用户组
4. 注册成功后会自动设置认证 Cookie，无需再次登录
5. 所有密码都会经过哈希处理后存储

## 相关文件

### 后端
- `apps/server/src/core/auth/dto/register.dto.ts`
- `apps/server/src/core/auth/auth.controller.ts`
- `apps/server/src/core/auth/services/auth.service.ts`
- `apps/server/src/core/auth/services/signup.service.ts`

### 前端
- `apps/client/src/pages/auth/register.tsx`
- `apps/client/src/features/auth/components/register-form.tsx`
- `apps/client/src/features/auth/services/auth-service.ts`
- `apps/client/src/features/auth/types/auth.types.ts`
- `apps/client/src/App.tsx`
- `apps/client/src/lib/app-route.ts`

### 翻译
- `apps/client/public/locales/en-US/translation.json`
- `apps/client/public/locales/zh-CN/translation.json`

### 测试
- `scripts/test-register.sh`
