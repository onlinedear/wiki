# 甘特图排序功能实现要点

## 快速概览

为甘特图添加了完整的排序功能，支持多条件排序、智能字段类型识别、拖拽调整优先级。

## 核心实现

### 1. 数据结构

```typescript
// 排序条件
interface SortCondition {
  id: string;           // 唯一标识
  fieldId: string;      // 字段ID
  direction: 'asc' | 'desc';  // 排序方向
}

// 状态
const [sortConditions, setSortConditions] = useState<SortCondition[]>([]);
const [autoSort, setAutoSort] = useState(true);
```

### 2. 排序算法

```typescript
// 核心比较函数
const compareValues = (a, b, field, direction) => {
  // 1. 处理空值（空值排最后）
  // 2. 根据字段类型选择比较方式：
  //    - 文本：localeCompare('zh-CN') 支持中文拼音
  //    - 数字：直接相减
  //    - 日期：时间戳比较
  //    - 单选/多选：选项索引比较
  //    - 人员：姓名比较
  // 3. 根据 direction 返回正序或倒序
}

// 应用排序
const applySorting = (tasks) => {
  if (!autoSort || sortConditions.length === 0) return tasks;
  
  return [...tasks].sort((a, b) => {
    // 按条件顺序依次比较
    for (const condition of sortConditions) {
      const result = compareValues(a, b, field, condition.direction);
      if (result !== 0) return result;  // 不相等立即返回
    }
    return 0;  // 所有条件都相等
  });
}
```

### 3. UI组件

```typescript
// 排序模态框
<Modal opened={isSortModalOpen} title="设置排序条件">
  {/* 自动排序开关 */}
  <Checkbox checked={autoSort} onChange={...} />
  
  {/* 排序条件列表（支持拖拽） */}
  <DragDropContext onDragEnd={handleSortDragEnd}>
    <Droppable droppableId="sort-conditions">
      {sortConditions.map((condition) => (
        <Draggable key={condition.id} draggableId={condition.id}>
          {/* 拖拽手柄 */}
          <IconGripVertical />
          
          {/* 字段选择 */}
          <Select value={condition.fieldId} data={allFields} />
          
          {/* 排序方向按钮 */}
          <Button onClick={() => setDirection('asc')}>A → Z</Button>
          <Button onClick={() => setDirection('desc')}>Z → A</Button>
          
          {/* 删除按钮 */}
          <Button onClick={() => handleDelete(condition.id)}>×</Button>
        </Draggable>
      ))}
    </Droppable>
  </DragDropContext>
  
  {/* 添加条件按钮 */}
  <Button onClick={handleAddSortCondition}>选择条件</Button>
</Modal>
```

### 4. 集成到任务列表

```typescript
// 筛选和排序后的任务列表
const filteredTasks = useMemo(() => {
  const filtered = tasks.filter(applyFilters);  // 先筛选
  return applySorting(filtered);                 // 后排序
}, [tasks, filterConditions, sortConditions, autoSort]);
```

## 关键特性

### 中文排序支持

```typescript
// 使用 localeCompare 支持中文拼音排序
String(aValue).localeCompare(String(bValue), 'zh-CN', { 
  sensitivity: 'base' 
});
```

### 空值处理

```typescript
// 空值统一排在最后
if (aValue === null || aValue === undefined || aValue === '') {
  return direction === 'asc' ? 1 : -1;
}
```

### 选项顺序排序

```typescript
// 单选/多选按选项定义的顺序排序
if (field.options && Array.isArray(field.options)) {
  const indexA = field.options.indexOf(aValue);
  const indexB = field.options.indexOf(bValue);
  result = indexA - indexB;
}
```

### 排序方向显示

```typescript
// 根据字段类型显示不同的排序方向文本
const getSortDirectionLabel = (fieldType, direction) => {
  if (fieldType === 'number' || fieldType === 'date') {
    return direction === 'asc' ? '0 → 9' : '9 → 0';
  } else if (fieldType === 'select' || fieldType === 'multiSelect') {
    return direction === 'asc' ? '选项顺序' : '选项倒序';
  } else {
    return direction === 'asc' ? 'A → Z' : 'Z → A';
  }
};
```

## 文件修改

### 主要修改

**apps/client/src/features/editor/components/gantt/gantt-view.tsx**

1. 添加类型定义（第 60-67 行）
2. 添加状态管理（第 105-106 行）
3. 添加排序逻辑函数（第 700-850 行）
4. 更新工具栏按钮（第 920 行）
5. 添加排序模态框（第 2100-2250 行）

### 新增文档

- `docs/甘特图排序功能说明.md` - 完整功能说明
- `docs/甘特图排序快速开始.md` - 快速上手指南
- `docs/甘特图排序测试清单.md` - 测试用例清单
- `docs/甘特图排序功能开发总结.md` - 开发总结

## 使用示例

### 示例1：按日期排序

```typescript
// 用户操作：
// 1. 点击"排序"按钮
// 2. 点击"选择条件"
// 3. 选择字段：开始日期
// 4. 选择方向：0 → 9

// 结果：任务按开始日期从早到晚排列
```

### 示例2：多条件排序

```typescript
// 用户操作：
// 1. 添加第一个条件：状态 - 选项顺序
// 2. 添加第二个条件：开始日期 - 0 → 9

// 结果：
// - 先按状态分组（待办、进行中、已完成）
// - 同一状态内按开始日期排序
```

### 示例3：调整优先级

```typescript
// 用户操作：
// 1. 拖动第二个条件到第一位

// 结果：
// - 排序优先级改变
// - 先按开始日期排序
// - 同一日期内按状态排序
```

## 注意事项

1. **本地排序**：排序仅在客户端进行，不修改服务器数据
2. **刷新重置**：刷新页面后排序条件会重置
3. **不影响他人**：每个用户的排序条件独立，不影响其他协作者
4. **与筛选配合**：排序在筛选之后应用
5. **性能考虑**：大数据量时可能有轻微延迟

## 测试要点

- [ ] 各种字段类型的排序正确性
- [ ] 中文拼音排序正确
- [ ] 多条件排序优先级正确
- [ ] 拖拽调整顺序正常
- [ ] 空值处理正确
- [ ] 与筛选功能配合正常
- [ ] 性能可接受

## 后续优化

1. 保存排序配置到 localStorage
2. 添加快速排序预设
3. 支持列标题点击排序
4. 添加排序动画效果
5. 优化大数据量性能

## 相关文档

- [完整功能说明](./甘特图排序功能说明.md)
- [快速开始](./甘特图排序快速开始.md)
- [测试清单](./甘特图排序测试清单.md)
- [开发总结](./甘特图排序功能开发总结.md)
