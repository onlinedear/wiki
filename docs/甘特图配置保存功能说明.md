# 甘特图配置保存功能说明

## 功能概述

甘特图配置保存功能允许用户将个性化的视图设置（筛选、排序、分组）保存到数据库中，确保刷新页面或下次访问时能够恢复这些设置。

## 功能特性

### 1. 可保存的配置项

以下个性化设置可以被保存：

- **筛选条件**：
  - 所有筛选条件（字段、操作符、值）
  - 筛选逻辑（所有/任一）
  
- **排序条件**：
  - 所有排序条件（字段、排序方向）
  - 排序条件的优先级顺序
  - 自动排序开关状态
  
- **分组条件**：
  - 分组字段
  - 分组状态（是否启用分组）

### 2. 保存配置按钮

- **位置**：工具栏左侧，"分组"按钮右侧
- **图标**：软盘图标（IconDeviceFloppy）
- **状态指示**：
  - 无未保存更改：灰色（subtle），按钮禁用
  - 有未保存更改：绿色（filled），按钮可点击
- **提示文本**："保存配置"

### 3. 未保存更改检测

以下操作会触发"有未保存更改"状态：

1. **筛选相关**：
   - 添加筛选条件
   - 更新筛选条件（字段、操作符、值）
   - 删除筛选条件
   - 清空所有筛选条件
   - 切换筛选逻辑（所有/任一）

2. **排序相关**：
   - 添加排序条件
   - 更新排序条件（字段、排序方向）
   - 删除排序条件
   - 清空所有排序条件
   - 拖拽调整排序优先级
   - 切换自动排序开关

3. **分组相关**：
   - 设置分组字段
   - 清除分组

### 4. 配置加载

- 页面加载时自动从数据库读取保存的配置
- 配置包括：
  - 筛选条件和逻辑
  - 排序条件和自动排序状态
  - 分组条件
- 如果没有保存的配置，使用默认值：
  - 无筛选条件
  - 无排序条件
  - 自动排序开启
  - 无分组

### 5. 配置持久化

- 配置保存到甘特图节点的 `viewConfig` 属性中
- 数据存储在文档的 JSON 结构中
- 与文档一起保存到数据库
- 支持协作：所有用户看到相同的配置

## 使用流程

### 基本使用

1. **设置个性化配置**：
   - 添加筛选条件
   - 设置排序规则
   - 选择分组字段

2. **观察按钮状态**：
   - "保存配置"按钮变为绿色
   - 表示有未保存的更改

3. **保存配置**：
   - 点击"保存配置"按钮
   - 按钮变回灰色并禁用
   - 配置已保存到数据库

4. **验证保存**：
   - 刷新页面
   - 配置自动恢复
   - 筛选、排序、分组状态保持不变

### 场景示例

#### 场景 1：项目经理的日常视图

**需求**：项目经理每天都需要查看"进行中"的任务，按优先级排序，并按负责人分组。

**操作**：
1. 设置筛选：任务状态 = 进行中
2. 设置排序：优先级（高到低）
3. 设置分组：负责人
4. 点击"保存配置"按钮
5. 下次打开文档时，自动显示这个视图

**效果**：
- 无需每次重新设置
- 快速进入工作状态
- 提高工作效率

#### 场景 2：团队共享视图

**需求**：团队希望所有成员看到相同的任务视图。

**操作**：
1. 团队负责人设置筛选、排序、分组
2. 点击"保存配置"
3. 其他成员打开文档时看到相同的视图

**效果**：
- 统一的任务视图
- 减少沟通成本
- 提高协作效率

#### 场景 3：多视图切换

**需求**：需要在不同的视图之间切换（如：按状态分组 vs 按负责人分组）。

**操作**：
1. 设置视图 A（按状态分组）
2. 保存配置
3. 需要切换时，修改分组条件
4. 临时使用视图 B（按负责人分组）
5. 不保存，刷新页面恢复视图 A

**提示**：
- 如果需要多个固定视图，可以考虑复制甘特图块
- 每个甘特图块可以保存不同的配置

## 技术实现

### 数据结构

```typescript
interface FilterCondition {
  id: string;
  fieldId: string;
  operator: 'equals' | 'notEquals' | 'contains' | 'notContains' | 'isEmpty' | 'isNotEmpty';
  value: any;
}

interface SortCondition {
  id: string;
  fieldId: string;
  direction: 'asc' | 'desc';
}

interface GroupCondition {
  fieldId: string;
}

interface GanttViewConfig {
  filterConditions?: FilterCondition[];
  filterLogic?: 'and' | 'or';
  sortConditions?: SortCondition[];
  autoSort?: boolean;
  groupCondition?: GroupCondition | null;
}

interface GanttAttributes {
  tasks?: GanttTask[];
  viewMode?: 'week' | 'month' | 'quarter' | 'year';
  hiddenColumns?: string[];
  customFields?: CustomField[];
  ganttSettings?: GanttSettings;
  viewConfig?: GanttViewConfig;  // 新增
}
```

### 状态管理

```typescript
// 从保存的配置初始化状态
const savedViewConfig = node.attrs.viewConfig || {};
const [filterConditions, setFilterConditions] = useState(savedViewConfig.filterConditions || []);
const [filterLogic, setFilterLogic] = useState(savedViewConfig.filterLogic || 'and');
const [sortConditions, setSortConditions] = useState(savedViewConfig.sortConditions || []);
const [autoSort, setAutoSort] = useState(savedViewConfig.autoSort !== undefined ? savedViewConfig.autoSort : true);
const [groupCondition, setGroupCondition] = useState(savedViewConfig.groupCondition || null);
const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
```

### 保存逻辑

```typescript
const handleSaveViewConfig = () => {
  const viewConfig = {
    filterConditions,
    filterLogic,
    sortConditions,
    autoSort,
    groupCondition,
  };
  updateAttributes({ viewConfig });
  setHasUnsavedChanges(false);
};
```

### 数据持久化

- 配置保存在 Tiptap 节点的 `viewConfig` 属性中
- 通过 `updateAttributes` 方法更新节点属性
- Tiptap 自动处理文档的序列化和反序列化
- 文档保存时，配置一起保存到数据库

## 注意事项

### 1. 配置共享

- 保存的配置对所有协作者可见
- 一个用户保存配置后，其他用户刷新页面会看到新配置
- 如果需要个人专属配置，建议使用浏览器本地存储（未来功能）

### 2. 配置冲突

- 如果字段被删除，相关的筛选/排序/分组配置会失效
- 系统会自动忽略无效的配置项
- 建议在删除字段前先清除相关配置

### 3. 性能考虑

- 配置保存是同步操作，会触发文档更新
- 频繁保存可能影响性能
- 建议在完成所有设置后再保存

### 4. 折叠状态

- 分组的折叠/展开状态不会被保存
- 每次加载时，所有分组默认展开
- 这是设计决策，避免用户看不到某些任务

### 5. 与其他设置的关系

- **字段配置**（显示/隐藏、排序）：保存在 `hiddenColumns` 和 `customFields` 中
- **甘特图设置**（时间范围、颜色等）：保存在 `ganttSettings` 中
- **视图配置**（筛选、排序、分组）：保存在 `viewConfig` 中
- 这些配置相互独立，可以分别保存

## 常见问题

### Q1：为什么刷新后配置没有恢复？

A：可能的原因：
1. 配置没有保存（按钮仍然是绿色）
2. 文档没有保存（需要等待自动保存或手动保存）
3. 浏览器缓存问题（尝试强制刷新）

### Q2：配置会同步给其他协作者吗？

A：是的。保存的配置存储在文档中，所有协作者都会看到相同的配置。

### Q3：可以保存多个配置方案吗？

A：当前版本每个甘特图只能保存一个配置。如果需要多个配置方案，可以：
1. 复制甘特图块，每个块保存不同的配置
2. 或者临时修改配置但不保存，刷新页面恢复原配置

### Q4：删除字段后，相关配置会怎样？

A：系统会自动忽略引用已删除字段的配置项。建议在删除字段前先清除相关的筛选、排序、分组配置。

### Q5：配置保存后可以撤销吗？

A：可以通过文档的撤销功能（Ctrl+Z / Cmd+Z）撤销配置保存操作。

## 未来优化方向

1. **个人配置**：支持个人专属的视图配置，不影响其他协作者
2. **配置模板**：预设常用的配置模板，快速切换
3. **配置历史**：查看和恢复历史配置
4. **配置导入导出**：在不同甘特图之间复制配置
5. **自动保存**：配置更改后自动保存，无需手动点击
6. **配置命名**：为不同的配置方案命名，方便识别

## 相关文档

- [甘特图筛选功能说明](./甘特图筛选功能说明.md)
- [甘特图排序功能说明](./甘特图排序功能说明.md)
- [甘特图分组功能说明](./甘特图分组功能说明.md)
- [甘特图功能说明](./甘特图功能说明.md)
