# 甘特图进度条拖拽移动功能说明

## 功能概述

进度条拖拽移动功能允许用户通过拖拽整个进度条来调整任务的起始日期，同时保持任务的持续时间不变。这是一个非常直观的交互方式，让用户可以快速调整任务的时间安排。

## 功能特性

### 1. 拖拽移动

- **操作方式**：鼠标悬停在进度条上，光标变为移动图标（十字箭头），按住鼠标左键拖拽
- **移动效果**：进度条整体左右移动
- **日期调整**：开始日期和结束日期同时调整，保持任务持续时间不变
- **实时更新**：拖拽过程中实时更新进度条位置和日期

### 2. 光标样式

- **默认状态**：鼠标悬停在进度条上显示 `move` 光标（十字箭头）
- **拖拽状态**：按住鼠标拖拽时显示 `grabbing` 光标（抓手）
- **只读模式**：只读模式下显示 `pointer` 光标，不可拖拽

### 3. 与调整大小的区别

| 功能 | 操作位置 | 光标样式 | 效果 |
|------|----------|----------|------|
| 调整大小 | 进度条两端的手柄 | `ew-resize`（左右箭头） | 改变任务持续时间 |
| 拖拽移动 | 进度条中间区域 | `move`（十字箭头） | 移动任务，保持持续时间 |

### 4. 拖拽精度

- **对齐到天**：拖拽时自动对齐到最近的天
- **智能计算**：根据鼠标移动距离计算移动的天数
- **平滑体验**：拖拽过程中实时更新，提供流畅的视觉反馈

## 使用方法

### 基本操作

1. **定位进度条**
   - 在甘特图中找到要移动的任务进度条

2. **开始拖拽**
   - 将鼠标移动到进度条的中间区域（不是两端的手柄）
   - 观察光标变为移动图标（十字箭头）
   - 按住鼠标左键

3. **拖拽移动**
   - 保持按住鼠标左键
   - 左右移动鼠标
   - 观察进度条跟随鼠标移动

4. **完成移动**
   - 松开鼠标左键
   - 任务的开始日期和结束日期已更新

### 使用场景

#### 场景 1：调整任务开始时间

**需求**：任务 A 原计划 11 月 1 日开始，现在需要推迟到 11 月 5 日开始。

**操作**：
1. 找到任务 A 的进度条
2. 拖拽进度条向右移动 4 天
3. 松开鼠标
4. 任务 A 的开始日期变为 11 月 5 日，结束日期相应推迟 4 天

**效果**：
- 开始日期：11 月 1 日 → 11 月 5 日
- 结束日期：11 月 10 日 → 11 月 14 日
- 持续时间：10 天（不变）

#### 场景 2：提前任务

**需求**：任务 B 可以提前开始，需要从 11 月 10 日提前到 11 月 5 日。

**操作**：
1. 找到任务 B 的进度条
2. 拖拽进度条向左移动 5 天
3. 松开鼠标
4. 任务 B 的开始日期变为 11 月 5 日

**效果**：
- 开始日期：11 月 10 日 → 11 月 5 日
- 结束日期：11 月 20 日 → 11 月 15 日
- 持续时间：11 天（不变）

#### 场景 3：快速调整多个任务

**需求**：项目整体推迟一周，需要调整所有任务。

**操作**：
1. 逐个拖拽每个任务的进度条向右移动 7 天
2. 或者使用批量编辑功能（如果支持）

**提示**：
- 可以结合筛选功能，只显示需要调整的任务
- 可以按住 Shift 键（如果支持）批量选择任务

#### 场景 4：调整依赖任务

**需求**：任务 A 完成后才能开始任务 B，现在任务 A 推迟了，需要调整任务 B。

**操作**：
1. 先拖拽任务 A 的进度条到新的时间
2. 再拖拽任务 B 的进度条，使其开始日期在任务 A 结束日期之后

**提示**：
- 未来可能支持自动依赖关系，任务 A 移动时任务 B 自动跟随

## 技术实现

### 状态管理

```typescript
const [draggingTask, setDraggingTask] = useState<{
  taskId: string;
  startX: number;
  originalStartDate: Date;
  originalEndDate: Date;
} | null>(null);
```

### 拖拽开始

```typescript
const handleTaskBarMouseDown = (e: React.MouseEvent, taskId: string) => {
  if (isReadOnly) return;
  e.stopPropagation();
  
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  setDraggingTask({
    taskId,
    startX: e.clientX,
    originalStartDate: new Date(task.startDate + 'T00:00:00'),
    originalEndDate: new Date(task.endDate + 'T00:00:00'),
  });
};
```

### 拖拽移动

```typescript
const handleMouseMove = (e: React.MouseEvent) => {
  if (draggingTask && !isReadOnly) {
    const timeline = e.currentTarget as HTMLElement;
    const rect = timeline.getBoundingClientRect();
    const deltaX = e.clientX - draggingTask.startX;
    const dayWidth = rect.width / dateColumns.length;
    const daysDelta = Math.round(deltaX / dayWidth);
    
    if (daysDelta !== 0) {
      const newStartDate = new Date(draggingTask.originalStartDate);
      newStartDate.setDate(newStartDate.getDate() + daysDelta);
      
      const newEndDate = new Date(draggingTask.originalEndDate);
      newEndDate.setDate(newEndDate.getDate() + daysDelta);
      
      const newTasks = tasks.map(t => 
        t.id === draggingTask.taskId 
          ? { 
              ...t, 
              startDate: newStartDate.toISOString().split('T')[0],
              endDate: newEndDate.toISOString().split('T')[0]
            } 
          : t
      );
      updateAttributes({ tasks: newTasks });
    }
  }
};
```

### 拖拽结束

```typescript
const handleMouseUp = () => {
  setResizingTask(null);
  setDraggingTask(null);
};
```

### 光标样式

```css
.taskBar {
  cursor: move;
  user-select: none;
}

.taskBar:active {
  cursor: grabbing;
}
```

## 与其他功能的交互

### 1. 与调整大小功能的协同

- **优先级**：点击调整大小手柄时，不触发拖拽移动
- **实现方式**：检查点击目标是否为手柄元素
- **用户体验**：两个功能互不干扰，可以分别使用

```typescript
onMouseDown={(e) => {
  const target = e.target as HTMLElement;
  if (target.classList.contains(classes.resizeHandle)) {
    return; // 点击手柄，不触发拖拽
  }
  handleTaskBarMouseDown(e, task.id);
}}
```

### 2. 与点击编辑功能的协同

- **区分方式**：通过鼠标移动距离判断
- **拖拽阈值**：如果鼠标移动距离很小，视为点击而非拖拽
- **当前实现**：拖拽和点击都会触发，未来可以优化

### 3. 与只读模式的协同

- **只读模式**：不可拖拽，光标显示为 `pointer`
- **编辑模式**：可拖拽，光标显示为 `move`

### 4. 与视图模式的协同

- **所有视图模式**：周、月、季、年视图都支持拖拽
- **精度调整**：不同视图模式下，拖拽精度相同（都是天）

## 注意事项

### 1. 拖拽范围

- **无限制**：可以拖拽到任意日期
- **建议**：避免拖拽到过去或过远的未来
- **未来优化**：可以添加日期范围限制

### 2. 拖拽性能

- **实时更新**：拖拽过程中实时更新数据
- **性能考虑**：频繁更新可能影响性能
- **优化方案**：可以考虑节流或在拖拽结束时才更新

### 3. 拖拽精度

- **对齐到天**：拖拽时自动对齐到最近的天
- **无法精确到小时**：当前实现不支持小时级别的精度
- **未来扩展**：可以根据视图模式调整精度

### 4. 撤销/重做

- **支持撤销**：拖拽移动后可以使用撤销功能（Ctrl+Z / Cmd+Z）
- **支持重做**：撤销后可以使用重做功能（Ctrl+Y / Cmd+Shift+Z）

### 5. 协作冲突

- **实时同步**：拖拽移动会立即同步给其他协作者
- **冲突处理**：如果多人同时拖拽同一任务，后者覆盖前者
- **建议**：团队协作时注意沟通，避免冲突

## 常见问题

### Q1：为什么拖拽时进度条会跳动？

A：这是因为拖拽精度对齐到天。如果鼠标移动距离不足一天的宽度，进度条不会移动。继续拖拽直到超过一天的距离，进度条会跳到下一天。

### Q2：可以拖拽到过去的日期吗？

A：可以。当前实现没有日期范围限制，可以拖拽到任意日期。

### Q3：拖拽时如何知道移动了多少天？

A：可以观察进度条的位置变化，或者在拖拽结束后点击进度条查看任务详情。未来可以添加拖拽时的提示信息。

### Q4：拖拽移动会改变任务持续时间吗？

A：不会。拖拽移动只改变开始日期和结束日期，持续时间保持不变。

### Q5：可以同时拖拽多个任务吗？

A：当前版本不支持。未来可以考虑添加批量拖拽功能。

### Q6：拖拽时可以滚动时间轴吗？

A：当前版本不支持自动滚动。如果需要拖拽到视图外的日期，需要先手动滚动时间轴。

### Q7：拖拽移动和调整大小有什么区别？

A：
- **拖拽移动**：点击进度条中间区域，整体移动，持续时间不变
- **调整大小**：点击进度条两端的手柄，改变持续时间

## 未来优化方向

1. **拖拽提示**：拖拽时显示当前日期和移动天数
2. **拖拽阈值**：区分点击和拖拽，避免误触
3. **自动滚动**：拖拽到视图边缘时自动滚动时间轴
4. **批量拖拽**：支持同时拖拽多个任务
5. **依赖关系**：拖拽时自动调整依赖任务
6. **日期限制**：设置可拖拽的日期范围
7. **拖拽动画**：添加平滑的拖拽动画效果
8. **拖拽预览**：拖拽时显示半透明的预览位置
9. **撤销优化**：拖拽过程中的多次更新合并为一次撤销操作
10. **性能优化**：使用节流减少拖拽过程中的更新频率

## 相关文档

- [甘特图功能说明](./甘特图功能说明.md) - 完整功能概述
- [甘特图功能索引](./甘特图功能索引.md) - 所有文档导航

## 测试建议

### 基本功能测试
- [ ] 拖拽进度条向右移动
- [ ] 拖拽进度条向左移动
- [ ] 验证开始日期和结束日期都已更新
- [ ] 验证持续时间保持不变

### 光标样式测试
- [ ] 悬停在进度条上显示 move 光标
- [ ] 拖拽时显示 grabbing 光标
- [ ] 只读模式下显示 pointer 光标

### 与其他功能的交互测试
- [ ] 点击调整大小手柄不触发拖拽
- [ ] 拖拽后可以点击编辑任务
- [ ] 拖拽后可以调整大小
- [ ] 只读模式下不可拖拽

### 边界情况测试
- [ ] 拖拽到视图外的日期
- [ ] 拖拽到过去的日期
- [ ] 拖拽到很远的未来
- [ ] 快速拖拽
- [ ] 拖拽后立即撤销

### 性能测试
- [ ] 拖拽大量任务
- [ ] 在不同视图模式下拖拽
- [ ] 拖拽时滚动时间轴
