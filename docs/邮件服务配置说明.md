# 邮件服务配置功能说明

## 功能概述

在设置-系统中新增了"邮件服务"菜单，管理员可以通过 Web 界面配置 SMTP 服务，用于发送：
- 用户邀请邮件
- 密码重置邮件
- 通知邮件

## 功能特性

### 1. SMTP 配置
- **SMTP 主机**: 邮件服务器地址（如 smtp.gmail.com）
- **SMTP 端口**: 邮件服务器端口（常用：25, 465, 587）
- **SSL/TLS**: 启用安全连接（推荐用于端口 465）
- **忽略 TLS**: 禁用 TLS 证书验证（不推荐，仅用于测试）

### 2. 身份验证
- **SMTP 用户名**: 邮箱账号或用户名
- **SMTP 密码**: 邮箱密码或应用专用密码

### 3. 发件人信息
- **发件人邮箱地址**: 邮件的发送地址
- **发件人名称**: 邮件显示的发件人名称

### 4. 测试功能
- 发送测试邮件验证配置是否正确
- 实时反馈发送结果

## 技术实现

### 后端实现

#### 1. 数据存储
邮件配置存储在 `workspaces` 表的 `settings` 字段中：
```json
{
  "mail": {
    "smtpHost": "smtp.example.com",
    "smtpPort": 587,
    "smtpSecure": false,
    "smtpUsername": "user@example.com",
    "smtpPassword": "password",
    "mailFromAddress": "noreply@example.com",
    "mailFromName": "NoteDoc",
    "smtpIgnoreTLS": false
  }
}
```

#### 2. API 端点

**获取邮件设置**
```
POST /workspace/mail-settings
```

**更新邮件设置**
```
POST /workspace/mail-settings/update
Body: {
  "smtpHost": "smtp.example.com",
  "smtpPort": 587,
  ...
}
```

**测试邮件发送**
```
POST /workspace/mail-settings/test
Body: {
  "email": "test@example.com"
}
```

#### 3. 文件结构

**后端**:
- `apps/server/src/core/workspace/dto/update-mail-settings.dto.ts` - 邮件设置 DTO
- `apps/server/src/core/workspace/dto/test-mail.dto.ts` - 测试邮件 DTO
- `apps/server/src/core/workspace/services/workspace.service.ts` - 邮件设置服务方法
- `apps/server/src/core/workspace/controllers/workspace.controller.ts` - 邮件设置控制器
- `apps/server/src/database/repos/workspace/workspace.repo.ts` - 邮件设置数据库操作
- `apps/server/src/integrations/mail/mail.service.ts` - 测试邮件发送方法

**前端**:
- `apps/client/src/pages/settings/system/mail-settings.tsx` - 邮件设置页面
- `apps/client/src/features/workspace/services/mail-settings-service.ts` - 邮件设置服务
- `apps/client/src/features/workspace/queries/mail-settings-query.ts` - 邮件设置查询钩子

### 前端实现

#### 1. 路由配置
在 `apps/client/src/App.tsx` 中添加路由：
```tsx
<Route path={"mail"} element={<MailSettings />} />
```

#### 2. 菜单配置
在 `apps/client/src/components/settings/settings-sidebar.tsx` 中添加菜单项：
```tsx
{
  label: "Mail service",
  icon: IconMail,
  path: "/settings/mail",
  isAdmin: true,
  isSelfhosted: true,
}
```

#### 3. 页面组件
使用 Mantine UI 组件构建表单：
- TextInput: 文本输入
- NumberInput: 数字输入
- Switch: 开关按钮
- Button: 操作按钮

## 使用说明

### 1. 访问邮件服务设置
1. 以管理员身份登录
2. 进入"设置"
3. 在左侧菜单选择"系统" > "邮件服务"

### 2. 配置 SMTP
1. 填写 SMTP 服务器信息
2. 配置身份验证信息
3. 设置发件人信息
4. 点击"保存设置"

### 3. 测试配置
1. 在"测试邮件"部分输入测试邮箱地址
2. 点击"发送测试邮件"
3. 检查邮箱是否收到测试邮件

## 常见 SMTP 配置示例

### Gmail
```
SMTP 主机: smtp.gmail.com
SMTP 端口: 587
SSL/TLS: 关闭
SMTP 用户名: your-email@gmail.com
SMTP 密码: 应用专用密码
```

### QQ 邮箱
```
SMTP 主机: smtp.qq.com
SMTP 端口: 587
SSL/TLS: 关闭
SMTP 用户名: your-email@qq.com
SMTP 密码: 授权码
```

### 163 邮箱
```
SMTP 主机: smtp.163.com
SMTP 端口: 465
SSL/TLS: 开启
SMTP 用户名: your-email@163.com
SMTP 密码: 授权码
```

### 阿里云邮件推送
```
SMTP 主机: smtpdm.aliyun.com
SMTP 端口: 465
SSL/TLS: 开启
SMTP 用户名: 发信地址
SMTP 密码: SMTP 密码
```

## 权限控制

- 仅管理员可以访问邮件服务设置
- 仅在自托管版本中显示（云版本不显示）
- 使用 CASL 权限系统进行访问控制

## 测试

使用测试脚本验证功能：
```bash
# 设置认证令牌
export AUTH_TOKEN="your_auth_token"

# 可选：设置测试邮箱
export TEST_EMAIL="test@example.com"

# 运行测试
./scripts/test-mail-settings.sh
```

## 注意事项

1. **密码安全**: SMTP 密码存储在数据库中，建议使用应用专用密码而非主密码
2. **端口选择**: 
   - 端口 25: 通常被 ISP 封锁
   - 端口 465: 使用 SSL/TLS
   - 端口 587: 使用 STARTTLS（推荐）
3. **测试环境**: 在生产环境使用前，先在测试环境验证配置
4. **邮件限制**: 注意邮件服务商的发送频率和数量限制

## 未来改进

- [ ] 支持更多邮件驱动（如 SendGrid, Mailgun）
- [ ] 邮件模板自定义
- [ ] 邮件发送日志和统计
- [ ] 密码加密存储
- [ ] 支持多个邮件配置（不同用途使用不同配置）
