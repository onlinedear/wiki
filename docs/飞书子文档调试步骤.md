# 飞书子文档调试步骤

## 当前状态

✅ **增强日志已添加** - 使用 📚 emoji 标记子文档相关日志  
⏳ **等待测试** - 需要重新导入并查看详细日志

## 快速测试步骤

### 1. 重启服务器

代码已更新，需要重启服务器：

```bash
# 如果服务器正在运行，先停止（Ctrl+C）
# 然后重新启动
pnpm dev
```

### 2. 准备测试文档

在飞书中确认你的测试文档：

**主文档**：包含子文档的引用或链接

**如何添加子文档引用**：
1. 在主文档中输入 `/`
2. 搜索"文档"、"链接"或"引用"
3. 选择插入文档链接
4. 选择要引用的子文档

**或者**：
- 直接粘贴子文档的 URL
- 使用 @ 提及文档

### 3. 打开日志监控

在新终端窗口运行：

```bash
cd /Users/cn-stevenlv/docmost/docmost

# 查看子文档相关日志
tail -f apps/server/logs/app.log | grep "📚"
```

或者查看所有日志：

```bash
tail -f apps/server/logs/app.log
```

### 4. 执行导入

1. 访问 NoteDoc (http://localhost:3000)
2. 进入飞书集成设置
3. 点击"在线导入"
4. 粘贴主文档 URL
5. 点击导入

### 5. 分析日志输出

查看日志中的关键信息：

#### 期望看到的日志

```
📚 Fetching child documents for token: doccnxxxxx
📚 Total blocks: 50
📚 Block type distribution: {"1":1,"2":10,"3":5,...}
📚 Found file block (type 22): {"token":"doccnyyyyy","name":"子文档A"}
📚 Found 1 unique child documents
📚 Child documents: [{"token":"doccnyyyyy","title":"子文档A"}]
📚 Checking for child documents of doccnxxxxx
📚 Found 1 child documents for doccnxxxxx
📚 Importing child document 1/1: 子文档A (doccnyyyyy)
```

#### 如果没有找到子文档

```
📚 Fetching child documents for token: doccnxxxxx
📚 Total blocks: 50
📚 Block type distribution: {"1":1,"2":10,"3":5,...}
📚 Found 0 unique child documents
📚 No child documents found for doccnxxxxx
```

### 6. 收集调试信息

如果没有找到子文档，我们需要：

#### A. 查看 Block 类型分布

从日志中找到：
```
📚 Block type distribution: {"1":1,"2":10,"3":5,"27":2}
```

这告诉我们文档中有哪些类型的 blocks。

#### B. 查看是否有 file 或 link blocks

查找日志中是否有：
```
📚 Found file block (type XX): ...
📚 Found link block (type XX): ...
📚 Found document link in text (type XX): ...
```

#### C. 导出完整的 blocks 数据

如果需要更详细的信息，可以临时添加代码：

在 `feishu-api.service.ts` 的 `getChildDocuments` 方法开头添加：

```typescript
// 临时调试：输出所有 blocks
this.logger.debug(`=== ALL BLOCKS ===`);
this.logger.debug(JSON.stringify(blocks.items.slice(0, 10), null, 2)); // 前 10 个 blocks
```

然后重新导入并查看日志。

## 可能的情况

### 情况 1：飞书使用不同的 block_type

**症状**：日志显示有 blocks，但没有找到 file 或 link blocks

**解决方案**：
1. 查看 block type distribution
2. 在飞书文档中确认子文档引用的位置
3. 对比日志，找出对应的 block_type
4. 调整代码中的识别逻辑

### 情况 2：子文档信息在不同的字段

**症状**：找到了相关 block，但字段名不对

**解决方案**：
1. 查看 "Interesting block" 日志
2. 确定正确的字段名
3. 调整代码

### 情况 3：需要使用不同的 API

**症状**：blocks API 根本不包含子文档信息

**解决方案**：
1. 查阅飞书 API 文档
2. 尝试其他 API 端点：
   - `/docx/v1/documents/{document_id}/children`
   - `/drive/v1/files/{file_token}/children`

### 情况 4：飞书没有"子文档"概念

**症状**：只有文档链接，没有父子关系

**解决方案**：
- 将文档链接作为"子文档"导入
- 用户需要手动在飞书中建立文档链接关系

## 调试命令

```bash
# 查看所有子文档相关日志
grep "📚" apps/server/logs/app.log

# 查看最近的子文档日志
grep "📚" apps/server/logs/app.log | tail -50

# 查看 block type distribution
grep "Block type distribution" apps/server/logs/app.log

# 查看是否找到 file blocks
grep "Found file block" apps/server/logs/app.log

# 查看是否找到 link blocks
grep "Found link block" apps/server/logs/app.log

# 导出子文档日志到文件
grep "📚" apps/server/logs/app.log > child_docs_debug.log
```

## 下一步

根据日志输出：

### 如果找到了子文档
→ 功能正常！验证导入结果

### 如果没有找到子文档
→ 请提供以下信息：
1. Block type distribution
2. 飞书文档中如何添加的子文档引用
3. 是否有 "Found file/link block" 日志
4. 完整的子文档相关日志

然后我们可以根据实际情况调整代码。

## 测试清单

- [ ] 服务器已重启
- [ ] 测试文档已准备（包含子文档引用）
- [ ] 日志监控已打开
- [ ] 执行导入
- [ ] 查看日志输出
- [ ] 记录 block type distribution
- [ ] 记录是否找到子文档
- [ ] 如果未找到，收集调试信息

---

**创建时间**：2025-11-26  
**状态**：等待测试结果
