# 甘特图时间轴断开修复说明

## 问题描述

在"周"、"月"、"季"、"年"视图中，当滑块滑到右边时，日期轴在某个时间点断开，后面显示为空白。规律是当滑块处在右侧时间轴中间位置时，后面就没有日期了。

## 问题原因

问题主要出在 `getDateRange` 函数中计算结束日期的逻辑错误：

```typescript
// 原代码 - 月视图
case 'month':
  start.setDate(1);
  start.setMonth(start.getMonth() - 1);
  end.setMonth(end.getMonth() + 3);
  end.setDate(0); // ❌ 问题在这里：setDate(0) 会回退到上个月的最后一天
  break;
```

### 根本原因

1. **setDate(0) 的行为**：`setDate(0)` 会将日期设置为**上个月**的最后一天，而不是当前月的最后一天
2. **月份计算错误**：`end.setMonth(end.getMonth() + 3)` 后再 `setDate(0)`，实际上只延伸了2个月，而不是预期的3个月
3. **季视图和年视图同样的问题**：这些视图也使用了相同的错误模式

### 示例说明

假设 `end` 初始是 2026年5月15日：
- `end.setMonth(end.getMonth() + 3)` → 2026年8月15日
- `end.setDate(0)` → 2026年7月31日（回退到8月的上个月最后一天）
- 结果：只延伸到7月底，而不是预期的8月底

## 解决方案

修正日期范围计算逻辑，确保 `setDate(0)` 应用到正确的月份，并扩大显示范围以确保滚动时有足够的时间轴：

```typescript
// 修复后的代码
switch (viewMode) {
  case 'month':
    start.setDate(1);
    start.setMonth(start.getMonth() - 1);
    end.setMonth(end.getMonth() + 5); // 向后延伸4个月，+5是因为要到第5个月的第0天
    end.setDate(0); // 这样会得到第4个月的最后一天
    break;
  case 'quarter':
    start.setDate(1);
    start.setMonth(start.getMonth() - 12);
    end.setMonth(end.getMonth() + 14); // 向后延伸13个月，+14是因为要到第14个月的第0天
    end.setDate(0); // 这样会得到第13个月的最后一天
    break;
  case 'year':
    start.setMonth(0, 1);
    start.setFullYear(start.getFullYear() - 2);
    end.setFullYear(end.getFullYear() + 5); // 向后延伸4年，+5是因为要到第5年
    end.setMonth(0, 0); // 第5年的1月0日 = 第4年的12月31日
    break;
}
```

### 关键点

- 要获取某个月的最后一天，需要先跳到**下一个月**，然后 `setDate(0)` 才能回退到目标月的最后一天
- 例如：要获取8月31日，需要先设置到9月（month + 1），然后 `setDate(0)`
- 扩大了显示范围以确保用户滚动到最右侧时仍有足够的时间轴显示

### 额外优化

同时优化了 `getDateColumns` 函数，标准化日期对象并使用时间戳比较：

```typescript
const getDateColumns = () => {
  const columns: Date[] = [];
  const start = new Date(rangeStart.getFullYear(), rangeStart.getMonth(), rangeStart.getDate());
  const end = new Date(rangeEnd.getFullYear(), rangeEnd.getMonth(), rangeEnd.getDate());
  const current = new Date(start);

  while (current.getTime() <= end.getTime()) {
    columns.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }

  return columns;
};
```

## 修改内容

**文件**：`apps/client/src/features/editor/components/gantt/gantt-view.tsx`

**主要修改**：

1. **修正 `getDateRange` 函数中的日期计算**（第 340-365 行）
   - 周视图：向后延伸84天（`end.setDate(end.getDate() + 84)`）
   - 月视图：向后延伸4个月（`end.setMonth(end.getMonth() + 5)` 然后 `setDate(0)`）
   - 季视图：向前12个月，向后14个月（`start.setMonth(start.getMonth() - 12)`，`end.setMonth(end.getMonth() + 15)` 然后 `setDate(0)`）
   - 年视图：向前2年，向后4年（`start.setFullYear(start.getFullYear() - 2)`，`end.setFullYear(end.getFullYear() + 5)` 然后 `setMonth(0, 0)`）

2. **优化 `getDateColumns` 函数**（第 373-387 行）
   - 标准化日期对象，只保留年月日
   - 使用 `getTime()` 进行时间戳比较

## 测试验证

修复后，请验证以下场景：

1. **周视图**：滑动到最右侧，确认日期连续显示
2. **月视图**：滑动到最右侧，确认日期连续显示
3. **季视图**：滑动到最右侧，确认周范围连续显示
4. **年视图**：滑动到最右侧，确认月份连续显示
5. **跨年场景**：创建跨年任务，确认时间轴在年份交界处正常显示
6. **空任务场景**：没有任务时，确认默认时间范围正常显示

## 影响范围

- 所有视图模式（周、月、季、年）
- 时间轴的完整性和连续性
- 任务进度条的位置计算（依赖 `dateColumns` 数组）

## 附加修复：TypeScript 类型推断问题

在修复过程中，还解决了一个 TypeScript 类型推断问题：

**问题**：使用 `const [, setter] = useAtom(atom)` 时，TypeScript 无法正确推断 setter 的类型，导致其被推断为 `never` 类型。

**解决方案**：为解构赋值添加显式类型注解：

```typescript
const [, setAsideState]: [any, (update: SetStateAction<{ tab: string; isAsideOpen: boolean }>) => void] = useAtom(asideStateAtom);
const [, setTaskReference]: [any, (update: SetStateAction<TaskReference | null>) => void] = useAtom(taskReferenceAtom);
```

## 相关文件

- `apps/client/src/features/editor/components/gantt/gantt-view.tsx` - 甘特图视图组件
- `packages/editor-ext/src/lib/gantt/gantt.ts` - 甘特图扩展定义
