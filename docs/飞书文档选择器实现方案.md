# é£ä¹¦æ–‡æ¡£é€‰æ‹©å™¨å®ç°æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ Bï¼‰

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

å®ç°ä¸€ä¸ªç±»ä¼¼ PandaWiki çš„æ–‡æ¡£é€‰æ‹©å™¨ï¼Œè®©ç”¨æˆ·å¯è§†åŒ–é€‰æ‹©è¦å¯¼å…¥çš„é£ä¹¦æ–‡æ¡£ã€‚

## äºŒã€å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šåç«¯ - æ·»åŠ è·å–æ–‡æ¡£åˆ—è¡¨ API

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-import.controller.ts`

æ·»åŠ æ–°çš„ç«¯ç‚¹ï¼š
```typescript
@Post('list-documents')
async listDocuments(@Body() dto: ListDocumentsDto, @CurrentUser() user: User) {
  // è·å–é£ä¹¦ç©ºé—´ä¸‹çš„æ‰€æœ‰æ–‡æ¡£
  return this.feishuImportService.listSpaceDocuments(dto);
}
```

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-import.service.ts`

æ·»åŠ æ–¹æ³•ï¼š
```typescript
async listSpaceDocuments(params: {
  spaceId: string;
  appId: string;
  appSecret: string;
}): Promise<DocumentTreeNode[]> {
  // 1. è·å– access token
  // 2. è°ƒç”¨é£ä¹¦ API è·å–æ–‡æ¡£åˆ—è¡¨
  // 3. æ„å»ºæ ‘å½¢ç»“æ„
  // 4. è¿”å›æ–‡æ¡£æ ‘
}
```

### æ­¥éª¤ 2ï¼šåç«¯ - æ·»åŠ æ‰¹é‡å¯¼å…¥ API

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-import.controller.ts`

```typescript
@Post('import/batch')
async importBatch(@Body() dto: BatchImportDto, @CurrentUser() user: User) {
  // æ‰¹é‡å¯¼å…¥é€‰ä¸­çš„æ–‡æ¡£
  return this.feishuImportService.importBatchDocuments(dto);
}
```

**æ–‡ä»¶**ï¼š`apps/server/src/ee/feishu-import/feishu-import.service.ts`

```typescript
async importBatchDocuments(params: {
  workspaceId: string;
  spaceId: string;
  userId: string;
  documents: Array<{
    token: string;
    parentToken?: string;
  }>;
  appId: string;
  appSecret: string;
}): Promise<ImportResult> {
  // 1. æŒ‰å±‚çº§é¡ºåºæ’åºæ–‡æ¡£
  // 2. ç»´æŠ¤ token -> pageId æ˜ å°„
  // 3. é€ä¸ªå¯¼å…¥æ–‡æ¡£
  // 4. å»ºç«‹çˆ¶å­å…³ç³»
}
```

### æ­¥éª¤ 3ï¼šå‰ç«¯ - åˆ›å»ºæ–‡æ¡£æ ‘æ•°æ®ç»“æ„

**æ–‡ä»¶**ï¼š`apps/client/src/features/feishu/types/document-tree.ts`

```typescript
export interface DocumentTreeNode {
  id: string;              // æ–‡æ¡£ token
  title: string;           // æ–‡æ¡£æ ‡é¢˜
  parentId: string | null; // çˆ¶æ–‡æ¡£ token
  isFolder: boolean;       // æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
  children?: DocumentTreeNode[];
  checked?: boolean;       // æ˜¯å¦é€‰ä¸­
  indeterminate?: boolean; // åŠé€‰çŠ¶æ€
}
```

### æ­¥éª¤ 4ï¼šå‰ç«¯ - åˆ›å»ºæ–‡æ¡£é€‰æ‹©å™¨ç»„ä»¶

**æ–‡ä»¶**ï¼š`apps/client/src/features/feishu/components/feishu-document-selector.tsx`

```typescript
export function FeishuDocumentSelector({
  documents,
  onSelectionChange,
}: {
  documents: DocumentTreeNode[];
  onSelectionChange: (selected: string[]) => void;
}) {
  // ä½¿ç”¨ Mantine Tree æˆ–è‡ªå®šä¹‰æ ‘å½¢ç»„ä»¶
  // æ”¯æŒï¼š
  // - å±•å¼€/æŠ˜å 
  // - å…¨é€‰/å–æ¶ˆå…¨é€‰
  // - çˆ¶å­è”åŠ¨é€‰æ‹©
  // - æœç´¢è¿‡æ»¤
}
```

### æ­¥éª¤ 5ï¼šå‰ç«¯ - æ”¹é€ å¯¼å…¥å¯¹è¯æ¡†

**æ–‡ä»¶**ï¼š`apps/client/src/features/feishu/components/feishu-online-import-modal.tsx`

æ·»åŠ ä¸¤ç§æ¨¡å¼ï¼š
1. **ç®€å•æ¨¡å¼**ï¼šè¾“å…¥å•ä¸ªæ–‡æ¡£ URLï¼ˆå½“å‰æ–¹å¼ï¼‰
2. **é«˜çº§æ¨¡å¼**ï¼šæ–‡æ¡£é€‰æ‹©å™¨

```typescript
const [mode, setMode] = useState<'simple' | 'advanced'>('simple');
const [documents, setDocuments] = useState<DocumentTreeNode[]>([]);
const [selectedDocuments, setSelectedDocuments] = useState<string[]>([]);

// è·å–æ–‡æ¡£åˆ—è¡¨
const fetchDocuments = async (spaceUrl: string) => {
  const result = await listFeishuDocuments({ spaceUrl });
  setDocuments(result.data);
};

// æ‰¹é‡å¯¼å…¥
const handleBatchImport = async () => {
  await importFeishuBatch({
    spaceId,
    documentTokens: selectedDocuments,
  });
};
```

## ä¸‰ã€æ•°æ®æµç¨‹

### 3.1 è·å–æ–‡æ¡£åˆ—è¡¨æµç¨‹

```
ç”¨æˆ·è¾“å…¥ç©ºé—´ URL
    â†“
å‰ç«¯æå– space_id
    â†“
è°ƒç”¨åç«¯ /api/feishu/list-documents
    â†“
åç«¯è°ƒç”¨é£ä¹¦ API
    â†“
æ„å»ºæ–‡æ¡£æ ‘
    â†“
è¿”å›ç»™å‰ç«¯
    â†“
å‰ç«¯æ˜¾ç¤ºæ ‘å½¢é€‰æ‹©å™¨
```

### 3.2 æ‰¹é‡å¯¼å…¥æµç¨‹

```
ç”¨æˆ·é€‰æ‹©æ–‡æ¡£
    â†“
å‰ç«¯æ”¶é›†é€‰ä¸­çš„æ–‡æ¡£ tokens
    â†“
è°ƒç”¨åç«¯ /api/feishu/import/batch
    â†“
åç«¯æŒ‰å±‚çº§æ’åº
    â†“
é€ä¸ªå¯¼å…¥æ–‡æ¡£
    â†“
å»ºç«‹çˆ¶å­å…³ç³»
    â†“
è¿”å›å¯¼å…¥ç»“æœ
    â†“
å‰ç«¯åˆ·æ–°é¡µé¢æ ‘
```

## å››ã€å…³é”®æŠ€æœ¯ç‚¹

### 4.1 é£ä¹¦ API è°ƒç”¨

ç”±äº Wiki API ä¸å¯ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ Drive APIï¼š

```typescript
// è·å–æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
GET /drive/v1/files?folder_token={folder_token}&page_size=200

// é€’å½’è·å–æ‰€æœ‰å­æ–‡ä»¶å¤¹
async function getAllDocuments(folderToken: string): Promise<Document[]> {
  const files = await getFiles(folderToken);
  const documents = [];
  
  for (const file of files) {
    if (file.type === 'docx') {
      documents.push(file);
    } else if (file.type === 'folder') {
      const children = await getAllDocuments(file.token);
      documents.push(...children);
    }
  }
  
  return documents;
}
```

### 4.2 æ ‘å½¢ç»“æ„æ„å»º

```typescript
function buildTree(files: File[]): DocumentTreeNode[] {
  const map = new Map<string, DocumentTreeNode>();
  const roots: DocumentTreeNode[] = [];
  
  // ç¬¬ä¸€éï¼šåˆ›å»ºæ‰€æœ‰èŠ‚ç‚¹
  for (const file of files) {
    map.set(file.token, {
      id: file.token,
      title: file.name,
      parentId: file.parent_token,
      isFolder: file.type === 'folder',
      children: [],
    });
  }
  
  // ç¬¬äºŒéï¼šå»ºç«‹çˆ¶å­å…³ç³»
  for (const node of map.values()) {
    if (node.parentId && map.has(node.parentId)) {
      map.get(node.parentId)!.children!.push(node);
    } else {
      roots.push(node);
    }
  }
  
  return roots;
}
```

### 4.3 çˆ¶å­è”åŠ¨é€‰æ‹©

```typescript
function handleNodeCheck(nodeId: string, checked: boolean) {
  // 1. æ›´æ–°å½“å‰èŠ‚ç‚¹
  updateNode(nodeId, { checked });
  
  // 2. é€’å½’æ›´æ–°æ‰€æœ‰å­èŠ‚ç‚¹
  updateChildren(nodeId, { checked });
  
  // 3. å‘ä¸Šæ›´æ–°çˆ¶èŠ‚ç‚¹çŠ¶æ€
  updateParentStatus(nodeId);
}

function updateParentStatus(nodeId: string) {
  const parent = getParent(nodeId);
  if (!parent) return;
  
  const siblings = getChildren(parent.id);
  const allChecked = siblings.every(s => s.checked);
  const someChecked = siblings.some(s => s.checked || s.indeterminate);
  
  parent.checked = allChecked;
  parent.indeterminate = !allChecked && someChecked;
  
  updateParentStatus(parent.id);
}
```

## äº”ã€UI è®¾è®¡

### 5.1 å¯¹è¯æ¡†å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»é£ä¹¦å¯¼å…¥                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¨¡å¼: â—‹ ç®€å•  â— é«˜çº§                â”‚
â”‚                                     â”‚
â”‚ é£ä¹¦ç©ºé—´ URL:                       â”‚
â”‚ [https://xxx.feishu.cn/wiki/xxxxx] â”‚
â”‚ [è·å–æ–‡æ¡£åˆ—è¡¨]                      â”‚
â”‚                                     â”‚
â”‚ é€‰æ‹©è¦å¯¼å…¥çš„æ–‡æ¡£:                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜‘ ğŸ“ äº§å“æ–‡æ¡£                   â”‚ â”‚
â”‚ â”‚   â˜‘ ğŸ“„ éœ€æ±‚æ–‡æ¡£                 â”‚ â”‚
â”‚ â”‚   â˜‘ ğŸ“„ è®¾è®¡æ–‡æ¡£                 â”‚ â”‚
â”‚ â”‚   â˜ ğŸ“ æŠ€æœ¯æ–‡æ¡£                 â”‚ â”‚
â”‚ â”‚     â˜ ğŸ“„ æ¶æ„è®¾è®¡               â”‚ â”‚
â”‚ â”‚     â˜ ğŸ“„ API æ–‡æ¡£               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ å·²é€‰æ‹©: 2 ä¸ªæ–‡æ¡£                    â”‚
â”‚                                     â”‚
â”‚ [å–æ¶ˆ]              [æ‰¹é‡å¯¼å…¥ (2)] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ‘å½¢èŠ‚ç‚¹æ ·å¼

```tsx
<TreeNode>
  <Checkbox checked={node.checked} indeterminate={node.indeterminate} />
  <Icon>{node.isFolder ? 'ğŸ“' : 'ğŸ“„'}</Icon>
  <Text>{node.title}</Text>
  <Badge>{node.children?.length || 0}</Badge>
</TreeNode>
```

## å…­ã€å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰

1. âœ… åç«¯è·å–æ–‡æ¡£åˆ—è¡¨ API
2. âœ… åç«¯æ‰¹é‡å¯¼å…¥ API
3. âœ… å‰ç«¯æ–‡æ¡£æ ‘æ˜¾ç¤º
4. âœ… å‰ç«¯æ–‡æ¡£é€‰æ‹©
5. âœ… æ‰¹é‡å¯¼å…¥åŠŸèƒ½

### P1 - å¢å¼ºåŠŸèƒ½ï¼ˆé‡è¦ï¼‰

1. â­• æœç´¢è¿‡æ»¤æ–‡æ¡£
2. â­• å…¨é€‰/å–æ¶ˆå…¨é€‰
3. â­• å±•å¼€/æŠ˜å æ‰€æœ‰
4. â­• å¯¼å…¥è¿›åº¦æ˜¾ç¤º

### P2 - ä¼˜åŒ–åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

1. â­• æ–‡æ¡£é¢„è§ˆ
2. â­• æ‰¹é‡æ“ä½œ
3. â­• å¯¼å…¥å†å²
4. â­• é”™è¯¯é‡è¯•

## ä¸ƒã€é¢„è®¡å·¥ä½œé‡

- åç«¯ APIï¼š2-3 å°æ—¶
- å‰ç«¯ç»„ä»¶ï¼š3-4 å°æ—¶
- é›†æˆæµ‹è¯•ï¼š1-2 å°æ—¶
- **æ€»è®¡**ï¼š6-9 å°æ—¶

## å…«ã€é£é™©å’ŒæŒ‘æˆ˜

### 8.1 é£ä¹¦ API é™åˆ¶

- Drive API å¯èƒ½ä¹Ÿæœ‰é™åˆ¶
- éœ€è¦æµ‹è¯•å¤§é‡æ–‡æ¡£çš„æ€§èƒ½
- å¯èƒ½éœ€è¦åˆ†é¡µå¤„ç†

### 8.2 å‰ç«¯æ€§èƒ½

- å¤§é‡æ–‡æ¡£æ—¶æ ‘å½¢æ¸²æŸ“æ€§èƒ½
- éœ€è¦è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–
- æœç´¢è¿‡æ»¤æ€§èƒ½

### 8.3 ç”¨æˆ·ä½“éªŒ

- åŠ è½½æ—¶é—´å¯èƒ½è¾ƒé•¿
- éœ€è¦åŠ è½½çŠ¶æ€æç¤º
- é”™è¯¯å¤„ç†è¦å‹å¥½

## ä¹ã€æµ‹è¯•è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

- æ ‘å½¢ç»“æ„æ„å»º
- çˆ¶å­è”åŠ¨é€‰æ‹©
- æ–‡æ¡£æ’åºé€»è¾‘

### 9.2 é›†æˆæµ‹è¯•

- è·å–æ–‡æ¡£åˆ—è¡¨
- æ‰¹é‡å¯¼å…¥
- çˆ¶å­å…³ç³»å»ºç«‹

### 9.3 ç”¨æˆ·æµ‹è¯•

- å°‘é‡æ–‡æ¡£ï¼ˆ< 10ï¼‰
- ä¸­ç­‰æ–‡æ¡£ï¼ˆ10-50ï¼‰
- å¤§é‡æ–‡æ¡£ï¼ˆ> 50ï¼‰

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-11-26  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š6-9 å°æ—¶  
**ä¼˜å…ˆçº§**ï¼šP0
