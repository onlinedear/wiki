聚焦于文档编辑器中「标题自动编号」功能的核心逻辑与边界场景。目标用户为需要结构化写作的专业用户（如产品经理、技术文档撰写者、学术作者）。文档采用用户故事-场景-规则三层结构，确保开发、测试、设计三方对齐。

---

### 文档编辑器标题自动编号功能 PRD
**版本**：v1.0  
**作者**：XXX  
**日期**：2025-11-30  
**状态**：评审中  

---

#### 1. 背景与目标
**用户痛点**：  
用户在撰写长文档时，需手动维护标题编号（如“1. 概述 / 1.1 范围 / 1.1.1 术语”）。当通过拖拽调整章节顺序时，编号全部错乱，需人工重排，耗时易错。

**产品目标**：  
- 实现「有序列表+标题」组合下的自动编号，支持 H1-H3 三级嵌套。  
- 拖拽排序后编号实时刷新，零人工维护。  
- 编号规则符合学术与出版通用标准（1. / 1.1 / 1.1.1）。  

---

#### 2. 用户故事
| 角色 | 故事 | 验收标准 |
|---|---|---|
| 作为技术文档作者 | 我希望在插入一级标题时自动出现“1.”前缀，二级标题出现“1.1”，三级标题出现“1.1.1”，无需手动输入 | 见第4章「功能规则」 |
| 作为用户 | 当我用拖拽手柄将第3章移动到第1章前，所有编号立即重算为1/2/3... | 见第5章「刷新机制」 |
| 作为用户 | 当我删除某一级标题后，其下游编号自动补齐，不出现跳号 | 见第4.3「断号处理」 |

---

#### 3. 范围
**纳入**：  
- 仅支持 H1-H3 三级标题。  
- 仅当用户显式选择「有序列表+标题」样式组合时生效（工具栏切换）。  
- 支持拖拽手柄（左侧 ⋮⋮ 图标）触发排序。  

**不纳入**：  
- H4 及以下标题。  
- 无序列表、任务列表。  
- 复制粘贴时保留编号（粘贴后重新计算）。  
- 多栏布局、分节场景（后续版本扩展）。  

---

#### 4. 功能规则
| 层级 | 编号模板 | 前置条件 | 示例 | 边界规则 |
|---|---|---|---|---|
| H1 | `{{n}}.` | 无 | 1. 概述 | 文档内首个 H1 从 1 开始，后续递增 |
| H2 | `{{n}}.{{m}}.` | 必须存在父级 H1 | 1.1 范围 | 若父级 H1 被删除，则该 H2 升级为新的 H1，编号从「1.」重新开始 |
| H3 | `{{n}}.{{m}}.{{k}}.` | 必须存在父级 H2 | 1.1.1 术语 | 若父级 H2 被删除，则该 H3 升级为新的 H2，编号从「1.1」开始 |

**4.1 编号初始值**  
- 任何层级在缺失父级时，均从 1 开始，禁止出现“0.x”形态。  

**4.2 跨级跳跃**  
- 允许用户直接插入 H3 而跳过 H2，此时 H3 编号仍遵循「父级 H1 序号 + 1 + 1」规则，即「1.1.1」。  

**4.3 断号处理**  
- 当用户删除中间某标题后，下游同层标题序号自动减 1，保持连续。  

**4.4 样式隔离**  
- 编号前缀与标题文本之间插入半角空格，采用 `::before` 伪元素注入，不写入 DOM 文本节点，避免复制时携带编号。  

---

#### 5. 刷新机制
| 触发事件 | 技术实现 | 用户体验 |
|---|---|---|
| 拖拽结束（mouseup） | 监听排序完成事件，发送「重算编号」指令 | 200ms 内完成重算，无闪烁 |
| 标题层级变更（H2→H1） | 监听 `formatBlock` 事件 | 立即重算当前节点及下游 |
| 删除标题 | 监听 `input` 或 `mutation` | 同上 |
| 撤销/重做 | 监听 `undoStack` 变化 | 重算后插入新历史记录，避免撤销冲突 |

**性能要求**：  
- 文档 500 个标题内，重算耗时 < 100ms。  
- 采用 CSS Counter 方案，利用浏览器原生计数，减少 JS 计算量。  

---

#### 6. 异常与错误处理
| 场景 | 表现 | 兜底策略 |
|---|---|---|
| 用户手动在标题前输入「1.」文本 | 检测到前缀匹配编号模板，弹出 Toast 提示「已启用自动编号，手动前缀将被覆盖」 | 下次刷新时移除手动前缀 |
| 网络协作下，远端用户拖拽导致冲突 | 本地立即重算，远端采用 OT 算法合并，可能出现临时跳号，1s 内再次重算对齐 | 在临时跳号位置展示灰色「~」符号，hover 提示「同步中」 |
| 粘贴富文本含编号 | 清除所有手动编号，重新计算 | 在粘贴菜单增加「保留源格式」选项，默认不勾选 |

---

#### 7. 验收指标（北极星指标）
- 编号错误率（人工发现跳号或 0.x 形态）= 0。  
- 拖拽后编号刷新耗时 P95 < 200ms。  
- 用户满意度调研「标题编号不再出错」评分 ≥ 4.5/5。  

---

#### 8. 里程碑
| 阶段 | 时间 | 交付 |
|---|---|---|
| PRD 评审 | T0 | 本文档定稿 |
| 技术方案 | T0+3d | 确定采用 CSS Counter + MutationObserver |
| 内测 | T0+14d | 支持 500 标题压力测试 |
| 公测 | T0+28d | 灰度 20% 用户，收集异常场景 |
| 全量 | T0+35d | 发布并输出帮助中心 FAQ |

---

#### 9. 附录
**A. 术语表**  
- 父级：指在文档流中距离当前标题最近的上层更高阶标题。  
- 下游：指文档流中位于当前标题之后的同阶或更低阶标题。  

**B. 参考规范**  
- ISO 2145:1978 文献工作——文献中章节的编号。  
- Google Docs 标题编号逻辑（竞品对标）。
