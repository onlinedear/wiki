# 甘特图功能说明

## 功能概述

在文档编辑器中新增了甘特图功能，用于项目规划和任务管理。

## 界面布局

- **左侧固定列**：显示任务序号和任务名称，不随横向滚动移动
- **右侧时间轴**：可横向滚动查看不同时间段
- **顶部工具栏**：
  - 左侧：快捷设置按钮（字段配置、甘特图设置、筛选、排序、分组、评论、全屏）
  - 右侧：视图切换按钮（周、月、季、年）和"今天"快速定位按钮
- **底部滚动条**：自定义滚动条滑块，与时间轴滚动同步
- **周末标识**：周六和周日的背景为浅灰色，便于识别
- **任务条布局**：任务名称显示在进度条左侧，天数显示在右侧

## 使用方法

### 1. 插入甘特图

在编辑器中输入 `/`，在弹出的菜单中找到"表格"下方的"甘特图"选项，点击即可插入。

或者直接输入 `/甘特图` 或 `/gantt` 进行快速搜索。

### 2. 默认内容

插入的甘特图默认包含 3 个任务：
- 任务 1：从今天开始，持续 4 天
- 任务 2：从今天+2天开始，持续 4 天
- 任务 3：从今天+4天开始，持续 4 天

### 3. 视图模式切换

甘特图支持 4 种视图模式，每种模式的显示密度和时间范围不同：
- **周视图**：每天 160px，显示前后约4周的内容
- **月视图**：每天 60px，显示前后约4个月的内容
- **季视图**：每天 14px，显示一整年的内容（前后各6个月）
- **年视图**：每天约 5.25px，显示前后约2年的内容

点击工具栏上的对应按钮即可切换视图。时间轴始终按天连续显示，可以通过横向滚动查看更多时间段。

### 4. 快速定位今天

点击工具栏上的"今天"按钮，可以快速滚动到当前日期所在的位置。

### 5. 编辑任务

有两种方式打开任务编辑对话框：
1. 点击蓝色的任务条
2. 点击左侧任务列表中的任务名称

在编辑对话框中可以设置：
- **任务名**：任务的名称
- **自定义字段**：显示所有已添加的自定义字段
- **开始日期**：任务的开始日期
- **截止日期**：任务的结束日期

### 6. 新增任务

点击任务列表下方的 "+" 按钮，可以新增任务。

### 7. 删除任务

在编辑任务对话框中，点击"删除"按钮可以删除当前任务。

或者在进度条上右键点击，选择"删除记录"快速删除任务。

### 8. 拖拽调整任务时间

#### 8.1 调整任务大小（改变持续时间）

鼠标悬停在任务条的两端时，会显示拖拽手柄：
- **左侧手柄**：拖拽调整任务的开始日期
- **右侧手柄**：拖拽调整任务的结束日期

拖拽时，任务的天数会自动更新。

#### 8.2 拖拽移动任务（保持持续时间）

鼠标悬停在任务条的中间区域时，光标变为移动图标（十字箭头）：
- **拖拽移动**：按住鼠标左键拖拽整个进度条
- **效果**：开始日期和结束日期同时调整，持续时间保持不变
- **精度**：自动对齐到最近的天

详细说明请参考 [甘特图进度条拖拽移动功能说明](./甘特图进度条拖拽移动功能说明.md)。

### 9. 右键菜单

在进度条上点击鼠标右键，可以打开快捷菜单。详细说明请参考 [甘特图右键菜单功能说明](./甘特图右键菜单功能说明.md)。

**菜单选项：**
- **清除时间条**：清除任务的开始和结束日期，保留任务本身
- **查看详情**：打开任务详情编辑对话框
- **添加评论**：针对任务添加评论（功能接口已预留）
- **删除记录**：删除整个任务记录

**使用场景：**
- 快速清除未确定时间的任务
- 便捷查看和编辑任务详情
- 快速删除不需要的任务

### 10. 字段配置

点击工具栏左侧的"字段配置"按钮（列图标），可以打开字段配置面板。

**字段配置功能：**
- **显示/隐藏字段**：点击眼睛图标可以切换字段的显示状态
  - 闭眼图标表示字段隐藏
  - 睁眼图标表示字段显示
  - 显示的字段会在任务名后面的列中显示
- **拖拽排序**：拖动显示字段左侧的手柄图标可以调整显示顺序
- **编辑字段**：点击自定义字段右侧的三点菜单，选择"编辑"可以修改字段配置
- **删除字段**：点击自定义字段右侧的三点菜单，选择"删除"可以删除字段
- **新增字段**：点击底部的"新增字段"按钮可以添加新的自定义字段（默认为隐藏状态）

**内置字段：**
- 任务名（始终显示，不可隐藏）
- 开始日期和结束日期（不在字段配置中显示，在任务编辑对话框中始终可用）

**支持的自定义字段类型：**
- 文本：普通文本输入
- 单选：单选下拉框（可配置选项和默认值）
- 多选：多选下拉框（可配置选项和默认值）
- 人员：选择人员（可限制可选成员范围）
- 日期：日期选择器（可配置日期格式）
- 数字：数字输入（可配置格式：整数、小数、千分位、百分比等）
- 复选框：勾选框（可配置默认值）
- 超链接：URL 链接

### 11. 筛选功能

点击工具栏左侧的"筛选"按钮（漏斗图标），可以打开筛选面板。详细说明请参考 [甘特图筛选功能说明](./甘特图筛选功能说明.md)。

### 12. 排序功能

点击工具栏左侧的"排序"按钮（排序图标），可以打开排序面板。详细说明请参考 [甘特图排序功能说明](./甘特图排序功能说明.md)。

**主要特性：**
- 支持多条件排序
- 可拖拽调整排序优先级
- 自动排序开关
- 智能识别字段类型（文本/数字/日期/单选/多选等）
- 中文按拼音首字母排序
- 排序仅在本地生效，不影响其他协作者

### 13. 分组功能

点击工具栏左侧的"分组"按钮（列表图标），可以打开分组面板。详细说明请参考 [甘特图分组功能说明](./甘特图分组功能说明.md)。

**主要特性：**
- 根据自定义字段对任务进行分组显示
- 支持所有非锁定字段作为分组依据
- 分组标题显示分组名称和任务数量
- 可折叠/展开分组
- 智能处理不同字段类型（单选、多选、人员、日期等）
- 空值任务归入"(暂无)"分组
- 分组仅在本地生效，不影响其他协作者

**使用场景：**
- 按任务状态分组：清晰查看未开始、进行中、已完成的任务
- 按负责人分组：了解每个成员的任务分配情况
- 按优先级分组：优先关注高优先级任务

### 14. 保存配置

点击工具栏左侧的"保存配置"按钮（软盘图标），可以保存当前的视图配置。详细说明请参考 [甘特图配置保存功能说明](./甘特图配置保存功能说明.md)。

**主要特性：**
- 保存筛选、排序、分组等个性化设置
- 刷新页面后自动恢复配置
- 按钮状态指示（有未保存更改时变为绿色）
- 配置对所有协作者可见
- 与文档一起保存到数据库

**可保存的配置：**
- 筛选条件和筛选逻辑
- 排序条件和自动排序状态
- 分组条件

### 15. 甘特图设置

点击工具栏左侧的"甘特图设置"按钮（齿轮图标），可以打开甘特图设置面板。

**可配置项：**
- **时间范围**：
  - 开始时间：设置甘特图显示的起始日期（留空则自动计算）
  - 结束时间：设置甘特图显示的结束日期（留空则自动计算）
- **标题显示字段**：选择在进度条上显示的字段
  - 默认为"任务名"
  - 可选择任何字段（包括自定义字段）
  - 进度条显示格式：**天数 + 选中字段的值**
  - 例如：选择"完成状态"后，进度条显示"5 天 - 已完成"
  - 设置保存到数据库，下次打开时保持
- **进度条颜色**：从 8 种预设颜色中选择进度条的颜色
  - 蓝色（默认）
  - 绿色
  - 红色
  - 橙色
  - 紫色
  - 青色
  - 黄色
  - 粉色
- **仅计算工作日**：
  - 勾选后，天数仅计算工作日，去除周末
  - 默认：法定工作日（周一至周五）
  - 可自定义每周工作日（选择周一到周日中的任意天）
  - 显示效果：未勾选显示"X 天"，勾选后显示"X 工作日"

## 技术实现

### 前端组件
- 位置：`apps/client/src/features/editor/components/gantt/`
- 主要文件：
  - `gantt-view.tsx`：甘特图视图组件
  - `gantt-view.module.css`：样式文件
  - `index.ts`：导出文件

### 编辑器扩展
- 位置：`packages/editor-ext/src/lib/gantt/`
- 主要文件：
  - `gantt.ts`：Tiptap 扩展定义
  - `index.ts`：导出文件

### 数据结构

```typescript
type FieldType = 'text' | 'select' | 'multiSelect' | 'person' | 'group' | 
  'date' | 'attachment' | 'number' | 'checkbox' | 'link' | 'formula' | 
  'reference' | 'workflow' | 'autoNumber';

interface CustomField {
  id: string;           // 字段唯一标识
  name: string;         // 字段名称
  type: FieldType;      // 字段类型
  options?: string[];   // 选项（用于 select/multiSelect/person）
  defaultValue?: any;   // 默认值
  order?: number;       // 字段排序
}

interface GanttSettings {
  startDate?: string;   // 甘特图开始日期
  endDate?: string;     // 甘特图结束日期
  titleField?: string;  // 标题显示字段（默认为 'name'）
  barColor?: string;    // 进度条颜色（默认为 '#228be6'）
}

interface GanttTask {
  id: string;           // 任务唯一标识
  name: string;         // 任务名称
  startDate: string;    // 开始日期 (YYYY-MM-DD)
  endDate: string;      // 结束日期 (YYYY-MM-DD)
  [key: string]: any;   // 自定义字段值
}

interface GanttAttributes {
  tasks?: GanttTask[];              // 任务列表
  viewMode?: 'week' | 'month' | 'quarter' | 'year';  // 视图模式
  hiddenColumns?: string[];         // 隐藏的列
  customFields?: CustomField[];     // 自定义字段定义
  ganttSettings?: GanttSettings;    // 甘特图设置
}
```

## 国际化

已添加中英文翻译：
- 中文：`apps/client/public/locales/zh-CN/translation.json`
- 英文：`apps/client/public/locales/en-US/translation.json`

翻译键：
- `"Gantt chart"`: 甘特图
- `"Insert a gantt chart for project planning."`: 插入甘特图用于项目规划

## 依赖

- `@mantine/core`：UI 组件库
- `@mantine/dates`：日期选择器
- `@hello-pangea/dnd`：拖拽排序
- `nanoid`：生成唯一 ID
- `@tiptap/core`：编辑器核心
- `@tiptap/react`：React 集成

## 注意事项

1. 甘特图在只读模式下不可编辑
2. 任务条的位置和宽度根据日期范围自动计算
3. 日期范围会根据所有任务的开始和结束日期自动调整
4. 任务条显示任务名称和持续天数
