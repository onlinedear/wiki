# é£ä¹¦æ–‡æ¡£å¯¼å…¥å›¾ç‰‡å¤„ç†è¯´æ˜

## å½“å‰çŠ¶æ€

âœ… **å·²å®ç°** - é£ä¹¦æ–‡æ¡£å¯¼å…¥åŠŸèƒ½ç°å·²æ”¯æŒå›¾ç‰‡å¯¼å…¥ï¼

å›¾ç‰‡ä¼šè‡ªåŠ¨ä»é£ä¹¦ä¸‹è½½å¹¶ä¸Šä¼ åˆ° NoteDoc çš„å­˜å‚¨ç³»ç»Ÿï¼Œä½œä¸ºé™„ä»¶æ°¸ä¹…ä¿å­˜ã€‚

## å®ç°æ–¹æ¡ˆ

é‡‡ç”¨äº†**å®Œæ•´å›¾ç‰‡å¯¼å…¥æ–¹æ¡ˆ**ï¼Œå›¾ç‰‡ä¼šï¼š

1. ä»é£ä¹¦ API ä¸‹è½½ï¼ˆä½¿ç”¨ image.tokenï¼‰
2. ä¸Šä¼ åˆ° NoteDoc çš„å­˜å‚¨ç³»ç»Ÿï¼ˆS3 æˆ–æœ¬åœ°å­˜å‚¨ï¼‰
3. åˆ›å»ºé™„ä»¶è®°å½•åˆ°æ•°æ®åº“
4. åœ¨æ–‡æ¡£ä¸­å¼•ç”¨é™„ä»¶ ID

## æŠ€æœ¯å®ç°

é£ä¹¦ API è¿”å›çš„å›¾ç‰‡ä¿¡æ¯æ˜¯ `image.token`ï¼ˆå›¾ç‰‡ä»¤ç‰Œï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥å¯è®¿é—®çš„ URLã€‚å®ç°æµç¨‹ï¼š

1. ä½¿ç”¨é£ä¹¦ API å°† token è½¬æ¢ä¸ºä¸´æ—¶ä¸‹è½½ URL
2. ä¸‹è½½å›¾ç‰‡æ–‡ä»¶åˆ°å†…å­˜
3. ä¸Šä¼ åˆ° NoteDoc çš„å­˜å‚¨ç³»ç»Ÿï¼ˆS3 æˆ–æœ¬åœ°å­˜å‚¨ï¼‰
4. åˆ›å»ºé™„ä»¶è®°å½•
5. åœ¨æ–‡æ¡£ä¸­å¼•ç”¨ä¸Šä¼ åçš„é™„ä»¶ ID

## æ ¸å¿ƒä»£ç 

### 1. å›¾ç‰‡ä¸‹è½½å’Œä¸Šä¼ æ–¹æ³•

åœ¨ `FeishuImportService` ä¸­å®ç°ï¼š

```typescript
private async downloadAndUploadImage(
  client: AxiosInstance,
  imageToken: string,
  pageId: string,
  workspaceId: string,
  userId: string,
): Promise<string | null> {
  try {
    // 1. ä»é£ä¹¦ä¸‹è½½å›¾ç‰‡
    const imageBuffer = await this.feishuApiService.downloadImage(client, imageToken);
    if (!imageBuffer) {
      return null;
    }

    // 2. ç”Ÿæˆé™„ä»¶ ID
    const attachmentId = uuid7();
    
    // 3. ç¡®å®šæ–‡ä»¶ç±»å‹å’Œè·¯å¾„
    const fileExt = '.png';
    const fileName = `${attachmentId}${fileExt}`;
    const filePath = `${getAttachmentFolderPath(AttachmentType.File, workspaceId)}/${attachmentId}/${fileName}`;

    // 4. ä¸Šä¼ åˆ°å­˜å‚¨
    await this.storageService.upload(filePath, imageBuffer);

    // 5. åˆ›å»ºé™„ä»¶è®°å½•
    await this.attachmentRepo.insertAttachment({
      id: attachmentId,
      fileName,
      fileExt,
      filePath,
      fileSize: imageBuffer.length,
      mimeType: 'image/png',
      type: AttachmentType.File,
      pageId,
      workspaceId,
      creatorId: userId,
    });

    return attachmentId;
  } catch (error) {
    this.logger.error(`Failed to download and upload image: ${error.message}`);
    return null;
  }
}
```

### 2. å›¾ç‰‡å—å¤„ç†

åœ¨ `convertFeishuBlock` æ–¹æ³•ä¸­ï¼š

```typescript
case 27: // Image
  if (block.image && client && pageId && workspaceId && userId) {
    const result = await this.downloadAndUploadImage(
      client,
      block.image.token,
      pageId,
      workspaceId,
      userId,
    );
    
    if (result) {
      return {
        type: 'image',
        attrs: {
          attachmentId: result.attachmentId,
          // æ³¨æ„ï¼šsrc å¿…é¡»åŒ…å« fileId å’Œ fileNameï¼ŒåŒ¹é…åç«¯è·¯ç”± /files/:fileId/:fileName
          src: `/api/files/${result.attachmentId}/${result.fileName}`,
          alt: null,
          title: null,
        },
      };
    } else {
      // å¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦
      return {
        type: 'paragraph',
        content: [{
          type: 'text',
          text: 'ğŸ–¼ï¸ [å›¾ç‰‡å¯¼å…¥å¤±è´¥]',
        }],
      };
    }
  }
  return null;
```

**é‡è¦è¯´æ˜ï¼š**
- `src` è·¯å¾„å¿…é¡»æ˜¯ `/api/files/{fileId}/{fileName}` æ ¼å¼
- è¿™ä¸åç«¯çš„æ–‡ä»¶è·¯ç”± `@Get('/files/:fileId/:fileName')` åŒ¹é…
- å‰ç«¯çš„ `getFileUrl()` ä¼šå°† `/api/files/` è½¬æ¢ä¸ºå®Œæ•´çš„åç«¯ URL

### 3. æ¨¡å—ä¾èµ–

åœ¨ `FeishuImportModule` ä¸­æ·»åŠ ï¼š

```typescript
imports: [DatabaseModule, StorageModule, AttachmentModule]
```

## é£ä¹¦æƒé™è¦æ±‚

è¦ä¸‹è½½å›¾ç‰‡ï¼Œéœ€è¦åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½®ä»¥ä¸‹æƒé™ï¼š

- `drive:drive:readonly` - è¯»å–äº‘ç©ºé—´æ–‡ä»¶
- `drive:file:readonly` - è¯»å–æ–‡ä»¶å†…å®¹
- `docx:document:readonly` - è¯»å–æ–‡æ¡£å†…å®¹

è¯¦è§ï¼š[é£ä¹¦æƒé™é…ç½®è¯¦ç»†æ­¥éª¤.md](./é£ä¹¦æƒé™é…ç½®è¯¦ç»†æ­¥éª¤.md)

## ç›¸å…³æ–‡ä»¶

- `apps/server/src/ee/feishu-import/feishu-api.service.ts` - é£ä¹¦ API æœåŠ¡ï¼ˆå›¾ç‰‡ä¸‹è½½æ–¹æ³•ï¼‰
- `apps/server/src/ee/feishu-import/feishu-import.service.ts` - å¯¼å…¥æœåŠ¡ï¼ˆå›¾ç‰‡å¤„ç†é€»è¾‘ï¼‰
- `apps/server/src/ee/feishu-import/feishu-import.module.ts` - æ¨¡å—é…ç½®
- `apps/server/src/core/attachment/services/attachment.service.ts` - é™„ä»¶æœåŠ¡
- `apps/server/src/integrations/storage/storage.service.ts` - å­˜å‚¨æœåŠ¡

## ç‰¹æ€§è¯´æ˜

### ä¼˜ç‚¹

- âœ… å›¾ç‰‡æ°¸ä¹…ä¿å­˜åœ¨ NoteDoc ä¸­
- âœ… ä¸ä¾èµ–é£ä¹¦æœåŠ¡
- âœ… ç¬¦åˆ NoteDoc çš„é™„ä»¶ç®¡ç†æœºåˆ¶
- âœ… æ”¯æŒ S3 å’Œæœ¬åœ°å­˜å‚¨
- âœ… å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½çš„å ä½ç¬¦

### é”™è¯¯å¤„ç†

- å¦‚æœå›¾ç‰‡ä¸‹è½½å¤±è´¥ï¼Œä¼šåœ¨æ–‡æ¡£ä¸­æ’å…¥ "ğŸ–¼ï¸ [å›¾ç‰‡å¯¼å…¥å¤±è´¥]" å ä½ç¬¦
- é”™è¯¯ä¼šè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
- ä¸ä¼šå› ä¸ºå•ä¸ªå›¾ç‰‡å¤±è´¥è€Œä¸­æ–­æ•´ä¸ªå¯¼å…¥æµç¨‹

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å›¾ç‰‡æ ¼å¼æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«å›¾ç‰‡å®é™…æ ¼å¼ï¼ˆPNG/JPG/GIF ç­‰ï¼‰
2. **æ‰¹é‡ä¸‹è½½**ï¼šå¹¶è¡Œä¸‹è½½å¤šä¸ªå›¾ç‰‡ï¼Œæå‡å¯¼å…¥é€Ÿåº¦
3. **è¿›åº¦æ˜¾ç¤º**ï¼šåœ¨å‰ç«¯æ˜¾ç¤ºå›¾ç‰‡ä¸‹è½½è¿›åº¦
4. **å›¾ç‰‡å‹ç¼©**ï¼šè‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
5. **é‡è¯•æœºåˆ¶**ï¼šä¸‹è½½å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
