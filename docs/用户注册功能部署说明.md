# 用户注册功能 - 部署说明

## 重要提示

由于添加了新的后端 API 端点，**必须重启后端服务器**才能使注册功能生效。

## 部署步骤

### 1. 停止当前运行的服务

如果开发服务器正在运行，请先停止它（Ctrl+C）。

### 2. 重启开发服务器

```bash
# 重启所有服务（推荐）
pnpm dev
```

或者分别启动：

```bash
# 启动后端服务器
pnpm server:dev

# 在另一个终端启动前端
pnpm client:dev
```

### 3. 验证后端端点

等待服务器启动完成后，可以通过以下方式验证注册端点是否可用：

```bash
# 检查注册端点
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","email":"test@example.com","password":"12345678","confirmPassword":"12345678"}'
```

如果返回 404，说明后端服务器还没有完全重启。

### 4. 清除浏览器缓存

重启服务器后，建议清除浏览器缓存或使用硬刷新：
- **Chrome/Edge**: Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows/Linux)
- **Firefox**: Cmd+Shift+R (Mac) 或 Ctrl+F5 (Windows/Linux)
- **Safari**: Cmd+Option+R

或者使用无痕模式打开。

### 5. 测试注册功能

访问注册页面：
```
http://localhost:5173/register
```

填写表单并提交，应该能够成功注册。

## 常见问题

### Q: 仍然显示 404 错误？

**解决方案**：
1. 确认后端服务器已完全重启
2. 检查后端控制台是否有错误信息
3. 确认后端服务器运行在 `http://localhost:3000`
4. 检查 `apps/server/src/core/auth/auth.controller.ts` 文件是否包含注册端点

### Q: 401 错误仍然显示在控制台？

**解决方案**：
1. 硬刷新浏览器（Cmd+Shift+R 或 Ctrl+Shift+R）
2. 清除浏览器缓存
3. 使用无痕模式
4. 确认前端代码已更新（检查 `apps/client/src/lib/api-client.ts`）

### Q: 注册后没有自动登录？

**解决方案**：
1. 检查浏览器控制台是否有错误
2. 确认 Cookie 设置正确
3. 检查后端是否正确设置了 `authToken` Cookie

### Q: 密码不匹配错误？

**解决方案**：
1. 确保"密码"和"确认密码"字段输入完全一致
2. 注意密码区分大小写

## 生产环境部署

### 1. 构建应用

```bash
# 构建所有应用
pnpm build

# 或分别构建
pnpm server:build
pnpm client:build
```

### 2. 运行生产版本

```bash
# 启动后端
cd apps/server
pnpm start:prod

# 前端静态文件部署到 Web 服务器（如 Nginx）
```

### 3. 环境变量

确保以下环境变量已正确配置：

```env
# 数据库
DATABASE_URL=postgresql://...

# Cookie 设置
COOKIE_SECURE=true  # 生产环境使用 HTTPS
COOKIE_DOMAIN=yourdomain.com

# 其他必需的环境变量
APP_URL=https://yourdomain.com
```

### 4. 数据库迁移

注册功能使用现有的用户表和用户组表，不需要额外的数据库迁移。

## 验证清单

部署后请验证以下功能：

- [ ] 访问注册页面不会自动跳转到登录页面
- [ ] 填写注册表单可以成功提交
- [ ] 注册成功后自动登录并跳转到首页
- [ ] 新注册用户在用户管理页面可见
- [ ] 新用户角色为"用户"
- [ ] 新用户已加入默认用户组
- [ ] 登录页面显示"还没有账户？注册"链接
- [ ] 注册页面显示"已有账户？登录"链接
- [ ] SSO 强制登录启用时，注册页面显示禁用提示
- [ ] 密码不匹配时显示错误提示
- [ ] 邮箱已存在时显示错误提示

## 监控和日志

### 后端日志

注册相关的日志会显示在后端控制台：
- 注册请求
- 用户创建
- 用户组分配
- 认证令牌生成

### 前端错误

打开浏览器开发者工具（F12）查看：
- 网络请求（Network 标签）
- 控制台错误（Console 标签）
- 应用状态（Application 标签 > Cookies）

## 回滚方案

如果注册功能出现问题，可以通过以下方式回滚：

### 1. 禁用注册端点

在 `apps/server/src/core/auth/auth.controller.ts` 中注释掉注册端点：

```typescript
// @HttpCode(HttpStatus.OK)
// @Post('register')
// async register(...) { ... }
```

### 2. 移除前端路由

在 `apps/client/src/App.tsx` 中注释掉注册路由：

```typescript
// <Route path={"/register"} element={<RegisterPage />} />
```

### 3. 重启服务器

```bash
pnpm dev
```

## 技术支持

如有问题，请查看：
- [用户注册功能说明](./用户注册功能说明.md)
- [用户注册快速开始](./用户注册快速开始.md)
- [用户注册功能完成总结](./用户注册功能完成总结.md)

或运行验证脚本：
```bash
./scripts/verify-register-implementation.sh
```
