# 标题列表组合功能说明

## 功能概述

现在编辑器支持在同一段文本上同时应用标题样式和列表样式，并实现了智能的层级编号系统：
- H1 标题在有序列表中显示为 "1.", "2.", "3." 等
- H2 标题在 H1 下显示为 "1.1", "1.2", "2.1", "2.2" 等
- H3 标题在 H2 下显示为 "1.1.1", "1.1.2", "1.2.1" 等
- 支持最多 6 级标题的层级编号
- 序号的字体大小自动匹配标题级别
- 普通段落的编号独立计数

## 使用方法

### 创建带层级编号的标题

1. **创建一级标题编号**
   - 输入文本并选中
   - 点击工具栏设置为 H1
   - 点击有序列表按钮
   - 结果：`1. 一级标题`
   - 继续创建 H1：`2. 一级标题`

2. **创建二级标题编号**
   - 在 H1 标题下创建新行
   - 设置为 H2
   - 点击有序列表按钮
   - 结果：`1.1 二级标题`
   - 继续创建：`1.2 二级标题`

3. **创建三级标题编号**
   - 在 H2 标题下创建新行
   - 设置为 H3
   - 点击有序列表按钮
   - 结果：`1.1.1 三级标题`

### 编号规则

- **H1 标题**：1., 2., 3. ...（重置所有下级计数器）
- **H2 标题**：1.1, 1.2, 2.1, 2.2 ...（重置 H3-H6 计数器）
- **H3 标题**：1.1.1, 1.1.2, 1.2.1 ...（重置 H4-H6 计数器）
- **H4 标题**：1.1.1.1, 1.1.1.2 ...（重置 H5-H6 计数器）
- **H5 标题**：1.1.1.1.1, 1.1.1.1.2 ...（重置 H6 计数器）
- **H6 标题**：1.1.1.1.1.1, 1.1.1.1.1.2 ...
- **普通段落**：独立编号 1., 2., 3. ...

### 字体大小匹配

编号的字体大小会自动匹配标题级别：
- H1 编号：2em（与 H1 标题相同）
- H2 编号：1.5em（与 H2 标题相同）
- H3 编号：1.25em（与 H3 标题相同）
- H4 编号：1.125em（与 H4 标题相同）
- H5 编号：1em（与 H5 标题相同）
- H6 编号：0.875em（与 H6 标题相同）
- 段落编号：1em（正常大小）

### 支持的组合

- ✅ 标题 + 有序列表（带层级编号）
- ✅ 标题 + 无序列表
- ✅ 标题 + 任务列表
- ✅ 所有级别的标题（H1-H6）都支持
- ✅ 嵌套列表

### 键盘快捷键

在标题列表项中：
- `Enter` - 创建新的列表项
- `Tab` - 增加缩进
- `Shift+Tab` - 减少缩进

## 技术实现

### 修改的文件

1. **packages/editor-ext/src/lib/list-item/list-item.ts**
   - 创建自定义 ListItem 扩展
   - 修改 content 规则：`'paragraph block* | heading block*'`
   - 允许标题作为列表项的内容

2. **packages/editor-ext/src/lib/ordered-list/ordered-list.ts**
   - 创建自定义 OrderedList 扩展
   - 添加 `hasHeading` 属性标记是否包含标题
   - 添加 `headingLevel` 全局属性存储标题级别

3. **apps/client/src/features/editor/styles/ordered-list.css**
   - 使用 CSS 计数器实现层级编号
   - 使用 `:has()` 选择器检测标题类型
   - 为不同级别的标题设置不同的编号格式和字体大小

4. **apps/client/src/features/editor/extensions/extensions.ts**
   - 在 StarterKit 中禁用默认的 ListItem 和 OrderedList
   - 使用自定义的 CustomListItem 和 CustomOrderedList

### 核心代码

**CustomListItem 扩展：**
```typescript
export const CustomListItem = ListItem.extend({
  content: 'paragraph block* | heading block*',
  
  addKeyboardShortcuts() {
    return {
      Enter: () => this.editor.commands.splitListItem(this.name),
      Tab: () => this.editor.commands.sinkListItem(this.name),
      'Shift-Tab': () => this.editor.commands.liftListItem(this.name),
    };
  },
});
```

**CSS 计数器实现：**
```css
/* H1 标题的编号 */
.tiptap ol li:has(> h1) {
  counter-increment: h1-counter;
  counter-reset: h2-counter;
}

.tiptap ol li:has(> h1)::before {
  content: counter(h1-counter) ". ";
  font-size: 2em; /* 匹配 H1 字体大小 */
  font-weight: 700;
}

/* H2 标题的编号 */
.tiptap ol li:has(> h2) {
  counter-increment: h2-counter;
  counter-reset: h3-counter;
}

.tiptap ol li:has(> h2)::before {
  content: counter(h1-counter) "." counter(h2-counter) " ";
  font-size: 1.5em; /* 匹配 H2 字体大小 */
  font-weight: 700;
}
```

## 示例效果

### 层级编号示例

```
1. 一级标题 (H1)
   1.1 二级标题 (H2)
       1.1.1 三级标题 (H3)
       1.1.2 三级标题 (H3)
   1.2 二级标题 (H2)
       1.2.1 三级标题 (H3)
2. 一级标题 (H1)
   2.1 二级标题 (H2)
   2.2 二级标题 (H2)
```

### 混合内容示例

```
1. 一级标题 (H1)
   1. 第一行文本 (普通段落)
   2. 第二行文本 (普通段落)
   1.1 二级标题 (H2)
   3. 第三行文本 (普通段落)
2. 一级标题 (H1)
```

### 完整文档结构示例

```
1. 引言 (H1)
   1. 背景介绍 (普通段落)
   2. 目标说明 (普通段落)

2. 技术架构 (H1)
   2.1 前端架构 (H2)
       2.1.1 React 组件 (H3)
       2.1.2 状态管理 (H3)
   2.2 后端架构 (H2)
       2.2.1 API 设计 (H3)
       2.2.2 数据库设计 (H3)

3. 实现细节 (H1)
   3.1 核心功能 (H2)
   3.2 扩展功能 (H2)
```

## 注意事项

1. 标题样式（字体大小、粗细）会保留
2. 列表编号/符号会正常显示
3. 支持多级嵌套
4. 与其他编辑器功能（如协作、评论）完全兼容

## 测试建议

1. 创建一个新文档
2. 尝试不同的标题级别（H1-H6）
3. 尝试不同的列表类型（有序、无序、任务）
4. 测试嵌套列表
5. 测试键盘快捷键
6. 测试复制粘贴功能

## 交互式编号设置

### 点击编号设置

点击任何标题前的编号，会弹出设置菜单，支持：

1. **继续标题编号** - 恢复自然排序
2. **重新开始编号** - 从 1 或当前编号重新开始
3. **设置编号的值** - 自定义编号（只能修改最后一级）

详细说明请参考：[标题编号设置功能说明](./标题编号设置功能说明.md)

### 编号交互特性

- 编号悬停时会变色，提示可点击
- 支持自定义任意编号值（1-999）
- 多级编号只能修改最后一级数字
- 自定义编号会影响后续同级标题

## 后续优化

- [ ] 添加更多的样式组合支持
- [ ] 优化列表项的视觉呈现
- [ ] 添加键盘快捷键设置编号
- [ ] 支持批量设置编号
