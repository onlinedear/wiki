# 飞书配置权限更新说明

## 更新日期
2025-11-26

## 重大变更

### 从用户级配置改为工作空间级配置

**原设计**：每个用户配置自己的飞书应用凭证  
**新设计**：管理员统一配置，所有成员共享使用

## 变更原因

1. **简化用户操作**：普通用户不需要自己配置飞书应用
2. **统一管理**：管理员集中管理飞书集成配置
3. **更符合企业使用场景**：一个工作空间使用一个飞书应用

## 技术实现

### 后端变更

#### 1. 配置存储位置变更

**之前**：存储在 `users.settings.feishu`
```typescript
// 用户级配置
await this.db
  .updateTable('users')
  .set({ settings: updatedSettings })
  .where('id', '=', userId)
  .execute();
```

**现在**：存储在 `workspaces.settings.feishu`
```typescript
// 工作空间级配置
await this.db
  .updateTable('workspaces')
  .set({ settings: updatedSettings })
  .where('id', '=', workspaceId)
  .execute();
```

#### 2. 方法重命名

| 旧方法名 | 新方法名 |
|---------|---------|
| `saveUserFeishuConfig()` | `saveWorkspaceFeishuConfig()` |
| `getUserFeishuConfig()` | `getWorkspaceFeishuConfig()` |
| `deleteUserFeishuConfig()` | `deleteWorkspaceFeishuConfig()` |

#### 3. 权限控制

**添加管理员权限检查**：
```typescript
// 保存配置
if (user.role !== 'admin' && user.role !== 'owner') {
  throw new Error('Only workspace administrators can configure Feishu integration');
}

// 删除配置
if (user.role !== 'admin' && user.role !== 'owner') {
  throw new Error('Only workspace administrators can delete Feishu configuration');
}

// 获取配置（返回是否是管理员）
return {
  appId: config?.appId || '',
  hasAppSecret: !!config?.appSecret,
  isAdmin: user.role === 'admin' || user.role === 'owner',
};
```

#### 4. 错误提示更新

**导入时配置未找到**：
```
之前：Feishu configuration not found. Please configure your Feishu connection in System Settings first.
现在：Feishu configuration not found. Please ask your workspace administrator to configure Feishu integration in System Settings first.
```

### 前端变更

#### 1. 配置页面权限控制

**管理员视图**：
- 显示完整的配置表单
- 可以保存/删除配置
- 显示说明："为您的工作空间配置飞书集成。所有工作空间成员都可以使用此配置导入文档。"

**普通用户视图**：
- 不显示配置表单
- 显示配置状态提示
- 已配置：显示"飞书集成已由您的工作空间管理员配置。您可以在任何文档库中使用导入功能。"
- 未配置：显示"飞书集成尚未配置。请联系您的工作空间管理员进行设置。"

#### 2. UI实现

```typescript
// 检查是否是管理员
const [isAdmin, setIsAdmin] = useState(false);

// 从API获取
const config = await getFeishuConfig();
setIsAdmin(config?.isAdmin || false);

// 根据权限显示不同界面
if (!isAdmin) {
  return <NonAdminView />;
}
return <AdminConfigForm />;
```

### 翻译更新

#### 中文翻译
- "为您的工作空间配置飞书集成。所有工作空间成员都可以使用此配置导入文档。"
- "从飞书工作空间导入文档"
- "飞书集成已由您的工作空间管理员配置。您可以在任何文档库中使用导入功能。"
- "飞书集成尚未配置。请联系您的工作空间管理员进行设置。"
- "只有工作空间管理员可以配置飞书集成"
- "只有工作空间管理员可以删除飞书配置"

#### 英文翻译
- "Configure Feishu integration for your workspace. All workspace members will be able to import documents using this configuration."
- "Import documents from Feishu workspace"
- "Feishu integration is configured by your workspace administrator. You can use the import feature in any document library."
- "Feishu integration is not configured yet. Please contact your workspace administrator to set it up."
- "Only workspace administrators can configure Feishu integration"
- "Only workspace administrators can delete Feishu configuration"

## 用户角色说明

### 工作空间管理员（Owner/Admin）
- ✅ 可以配置飞书集成
- ✅ 可以修改飞书配置
- ✅ 可以删除飞书配置
- ✅ 可以使用导入功能

### 普通成员（Member）
- ❌ 不能配置飞书集成
- ❌ 不能修改飞书配置
- ❌ 不能删除飞书配置
- ✅ 可以使用导入功能（如果管理员已配置）

## 使用流程

### 管理员配置流程

1. **进入设置页面**
   - 导航到：设置 → 第三方系统集成 → 飞书

2. **配置飞书应用**
   - 输入 App ID
   - 输入 App Secret
   - 点击"保存配置"

3. **通知成员**
   - 配置完成后，所有成员都可以使用导入功能

### 普通用户使用流程

1. **检查配置状态**
   - 进入：设置 → 第三方系统集成 → 飞书
   - 查看配置状态

2. **使用导入功能**
   - 如果已配置：直接在文档库中使用"从飞书导入"
   - 如果未配置：联系管理员配置

## 数据迁移

### 现有用户配置处理

**问题**：如果用户之前已经配置了个人飞书配置怎么办？

**方案**：
1. 旧的用户配置仍然保留在 `users.settings.feishu`
2. 新系统只读取 `workspaces.settings.feishu`
3. 管理员需要重新配置工作空间级别的飞书集成
4. 旧配置不会自动迁移（避免权限问题）

**建议**：
- 通知管理员重新配置
- 提供迁移脚本（可选）

## 测试验证

### 管理员测试
- [x] 管理员可以看到配置表单
- [x] 管理员可以保存配置
- [x] 管理员可以修改配置
- [x] 管理员可以删除配置
- [x] 配置保存到工作空间

### 普通用户测试
- [x] 普通用户看不到配置表单
- [x] 普通用户看到提示信息
- [x] 普通用户可以使用导入功能（如果已配置）
- [x] 普通用户尝试配置时返回权限错误

### 导入功能测试
- [x] 使用工作空间配置导入文档
- [x] 单文档导入正常
- [x] 批量导入正常
- [x] 未配置时显示正确错误提示

## API变更总结

### 配置管理API

#### POST /api/feishu/config
**权限**：仅管理员（admin/owner）  
**变更**：从用户配置改为工作空间配置

#### GET /api/feishu/config
**权限**：所有用户  
**变更**：返回工作空间配置 + isAdmin标志

#### DELETE /api/feishu/config
**权限**：仅管理员（admin/owner）  
**变更**：删除工作空间配置

### 导入API

#### POST /api/feishu/import/online
**权限**：所有用户  
**变更**：使用工作空间配置

#### POST /api/feishu/list-documents
**权限**：所有用户  
**变更**：使用工作空间配置

#### POST /api/feishu/import/batch
**权限**：所有用户  
**变更**：使用工作空间配置

## 优势

### 1. 简化用户体验
- 普通用户不需要了解飞书应用配置
- 减少用户操作步骤
- 降低使用门槛

### 2. 统一管理
- 管理员集中管理集成配置
- 便于维护和更新
- 避免配置不一致

### 3. 安全性
- 减少凭证泄露风险
- 集中控制访问权限
- 便于审计

### 4. 企业友好
- 符合企业IT管理规范
- 便于统一采购和配置
- 支持多团队协作

## 注意事项

### 1. 权限管理
- 只有管理员可以配置
- 所有成员可以使用
- 权限检查在后端实现

### 2. 配置共享
- 一个工作空间一个配置
- 所有成员共享使用
- 配置变更影响所有成员

### 3. 飞书应用
- 需要管理员创建飞书应用
- 需要配置正确的权限
- 需要发布应用版本

### 4. 错误处理
- 未配置时提示联系管理员
- 权限不足时返回明确错误
- 配置错误时提供详细信息

## 总结

✅ **配置级别**：从用户级改为工作空间级  
✅ **权限控制**：只有管理员可以配置  
✅ **使用权限**：所有成员可以使用  
✅ **UI适配**：根据角色显示不同界面  
✅ **错误提示**：更新为工作空间相关提示  
✅ **翻译更新**：中英文完整支持  

这个变更使飞书集成更符合企业使用场景，简化了用户操作，加强了集中管理。

---

**更新时间**：2025-11-26  
**状态**：✅ 已完成
