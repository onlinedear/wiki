# 宝塔面板反向代理配置指南

## 步骤 1：创建网站

1. 登录宝塔面板
2. 点击 **网站** → **添加站点**
3. 填写信息：
   - **域名**: `notedoc.cn` 和 `www.notedoc.cn`
   - **根目录**: 随意选择（不会用到）
   - **PHP 版本**: 纯静态
   - **数据库**: 不创建
   - **FTP**: 不创建

4. 点击 **提交**

## 步骤 2：配置反向代理

1. 在网站列表找到 `notedoc.cn`
2. 点击 **设置**
3. 点击左侧 **反向代理**
4. 点击 **添加反向代理**
5. 填写配置：

```
代理名称: NoteDoc
目标URL: http://127.0.0.1:3000
发送域名: $host
```

6. 高级配置（点击展开）：

```nginx
# 添加以下配置
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";

# 超时设置
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

# 缓冲设置
proxy_buffering off;
proxy_request_buffering off;
```

7. 点击 **提交**

## 步骤 3：配置 SSL 证书（HTTPS）

### 方式 A：使用 Let's Encrypt 免费证书（推荐）

1. 在网站设置中，点击 **SSL**
2. 选择 **Let's Encrypt**
3. 勾选你的域名
4. 点击 **申请**
5. 等待证书申请成功
6. 开启 **强制 HTTPS**

### 方式 B：使用其他证书

1. 如果你有其他证书，选择 **其他证书**
2. 粘贴证书内容和密钥
3. 点击 **保存**
4. 开启 **强制 HTTPS**

## 步骤 4：完整的 Nginx 配置（可选优化）

如果需要更详细的配置，可以点击 **配置文件**，参考以下配置：

```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name notedoc.cn www.notedoc.cn;
    
    # SSL 证书配置（宝塔会自动添加）
    # ssl_certificate ...
    # ssl_certificate_key ...
    
    # 强制 HTTPS
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
    
    # 日志
    access_log /www/wwwlogs/notedoc.cn.log;
    error_log /www/wwwlogs/notedoc.cn.error.log;
    
    # 反向代理到 Docker 容器
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
        
        # 文件上传大小限制
        client_max_body_size 100M;
    }
    
    # WebSocket 支持（协作编辑需要）
    location /socket.io/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 超时设置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
}
```

## 步骤 5：验证配置

1. 保存配置后，点击 **重载配置**
2. 在浏览器访问 `https://notedoc.cn`
3. 应该能看到 NoteDoc 的登录/注册页面

## 步骤 6：更新环境变量

确保 `docker-compose.yml` 中的 `APP_URL` 配置正确：

```yaml
environment:
  APP_URL: 'https://notedoc.cn'  # 使用你的实际域名
```

如果修改了环境变量，需要重启服务：

```bash
cd /www/wwwroot/notedoc
docker-compose restart notedoc
```

## 常见问题

### 1. 502 Bad Gateway

**原因**: 反向代理无法连接到后端服务

**解决**:
```bash
# 检查 Docker 服务是否运行
docker-compose ps

# 检查端口是否监听
netstat -tlnp | grep 3000

# 查看日志
docker-compose logs notedoc
```

### 2. WebSocket 连接失败

**原因**: 协作编辑功能需要 WebSocket 支持

**解决**: 确保反向代理配置中包含 WebSocket 相关配置（见上面的完整配置）

### 3. 文件上传失败

**原因**: 文件大小超过限制

**解决**: 在 Nginx 配置中添加：
```nginx
client_max_body_size 100M;
```

### 4. SSL 证书申请失败

**原因**: 域名未正确解析或端口未开放

**解决**:
- 确保域名 A 记录指向服务器 IP
- 确保服务器 80 和 443 端口已开放
- 检查防火墙设置

## 安全建议

1. **开启防火墙**: 只开放必要的端口（80, 443, 22）
2. **定期更新**: 保持系统和 Docker 镜像更新
3. **备份数据**: 定期备份数据库和文件
4. **强密码**: 使用强密码保护管理员账号
5. **监控日志**: 定期检查访问日志和错误日志

## 性能优化（可选）

在 Nginx 配置中添加缓存和压缩：

```nginx
# Gzip 压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf)$ {
    proxy_pass http://127.0.0.1:3000;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

## 完成！

现在你可以通过 `https://notedoc.cn` 访问你的 NoteDoc 实例了。
